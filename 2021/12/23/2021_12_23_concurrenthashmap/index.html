<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>ConcurrentHashMap æºç é˜…è¯»ç¬”è®° - PPTing&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="PPTing&#039;s Blog"><meta name="msapplication-TileImage" content="/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="PPTing&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="æœ¬æ–‡åŸºäº JDK 1.8 åˆ†æ  HashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œåœ¨å¤šçº¿ç¨‹å¹¶å‘ put å¯¼è‡´ resizeï¼Œåœ¨ transfer è¿‡ç¨‹ä¸­å¯èƒ½å¯¼è‡´æ­»é”æˆ–è€…æ•°æ®ä¸¢å¤± è€Œ ConcurrentHashMap åˆ™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Map ç±»ï¼Œåœ¨ HashMap çš„åŸºç¡€ä¸Šåšäº†çº¿ç¨‹å®‰å…¨çš„å¤„ç†"><meta property="og:type" content="blog"><meta property="og:title" content="ConcurrentHashMap æºç é˜…è¯»ç¬”è®°"><meta property="og:url" content="https://ppting.me/2021/12/23/2021_12_23_concurrenthashmap/"><meta property="og:site_name" content="PPTing&#039;s Blog"><meta property="og:description" content="æœ¬æ–‡åŸºäº JDK 1.8 åˆ†æ  HashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œåœ¨å¤šçº¿ç¨‹å¹¶å‘ put å¯¼è‡´ resizeï¼Œåœ¨ transfer è¿‡ç¨‹ä¸­å¯èƒ½å¯¼è‡´æ­»é”æˆ–è€…æ•°æ®ä¸¢å¤± è€Œ ConcurrentHashMap åˆ™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Map ç±»ï¼Œåœ¨ HashMap çš„åŸºç¡€ä¸Šåšäº†çº¿ç¨‹å®‰å…¨çš„å¤„ç†"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://s2.loli.net/2021/12/23/vQgJ7Bea1GO5mu2.png"><meta property="og:image" content="https://s2.loli.net/2021/12/23/7uBlQZRbcPYH3Fm.png"><meta property="article:published_time" content="2021-12-22T16:00:00.000Z"><meta property="article:modified_time" content="2022-02-12T08:17:24.000Z"><meta property="article:author" content="PPTing"><meta property="article:tag" content="Map"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://s2.loli.net/2021/12/23/vQgJ7Bea1GO5mu2.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ppting.me/2021/12/23/2021_12_23_concurrenthashmap/"},"headline":"ConcurrentHashMap æºç é˜…è¯»ç¬”è®°","image":["https://s2.loli.net/2021/12/23/vQgJ7Bea1GO5mu2.png","https://s2.loli.net/2021/12/23/7uBlQZRbcPYH3Fm.png"],"datePublished":"2021-12-22T16:00:00.000Z","dateModified":"2022-02-12T08:17:24.000Z","author":{"@type":"Person","name":"PPTing"},"publisher":{"@type":"Organization","name":"PPTing's Blog","logo":{"@type":"ImageObject","url":"https://ppting.me/favicon.ico"}},"description":"æœ¬æ–‡åŸºäº JDK 1.8 åˆ†æ  HashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œåœ¨å¤šçº¿ç¨‹å¹¶å‘ put å¯¼è‡´ resizeï¼Œåœ¨ transfer è¿‡ç¨‹ä¸­å¯èƒ½å¯¼è‡´æ­»é”æˆ–è€…æ•°æ®ä¸¢å¤± è€Œ ConcurrentHashMap åˆ™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Map ç±»ï¼Œåœ¨ HashMap çš„åŸºç¡€ä¸Šåšäº†çº¿ç¨‹å®‰å…¨çš„å¤„ç†"}</script><link rel="canonical" href="https://ppting.me/2021/12/23/2021_12_23_concurrenthashmap/"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-51029889-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-51029889-1');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start -->
        <script>
            function switchTab(element) {
                const id = element.parentElement.id;
                const tabElements = element.parentElement.parentElement.children;
                const contentElements = element.parentElement.parentElement.parentElement.parentElement.children[1].children;
                for (let i = 0; i < tabElements.length; i++) {
                    const $tab = tabElements[i];
                    const $content = contentElements[i];
                    if ($tab.id === id) {
                        $tab.classList.add('is-active');
                    } else {
                        $tab.classList.remove('is-active');
                    }
                    if ($content.id === id) {
                        $content.classList.remove('is-hidden');
                    } else {
                        $content.classList.add('is-hidden');
                    }
                }
            }
        </script>
        <!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="PPTing's Blog" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/favicon.ico" alt="PPTing&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/PPTing"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="ç›®å½•" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="æœç´¢" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-12-22T16:00:00.000Z" title="12/23/2021, 12:00:00 AM">2021-12-23</time>å‘è¡¨</span><span class="level-item"><time dateTime="2022-02-12T08:17:24.000Z" title="2/12/2022, 4:17:24 PM">2022-02-12</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/%E7%AC%94%E8%AE%B0/">ç¬”è®°</a><span>Â /Â </span><a class="link-muted" href="/categories/Java/">Java</a><span>Â /Â </span><a class="link-muted" href="/categories/%E6%BA%90%E7%A0%81/">æºç </a><span>Â /Â </span><a class="link-muted" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">æ•°æ®ç»“æ„</a></span><span class="level-item">1 å°æ—¶è¯»å®Œ (å¤§çº¦8788ä¸ªå­—)</span></div></div><h1 class="title is-3 is-size-4-mobile">ConcurrentHashMap æºç é˜…è¯»ç¬”è®°</h1><div class="content"><br>

<blockquote>
<p>æœ¬æ–‡åŸºäº JDK 1.8 åˆ†æ</p>
</blockquote>
<p>HashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œåœ¨å¤šçº¿ç¨‹å¹¶å‘ put å¯¼è‡´ resizeï¼Œåœ¨ transfer è¿‡ç¨‹ä¸­å¯èƒ½å¯¼è‡´æ­»é”æˆ–è€…æ•°æ®ä¸¢å¤±</p>
<p>è€Œ ConcurrentHashMap åˆ™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Map ç±»ï¼Œåœ¨ HashMap çš„åŸºç¡€ä¸Šåšäº†çº¿ç¨‹å®‰å…¨çš„å¤„ç†</p>
<span id="more"></span>

<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>å…ˆå¤§æ¦‚å¯¹ ConcurrentHashMap çš„æ•°æ®ç»“æ„æ¨¡å‹æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£</p>
<p>è·Ÿ HashMap ä¸€æ ·ï¼Œç”±ä¸€ä¸ªæ•°ç»„å’Œå¤šä¸ªé“¾è¡¨&#x2F;çº¢é»‘æ ‘ç»„æˆ</p>
<p><img src="https://s2.loli.net/2021/12/23/vQgJ7Bea1GO5mu2.png" alt="concurrenthashmap.png"></p>
<h3 id="å¸¸é‡"><a href="#å¸¸é‡" class="headerlink" title="å¸¸é‡"></a>å¸¸é‡</h3><p><em><code>MAXIMUM_CAPACITY</code> &#x3D; 1 &lt;&lt; 30</em></p>
<p>æœ€å¤§çš„å®¹é‡ï¼Œå› ä¸º 32 ä½çš„ hash å€¼çš„å‰ä¸¤ä½ä¸ºæ§åˆ¶ä½ï¼Œæ‰€ä»¥æœ€å¤§åªåˆ° 1&lt;&lt;30</p>
<p><em><code>DEFAULT_CAPACITY</code></em>  &#x3D; 16</p>
<p>é»˜è®¤åˆå§‹å®¹é‡ï¼Œå¿…é¡»ä¸º2çš„æ¬¡å¹‚ï¼Œæœ€ä½ä½ 1ï¼Œæœ€å¤§ä¸º <em><code>MAXIMUM_CAPACITY</code></em></p>
<p><em><code>DEFAULT_CONCURRENCY_LEVEL</code> &#x3D; 16</em></p>
<p>é»˜è®¤çš„å¹¶å‘çº§åˆ«</p>
<p><em><code>LOAD_FACTOR</code> &#x3D; 0.75</em> </p>
<p>è´Ÿè½½å› å­</p>
<p><em><code>TREEIFY_THRESHOLD</code> &#x3D; 8</em></p>
<p><em><code>MIN_TREEIFY_CAPACITY</code> &#x3D; 64</em></p>
<p>å½“æ’å…¥æ—¶ï¼Œé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹æ•°é‡è¶…è¿‡ <code>TREEIFY_THRESHOLD</code> ï¼Œä¸” table çš„é•¿åº¦ä¹Ÿè¶…è¿‡äº† <code>MIN_TREEIFY_CAPACITY</code>ï¼Œåˆ™ä¼šå°†é“¾è¡¨è½¬ä¸ºæ ‘</p>
<p>å¦åˆ™è¿›è¡Œæ‰©å®¹æ“ä½œ</p>
<h3 id="sizeCtl"><a href="#sizeCtl" class="headerlink" title="sizeCtl"></a>sizeCtl</h3><p>sizeCtl å­—æ®µæ˜¯ç”¨æ¥è¡¨ç¤º table çš„åˆå§‹åŒ–çŠ¶æ€æˆ–è€…ç”¨æ¥æ§åˆ¶ table æ•°ç»„çš„å®¹é‡</p>
<p>å¦‚æœ sizeCtl ä¸ºè´Ÿæ•°ï¼Œåˆ™è¡¨ç¤º table æ­£åœ¨åˆå§‹åŒ–æˆ–è€…åœ¨è°ƒæ•´å®¹é‡</p>
<p>å¦‚æœ sizeCtl ä¸ä¸ºè´Ÿæ•°ï¼Œå¦‚æœ table ä¸º nullï¼Œåˆ™ä¿å­˜åˆå§‹åŒ– ConcurrentHashMap æ—¶çš„å®¹é‡ï¼Œä¸º0æˆ–è€…é»˜è®¤å€¼</p>
<p>åˆå§‹åŒ–ä»¥åï¼Œåˆ™ä¿å­˜çš„æ˜¯è¦è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼</p>
<p><strong>sizeCtl &#x3D; -1</strong> è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–</p>
<p><strong>sizeCtl &lt; 0 &amp;&amp; sizeCtl! &#x3D; -1</strong> è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­ï¼Œä¸” sizeCtl çš„ä½16ä½çš„å€¼è¡¨ç¤ºæ­£åœ¨æ‰©å®¹çš„çº¿ç¨‹æ•° + 1ï¼Œé«˜16ä½ä¸ºæ‰©å®¹æ ‡è¯†ï¼Œæ˜¯ç”±æ•°ç»„é•¿åº¦è®¡ç®—å¾—åˆ°çš„å€¼</p>
<p><strong>sizeCtl â‰¥ 0 &amp;&amp; table &#x3D;&#x3D; null</strong> è¡¨ç¤ºåˆå§‹åŒ–æ—¶è®¡ç®—å‡ºçš„é»˜è®¤å®¹é‡</p>
<p>s<strong>izeCtl â‰¥ 0 &amp;&amp; table !&#x3D; null</strong> è¡¨ç¤ºéœ€è¦æ‰©å®¹çš„é˜ˆå€¼</p>
<h3 id="Node-lt-K-V-gt"><a href="#Node-lt-K-V-gt" class="headerlink" title="Node&lt;K,V&gt;"></a>Node&lt;K,V&gt;</h3><p><code>Node&lt;K,V&gt;</code> æ˜¯ ConcurrentHashMap çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå®ç°äº† <code>Map.Entry&lt;K,V&gt;</code> æ¥å£ï¼Œç”¨æ¥ä¿å­˜é”®å€¼å¯¹ä¿¡æ¯ï¼Œæ³¨æ„è¿™é‡Œçš„ <code>val</code> å’Œ <code>next</code> å­—æ®µéƒ½æ˜¯ç”¨äº† <code>volatile</code> ä¿®é¥°ï¼Œä»¥ä¿è¯å…¶çº¿ç¨‹é—´çš„å¯è§æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">      <span class="keyword">final</span> K key;</span><br><span class="line">      <span class="keyword">volatile</span> V val;</span><br><span class="line">      <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><p> ConcurrentHashMap æœ‰å¤šä¸ªæ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">        initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">    <span class="keyword">long</span> size = (<span class="keyword">long</span>)(<span class="number">1.0</span> + (<span class="keyword">long</span>)initialCapacity / loadFactor);</span><br><span class="line">    <span class="keyword">int</span> cap = (size &gt;= (<span class="keyword">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="keyword">int</span>)size);</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>initialCapacity:</strong> ä¼ å…¥çš„åˆå§‹å®¹é‡</p>
<p><strong>loadFactor</strong>: è´Ÿè½½å› å­</p>
<p>åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå®é™…ä¸Šï¼Œæ˜¯æƒ³é€šè¿‡ä¼ å…¥çš„ <em>initialCapacity</em> å‚æ•°ï¼Œå¹¶æ ¹æ® loadFactor è®¡ç®—å‡ºæ•°ç»„çš„åˆå§‹åŒ–å®¹é‡ capï¼Œå¹¶ä¸”æ•°ç»„çš„é˜ˆå€¼è¦å¤§äº <em>initialCapacity ï¼Œ</em>åœ¨ <code>initTable()</code> æ–¹æ³•ä¸­ä¼šä½¿ç”¨è¿™ä¸ª sizeCtl å€¼åˆå§‹åŒ– table æ•°ç»„çš„å®¹é‡</p>
<p><em><strong>Butï¼Œä½†æ˜¯</strong></em></p>
<p>è¿™é‡Œçš„ <code>public ConcurrentHashMap(int initialCapacity)</code> å®é™…ä¸Šæ˜¯æœ‰ bug çš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå’Œä¸‹é¢ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•è®¡ç®—å‡ºæ¥çš„ cap å€¼å¹¶ä¸ä¸€è‡´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ConcurrentHashMap(<span class="number">22</span>)</span><br><span class="line"><span class="keyword">new</span> ConcurrentHashMap(<span class="number">22</span>,<span class="number">0.75</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸€ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ä¸­ï¼Œè®¡ç®—å‡ºæ¥çš„ cap å€¼ä¸º 64ï¼Œè€Œä¸‰å‚æ•°çš„æ„é€ æ–¹æ³•è®¡ç®—æ‰€å¾—åˆ°çš„ cap ä¸º 32</p>
<p>è¿™ä¸ªé—®é¢˜ç›´åˆ° JDK 12 æ‰è¢«ä¿®å¤</p>
<p><a target="_blank" rel="noopener" href="https://bugs.openjdk.java.net/browse/JDK-8202422">value of â€˜sizeCtlâ€™ in ConcurrentHashMap varies with the constructor called</a></p>
<h3 id="tableSizeFor-int-size"><a href="#tableSizeFor-int-size" class="headerlink" title="tableSizeFor(int size)"></a>tableSizeFor(int size)</h3><p><code>tableSizeFor(int size)</code> ä¼šè¿”å›å¤§äºç­‰äº size çš„æœ€å°çš„ 2^n çš„</p>
<p>ä¾‹å¦‚ï¼štableSizeFor(22) &#x3D; 32 ; tableSizeFor(3) &#x3D; 4</p>
<p>å…·ä½“ <code>tableSizeFor(size)</code> çš„æ–¹æ³•å¯ä»¥å‚è€ƒ</p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039392972">HashMapä¹‹tableSizeForæ–¹æ³•å›¾è§£</a></p>
<h2 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h2><h3 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put æ–¹æ³•"></a>put æ–¹æ³•</h3><p>final V putVal(K key , V value , boolean onlyIfAbsent) </p>
<aside>
ğŸ’¡ æ·»åŠ é”®å€¼å¯¹ï¼Œä¼šè¿›è¡Œåˆå§‹åŒ– table æ•°ç»„ã€æ‰©å®¹ã€é“¾è¡¨è½¬æ ‘ç­‰æ“ä½œ
</aside>

<p>å…ˆçœ‹æºç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœ key å’Œ value éƒ½ä¸º null åˆ™æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">//è®¡ç®— key çš„ hash å€¼</span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="comment">//è®°å½•é“¾è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ï¼Œç”¨æ¥æ§åˆ¶æ‰©å®¹æˆ–è€…ç”±é“¾è¡¨è½¬å˜ä¸ºæ ‘</span></span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        <span class="comment">//æ­»å¾ªç¯ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶åå†é€€å‡º</span></span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//-------------â‘ --------------------</span></span><br><span class="line">            <span class="comment">//å¦‚æœ tab ä¸ºç©ºæˆ–è€… tab çš„é•¿åº¦ä¸º 0ï¼Œåˆ™åˆå§‹åŒ– table</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//-------------â‘¡--------------------</span></span><br><span class="line">            <span class="comment">//å¦‚æœ hash å¯¹åº”çš„ç´¢å¼•å¤„ i çš„æ¡¶ä¸ºç©ºï¼Œåˆ™å°è¯• cas æ’å…¥</span></span><br><span class="line">            <span class="comment">//è¿™é‡Œ i è¢«èµ‹å€¼ä¸ºç´¢å¼•</span></span><br><span class="line">            <span class="comment">//f è¢«èµ‹å€¼ä¸ºç´¢å¼•å¤„çš„ node å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,<span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="comment">//æ’å…¥æ•°æ®æˆåŠŸï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">//-------------â‘¢--------------------</span></span><br><span class="line">            <span class="comment">// i å¤„çš„ Node ä¸ä¸º null ä¸”å…¶ hash ä¸º MOVEDï¼Œå³æ­£åœ¨æ‰©å®¹ä¸­</span></span><br><span class="line">            <span class="comment">// è¿™é‡Œå°† fh èµ‹å€¼ä¸º Node f çš„ hash å€¼</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//-------------â‘£--------------------</span></span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œå³ i å¤„å·²ç»æœ‰ Node f å­˜åœ¨ï¼Œå¹¶ä¸”ä¸å¤„äºæ‰©å®¹ä¸­ï¼Œé‚£å°±åº”è¯¥æ’å…¥åˆ°é“¾è¡¨ä¸­</span></span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//å¤š f åŠ é”ï¼Œå¤šçº¿ç¨‹è®¿é—®</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">//è¿™é‡Œå†æ¬¡ç¡®è®¤ i å¤„ Node å¯¹è±¡æ˜¯å¦ä¸º f</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœ f çš„ hash å¤§äºç­‰äº 0 </span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            <span class="comment">//å¼€å§‹éå†é“¾è¡¨ï¼Œ</span></span><br><span class="line">                            <span class="comment">//è¿‡ç¨‹ä¸­å¦‚æœæ‰¾åˆ° key ç›¸åŒçš„ï¼Œåˆ™æ›¿æ¢ value å¹¶é€€å‡ºéå†</span></span><br><span class="line">                            <span class="comment">//å¦åˆ™ï¼Œéå†å®Œé“¾è¡¨ï¼Œå°†èŠ‚ç‚¹æ’å…¥é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                    (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                <span class="comment">//å¦‚æœ key ç›¸ç­‰ï¼Œåˆ™æ›¿æ¢ valueï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                            value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœå½“å‰èŠ‚ç‚¹å·²ç»æ˜¯æ ‘äº†ï¼Œåˆ™å°†é”®å€¼å¯¹æ’å…¥æ ‘ä¸­</span></span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                        value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> ReservationNode)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Recursive update&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//binCount ä¸ä¸º0ï¼Œé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹æ•°é‡ä¸ä¸º 0 ï¼Œå³é”®å€¼å¯¹æ’å…¥äº†</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">//èŠ‚ç‚¹ä¸Šçš„æ•°é‡è¶…è¿‡äº†é˜ˆå€¼ï¼Œè½¬ä¸ºæ ‘</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//å¦‚æœæ—§å€¼ä¸ä¸º nullï¼Œå³æ›¿æ¢äº†æŸä¸ªé”®å€¼å¯¹</span></span><br><span class="line">                    <span class="comment">//åˆ™ return æ—§å€¼ï¼Œç»“æŸæ•´ä¸ª put æµç¨‹</span></span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="comment">//å¦åˆ™ï¼Œå³ oldVal == null çš„æƒ…å†µä¸‹</span></span><br><span class="line">                <span class="comment">//é€€å‡º for (Node&lt;K,V&gt;[] tab = table;;) å¾ªç¯</span></span><br><span class="line">                <span class="comment">//èµ° addCount(1L,binCount) å¤„çš„é€»è¾‘å¹¶è¿”å› null</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¢åŠ è®¡æ•°ï¼Œæ‰©å®¹ç­‰</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="comment">//è¿”å› nullï¼Œä»£è¡¨æ˜¯æ–°å¢çš„é”®å€¼å¯¹ï¼Œå¹¶é key ç›¸åŒæ›¿æ¢æ—§çš„ value</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p><strong>â‘ . åˆå§‹åŒ–æ•°ç»„</strong></p>
<p>é€šè¿‡ spread æ–¹æ³•è®¡ç®— hash å€¼ï¼Œå¹¶å¼€å§‹æ­»å¾ªç¯ï¼Œç›´åˆ°æ’å…¥æˆåŠŸåé€€å‡º</p>
<p>å¦‚æœ table è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™å…ˆé€šè¿‡ initTable() åˆå§‹åŒ–æ•°ç»„ </p>
<p><strong>â‘¡. index å¤„ä¸º null</strong></p>
<p>é€šè¿‡ spread() æ–¹æ³•è®¡ç®—å‡ºå¯¹åº”çš„ç´¢å¼• i ï¼Œå¦‚æœæ•°ç»„ i ç´¢å¼•å¤„çš„å€¼ä¸º null ï¼Œåˆ™é€šè¿‡ cas çš„æ–¹å¼è¿›è¡Œæ’å…¥ï¼Œå¦‚æœ cas å¤±è´¥ï¼Œè¯´æ˜æœ‰åˆ«çš„çº¿ç¨‹åœ¨å¯¹è¯¥å¤„è¿›è¡Œæ“ä½œï¼Œåˆ™è¿›è¡Œä¸‹ä¸€æ¬¡ for å¾ªç¯ï¼Œä¸‹ä¸€æ¬¡ for å¾ªç¯åˆ™ä¼šè¿›å…¥ 3ã€4 æ­¥ä¸­</p>
<p><strong>â‘¢. å¸®åŠ©æ‰©å®¹</strong></p>
<p>å¦‚æœ index å¤„èŠ‚ç‚¹ä¸ä¸º null ä¸” index å¤„çš„èŠ‚ç‚¹ hash å€¼ä¸º MOVED ï¼Œåˆ™è¿›è¡Œ helpTransfer() æ–¹æ³•</p>
<p><strong>â‘£. æ™®é€šæ’å…¥</strong></p>
<p>ä¸Šè¿°å‡ æ­¥éƒ½ä¸æ»¡è¶³ï¼Œåˆ™è¯´æ˜ index ä¸Šæœ‰ä¸ªæ™®é€šçš„èŠ‚ç‚¹ï¼Œæˆ–ä¸ºé“¾è¡¨ï¼Œæˆ–ä¸ºæ ‘ï¼Œè¿›è¡Œæ›´æ–°æˆ–è€…æ’å…¥æ“ä½œ</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¼šå°† f(å³ index å¤„çš„èŠ‚ç‚¹) è¿›è¡ŒåŠ é”ï¼Œå¹¶ä¼šå†æ¬¡æ£€æŸ¥æ­¤æ—¶çš„ table index ç´¢å¼•å¤„çš„èŠ‚ç‚¹æ˜¯å¦è¢«æ”¹å˜äº†ï¼Œå¦‚æœæ”¹å˜äº†ï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå¦‚æœæ²¡æœ‰æ”¹å˜ä¾æ—§ä¸º f ï¼Œåˆ™è¿›è¡Œæ›´æ–°æˆ–è€…æ’å…¥æ“ä½œ</p>
<p>å¦‚æœæ˜¯é“¾è¡¨ï¼Œåˆ™éå†é“¾è¡¨è¦†ç›–æ›´æ–°å€¼æˆ–è€…åœ¨é“¾è¡¨å°¾éƒ¨æ’å…¥æ–°çš„é”®å€¼å¯¹(binCount &#x3D; åŸé“¾è¡¨é•¿åº¦)</p>
<p>å¦‚æœæ˜¯æ ‘ï¼Œåˆ™å°†é”®å€¼å¯¹æ’å…¥æ ‘ä¸­</p>
<p>æ·»åŠ å®Œæˆåï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹ä¸Šçš„é“¾è¡¨é•¿åº¦ï¼Œå¦‚æœè¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è°ƒç”¨ treeifyBin è½¬ä¸ºæ ‘æˆ–è€…æ‰©å®¹æ•°ç»„ï¼Œæœ€åè°ƒç”¨ addCount æ·»åŠ è®¡æ•°ï¼Œè§†æœºæ‰©å®¹æ•°ç»„ç­‰</p>
<h3 id="initTable"><a href="#initTable" class="headerlink" title="initTable()"></a>initTable()</h3><p>ğŸ’¡ åˆå§‹åŒ– table æ•°ç»„</p>
<p>æ¥ç€çœ‹æºç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//table è¿˜æ²¡åˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// sizeCtl å°äº 0 è¯´æ˜æœ‰åˆ«çš„çº¿ç¨‹åœ¨åˆå§‹åŒ–ï¼Œåˆ™è®©å‡º CPU æ—¶é—´ç¢ç‰‡</span></span><br><span class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œé€šè¿‡ cas å°† sc å’Œ -1 è¿›è¡Œ cas æ“ä½œ</span></span><br><span class="line">            <span class="comment">//SIZECTL æ˜¯ sizeCtl ä¼ å…¥çš„å¯¹è±¡ this</span></span><br><span class="line">            <span class="comment">//(å³ sizeCtl åœ¨ ConcurrentHashMap è¿™ä¸ªå¯¹è±¡ä¸­å†…å­˜çš„åç§»é‡)</span></span><br><span class="line">            <span class="comment">// sc ä¸ºæœŸæœ›å€¼ï¼Œæ­¤æ—¶å€¼ä¸º sizeCtl</span></span><br><span class="line">            <span class="comment">// -1 ä¸ºè¦æ›¿æ¢çš„å€¼</span></span><br><span class="line">            <span class="comment">//æ€»ç»“æ¥è¯´å°±æ˜¯å°† sizeCtl å’Œ sc è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰å°±å°† -1 èµ‹å€¼ç»™ sizeCtlï¼Œè¿”å› true</span></span><br><span class="line">            <span class="comment">//å¦åˆ™ä¸èµ‹å€¼è¿”å› false</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ cas æˆåŠŸäº†</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœè®¾ç½®äº†å®¹é‡å¤§å°åˆ™ä½¿ç”¨è®¾ç½®çš„å®¹é‡ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„å®¹é‡</span></span><br><span class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="comment">//new ä¸€ä¸ªæ•°ç»„å¹¶èµ‹å€¼</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">//è®¡ç®—æ‰©å®¹çš„é˜ˆå€¼ n - (n &gt;&gt;&gt; 2) ç­‰åŒäº n * LOAD_FACTOR</span></span><br><span class="line">                    <span class="comment">//åªä¸è¿‡ä½¿ç”¨ä½è¿ç®—æ›´å¿«</span></span><br><span class="line">                    <span class="comment">//å³ n * 0.75 = n * 3/4 = n * (1 - 1/4) = n - n/4</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//å°† sc çš„å€¼èµ‹å€¼ç»™ sizeCtl</span></span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›æ–°çš„ table æ•°ç»„</span></span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapInt</span><span class="params">(Object o, <span class="keyword">long</span> offset,<span class="keyword">int</span> expected,<span class="keyword">int</span> x&#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼Œè¯»å–ä¼ å…¥çš„å¯¹è±¡ o åœ¨å†…å­˜ä¸­åç§» offset çš„å€¼ï¼Œå¹¶å’Œ expected æ¯”è¾ƒ</span></span></span><br><span class="line"><span class="params"><span class="function">å¦‚æœç›¸åŒï¼Œåˆ™å°† x èµ‹å€¼ç»™å†…å­˜ä¸­åç§» offset ä½ç½®çš„å€¼ï¼Œå¹¶è¿”å› <span class="keyword">true</span></span></span></span><br><span class="line"><span class="params"><span class="function">å¦åˆ™ä¸èµ‹å€¼è¿”å› <span class="keyword">false</span></span></span></span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼š</p>
<p>å¦‚æœ sizeCtl  å°äº 0 åˆ™è®©å‡ºï¼Œåˆ™æš‚åœè‡ªå·±çš„çº¿ç¨‹ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹å»æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</p>
<p>å¦‚æœ sizeCtl å¤§äºç­‰äº 0 åˆ™åˆå§‹åŒ–ä¸€ä¸ª sizeCtl å¤§å°çš„æ•°ç»„ï¼Œå¹¶æ›´æ–° sizeCtl ä¸ºè‡ªèº«çš„è´Ÿè½½å› å­å€( * 0.75)</p>
<p>è¿™é‡Œé€šè¿‡ Unsafe.compareAndSwapInt ä¿è¯äº†çº¿ç¨‹å®‰å…¨</p>
<p>å‡å¦‚æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨äº† initTable æ–¹æ³•ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„ <code>U.compareAndSwapInt(this, SIZECTL, sc, -1)</code> ä¼šè¿”å› true èµ°å…¥è¯¥ if ä¸­çš„ä»£ç å»æ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå‡å¦‚æœ‰ç¬¬ä¸‰ä¸ªçº¿ç¨‹æ¥äº†ï¼Œåˆ™ä¼šèµ°å…¥åˆ° Thread.yield() è¿™é‡Œå»è®©å‡ºæ—¶é—´ç¢ç‰‡</p>
<h3 id="helpTransfer"><a href="#helpTransfer" class="headerlink" title="helpTransfer"></a>helpTransfer</h3><p>å¦‚æœåœ¨æŸä¸ªçº¿ç¨‹åœ¨è¿›è¡Œè½¬ç§»èŠ‚ç‚¹æ•°æ®ï¼Œåˆ™è¿›è¡Œåˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶å°±å¸®åŠ©è½¬ç§»ï¼Œå¹¶è¿”å› table æ•°ç»„ï¼Œä»¥ä¾¿åœ¨ä¸‹æ¬¡å¾ªç¯ä¸­è¿›è¡Œæ’å…¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] nextTab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; (f <span class="keyword">instanceof</span> ForwardingNode) &amp;&amp;</span><br><span class="line">        (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœ tab ä¸ä¸ºç©ºï¼Œä¸”å…¶å¤´èŠ‚ç‚¹ä¸º fwd èŠ‚ç‚¹ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹è¿ç§»</span></span><br><span class="line">        <span class="keyword">int</span> rs = resizeStamp(tab.length);</span><br><span class="line">        <span class="keyword">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;</span><br><span class="line">                (sc = sizeCtl) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//æ»¡è¶³ while ä¸­çš„æ¡ä»¶è¿™é‡Œè¯´æ˜æ­£åœ¨æ‰©å®¹</span></span><br><span class="line">            <span class="comment">//åˆ™å¾ªç¯ï¼Œç›´åˆ°æ‰©å®¹ç»“æŸ</span></span><br><span class="line">            <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                sc == rs + MAX_RESIZERS || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">//ä¿®æ”¹ sizeCtl æˆåŠŸï¼Œä¿®æ”¹æ‰©å®¹çš„çº¿ç¨‹æ•° +1ï¼Œå‚ä¸æ‰©å®¹</span></span><br><span class="line">                transfer(tab, nextTab);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‰©å®¹ç»“æŸï¼Œè¿”å›æ–° table</span></span><br><span class="line">        <span class="keyword">return</span> nextTab;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¤´èŠ‚ç‚¹é fwd èŠ‚ç‚¹ï¼Œåˆ™è¿”å›æ—§ table </span></span><br><span class="line">    <span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="resizeStamp-int-n"><a href="#resizeStamp-int-n" class="headerlink" title="resizeStamp(int n)"></a>resizeStamp(int n)</h3><blockquote>
<p>ç”±äºä¼ å…¥çš„å‚æ•° n éƒ½æ˜¯ 2 çš„ n æ¬¡å¹‚ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ç”¨æ¥å°†è¿™ä¸ª n é€šè¿‡ç®—æ³•å°†å…¶è®°å½•åœ¨ä½16ä½ä¸­</p>
</blockquote>
<p><em>TL;DR</em> </p>
<blockquote>
<p><strong>è¿”å›å€¼é«˜16ä½è®°å½•ä¸º 0ï¼Œä½16ä½è®°å½•çš„æ˜¯ã€Œæ‰©å®¹æ ‡è¯†ã€ï¼Œä¸æ•°ç»„é•¿åº¦æœ‰å…³</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">resizeStamp</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.numberOfLeadingZeros(n) | (<span class="number">1</span> &lt;&lt; (RESIZE_STAMP_BITS- <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>Integer.numberOfLeadingZeros(n)</code> è¿”å› n åœ¨äºŒè¿›åˆ¶ä¸­æœ€é«˜ä½çš„1å‰é¢0çš„ä¸ªæ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æ¯”æ–¹è¯´ <span class="number">1</span> çš„äºŒè¿›åˆ¶ä¸º </span><br><span class="line"><span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0001</span></span><br><span class="line">åˆ™ `Integer.numberOfLeadingZeros(<span class="number">1</span>)` = <span class="number">31</span></span><br><span class="line">æ‰€ä»¥ Integer.numberOfLeadingZeros(<span class="keyword">int</span> n) çš„å€¼çš„èŒƒå›´ä¸º <span class="number">0</span>-<span class="number">32</span></span><br></pre></td></tr></table></figure>

<p>æ¥ç€çœ‹ååŠæ®µï¼Œ*<code>RESIZE_STAMP_BITS</code> å€¼ä¸º  16ï¼Œ*æ‰€ä»¥ <code>(1 &lt;&lt; (*RESIZE_STAMP_BITS - 1 )*</code> å³1å·¦ç§»15ä½ï¼Œå¾—åˆ° <code>0000 0000 0000 0000 1000 0000 0000 0000</code></p>
<p>æœ€åè¿›è¡Œ <code>|</code> è¿ç®—*(æœ‰1åˆ™ä¸º1)*</p>
<p>æˆ‘ä»¬ä»¥ resizeStamp(16) ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(åè¿›åˆ¶ <span class="number">16</span>)                            == <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0001</span> <span class="number">0000</span></span><br><span class="line"></span><br><span class="line">Integer.numberOfLeadingZeros(<span class="number">16</span>) = <span class="number">27</span> == <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0001</span> <span class="number">1001</span></span><br><span class="line">              | æˆ–è¿ç®—</span><br><span class="line">(<span class="number">1</span> &lt;&lt; (RESIZE_STAMP_BITS- <span class="number">1</span>)  = <span class="number">1</span>&lt;&lt;<span class="number">15</span> == <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">1000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line">              = ç­‰äº</span><br><span class="line">                                         <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">1000</span> <span class="number">0000</span> <span class="number">0001</span> <span class="number">1001</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯è§ resizeStamp æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª é«˜16ä¸ºéƒ½ä¸º0ï¼Œä½16ä½ä¸ºä¼ å…¥çš„å‚æ•° n çš„ ã€Œæœ€é«˜ä½çš„1å‰é¢0çš„ä¸ªæ•°ã€</p>
<p>å³é«˜16ä½è®°å½•ä¸º 0ï¼Œç¬¬16ä½ä¸º1ï¼Œä½15ä½è®°å½•çš„æ˜¯ã€Œæœ€é«˜ä½çš„1å‰é¢0çš„ä¸ªæ•°ã€ä½16ä½æ„æˆä¸€ä¸ªã€Œæ‰©å®¹æ ‡è¯†ã€</p>
<p>å¯è§è¯¥æ–¹æ³•è¿”å›çš„å€¼çš„å–å€¼èŒƒå›´ä¸º [32769,32799]</p>
<h3 id="treeifyBin-Node-lt-K-V-gt-tab-int-index"><a href="#treeifyBin-Node-lt-K-V-gt-tab-int-index" class="headerlink" title="treeifyBin(Node&lt;K,V&gt;[] tab,int index)"></a>treeifyBin(Node&lt;K,V&gt;[] tab,int index)</h3><p>åœ¨å¾€ ConcurrentHashMap ä¸­æ’å…¥å…ƒç´ åï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œæ‰©å®¹æˆ–è€…å°†é“¾è¡¨è½¬ä¸ºæ ‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; b; <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            <span class="comment">//å¦‚æœ tab çš„é•¿åº¦å°äº MIN_TREEIFY_CAPACITY(64)ï¼Œåˆ™è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">            tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œå¦‚æœ index å¤„çš„èŠ‚ç‚¹ b ä¸ä¸ºç©ºä¸” hash å€¼å¤§äº0</span></span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                <span class="comment">//åŠ é”</span></span><br><span class="line">                <span class="comment">//å†æ¬¡åˆ¤æ–­ï¼Œtab çš„ index å¤„æ˜¯å¦ä¸º b</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    <span class="comment">//è½¬ä¸ºæ ‘ï¼Œç•¥è¿‡ä¸è¡¨</span></span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; p =</span><br><span class="line">                            <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼š</p>
<p>å½“æ’å…¥ä¸€ä¸ªå…ƒç´ åï¼Œå¦‚æœé“¾è¡¨çš„é•¿åº¦è¶…è¿‡<code>TREEIFY_THRESHOLD == 8</code>ï¼Œä½†æ•´ä¸ª table æ•°ç»„é•¿åº¦å°äº  <code>MIN_TREEIFY_CAPACITY</code>&#x3D;&#x3D;64ï¼Œåˆ™è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¦‚æœè¶…è¿‡äº† <code>MIN_TREEIFY_CAPACITY</code> åˆ™å°†é“¾è¡¨è½¬ä¸ºæ ‘</p>
<h3 id="tryPresize-int-size"><a href="#tryPresize-int-size" class="headerlink" title="tryPresize(int size)"></a>tryPresize(int size)</h3><p>ğŸ’¡ å°è¯•é¢„å¤„ç† table æ•°ç»„çš„å®¹é‡ä»¥å®¹çº³ç»™å®šçš„æ•°é‡çš„å…ƒç´ </p>
<p>è¿™ä¸ªæ–¹æ³•åªåœ¨ treeifyBin() ä»¥åŠ putAll() ä¸­è¢«è°ƒç”¨</p>
<p>treeifyBin() æ–¹æ³•ä¼ å…¥çš„ size ä¸º <code>table.length &lt;&lt; 1</code></p>
<p>putAll() ä¼ å…¥çš„ size ä¸º <code>m.size()</code> å³åŸ Map çš„èŠ‚ç‚¹æ•°</p>
<p>ä»¥ table.length &#x3D;&#x3D; 16 ä¸ºä¾‹ï¼Œè°ƒç”¨è¯¥æ–¹æ³•æ—¶å€™ï¼Œsize &#x3D; table.length &lt;&lt; 1 å³ 32ï¼Œè®¡ç®—å‡ºæ¥çš„ c ä¸º 64ï¼Œç›´åˆ° c â‰¤ sc æ—¶æ‰ä¼šé€€å‡ºå¾ªç¯ï¼Œåˆ™ sc è‡³å°‘éœ€è¦ä¸º 128 * 0.75 &#x3D; 96 æ‰ä¼šé€€å‡ºå¾ªç¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°è¯•è°ƒæ•´ table æ•°ç»„çš„å®¹é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size éœ€è¦è°ƒæ•´åˆ°çš„å®¹é‡</span></span><br><span class="line"><span class="comment"> * è¿™ä¸ªæ–¹æ³•åªåœ¨ treeifyBin() ä»¥åŠ putAll() ä¸­è¢«è°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryPresize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ ¹æ® size çš„å€¼è®¡ç®—çº¦æŸå‡ºä¸ºä¸€ä¸ªæ­£ç¡®çš„ 2çš„æ¬¡å¹‚å€¼</span></span><br><span class="line">    <span class="comment">//ä¸º MAXIMUM_CAPACITY æˆ–è€…æ˜¯å¤§äºç­‰äº (size * 1.5 + 1) çš„æœ€å°çš„ 2æ¬¡å¹‚</span></span><br><span class="line">    <span class="keyword">int</span> c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">        tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// sc ä¸º sizeCtl åœ¨æœ¬æ–¹æ³•ä¸­çš„ä¸´æ—¶å˜é‡</span></span><br><span class="line">    <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//-------â‘ --------</span></span><br><span class="line">            <span class="comment">//å¦‚æœ table è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">            <span class="comment">// n ä¸ºæ–°çš„æ•°ç»„å®¹é‡</span></span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            <span class="comment">//åŒç†ï¼Œif ä¸­çš„è¯­å¥ä¼šé€šè¿‡ cas å°† sizeCtl æ›´æ–°ä¸º -1ï¼Œè¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        <span class="comment">//è®¡ç®— scï¼Œå³ n - 0.25 * n = 0.75 * n</span></span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// è®¾ç½®æ–°çš„é˜ˆå€¼</span></span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">            <span class="comment">//-------â‘¡--------</span></span><br><span class="line">            <span class="comment">// c &lt;= sc è¯´æ˜æ•°ç»„çš„å®¹é‡å·²ç»è¶³å¤Ÿäº†</span></span><br><span class="line">            <span class="comment">// n &gt;= MAXIMUM_CAPACITY è¯´æ˜å·²ç»è¶…è¿‡æœ€å¤§å®¹é‡äº†</span></span><br><span class="line">            <span class="comment">//åˆ™é€€å‡ºå¾ªç¯ï¼Œä¸å¤„ç†</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">            <span class="comment">//-------â‘¢--------</span></span><br><span class="line">            <span class="comment">//è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">            <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜â‘ å’Œâ‘¡çš„æƒ…å†µå·²ç»è¢«æ’é™¤æ‰äº†ï¼Œå³å·²ç» table æ•°ç»„å·²ç»åˆå§‹åŒ–è¿‡äº†</span></span><br><span class="line">            <span class="comment">//å¹¶ä¸”c &lt;= scä¸æˆç«‹ï¼Œå³ sc &lt; c ï¼Œè¯´æ˜è¿˜æ²¡æ‰©å®¹å®Œæˆ</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//n ä¸º table çš„å®¹é‡</span></span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//sc &lt; 0 å› ä¸ºæ•°ç»„å·²ç»åˆå§‹åŒ–äº†ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰©å®¹</span></span><br><span class="line">                Node&lt;K,V&gt;[] nt;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//sc å³ç§»16ä½åï¼Œé«˜16ä½ä¸º0ï¼Œä½16ä½ä¸ºæ•°ç»„é•¿åº¦è®¡ç®—å‡ºçš„æ‰©å®¹æ ‡è¯†</span></span><br><span class="line">                <span class="comment">//(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs:æ‰©å®¹æ ‡è¯†ä¸åŒ</span></span><br><span class="line">                <span class="comment">//è¯´æ˜æ•°ç»„é•¿åº¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯èƒ½æ˜¯åˆ«çš„çº¿ç¨‹è§¦å‘äº†ç¬¬äºŒæ¬¡æ‰©å®¹</span></span><br><span class="line">                <span class="comment">//sc == rs + MAX_RESIZERS:å·²ç»è¾¾åˆ°æœ€å¤§çš„æ‰©å®¹çº¿ç¨‹æ•°é‡äº†</span></span><br><span class="line">                <span class="comment">//(nt = nextTable) == null :nextTable è¿˜æ²¡åˆ›å»º</span></span><br><span class="line">                <span class="comment">//transferIndex &lt;= 0 éœ€è¦è¿ç§»çš„åŒºé—´å·²ç»è¢«åˆ«çš„çº¿ç¨‹åˆ†å®Œäº†</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//å®é™…ä¸Šè¿™é‡Œæœ‰ä¸¤ä¸ª bug</span></span><br><span class="line">                <span class="comment">//1. sc == rs + 1</span></span><br><span class="line">                <span class="comment">//sc ç°åœ¨æ˜¯ä¸ªè´Ÿæ•°ï¼Œrs é«˜16ä½éƒ½ä¸º 0ï¼Œæ— è®ºå¦‚ä½• rs + 1 éƒ½ä¸ä¼šç­‰äº sc</span></span><br><span class="line">                <span class="comment">//fix:</span></span><br><span class="line">                <span class="comment">//sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 1</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//2. sc == rs + MAX_RESIZERS</span></span><br><span class="line">                <span class="comment">//MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1 = (1 &lt;&lt; 16) -1 = 65535</span></span><br><span class="line">                <span class="comment">//rs çš„å–å€¼èŒƒå›´ä¸º [32769,32799] è€Œ rs + MAX_RESIZERS &gt; 0 å¹¶ä¸”è¿˜æ²¡æº¢å‡ºä¸ºè´Ÿæ•°</span></span><br><span class="line">                <span class="comment">//ä¹Ÿæ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰</span></span><br><span class="line">                <span class="comment">//fix:</span></span><br><span class="line">                <span class="comment">//sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + MAX_RESIZERS</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//å°† rs å·¦ç§» 16ä½ï¼Œå…¶é«˜16ä½æ‰æ˜¯æ‰©å®¹æ ‡è¯†ï¼Œä½16ä¸ºå­˜å‚¨æ‰©å®¹çš„çº¿ç¨‹æ•° + 1</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//ä¸‹é¢è¿™é‡Œå¯¹ sizeCtl åŠ ä¸€ï¼Œè¡¨ç¤ºå‚ä¸è¿ç§»çš„çº¿ç¨‹æ•° +1ï¼Œå¹¶è¿›è¡Œè¿ç§»</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¯´æ˜è‡ªå·±æ˜¯ç¬¬ä¸€ä¸ªè¿›è¡Œæ‰©å®¹çš„çº¿ç¨‹ï¼Œåˆ™é€šè¿‡ cas çš„æ–¹å¼ï¼Œå°† rs å·¦ç§» 16ä½å¹¶åŠ 2ï¼Œå­˜å‚¨åœ¨ sizeCtl ä¸­</span></span><br><span class="line">            <span class="comment">//é€šè¿‡å‰é¢çš„ resizeStamp æ–¹æ³•æˆ‘ä»¬ç›´åˆ° rs çš„é«˜16ä½ä¸º0ï¼Œè¿™é‡Œå·¦ç§»16ä½ï¼Œåˆ™ä½16ä½éƒ½ä¸º0ï¼Œå†åŠ 2</span></span><br><span class="line">            <span class="comment">//åˆ™ç”¨ä½16ä¸ºè¡¨ç¤ºæ­£åœ¨æ‰©å®¹çš„çº¿ç¨‹æ•°ï¼Œå¹¶ä¸”ç”¨ 2 è¡¨ç¤ºç¬¬ä¸€ä¸ªæ­£åœ¨æ‰©å®¹çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                            (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="transfer"><a href="#transfer" class="headerlink" title="transfer()"></a>transfer()</h3><p>transfer(Node&lt;K,V&gt; tab, Node&lt;K,V&gt;[] nextTab)<br>ğŸ’¡ å°†æ—§æ•°ç»„çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œæ”¯æŒå¤šçº¿ç¨‹è¿ç§»</p>
<h4 id="å­—æ®µè¯´æ˜"><a href="#å­—æ®µè¯´æ˜" class="headerlink" title="å­—æ®µè¯´æ˜"></a><strong>å­—æ®µè¯´æ˜</strong></h4><p><code>transferIndex</code> æ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œé€šè¿‡ volatile ä¿®é¥°ï¼Œå¹¶é€šè¿‡ cas çš„æ–¹å¼è¿›è¡Œä¿®æ”¹ï¼Œç”¨æ¥è¡¨ç¤ºå½“å‰çº¿ç¨‹åº”è¯¥ä»å“ªä¸ªåœ°æ–¹å¼€å§‹å¾€å‰éå†ï¼Œå¦‚æœ transferIndex &lt;&#x3D; 0 è¯´æ˜å¯¹æ•°ç»„çš„è½¬ç§»å·²ç»åˆ°å¤´äº†ï¼Œä¸éœ€è¦å†ç»§ç»­å¤„ç†äº†</p>
<p><code>i</code> å­—æ®µè¡¨ç¤ºå½“å‰çº¿ç¨‹åœ¨è¿ç§»çš„æ¡¶çš„ç´¢å¼•</p>
<p><code>bound</code> å­—æ®µè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„éœ€è¦è¿ç§»çš„åŒºé—´çš„ä¸Šè¾¹ç•Œ</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><strong>æ€»ç»“</strong></h4><p>å³æ¯ä¸ªçº¿ç¨‹çš„è¿ç§»åŒºé—´ä¸º [bound,transferIndex)ï¼Œå¹¶é€šè¿‡ i åœ¨è¯¥åŒºé—´ä»åå¾€å‰éå†æ¡¶è¿›è¡Œè¿ç§»å¤„ç†ï¼Œéå†åŒºé—´å®Œæˆåï¼Œä¼šç»§ç»­ç«äº‰ä¸‹ä¸€ä¸ªåŒºé—´</p>
<p>ä¸ºäº†é«˜æ•ˆçš„è¿›è¡Œè¿ç§»æ•°æ®ï¼Œè¿™é‡Œå…è®¸å¤šä¸ªçº¿ç¨‹è¿›å…¥ï¼Œä½†æ˜¯ç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…äº†æ—§æ•°ç»„çš„ä¸€æ®µåŒºé—´è¿›è¡Œè¿ç§»ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿ç§»åŒä¸ªåŒºé—´ï¼Œä»£ç ä¸­é€šè¿‡ cas çš„æ–¹å¼ï¼Œ</p>
<p>è®©å¤šä¸ªçº¿ç¨‹é€šè¿‡ cas çš„æ“ä½œç«äº‰ transferIndex å­—æ®µï¼Œå¹¶é€šè¿‡ transferIndex å­—æ®µå’Œ stride è®¡ç®—å‡ºæ¯ä¸ªçº¿ç¨‹çš„è¿ç§»åŒºé—´ï¼Œæ‰€ä»¥çº¿ç¨‹åœ¨å¤„ç†å®Œç«äº‰åˆ°çš„æŸä¸ªåŒºé—´åï¼Œä¼šä¸åœåœ°å¾€å‰ç«äº‰å¤„ç†ä¸‹ä¸€ä¸ªåŒºé—´ï¼Œç›´åˆ°å¤„ç†åˆ°æ•°ç»„æœ€å‰é¢çš„åŒºé—´ï¼Œæ¯”å¦‚è¯´[0,16) çš„åŒºé—´åï¼ŒtransferIndex ç­‰äº 0ï¼Œæ‰€ä»¥ i &#x3D; -1ï¼Œ</p>
<p>å°±ä¼šå°† sizeCtl ä¸­ä½16ä½ä¸­å­˜å‚¨çš„çº¿ç¨‹æ•°å‡1å returnï¼Œé€€å‡ºè¿ç§»ï¼Œç­‰åˆ°æ‰€æœ‰çš„çº¿ç¨‹å¯¹æ‰€æœ‰çš„åŒºé—´å¤„ç†å®Œæ¯•åï¼Œå…¶ä»–çº¿ç¨‹éƒ½é€€å‡ºè¿ç§»æ“ä½œäº†ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹ä¼šå°† finish è®¾ç½®ä¸º trueï¼Œ</p>
<p>å†è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯åä¼šå°†æ–°çš„ nextTab èµ‹å€¼ç»™ table å¹¶å°† nextTable ç½®ä¸ºç©º</p>
<p>ä» HashMap çš„è¿ç§»ç®—æ³•ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´åˆ°ï¼Œå¯¹äºä¸€ä¸ªèŠ‚ç‚¹ï¼Œåœ¨æ‰©å®¹è¿ç§»åï¼Œè¦ä¹ˆè¿˜åœ¨åŸæ¥çš„æ¡¶(å‡è®¾ç´¢å¼•ä¸º index)ä¸­ï¼Œè¦ä¹ˆå°±åœ¨ç´¢å¼•ä¸º 2 * index çš„æ¡¶å¤„</p>
<p>åŒç†åœ¨ ConcurrentHashMap ä¸­ä¹Ÿæ˜¯è¿™æ ·å­ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è½¬ç§»åˆ°åŒä¸€ä¸ªæ¡¶ä¸­</p>
<p>é¦–å…ˆä¼šè®¡ç®—æ¯ä¸ªçº¿ç¨‹éœ€è¦è¿›è¡Œè¿ç§»çš„æ­¥é•¿ strideï¼Œå³è¿ç§»çš„æ¡¶çš„æ•°é‡ï¼Œè‡³å°‘ä¸º 16</p>
<p>åœ¨è¿›è¡Œè¿ç§»æ—¶ï¼Œä¼šä»åå¾€å‰å¯¹ table æ•°ç»„è¿›è¡Œéå†ï¼Œé€æ­¥å¯¹æ¡¶å†…çš„æ•°æ®(é“¾è¡¨æˆ–è€…æ ‘)è¿›è¡Œè¿ç§»</p>
<p>ç”±äºç¯‡å¹…å¤ªé•¿ï¼Œæˆ‘ä»¬å‡è®¾æ­¥é•¿ stride ä¸º4ï¼Œä¸¾ä¾‹è¿›è¡Œè¯´æ˜</p>
<p><img src="https://s2.loli.net/2021/12/23/7uBlQZRbcPYH3Fm.png" alt="transfer_concurrenthashmap.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè½¬ç§»æ•°æ®æ—¶ï¼ŒnextTab == nullï¼Œå¦åˆ™ä¸ºå…¨å±€å˜é‡ nextTable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">    <span class="comment">//è®¡ç®—æ­¥é•¿ strideï¼Œè‡³å°‘ä¸º 16</span></span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">        <span class="comment">//nextTab ä¸º null è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè½¬ç§»</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸ºæ—§æ•°ç»„å®¹é‡ä¸¤å€çš„æ–°æ•°ç»„ï¼Œå¹¶èµ‹å€¼ç»™ nextTab</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            <span class="comment">//å¦‚æœäº§ç”Ÿ OOM ç­‰å¼‚å¸¸ï¼Œåˆ™ç›´æ¥é€€å‡ºï¼Œä¸è½¬ç§»äº†</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å°†æ–°æ•°ç»„èµ‹å€¼ç»™ nextTable ï¼Œæ­¤æ—¶æ•°ç»„ä¸ºä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„ç©ºæ•°ç»„</span></span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        <span class="comment">//transferIndex è®°å½•æ—§æ•°ç»„çš„é•¿åº¦ï¼Œè¡¨ç¤ºè½¬ç§»å¼€å§‹çš„ç´¢å¼•å€¼</span></span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//nextn ä¸ºæ–°æ•°ç»„çš„å®¹é‡</span></span><br><span class="line">    <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">    <span class="comment">//fwd æ˜¯ç”¨æ¥æ ‡è¯†æŸä¸ªæ¡¶å¤„æ­£åœ¨è½¬ç§»çš„ï¼Œå­˜å‚¨äº†æ–°æ•°ç»„</span></span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="comment">//advance æ˜¯å¦å‰è¿›ï¼Œç”¨æ¥æ ‡è®°æ˜¯å¦éœ€è¦åœ¨åŒºé—´å†…ç»§ç»­å¾€å‰å‰è¿›å¤„ç†</span></span><br><span class="line">    <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//finishing æ˜¯å¦æ‰«æç»“æŸäº†ï¼Œç”¨æ¥æ ‡è®°æ˜¯å¦å°†æ‰€æœ‰çš„åŒºé—´éƒ½è¿ç§»å®Œæˆäº†</span></span><br><span class="line">    <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œå°† i å’Œ bound åˆå§‹åŒ–ä¸º 0ï¼Œå¹¶å¼€å§‹æ­»å¾ªç¯ï¼Œç›´åˆ°æ•°æ®è½¬ç§»æˆåŠŸåå†é€€å‡ºå¾ªç¯</span></span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡æ‰§è¡Œåˆ°è¿™é‡Œæ—¶</span></span><br><span class="line">        <span class="comment">//--i == -1ï¼Œ bound == 0ï¼Œç¬¬ä¸€ä¸ªåˆ¤æ–­ä¸º false</span></span><br><span class="line">        <span class="comment">//æ³¨æ„è¿™é‡Œæ¯æ¬¡è¿›å…¥ while å¾ªç¯éƒ½ä¼šåšä¸€æ¬¡ --i çš„æ“ä½œï¼Œä½¿å¾— i ä¸æ–­çš„è‡ªå‡</span></span><br><span class="line">        <span class="comment">//nextIndex = transferIndex == n == tab.length å³æ—§æ•°ç»„çš„é•¿åº¦ï¼Œå¤§äº0ï¼Œç¬¬äºŒä¸ªåˆ¤æ–­ä¸º false</span></span><br><span class="line">        <span class="comment">//åˆ™èµ°åˆ°ç¬¬ä¸‰ä¸ªåˆ¤æ–­ä¸­</span></span><br><span class="line">        <span class="comment">//nextBound ä¸ºä¸‹ä¸€ä¸ªçº¿ç¨‹éœ€è¦è¿›è¡Œè½¬ç§»çš„æ•°ç»„çš„ä¸‹è¾¹ç•Œ</span></span><br><span class="line">        <span class="comment">//è®¡ç®— nextBound çš„å€¼ï¼Œå¦‚æœ nextIndex(å³å°±æ•°ç»„çš„é•¿åº¦)å¤§äºæ­¥é•¿ strideï¼Œ</span></span><br><span class="line">        <span class="comment">//åˆ™ nextBound = nextIndex - strideï¼Œå¹¶é€šè¿‡ cas çš„æ–¹å¼èµ‹å€¼</span></span><br><span class="line">        <span class="comment">//ç»™å…¨å±€å˜é‡ transferIndexï¼Œå³ä¸‹ä¸ªçº¿ç¨‹éœ€è¦è½¬ç§»çš„åŒºé—´çš„ä¸‹è¾¹ç•Œ</span></span><br><span class="line">        <span class="comment">//ä¸‹é¢çš„ä»£ç ä¸»è¦å°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œè®¡ç®—å‡ºæ¥ [bound,transferIndex) è¿™ä¸ªåŒºé—´</span></span><br><span class="line">        <span class="comment">//åœ¨ä¸‹ä¸€æ¬¡ for å¾ªç¯åˆ™ä¼šèµ°åˆ°ç¬¬ä¸€ä¸ªåˆ¤æ–­ä¸­ï¼Œç›´åˆ° i &lt; bound æˆ–è€… finishing</span></span><br><span class="line">        <span class="comment">//å½“ i &lt; bound æ—¶ï¼Œå³å½“å‰çº¿ç¨‹å·²ç»æŠŠåˆ†é…ç»™è‡ªå·±çš„åŒºé—´é‡Œçš„æ¡¶éƒ½è½¬ç§»å®Œæ¯•äº†</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ­¤æ—¶åˆ«çš„çº¿ç¨‹è¿˜æ²¡æœ‰å°†æ•´ä¸ªæ•°ç»„è½¬ç§»å®Œæ¯•(transferIndex &lt;= 0 ä¸æˆç«‹)ï¼Œ</span></span><br><span class="line">        <span class="comment">//åˆ™å½“å‰çº¿ç¨‹ä¼šç»§ç»­å¾€å‰ç«äº‰ä¸‹ä¸€ä¸ªåŒºé—´ï¼Œè¿™ä¹Ÿå°±æ˜¯å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è¯ï¼Œä¹Ÿå¯ä»¥è¿ç§»å®Œæˆ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                <span class="comment">//æŸä¸ªçº¿ç¨‹çš„ç¬¬äºŒæ¬¡å¾ªç¯æ—¶å€™æ‰ä¼šèµ°åˆ°è¿™é‡Œæ¥ï¼Œè¯´æ˜ i è¿˜åœ¨è¯¥çº¿ç¨‹éœ€è¦è½¬ç§»çš„åŒºé—´å†…</span></span><br><span class="line">                <span class="comment">//[bound &lt;--&gt; i &lt;--&gt; transferIndex)</span></span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//transferIndex &lt;= 0 è¯´æ˜å°†å·²ç»åˆ°æœ€å‰é¢äº†ï¼Œå°† i èµ‹å€¼ä¸º -1</span></span><br><span class="line">                <span class="comment">//åˆ™ä¼šèµ°åˆ° â‘¢ å¤„æ‰§è¡Œï¼Œç®€å•æ¥è¯´ â‘¢ å¤„ä¼šåšä¸€äº›åˆ¤æ–­æ˜¯å¦è¯¥çº¿ç¨‹è¦é€€å‡ºè¿ç§»æ“ä½œ</span></span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                        (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                        nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                    nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ i &lt; bound ä¸” transferIndex &gt; 0 (å³æ•´ä¸ª table çš„è½¬ç§»è¿˜æ²¡å¤„ç†å®Œæˆ)</span></span><br><span class="line">                <span class="comment">//é€šè¿‡ cas ç»§ç»­è®¤é¢†ä¸€æ®µåŒºé—´è¿›è¡Œè½¬ç§»</span></span><br><span class="line">                <span class="comment">//è®¡ç®—å‡ºå½“å‰çº¿ç¨‹æ‰€éœ€è¦å¤„ç†çš„åŒºé—´</span></span><br><span class="line">                <span class="comment">//nextBound å°±æ˜¯ä¸‹ä¸€ä¸ªçº¿ç¨‹çš„ä¸‹è¾¹ç•Œï¼Œä¹Ÿå°±æ˜¯å½“å…ˆçº¿ç¨‹çš„ä¸Šè¾¹ç•Œ</span></span><br><span class="line">                bound = nextBound;</span><br><span class="line">                <span class="comment">//i ä¸ºç´¢å¼•å€¼ï¼Œæ‰€ä»¥éœ€è¦ - 1</span></span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="comment">//-----â‘¢----</span></span><br><span class="line">            <span class="comment">//å¦‚æœ i &lt; 0 æˆ–è€… i &gt;= n è¯´æ˜å·²ç»è¶…å‡ºäº†æ‰€éœ€è¦å¤„ç†çš„åŒºé—´äº†</span></span><br><span class="line">            <span class="keyword">int</span> sc;</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                <span class="comment">//------â‘ -----</span></span><br><span class="line">                <span class="comment">//å¦‚æœ finishing ä¸º true ï¼Œè¯´æ˜æ‰€æœ‰çš„æ¡¶éƒ½å¤„ç†å®Œäº†</span></span><br><span class="line">                <span class="comment">//åˆ™å°†æ–°çš„æ•°ç»„èµ‹å€¼ç»™ table å¹¶å°† nextTable ç½®ä¸ºç©º</span></span><br><span class="line">                nextTable = <span class="keyword">null</span>;</span><br><span class="line">                table = nextTab;</span><br><span class="line">                <span class="comment">//å¹¶ä¸”è®¾ç½®æ–°çš„é˜ˆå€¼ï¼Œæ–°æ•°ç»„çš„é•¿åº¦ä¸º 2nï¼Œæ‰€ä»¥é˜ˆå€¼åº”è¯¥ä¸º 0.75 * 2nï¼Œå³ 2n - 0.5n</span></span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                <span class="comment">//è¿”å›ï¼Œç»“æŸè¿ç§»</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ finishing ä¸º falseï¼Œå³è¿˜æœªå¤„ç†å®Œæ‰€æœ‰çš„æ¡¶</span></span><br><span class="line">            <span class="comment">//ä½†å½“å‰çº¿ç¨‹éœ€è¦å¤„ç†çš„åŒºé—´å†…çš„æ¡¶å·²ç»å¤„ç†å®Œäº†ï¼Œæ‰€ä»¥å°† sizeCtl å‡ä¸€è¡¨ç¤ºæ­£åœ¨è¿ç§»çš„çº¿ç¨‹æ•° -1</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="comment">//if ä¸­ä¸º true è¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯æœ€åä¸€ä¸ªåœ¨è¿›è¡Œè¿ç§»çš„çº¿ç¨‹ï¼Œè¿”å›ï¼Œç»“æŸæœ¬çº¿ç¨‹çš„è¿ç§»</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªå‚ä¸è¿ç§»çš„çº¿ç¨‹</span></span><br><span class="line">                <span class="comment">//å°† finishing å’Œ advance å‡è®¾ä¸º true</span></span><br><span class="line">                <span class="comment">//å¹¶æŠŠ i è®¾ç½®ä¸º n(å³æ—§æ•°ç»„ table çš„é•¿åº¦)</span></span><br><span class="line">                <span class="comment">//è¿™æ ·ä¸‹ä¸€æ¬¡å¾ªç¯å°±ä¼šèµ°å…¥ â‘  å¤„çš„é€»è¾‘ç»“æŸè¿ç§»</span></span><br><span class="line">                finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                i = n; <span class="comment">// recheck before commit</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//å¦‚æœç´¢å¼•ä¸º i çš„æ¡¶å¤„ä¸º nullï¼Œåˆ™é€šè¿‡ cas æ–¹å¼å°† fwd æ”¾åœ¨è¯¥æ¡¶å¤„</span></span><br><span class="line">            <span class="comment">//æ¥ç€å°† advance è®¾ç½®ä¸º trueï¼Œé€€å‡ºå¾ªç¯ç»§ç»­å¾€å‰</span></span><br><span class="line">            advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">//å¦‚æœç´¢å¼•ä¸º i å¤„çš„æ¡¶ä¸Šçš„æ•°æ®ä¸ä¸ºç©ºï¼Œä¸”å…¶ hash å€¼ä¸º MOVED</span></span><br><span class="line">            <span class="comment">//ä»£è¡¨è¯¥å¤„çš„æ•°æ®å·²ç»è¿ç§»è¿‡äº†ï¼Œå°† advance è®¾ç½®ä¸º trueï¼Œé€€å‡ºå¾ªç¯ç»§ç»­å¾€å‰</span></span><br><span class="line">            advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œç´¢å¼•ä¸º i å¤„çš„æ¡¶ä¸Šæœ‰æ•°æ®ï¼Œåˆ™å¯¹æ¡¶å¤„çš„å¤´èŠ‚ç‚¹åŠ é”</span></span><br><span class="line">            <span class="comment">//è¿›è¡Œè¿ç§»ï¼Œè¿ç§»å®Œæˆåä¼šå°† advance è®¾ç½®ä¸º true</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">//äºŒæ¬¡ç¡®è®¤ç´¢å¼•ä¸º i å¤„çš„æ¡¶çš„èŠ‚ç‚¹ä¸º f</span></span><br><span class="line">                    <span class="comment">//è¿›è¡Œæ•°æ®è¿ç§»ï¼Œè§åæ–‡ç»†è¯´</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é“¾è¡¨-x2F-æ ‘çš„è½¬ç§»"><a href="#é“¾è¡¨-x2F-æ ‘çš„è½¬ç§»" class="headerlink" title="é“¾è¡¨&#x2F;æ ‘çš„è½¬ç§»"></a>é“¾è¡¨&#x2F;æ ‘çš„è½¬ç§»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœå¤´èŠ‚ç‚¹ f çš„ hash å€¼å¤§äº0ï¼Œè¯´æ˜ä¸ºé“¾è¡¨</span></span><br><span class="line">        <span class="comment">//è®¡ç®—å‡º fh å’Œ n çš„ä¸è¿ç®—çš„ç»“æœï¼Œç”±äº n ä¸ºæ•°ç»„çš„é•¿åº¦ï¼Œæ˜¯2çš„æ¬¡å¹‚ï¼Œæ‰€ä»¥åªæœ‰æœ€é«˜ä½ä¸º1ï¼Œå…¶ä»–éƒ½ä¸º0</span></span><br><span class="line">        <span class="comment">//ä¸è¿ç®—è®¡ç®—å‡ºæ¥å runBit è¦ä¹ˆä¸º 0 ï¼Œè¦ä¹ˆä¸º n</span></span><br><span class="line">        <span class="comment">//å¦‚æœ runBid == 0 è¯´æ˜æ‰©å®¹å f ä¾æ—§åœ¨åŸæ¥çš„ index å¤„ï¼Œå¦åˆ™åœ¨ index + n å¤„</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">            <span class="comment">//éå†é“¾è¡¨ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåé¢å…¨éƒ¨ä¸ºç›¸åŒçš„ runBit çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">//ä¸¾ä¸ªä¾‹å­</span></span><br><span class="line">            <span class="comment">//é“¾è¡¨     ï¼š A-&gt;B-&gt;C-&gt;D-&gt;E-&gt;F-&gt;G</span></span><br><span class="line">            <span class="comment">//runBit å€¼ï¼š n-&gt;0-&gt;n-&gt;0-&gt;0-&gt;0-&gt;0</span></span><br><span class="line">            <span class="comment">//åˆ™è¿™ä¸ª for å¾ªç¯è·‘å®Œä»¥åï¼ŒlastRun åˆ™ä¸ºDï¼ŒrunBit = 0</span></span><br><span class="line">            <span class="comment">//åç»­åˆ™å¯ä»¥å°†è¿™ä¸ª D åé¢çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸€èµ·æŒªåŠ¨è¿‡å»ï¼Œå°±ä¸éœ€è¦å†ä¸€ä¸ªä¸€ä¸ªå¤„ç†</span></span><br><span class="line">            <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                runBit = b;</span><br><span class="line">                lastRun = p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ runBit == 0 è¯´æ˜è¿™äº›èŠ‚ç‚¹è¿˜è¦æ”¾åœ¨ç›¸åŒ index çš„æ¡¶é‡Œï¼Œèµ‹å€¼ç»™ ln</span></span><br><span class="line">            ln = lastRun;</span><br><span class="line">            hn = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ runBit == n è¯´æ˜è¿™äº›èŠ‚ç‚¹è¿˜è¦æ”¾åœ¨ç›¸åŒ index + n çš„æ¡¶é‡Œï¼Œèµ‹å€¼ç»™ hn</span></span><br><span class="line">            hn = lastRun;</span><br><span class="line">            ln = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">            <span class="comment">//å¾ªç¯ï¼Œæ„å»ºä¸¤ä¸ªé“¾è¡¨ï¼Œå°†èŠ‚ç‚¹æ’å…¥å¯¹åº”çš„é“¾è¡¨çš„å°¾éƒ¨</span></span><br><span class="line">            <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å°† ln æ’å…¥æ–°çš„ table çš„ i å¤„</span></span><br><span class="line">        setTabAt(nextTab, i, ln);</span><br><span class="line">        <span class="comment">//å°† ln æ’å…¥æ–°çš„ table çš„ i + n å¤„</span></span><br><span class="line">        setTabAt(nextTab, i + n, hn);</span><br><span class="line">        <span class="comment">//å°†æ—§çš„ table i å¤„ç½®ä¸º fwd</span></span><br><span class="line">        setTabAt(tab, i, fwd);</span><br><span class="line">        <span class="comment">//æ›´æ–° advance ä¸º trueï¼Œå‡†å¤‡ä¸‹æ¬¡ for å¾ªç¯</span></span><br><span class="line">        advance = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">        <span class="comment">//åŒç†å¯¹ TreeBin è¿›è¡Œè¿ç§»</span></span><br><span class="line">        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">        TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">        TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            <span class="keyword">int</span> h = e.hash;</span><br><span class="line">            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                    lo = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    loTail.next = p;</span><br><span class="line">                loTail = p;</span><br><span class="line">                ++lc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                    hi = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    hiTail.next = p;</span><br><span class="line">                hiTail = p;</span><br><span class="line">                ++hc;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">        setTabAt(nextTab, i, ln);</span><br><span class="line">        setTabAt(nextTab, i + n, hn);</span><br><span class="line">        setTabAt(tab, i, fwd);</span><br><span class="line">        advance = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="å…ƒç´ æ•°é‡è®¡æ•°"><a href="#å…ƒç´ æ•°é‡è®¡æ•°" class="headerlink" title="å…ƒç´ æ•°é‡è®¡æ•°"></a>å…ƒç´ æ•°é‡è®¡æ•°</h2><h3 id="size"><a href="#size" class="headerlink" title="size()"></a>size()</h3><blockquote>
<p>è·å– map ä¸­é”®å€¼å¯¹çš„æ•°é‡</p>
</blockquote>
<p>è¿”å› <code>sumCount</code> æ–¹æ³•çš„å€¼ï¼Œå¦‚æœå°äº0ï¼Œåˆ™è¿”å›0ï¼Œå¦‚æœè¶…è¿‡äº† Integer.MAX_VALUEï¼Œåˆ™è¿”å› Integer.MAX_VALUE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">long</span> n = sumCount();</span><br><span class="line">      <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">              (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">              (<span class="keyword">int</span>)n);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="sumCount"><a href="#sumCount" class="headerlink" title="sumCount()"></a>sumCount()</h3><p>è¿”å› <code>baseCount</code> å’Œ <code>counterCells åˆ—è¡¨ä¸­å€¼çš„æ€»å’Œ</code> çš„å’Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">    <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£è¿™ä¸ª baseCount å’Œ counterCells æ˜¯ä»€ä¹ˆå‘¢ï¼Œæˆ‘ä»¬åœ¨å‰é¢ putVal çš„æµç¨‹ä¸­è¿˜æ²¡æœ‰ä»‹ç» addCount(1L,binCount) è¿™ä¸ªæ–¹æ³•ã€‚é€šè¿‡åå­—æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºæ¥è¿™æ˜¯ä¸ªç”¨æ¥å¢åŠ è®¡æ•°çš„æ–¹æ³•</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªæ–¹æ³•</p>
<h3 id="addCount-long-x-int-check"><a href="#addCount-long-x-int-check" class="headerlink" title="addCount(long x,int check)"></a>addCount(long x,int check)</h3><p><code>x</code> è¡¨ç¤ºæ–°å¢çš„èŠ‚ç‚¹æ•°</p>
<p><code>check</code> è¡¨ç¤ºæ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹æ£€æŸ¥ï¼Œå¦‚æœ &lt; 0 åˆ™ä¸è¿›è¡Œæ‰©å®¹</p>
<p>ä»å‰é¢ putVal ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå½“ä¸€ä¸ªé”®å€¼å¯¹èŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨ä¸­æ—¶ï¼Œ check çš„å€¼ä¸ºé“¾è¡¨çš„é•¿åº¦ï¼Œå½“æ’å…¥åˆ°çº¢é»‘æ ‘ä¸­æ—¶ï¼Œcheck ä¸º 2</p>
<p>è¿™ä¸ªæ–¹æ³•åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå‰ä¸€éƒ¨åˆ†æ˜¯é€šè¿‡ LongAdder çš„æ–¹å¼ï¼Œè¿›è¡Œè®¡æ•°ï¼ŒååŠéƒ¨åˆ†ä¸­ä¼šè¿›è¡Œæ‰©å®¹è¿ç§»æ“ä½œåï¼Œå†è¿›è¡Œè®¡æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">    CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">    <span class="comment">//ç¬¬ä¸€ä¸ªåˆ¤æ–­ï¼š(as = counterCells) != null</span></span><br><span class="line">    <span class="comment">//è¡¨ç¤º counterCells å·²ç»è¢«åˆå§‹åŒ–äº†</span></span><br><span class="line">    <span class="comment">//ç¬¬äºŒä¸ªåˆ¤æ–­ï¼šå°† baseCount é€šè¿‡ cas çš„æ–¹å¼ä¿®æ”¹ä¸º baseCount + x</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¿®æ”¹æˆåŠŸè¯´æ˜æ²¡æœ‰ç«äº‰</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¿®æ”¹å¤±è´¥ï¼Œè¯´æ˜å­˜åœ¨ç«äº‰ï¼Œåˆ™è¿›å…¥ä¸‹é¢çš„é€»è¾‘å¯¹ counterCells è¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">        !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">        CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//å‰ä¸¤ä¸ªåˆ¤æ–­ as == null || (m = as.length - 1) &lt; 0 </span></span><br><span class="line">        <span class="comment">//åˆ¤æ–­ counterCells æ˜¯å¦åˆå§‹åŒ–äº†ï¼Œå¹¶ä¸”æ•°ç»„ä¸­æ˜¯å¦æœ‰å†…å®¹</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ºè¿˜æœªåˆå§‹åŒ–æˆ–è€…æ•°ç»„ä¸­æ²¡æœ‰å†…å®¹ï¼Œåˆ™è°ƒç”¨ fullAddCount(x, true)</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªåˆ¤æ–­æ˜¯åœ¨å‰ä¸¤ä¸ªåˆ¤æ–­éƒ½ä¸º false çš„åŸºç¡€ä¸Š</span></span><br><span class="line">        <span class="comment">//è¿›ä¸€æ­¥è·å– counterCells ä¸­å½“å‰çº¿ç¨‹æ‰€å¯¹åº”çš„ CounterCell å…ƒç´ </span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ºç©ºï¼Œåˆ™è°ƒç”¨ fullAddCount(x, true)</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™å°è¯•å¯¹ CounterCell é€šè¿‡ cas è¿›è¡Œç´¯åŠ ï¼Œç´¯åŠ æˆåŠŸåˆ™è¿›è¡Œä¸‹ä¸€æ­¥</span></span><br><span class="line">        <span class="comment">//ç´¯åŠ ä¸æˆåŠŸè¯´æ˜å­˜åœ¨ç«äº‰ï¼Œåˆ™è°ƒç”¨ fullAddCount(x, false)</span></span><br><span class="line">        <span class="comment">//uncontended ä»£è¡¨æ˜¯å¦æ— ç«äº‰</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            !(uncontended =</span><br><span class="line">              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">            <span class="comment">//è¯¦è§åé¢çš„å°èŠ‚</span></span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å½“ check &gt;= 0ï¼Œåˆ™å°è¯•æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">        <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">//å½“ä¸‹é¢çš„ä¸‰ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ—¶ï¼Œæ‰ä¼šè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">            <span class="comment">//1. å½“ s (èŠ‚ç‚¹æ•°é‡) &gt;= é˜ˆå€¼ sizeCtl äº†</span></span><br><span class="line">            <span class="comment">//2. table ä¸ä¸º null</span></span><br><span class="line">            <span class="comment">//3. table çš„é•¿åº¦å°äºæœ€å¤§å®¹é‡</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//rs çš„é«˜16ä½ä¸º0ï¼Œä½16ä¸ºå­˜å‚¨æ•°ç»„é•¿åº¦ n è®¡ç®—å‡ºæ¥çš„å€¼</span></span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;(</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//sc å³ç§»16ä½åï¼Œé«˜16ä½ä¸º0ï¼Œä½16ä½ä¸ºæ•°ç»„é•¿åº¦è®¡ç®—å‡ºçš„æ‰©å®¹æ ‡è¯†</span></span><br><span class="line">                <span class="comment">//(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs:æ‰©å®¹æ ‡è¯†ä¸åŒï¼Œ</span></span><br><span class="line">                <span class="comment">//  è¯´æ˜æ•°ç»„é•¿åº¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯èƒ½æ˜¯åˆ«çš„çº¿ç¨‹è§¦å‘äº†ç¬¬äºŒæ¬¡æ‰©å®¹</span></span><br><span class="line">                <span class="comment">//sc == rs + MAX_RESIZERS:å·²ç»è¾¾åˆ°æœ€å¤§çš„æ‰©å®¹çº¿ç¨‹æ•°é‡äº†</span></span><br><span class="line">                <span class="comment">//(nt = nextTable) == null :nextTable è¿˜æ²¡åˆ›å»º</span></span><br><span class="line">                <span class="comment">//transferIndex &lt;= 0 éœ€è¦è¿ç§»çš„åŒºé—´å·²ç»è¢«åˆ«çš„çº¿ç¨‹åˆ†å®Œäº†</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//å®é™…ä¸Šè¿™é‡Œæœ‰ä¸¤ä¸ª bug</span></span><br><span class="line">                <span class="comment">//1. sc == rs + 1</span></span><br><span class="line">                <span class="comment">//sc ç°åœ¨æ˜¯ä¸ªè´Ÿæ•°ï¼Œrs é«˜16ä½éƒ½ä¸º 0ï¼Œæ— è®ºå¦‚ä½• rs + 1 éƒ½ä¸ä¼šç­‰äº sc</span></span><br><span class="line">                <span class="comment">//fix:</span></span><br><span class="line">                <span class="comment">//sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 1</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//2. sc == rs + MAX_RESIZERS</span></span><br><span class="line">                <span class="comment">//MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1 = (1 &lt;&lt; 16) -1 = 65535</span></span><br><span class="line">                <span class="comment">//rs çš„å–å€¼èŒƒå›´ä¸º [32769,32799] è€Œ rs + MAX_RESIZERS &gt; 0 ä¸”è¿˜æ²¡æº¢å‡ºä¸ºè´Ÿæ•°</span></span><br><span class="line">                <span class="comment">//ä¹Ÿæ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰</span></span><br><span class="line">                <span class="comment">//fix:</span></span><br><span class="line">                <span class="comment">//sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + MAX_RESIZERS</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//å°† rs å·¦ç§» 16ä½ï¼Œå…¶é«˜16ä½æ‰æ˜¯æ‰©å®¹æ ‡è¯†ï¼Œä½16ä¸ºå­˜å‚¨æ‰©å®¹çš„çº¿ç¨‹æ•° + 1</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//ä¸éœ€è¦æ‰©å®¹</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    <span class="comment">//æ­¤æ—¶æœ‰åˆ«çš„çº¿ç¨‹åœ¨æ‰©å®¹äº†ï¼Œåˆ™å¸®åŠ©è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                <span class="comment">//è¿›è¡Œæ‰©å®¹ï¼Œè¿™é‡Œæ˜¯ç¬¬ä¸€ä¸ªè¿›è¡Œæ‰©å®¹çš„çº¿ç¨‹</span></span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//è¿›è¡Œè®¡æ•°</span></span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fullAddCount"><a href="#fullAddCount" class="headerlink" title="fullAddCount"></a>fullAddCount</h3><p>private final void fullAddCount(long x, boolean wasUncontended)</p>
<p><code>x</code>è¡¨ç¤ºæ–°å¢çš„èŠ‚ç‚¹æ•°é‡</p>
<p><code>wasUncontented</code> è¡¨ç¤ºæ˜¯å¦æ— ç«äº‰</p>
<pre><code>true == è¡¨ç¤ºæ²¡æœ‰ç«äº‰
false == è¡¨ç¤ºæœ‰ç«äº‰
</code></pre>
<p>åœ¨ ConcurrentHashMap ä¸­ï¼Œå…¶å®æ˜¯å¤åˆ¶äº†ä¸€ä»½ LongAdder çš„æºç ï¼Œåœ¨ ConcurrentHashMap ä¸­ï¼Œç”±äºå¹¶å‘æƒ…å†µå¤šï¼Œå¦‚æœä½¿ç”¨ AtomicLong çš„æ–¹å¼è¿›è¡Œè®°å½•ï¼Œå¦‚æœ N ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ AtomicLong è¿›è¡Œä¿®æ”¹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä¿®æ”¹æˆåŠŸï¼Œå…¶ä»–çº¿ç¨‹åˆ™ä¼šå¤„äºè‡ªæ—‹ç­‰å¾…çŠ¶æ€ï¼Œè€Œ LongAdder çš„æ–¹å¼æ˜¯ä½¿ç”¨ä¸€ä¸ªå˜é‡ baseCount+æ•°ç»„ CounterCell[]ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å»ç»´æŠ¤è‡ªå·±çš„ä¸€ä¸ªå˜é‡ï¼Œå‡å°‘ç¢°æ’å†²çªï¼Œæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤æ•°ç»„ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸­å­˜å‚¨ä¸€ä¸ªå€¼ï¼›ä» CounterCell[] ä¸­è·å–åˆ°å¯¹åº”çš„å€¼å¹¶è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœä¿®æ”¹å¤±è´¥ï¼Œåˆ™å°è¯•ä¿®æ”¹ baseCount çš„å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">fullAddCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">if</span> ((h = ThreadLocalRandom.getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">        ThreadLocalRandom.localInit();      <span class="comment">// force initialization</span></span><br><span class="line">        h = ThreadLocalRandom.getProbe();</span><br><span class="line">        <span class="comment">//è¿˜æ²¡åˆå§‹åŒ–ï¼Œæ‰€ä»¥ä¸å­˜åœ¨ç«äº‰ï¼Œå°† wasUncontended è®¾ç½®ä¸º true</span></span><br><span class="line">        wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//collide è¡¨ç¤ºæ˜¯å¦å¤šä¸ªçº¿ç¨‹ hash åˆ°åŒä¸€ä¸ª CounterCell äº§ç”Ÿç¢°æ’äº†</span></span><br><span class="line">    <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        CounterCell[] as; CounterCell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ counterCells ä¸ä¸º null ä¸” counterCells é•¿åº¦å¤§äº 0</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//å–åˆ° counterCells ä¸­å¯¹åº”çº¿ç¨‹çš„ CounterCell ä¸ºç©º</span></span><br><span class="line">                <span class="comment">//cellsBusy å­—æ®µä¸º 1 è¯´æ˜ counterCells æ­£åœ¨åˆå§‹åŒ–æˆ–è€…æ‰©å®¹</span></span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;            <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                    <span class="comment">//ä¸‹é¢ä¸ºå°è¯•åˆ›å»ºä¸€ä¸ª CounterCell å¯¹è±¡å¹¶å­˜åˆ° counterCells æ•°ç»„å¯¹åº”çš„ç´¢å¼•å¤„</span></span><br><span class="line">                    CounterCell r = <span class="keyword">new</span> CounterCell(x); <span class="comment">// Optimistic create</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                        <span class="comment">//counterCells ä¸ºæ­£å¸¸çŠ¶æ€ä¸”ä¿®æ”¹ cellsBusy ä¸º1 æˆåŠŸ</span></span><br><span class="line">                        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            CounterCell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = counterCells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">//j æ˜¯å½“å‰çº¿ç¨‹çš„ hash å€¼è®¡ç®—å¾—å‡ºçš„ç´¢å¼•</span></span><br><span class="line">                                <span class="comment">//å¯¹ counterCells ä¸­ j å¤„çš„å…ƒç´ è¿›è¡Œæ›¿æ¢</span></span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created)</span><br><span class="line">                            <span class="comment">//åˆ›å»ºæˆåŠŸï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//åˆ›å»ºä¸æˆåŠŸï¼Œåˆ™è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                        <span class="comment">//å¯èƒ½æ˜¯å› ä¸º rs[j] != nullï¼Œå³è¯¥å¤„æœ‰å€¼äº†</span></span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       </span><br><span class="line">                <span class="comment">// cas å¤±è´¥äº†ï¼Œåˆ™è®¾ç½®ä¸º trueï¼Œåœ¨ä¸‹æ¬¡å¾ªç¯çš„æ—¶å€™é‡æ–°è®¡ç®— hash å†è¿›è¡Œåˆ†é…</span></span><br><span class="line">                wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))</span><br><span class="line">                <span class="comment">//ä¿®æ”¹å½“å‰ CounterCell ä¸­çš„ value æˆåŠŸï¼Œåˆ™é€€å‡º</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (counterCells != as || n &gt;= NCPU)</span><br><span class="line">                <span class="comment">//counterCells != as è¯´æ˜ counterCells è¢«æ‰©å®¹äº†</span></span><br><span class="line">                <span class="comment">//æˆ–è€… as å¤§äºç­‰äº CPU çš„æ•°é‡äº†ï¼Œç­‰å¾…ä¸‹ä¸€è½®é‡è¯•</span></span><br><span class="line">                collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                <span class="comment">//ä¸Šè¿°æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œè¯´æ˜äº§ç”Ÿäº†ç¢°æ’ï¼Œä¸”ç«äº‰å¤±è´¥äº†</span></span><br><span class="line">                <span class="comment">//å°†å€¼ collide ä¿®æ”¹ä¸º trueï¼Œä¸‹ä¸€æ¬¡å¾ªç¯å°±å¯ä»¥èµ°åˆ°ä¸‹ä¸ª if ä¸­</span></span><br><span class="line">                collide = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">//counterCells å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œä¸”ä¿®æ”¹ cellsBusy å€¼ä¸º1æˆåŠŸ</span></span><br><span class="line">                <span class="comment">//åˆ™å¯¹ counterCells è¿›è¡Œæ‰©å®¹å¹¶è¿ç§»æ•°æ®ï¼Œ</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (counterCells == as) &#123;<span class="comment">// Expand table unless stale</span></span><br><span class="line">                        CounterCell[] rs = <span class="keyword">new</span> CounterCell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        counterCells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é‡æ–°è®¡ç®— hash å€¼</span></span><br><span class="line">            h = ThreadLocalRandom.advanceProbe(h);</span><br><span class="line">        &#125;<span class="comment">//è¿™é‡Œæ˜¯ (as = counterCells) != null &amp;&amp; (n = as.length) &gt; 0 è¿™ä¸ªæ¡ä»¶ç»“æŸçš„åœ°æ–¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; counterCells == as &amp;&amp;</span><br><span class="line">                    U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ counterCells ä¸ºç©ºï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–ï¼Œå®¹é‡ä¸º2ï¼Œå¹¶å°† CounterCell æ”¾è¿›æ•°ç»„ä¸­</span></span><br><span class="line">            <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;                           <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (counterCells == as) &#123;</span><br><span class="line">                    CounterCell[] rs = <span class="keyword">new</span> CounterCell[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> CounterCell(x);</span><br><span class="line">                    counterCells = rs;</span><br><span class="line">                    init = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ counterCells ä¸ºç©ºï¼Œä¸”ç«äº‰åˆå§‹åŒ–å¤±è´¥äº†ï¼Œåˆ™å°è¯•å°† x åŠ åˆ° baseCount ä¸Š</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, v = baseCount, v + x))</span><br><span class="line">            <span class="keyword">break</span>;<span class="comment">// Fall back on using base</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±çœ‹å®Œäº† ConcurrentHashMap ä¸­çš„ put çš„æ–¹æ³•</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039055166">é€šä¿—æ˜“æ‡‚çš„JUCæºç å‰–æ-LongAdder&#x2F;LongAccumulator</a></li>
<li><a target="_blank" rel="noopener" href="https://xilidou.com/2018/11/27/LongAdder/">ä» LongAdder ä¸­çª¥è§å¹¶å‘ç»„ä»¶çš„è®¾è®¡æ€è·¯
</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/9x1V8DG3fv-4bgXYs5b6Hw">ç²¾å¦™ç»ä¼¦çš„å¹¶å‘è‰ºæœ¯å“ â€” ConcurrentHashMapæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zerotomax/p/8687425.html">ConcurrentHashMapæºç åˆ†æ(1.8)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.meetkiki.com/archives/%E4%BB%8E%E6%AD%BB%E5%BE%AA%E7%8E%AFBUG%E6%9D%A5%E8%81%8A%E8%81%8AConcurrentHashMap%E7%9A%84%E6%89%A7%E8%A1%8C%E5%86%85%E5%B9%95(%E4%B8%8A)">ä»æ­»å¾ªç¯BUGæ¥èŠèŠConcurrentHashMapçš„æ‰§è¡Œå†…å¹•ï¼ˆä¸Šï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hegongshan.com/2020/03/06/java-collections-api-concurrenthashmap/">Javaå®¹å™¨æ¢ç§˜ä¹‹æ—… ConcurrentHashMap</a></li>
<li><a target="_blank" rel="noopener" href="http://ljh.gold/java-10/">ConcurrentHashMap</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>ConcurrentHashMap æºç é˜…è¯»ç¬”è®°</p><p><a href="https://ppting.me/2021/12/23/2021_12_23_concurrenthashmap/">https://ppting.me/2021/12/23/2021_12_23_concurrenthashmap/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>ä½œè€…</h6><p>PPTing</p></div></div><div class="level-item is-narrow"><div><h6>å‘å¸ƒäº</h6><p>2021-12-23</p></div></div><div class="level-item is-narrow"><div><h6>æ›´æ–°äº</h6><p>2022-02-12</p></div></div><div class="level-item is-narrow"><div><h6>è®¸å¯åè®®</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Map/">Map</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/02/17/2022_02_17_Java_Interrupt/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Java çº¿ç¨‹çš„ä¸­æ–­æœºåˆ¶</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/11/24/2021_11_24_rxjava/"><span class="level-item">RxJava2 åŸç†è§£æ</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">è¯„è®º</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "f31447d117616c0f61c9bfc5d0753d49",
            repo: "ppting.github.io",
            owner: "PPTing",
            clientID: "8ee6c32324c60fd9fe83",
            clientSecret: "caabfe4dc60fd4b19575bcb4b754d5068a0f7a41",
            admin: ["PPTing"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://www.gravatar.com/avatar/f10df62c29905b9b4ba7aaa81b28f152?s=128" alt="PPTing"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">PPTing</p><p class="is-size-6 is-block">Android Developer | Former Frisbee Player</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Guangzhou,China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">æ–‡ç« </p><a href="/archives"><p class="title">49</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">åˆ†ç±»</p><a href="/categories"><p class="title">14</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">æ ‡ç­¾</p><a href="/tags"><p class="title">26</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/PPTing" target="_blank" rel="noopener">å…³æ³¨æˆ‘</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:zhengkejian0@gmail.com"><i class="fas fa-inbox"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/PPTing"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">ç›®å½•</h3><ul class="menu-list"><li><a class="level is-mobile" href="#åŸºç¡€çŸ¥è¯†"><span class="level-left"><span class="level-item">åŸºç¡€çŸ¥è¯†</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å¸¸é‡"><span class="level-left"><span class="level-item">å¸¸é‡</span></span></a></li><li><a class="level is-mobile" href="#sizeCtl"><span class="level-left"><span class="level-item">sizeCtl</span></span></a></li><li><a class="level is-mobile" href="#Node-lt-K-V-gt"><span class="level-left"><span class="level-item">Node&lt;K,V&gt;</span></span></a></li><li><a class="level is-mobile" href="#æ„é€ æ–¹æ³•"><span class="level-left"><span class="level-item">æ„é€ æ–¹æ³•</span></span></a></li><li><a class="level is-mobile" href="#tableSizeFor-int-size"><span class="level-left"><span class="level-item">tableSizeFor(int size)</span></span></a></li></ul></li><li><a class="level is-mobile" href="#æ·»åŠ å…ƒç´ "><span class="level-left"><span class="level-item">æ·»åŠ å…ƒç´ </span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#put-æ–¹æ³•"><span class="level-left"><span class="level-item">put æ–¹æ³•</span></span></a></li><li><a class="level is-mobile" href="#initTable"><span class="level-left"><span class="level-item">initTable()</span></span></a></li><li><a class="level is-mobile" href="#helpTransfer"><span class="level-left"><span class="level-item">helpTransfer</span></span></a></li><li><a class="level is-mobile" href="#resizeStamp-int-n"><span class="level-left"><span class="level-item">resizeStamp(int n)</span></span></a></li><li><a class="level is-mobile" href="#treeifyBin-Node-lt-K-V-gt-tab-int-index"><span class="level-left"><span class="level-item">treeifyBin(Node&lt;K,V&gt;[] tab,int index)</span></span></a></li><li><a class="level is-mobile" href="#tryPresize-int-size"><span class="level-left"><span class="level-item">tryPresize(int size)</span></span></a></li><li><a class="level is-mobile" href="#transfer"><span class="level-left"><span class="level-item">transfer()</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#å­—æ®µè¯´æ˜"><span class="level-left"><span class="level-item">å­—æ®µè¯´æ˜</span></span></a></li><li><a class="level is-mobile" href="#æ€»ç»“"><span class="level-left"><span class="level-item">æ€»ç»“</span></span></a></li></ul></li><li><a class="level is-mobile" href="#é“¾è¡¨-x2F-æ ‘çš„è½¬ç§»"><span class="level-left"><span class="level-item">é“¾è¡¨/æ ‘çš„è½¬ç§»</span></span></a></li></ul></li><li><a class="level is-mobile" href="#å…ƒç´ æ•°é‡è®¡æ•°"><span class="level-left"><span class="level-item">å…ƒç´ æ•°é‡è®¡æ•°</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#size"><span class="level-left"><span class="level-item">size()</span></span></a></li><li><a class="level is-mobile" href="#sumCount"><span class="level-left"><span class="level-item">sumCount()</span></span></a></li><li><a class="level is-mobile" href="#addCount-long-x-int-check"><span class="level-left"><span class="level-item">addCount(long x,int check)</span></span></a></li><li><a class="level is-mobile" href="#fullAddCount"><span class="level-left"><span class="level-item">fullAddCount</span></span></a></li></ul></li><li><a class="level is-mobile" href="#å°ç»“"><span class="level-left"><span class="level-item">å°ç»“</span></span></a></li><li><a class="level is-mobile" href="#å‚è€ƒé“¾æ¥"><span class="level-left"><span class="level-item">å‚è€ƒé“¾æ¥</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/favicon.ico" alt="PPTing&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 PPTing</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/PPTing"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "æ­¤ç½‘ç«™ä½¿ç”¨Cookieæ¥æ”¹å–„æ‚¨çš„ä½“éªŒã€‚",
          dismiss: "çŸ¥é“äº†ï¼",
          allow: "å…è®¸ä½¿ç”¨Cookie",
          deny: "æ‹’ç»",
          link: "äº†è§£æ›´å¤š",
          policy: "Cookieæ”¿ç­–",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ...","untitled":"(æ— æ ‡é¢˜)","posts":"æ–‡ç« ","pages":"é¡µé¢","categories":"åˆ†ç±»","tags":"æ ‡ç­¾"});
        });</script></body></html>