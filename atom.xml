<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>PPTing&#39;s Blog</title>
  
  <subtitle>ç¾å¥½çš„äº‹ç‰©æ€»æ˜¯ç¨çºµå³é€ï¼Œä¸è®°å¾€æ˜”ï¼Œçæƒœå½“ä¸‹</subtitle>
  <link href="https://ppting.me/atom.xml" rel="self"/>
  
  <link href="https://ppting.me/"/>
  <updated>2022-02-17T14:56:54.198Z</updated>
  <id>https://ppting.me/</id>
  
  <author>
    <name>PPTing</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Java çº¿ç¨‹çš„ä¸­æ–­æœºåˆ¶</title>
    <link href="https://ppting.me/2022/02/17/2022_02_17_Java_Interrupt/"/>
    <id>https://ppting.me/2022/02/17/2022_02_17_Java_Interrupt/</id>
    <published>2022-02-17T14:52:12.000Z</published>
    <updated>2022-02-17T14:56:54.198Z</updated>
    
    <content type="html"><![CDATA[<br><p>ç®€å•å›é¡¾ä¸€ä¸‹ Java çš„ä¸­æ–­æœºåˆ¶</p><p>Java ä¸­çš„çº¿ç¨‹ Thread æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•</p><span id="more"></span><p><strong>public void interrupt()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> != Thread.currentThread())</span><br><span class="line">        checkAccess();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (blockerLock) &#123;</span><br><span class="line">        Interruptible b = blocker;</span><br><span class="line">        <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">            interrupt0();           <span class="comment">// Just to set the interrupt flag</span></span><br><span class="line">            b.interrupt(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt0();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>public static boolean interrupted()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">interrupted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    returncurrentThread().isInterrupted(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>isInterrupted()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInterrupted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> isInterrupted(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>interrupt()</td><td>ä¸­æ–­çº¿ç¨‹ <br> å½“çº¿ç¨‹å¤„äº Runnable çŠ¶æ€æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¸­æ–­è¯¥çº¿ç¨‹ï¼Œä¼šä½¿å¾— isInterrupted() æ–¹æ³•è¿”å› true <br> å½“çº¿ç¨‹å¤„äº Block æˆ–è€… Wait é˜»å¡çŠ¶æ€æ—¶ï¼Œå¦‚æœæ˜¯é€šè¿‡ thread.wait(),thread.join(),Thread.sleep() æ–¹æ³•å¤„äºé˜»å¡çŠ¶æ€æ—¶ï¼Œåˆ™ä¼šæŠ›å‡º InterruptedException,å¦‚æœæ˜¯é€šè¿‡ LockSupport.park() æ–¹æ³•ä½¿çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œåˆ™ä¸ä¼šæŠ›å‡º InterruptedException</td></tr><tr><td>interrupted()</td><td>é™æ€æ–¹æ³•ï¼Œä½œç”¨äºè°ƒç”¨è¯¥æ–¹æ³•çš„å½“å‰çº¿ç¨‹ï¼Œè¿™ä¸ªæ–¹æ³•çš„å‘½åç”¨çš„æ˜¯ä¸€èˆ¬è¿‡å»æ—¶ï¼Œæ‰€ä»¥è¿”å›çš„å€¼ä»£è¡¨çš„æ˜¯ã€Œçº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­è¿‡ã€å¹¶ä¸”ä¼šæ¸…é™¤æ‰è¯¥çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€</td></tr><tr><td>isInterrupted()</td><td>å…¬å¼€æ–¹æ³•ï¼Œä½œç”¨äºè°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹å¯¹è±¡ï¼Œè¿”å›å€¼ä»£è¡¨çš„æ˜¯ã€Œè°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­è¿‡ã€ï¼Œä½†ä¸ä¼šæ¸…é™¤è¯¥çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;p&gt;ç®€å•å›é¡¾ä¸€ä¸‹ Java çš„ä¸­æ–­æœºåˆ¶&lt;/p&gt;
&lt;p&gt;Java ä¸­çš„çº¿ç¨‹ Thread æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Java" scheme="https://ppting.me/categories/Java/"/>
    
    <category term="æºç " scheme="https://ppting.me/categories/%E6%BA%90%E7%A0%81/"/>
    
    
    <category term="Thread" scheme="https://ppting.me/tags/Thread/"/>
    
    <category term="å¹¶å‘" scheme="https://ppting.me/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>ConcurrentHashMap æºç é˜…è¯»ç¬”è®°</title>
    <link href="https://ppting.me/2021/12/23/2021_12_23_concurrenthashmap/"/>
    <id>https://ppting.me/2021/12/23/2021_12_23_concurrenthashmap/</id>
    <published>2021-12-22T16:00:00.000Z</published>
    <updated>2022-02-12T08:17:24.000Z</updated>
    
    <content type="html"><![CDATA[<br><blockquote><p>æœ¬æ–‡åŸºäº JDK 1.8 åˆ†æ</p></blockquote><p>HashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œåœ¨å¤šçº¿ç¨‹å¹¶å‘ put å¯¼è‡´ resizeï¼Œåœ¨ transfer è¿‡ç¨‹ä¸­å¯èƒ½å¯¼è‡´æ­»é”æˆ–è€…æ•°æ®ä¸¢å¤±</p><p>è€Œ ConcurrentHashMap åˆ™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Map ç±»ï¼Œåœ¨ HashMap çš„åŸºç¡€ä¸Šåšäº†çº¿ç¨‹å®‰å…¨çš„å¤„ç†</p><span id="more"></span><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>å…ˆå¤§æ¦‚å¯¹ ConcurrentHashMap çš„æ•°æ®ç»“æ„æ¨¡å‹æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£</p><p>è·Ÿ HashMap ä¸€æ ·ï¼Œç”±ä¸€ä¸ªæ•°ç»„å’Œå¤šä¸ªé“¾è¡¨&#x2F;çº¢é»‘æ ‘ç»„æˆ</p><p><img src="https://s2.loli.net/2021/12/23/vQgJ7Bea1GO5mu2.png" alt="concurrenthashmap.png"></p><h3 id="å¸¸é‡"><a href="#å¸¸é‡" class="headerlink" title="å¸¸é‡"></a>å¸¸é‡</h3><p><em><code>MAXIMUM_CAPACITY</code> &#x3D; 1 &lt;&lt; 30</em></p><p>æœ€å¤§çš„å®¹é‡ï¼Œå› ä¸º 32 ä½çš„ hash å€¼çš„å‰ä¸¤ä½ä¸ºæ§åˆ¶ä½ï¼Œæ‰€ä»¥æœ€å¤§åªåˆ° 1&lt;&lt;30</p><p><em><code>DEFAULT_CAPACITY</code></em>  &#x3D; 16</p><p>é»˜è®¤åˆå§‹å®¹é‡ï¼Œå¿…é¡»ä¸º2çš„æ¬¡å¹‚ï¼Œæœ€ä½ä½ 1ï¼Œæœ€å¤§ä¸º <em><code>MAXIMUM_CAPACITY</code></em></p><p><em><code>DEFAULT_CONCURRENCY_LEVEL</code> &#x3D; 16</em></p><p>é»˜è®¤çš„å¹¶å‘çº§åˆ«</p><p><em><code>LOAD_FACTOR</code> &#x3D; 0.75</em> </p><p>è´Ÿè½½å› å­</p><p><em><code>TREEIFY_THRESHOLD</code> &#x3D; 8</em></p><p><em><code>MIN_TREEIFY_CAPACITY</code> &#x3D; 64</em></p><p>å½“æ’å…¥æ—¶ï¼Œé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹æ•°é‡è¶…è¿‡ <code>TREEIFY_THRESHOLD</code> ï¼Œä¸” table çš„é•¿åº¦ä¹Ÿè¶…è¿‡äº† <code>MIN_TREEIFY_CAPACITY</code>ï¼Œåˆ™ä¼šå°†é“¾è¡¨è½¬ä¸ºæ ‘</p><p>å¦åˆ™è¿›è¡Œæ‰©å®¹æ“ä½œ</p><h3 id="sizeCtl"><a href="#sizeCtl" class="headerlink" title="sizeCtl"></a>sizeCtl</h3><p>sizeCtl å­—æ®µæ˜¯ç”¨æ¥è¡¨ç¤º table çš„åˆå§‹åŒ–çŠ¶æ€æˆ–è€…ç”¨æ¥æ§åˆ¶ table æ•°ç»„çš„å®¹é‡</p><p>å¦‚æœ sizeCtl ä¸ºè´Ÿæ•°ï¼Œåˆ™è¡¨ç¤º table æ­£åœ¨åˆå§‹åŒ–æˆ–è€…åœ¨è°ƒæ•´å®¹é‡</p><p>å¦‚æœ sizeCtl ä¸ä¸ºè´Ÿæ•°ï¼Œå¦‚æœ table ä¸º nullï¼Œåˆ™ä¿å­˜åˆå§‹åŒ– ConcurrentHashMap æ—¶çš„å®¹é‡ï¼Œä¸º0æˆ–è€…é»˜è®¤å€¼</p><p>åˆå§‹åŒ–ä»¥åï¼Œåˆ™ä¿å­˜çš„æ˜¯è¦è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼</p><p><strong>sizeCtl &#x3D; -1</strong> è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–</p><p><strong>sizeCtl &lt; 0 &amp;&amp; sizeCtl! &#x3D; -1</strong> è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­ï¼Œä¸” sizeCtl çš„ä½16ä½çš„å€¼è¡¨ç¤ºæ­£åœ¨æ‰©å®¹çš„çº¿ç¨‹æ•° + 1ï¼Œé«˜16ä½ä¸ºæ‰©å®¹æ ‡è¯†ï¼Œæ˜¯ç”±æ•°ç»„é•¿åº¦è®¡ç®—å¾—åˆ°çš„å€¼</p><p><strong>sizeCtl â‰¥ 0 &amp;&amp; table &#x3D;&#x3D; null</strong> è¡¨ç¤ºåˆå§‹åŒ–æ—¶è®¡ç®—å‡ºçš„é»˜è®¤å®¹é‡</p><p>s<strong>izeCtl â‰¥ 0 &amp;&amp; table !&#x3D; null</strong> è¡¨ç¤ºéœ€è¦æ‰©å®¹çš„é˜ˆå€¼</p><h3 id="Node-lt-K-V-gt"><a href="#Node-lt-K-V-gt" class="headerlink" title="Node&lt;K,V&gt;"></a>Node&lt;K,V&gt;</h3><p><code>Node&lt;K,V&gt;</code> æ˜¯ ConcurrentHashMap çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå®ç°äº† <code>Map.Entry&lt;K,V&gt;</code> æ¥å£ï¼Œç”¨æ¥ä¿å­˜é”®å€¼å¯¹ä¿¡æ¯ï¼Œæ³¨æ„è¿™é‡Œçš„ <code>val</code> å’Œ <code>next</code> å­—æ®µéƒ½æ˜¯ç”¨äº† <code>volatile</code> ä¿®é¥°ï¼Œä»¥ä¿è¯å…¶çº¿ç¨‹é—´çš„å¯è§æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">      <span class="keyword">final</span> K key;</span><br><span class="line">      <span class="keyword">volatile</span> V val;</span><br><span class="line">      <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><p> ConcurrentHashMap æœ‰å¤šä¸ªæ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">        initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">    <span class="keyword">long</span> size = (<span class="keyword">long</span>)(<span class="number">1.0</span> + (<span class="keyword">long</span>)initialCapacity / loadFactor);</span><br><span class="line">    <span class="keyword">int</span> cap = (size &gt;= (<span class="keyword">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="keyword">int</span>)size);</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>initialCapacity:</strong> ä¼ å…¥çš„åˆå§‹å®¹é‡</p><p><strong>loadFactor</strong>: è´Ÿè½½å› å­</p><p>åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå®é™…ä¸Šï¼Œæ˜¯æƒ³é€šè¿‡ä¼ å…¥çš„ <em>initialCapacity</em> å‚æ•°ï¼Œå¹¶æ ¹æ® loadFactor è®¡ç®—å‡ºæ•°ç»„çš„åˆå§‹åŒ–å®¹é‡ capï¼Œå¹¶ä¸”æ•°ç»„çš„é˜ˆå€¼è¦å¤§äº <em>initialCapacity ï¼Œ</em>åœ¨ <code>initTable()</code> æ–¹æ³•ä¸­ä¼šä½¿ç”¨è¿™ä¸ª sizeCtl å€¼åˆå§‹åŒ– table æ•°ç»„çš„å®¹é‡</p><p><em><strong>Butï¼Œä½†æ˜¯</strong></em></p><p>è¿™é‡Œçš„ <code>public ConcurrentHashMap(int initialCapacity)</code> å®é™…ä¸Šæ˜¯æœ‰ bug çš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå’Œä¸‹é¢ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•è®¡ç®—å‡ºæ¥çš„ cap å€¼å¹¶ä¸ä¸€è‡´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ConcurrentHashMap(<span class="number">22</span>)</span><br><span class="line"><span class="keyword">new</span> ConcurrentHashMap(<span class="number">22</span>,<span class="number">0.75</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸€ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ä¸­ï¼Œè®¡ç®—å‡ºæ¥çš„ cap å€¼ä¸º 64ï¼Œè€Œä¸‰å‚æ•°çš„æ„é€ æ–¹æ³•è®¡ç®—æ‰€å¾—åˆ°çš„ cap ä¸º 32</p><p>è¿™ä¸ªé—®é¢˜ç›´åˆ° JDK 12 æ‰è¢«ä¿®å¤</p><p><a href="https://bugs.openjdk.java.net/browse/JDK-8202422">value of â€˜sizeCtlâ€™ in ConcurrentHashMap varies with the constructor called</a></p><h3 id="tableSizeFor-int-size"><a href="#tableSizeFor-int-size" class="headerlink" title="tableSizeFor(int size)"></a>tableSizeFor(int size)</h3><p><code>tableSizeFor(int size)</code> ä¼šè¿”å›å¤§äºç­‰äº size çš„æœ€å°çš„ 2^n çš„</p><p>ä¾‹å¦‚ï¼štableSizeFor(22) &#x3D; 32 ; tableSizeFor(3) &#x3D; 4</p><p>å…·ä½“ <code>tableSizeFor(size)</code> çš„æ–¹æ³•å¯ä»¥å‚è€ƒ</p><p><a href="https://segmentfault.com/a/1190000039392972">HashMapä¹‹tableSizeForæ–¹æ³•å›¾è§£</a></p><h2 id="æ·»åŠ å…ƒç´ "><a href="#æ·»åŠ å…ƒç´ " class="headerlink" title="æ·»åŠ å…ƒç´ "></a>æ·»åŠ å…ƒç´ </h2><h3 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put æ–¹æ³•"></a>put æ–¹æ³•</h3><p>final V putVal(K key , V value , boolean onlyIfAbsent) </p><aside>ğŸ’¡ æ·»åŠ é”®å€¼å¯¹ï¼Œä¼šè¿›è¡Œåˆå§‹åŒ– table æ•°ç»„ã€æ‰©å®¹ã€é“¾è¡¨è½¬æ ‘ç­‰æ“ä½œ</aside><p>å…ˆçœ‹æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœ key å’Œ value éƒ½ä¸º null åˆ™æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">//è®¡ç®— key çš„ hash å€¼</span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="comment">//è®°å½•é“¾è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ï¼Œç”¨æ¥æ§åˆ¶æ‰©å®¹æˆ–è€…ç”±é“¾è¡¨è½¬å˜ä¸ºæ ‘</span></span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        <span class="comment">//æ­»å¾ªç¯ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶åå†é€€å‡º</span></span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//-------------â‘ --------------------</span></span><br><span class="line">            <span class="comment">//å¦‚æœ tab ä¸ºç©ºæˆ–è€… tab çš„é•¿åº¦ä¸º 0ï¼Œåˆ™åˆå§‹åŒ– table</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//-------------â‘¡--------------------</span></span><br><span class="line">            <span class="comment">//å¦‚æœ hash å¯¹åº”çš„ç´¢å¼•å¤„ i çš„æ¡¶ä¸ºç©ºï¼Œåˆ™å°è¯• cas æ’å…¥</span></span><br><span class="line">            <span class="comment">//è¿™é‡Œ i è¢«èµ‹å€¼ä¸ºç´¢å¼•</span></span><br><span class="line">            <span class="comment">//f è¢«èµ‹å€¼ä¸ºç´¢å¼•å¤„çš„ node å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,<span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="comment">//æ’å…¥æ•°æ®æˆåŠŸï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">//-------------â‘¢--------------------</span></span><br><span class="line">            <span class="comment">// i å¤„çš„ Node ä¸ä¸º null ä¸”å…¶ hash ä¸º MOVEDï¼Œå³æ­£åœ¨æ‰©å®¹ä¸­</span></span><br><span class="line">            <span class="comment">// è¿™é‡Œå°† fh èµ‹å€¼ä¸º Node f çš„ hash å€¼</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//-------------â‘£--------------------</span></span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œå³ i å¤„å·²ç»æœ‰ Node f å­˜åœ¨ï¼Œå¹¶ä¸”ä¸å¤„äºæ‰©å®¹ä¸­ï¼Œé‚£å°±åº”è¯¥æ’å…¥åˆ°é“¾è¡¨ä¸­</span></span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//å¤š f åŠ é”ï¼Œå¤šçº¿ç¨‹è®¿é—®</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">//è¿™é‡Œå†æ¬¡ç¡®è®¤ i å¤„ Node å¯¹è±¡æ˜¯å¦ä¸º f</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœ f çš„ hash å¤§äºç­‰äº 0 </span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            <span class="comment">//å¼€å§‹éå†é“¾è¡¨ï¼Œ</span></span><br><span class="line">                            <span class="comment">//è¿‡ç¨‹ä¸­å¦‚æœæ‰¾åˆ° key ç›¸åŒçš„ï¼Œåˆ™æ›¿æ¢ value å¹¶é€€å‡ºéå†</span></span><br><span class="line">                            <span class="comment">//å¦åˆ™ï¼Œéå†å®Œé“¾è¡¨ï¼Œå°†èŠ‚ç‚¹æ’å…¥é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                    (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                <span class="comment">//å¦‚æœ key ç›¸ç­‰ï¼Œåˆ™æ›¿æ¢ valueï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                            value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœå½“å‰èŠ‚ç‚¹å·²ç»æ˜¯æ ‘äº†ï¼Œåˆ™å°†é”®å€¼å¯¹æ’å…¥æ ‘ä¸­</span></span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                        value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> ReservationNode)</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Recursive update&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//binCount ä¸ä¸º0ï¼Œé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹æ•°é‡ä¸ä¸º 0 ï¼Œå³é”®å€¼å¯¹æ’å…¥äº†</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">//èŠ‚ç‚¹ä¸Šçš„æ•°é‡è¶…è¿‡äº†é˜ˆå€¼ï¼Œè½¬ä¸ºæ ‘</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//å¦‚æœæ—§å€¼ä¸ä¸º nullï¼Œå³æ›¿æ¢äº†æŸä¸ªé”®å€¼å¯¹</span></span><br><span class="line">                    <span class="comment">//åˆ™ return æ—§å€¼ï¼Œç»“æŸæ•´ä¸ª put æµç¨‹</span></span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="comment">//å¦åˆ™ï¼Œå³ oldVal == null çš„æƒ…å†µä¸‹</span></span><br><span class="line">                <span class="comment">//é€€å‡º for (Node&lt;K,V&gt;[] tab = table;;) å¾ªç¯</span></span><br><span class="line">                <span class="comment">//èµ° addCount(1L,binCount) å¤„çš„é€»è¾‘å¹¶è¿”å› null</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¢åŠ è®¡æ•°ï¼Œæ‰©å®¹ç­‰</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="comment">//è¿”å› nullï¼Œä»£è¡¨æ˜¯æ–°å¢çš„é”®å€¼å¯¹ï¼Œå¹¶é key ç›¸åŒæ›¿æ¢æ—§çš„ value</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼š</p><p><strong>â‘ . åˆå§‹åŒ–æ•°ç»„</strong></p><p>é€šè¿‡ spread æ–¹æ³•è®¡ç®— hash å€¼ï¼Œå¹¶å¼€å§‹æ­»å¾ªç¯ï¼Œç›´åˆ°æ’å…¥æˆåŠŸåé€€å‡º</p><p>å¦‚æœ table è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™å…ˆé€šè¿‡ initTable() åˆå§‹åŒ–æ•°ç»„ </p><p><strong>â‘¡. index å¤„ä¸º null</strong></p><p>é€šè¿‡ spread() æ–¹æ³•è®¡ç®—å‡ºå¯¹åº”çš„ç´¢å¼• i ï¼Œå¦‚æœæ•°ç»„ i ç´¢å¼•å¤„çš„å€¼ä¸º null ï¼Œåˆ™é€šè¿‡ cas çš„æ–¹å¼è¿›è¡Œæ’å…¥ï¼Œå¦‚æœ cas å¤±è´¥ï¼Œè¯´æ˜æœ‰åˆ«çš„çº¿ç¨‹åœ¨å¯¹è¯¥å¤„è¿›è¡Œæ“ä½œï¼Œåˆ™è¿›è¡Œä¸‹ä¸€æ¬¡ for å¾ªç¯ï¼Œä¸‹ä¸€æ¬¡ for å¾ªç¯åˆ™ä¼šè¿›å…¥ 3ã€4 æ­¥ä¸­</p><p><strong>â‘¢. å¸®åŠ©æ‰©å®¹</strong></p><p>å¦‚æœ index å¤„èŠ‚ç‚¹ä¸ä¸º null ä¸” index å¤„çš„èŠ‚ç‚¹ hash å€¼ä¸º MOVED ï¼Œåˆ™è¿›è¡Œ helpTransfer() æ–¹æ³•</p><p><strong>â‘£. æ™®é€šæ’å…¥</strong></p><p>ä¸Šè¿°å‡ æ­¥éƒ½ä¸æ»¡è¶³ï¼Œåˆ™è¯´æ˜ index ä¸Šæœ‰ä¸ªæ™®é€šçš„èŠ‚ç‚¹ï¼Œæˆ–ä¸ºé“¾è¡¨ï¼Œæˆ–ä¸ºæ ‘ï¼Œè¿›è¡Œæ›´æ–°æˆ–è€…æ’å…¥æ“ä½œ</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¼šå°† f(å³ index å¤„çš„èŠ‚ç‚¹) è¿›è¡ŒåŠ é”ï¼Œå¹¶ä¼šå†æ¬¡æ£€æŸ¥æ­¤æ—¶çš„ table index ç´¢å¼•å¤„çš„èŠ‚ç‚¹æ˜¯å¦è¢«æ”¹å˜äº†ï¼Œå¦‚æœæ”¹å˜äº†ï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå¦‚æœæ²¡æœ‰æ”¹å˜ä¾æ—§ä¸º f ï¼Œåˆ™è¿›è¡Œæ›´æ–°æˆ–è€…æ’å…¥æ“ä½œ</p><p>å¦‚æœæ˜¯é“¾è¡¨ï¼Œåˆ™éå†é“¾è¡¨è¦†ç›–æ›´æ–°å€¼æˆ–è€…åœ¨é“¾è¡¨å°¾éƒ¨æ’å…¥æ–°çš„é”®å€¼å¯¹(binCount &#x3D; åŸé“¾è¡¨é•¿åº¦)</p><p>å¦‚æœæ˜¯æ ‘ï¼Œåˆ™å°†é”®å€¼å¯¹æ’å…¥æ ‘ä¸­</p><p>æ·»åŠ å®Œæˆåï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹ä¸Šçš„é“¾è¡¨é•¿åº¦ï¼Œå¦‚æœè¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è°ƒç”¨ treeifyBin è½¬ä¸ºæ ‘æˆ–è€…æ‰©å®¹æ•°ç»„ï¼Œæœ€åè°ƒç”¨ addCount æ·»åŠ è®¡æ•°ï¼Œè§†æœºæ‰©å®¹æ•°ç»„ç­‰</p><h3 id="initTable"><a href="#initTable" class="headerlink" title="initTable()"></a>initTable()</h3><p>ğŸ’¡ åˆå§‹åŒ– table æ•°ç»„</p><p>æ¥ç€çœ‹æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//table è¿˜æ²¡åˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// sizeCtl å°äº 0 è¯´æ˜æœ‰åˆ«çš„çº¿ç¨‹åœ¨åˆå§‹åŒ–ï¼Œåˆ™è®©å‡º CPU æ—¶é—´ç¢ç‰‡</span></span><br><span class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œé€šè¿‡ cas å°† sc å’Œ -1 è¿›è¡Œ cas æ“ä½œ</span></span><br><span class="line">            <span class="comment">//SIZECTL æ˜¯ sizeCtl ä¼ å…¥çš„å¯¹è±¡ this</span></span><br><span class="line">            <span class="comment">//(å³ sizeCtl åœ¨ ConcurrentHashMap è¿™ä¸ªå¯¹è±¡ä¸­å†…å­˜çš„åç§»é‡)</span></span><br><span class="line">            <span class="comment">// sc ä¸ºæœŸæœ›å€¼ï¼Œæ­¤æ—¶å€¼ä¸º sizeCtl</span></span><br><span class="line">            <span class="comment">// -1 ä¸ºè¦æ›¿æ¢çš„å€¼</span></span><br><span class="line">            <span class="comment">//æ€»ç»“æ¥è¯´å°±æ˜¯å°† sizeCtl å’Œ sc è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰å°±å°† -1 èµ‹å€¼ç»™ sizeCtlï¼Œè¿”å› true</span></span><br><span class="line">            <span class="comment">//å¦åˆ™ä¸èµ‹å€¼è¿”å› false</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ cas æˆåŠŸäº†</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœè®¾ç½®äº†å®¹é‡å¤§å°åˆ™ä½¿ç”¨è®¾ç½®çš„å®¹é‡ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„å®¹é‡</span></span><br><span class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="comment">//new ä¸€ä¸ªæ•°ç»„å¹¶èµ‹å€¼</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">//è®¡ç®—æ‰©å®¹çš„é˜ˆå€¼ n - (n &gt;&gt;&gt; 2) ç­‰åŒäº n * LOAD_FACTOR</span></span><br><span class="line">                    <span class="comment">//åªä¸è¿‡ä½¿ç”¨ä½è¿ç®—æ›´å¿«</span></span><br><span class="line">                    <span class="comment">//å³ n * 0.75 = n * 3/4 = n * (1 - 1/4) = n - n/4</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//å°† sc çš„å€¼èµ‹å€¼ç»™ sizeCtl</span></span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›æ–°çš„ table æ•°ç»„</span></span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapInt</span><span class="params">(Object o, <span class="keyword">long</span> offset,<span class="keyword">int</span> expected,<span class="keyword">int</span> x&#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼Œè¯»å–ä¼ å…¥çš„å¯¹è±¡ o åœ¨å†…å­˜ä¸­åç§» offset çš„å€¼ï¼Œå¹¶å’Œ expected æ¯”è¾ƒ</span></span></span><br><span class="line"><span class="params"><span class="function">å¦‚æœç›¸åŒï¼Œåˆ™å°† x èµ‹å€¼ç»™å†…å­˜ä¸­åç§» offset ä½ç½®çš„å€¼ï¼Œå¹¶è¿”å› <span class="keyword">true</span></span></span></span><br><span class="line"><span class="params"><span class="function">å¦åˆ™ä¸èµ‹å€¼è¿”å› <span class="keyword">false</span></span></span></span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><p>å¦‚æœ sizeCtl  å°äº 0 åˆ™è®©å‡ºï¼Œåˆ™æš‚åœè‡ªå·±çš„çº¿ç¨‹ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹å»æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</p><p>å¦‚æœ sizeCtl å¤§äºç­‰äº 0 åˆ™åˆå§‹åŒ–ä¸€ä¸ª sizeCtl å¤§å°çš„æ•°ç»„ï¼Œå¹¶æ›´æ–° sizeCtl ä¸ºè‡ªèº«çš„è´Ÿè½½å› å­å€( * 0.75)</p><p>è¿™é‡Œé€šè¿‡ Unsafe.compareAndSwapInt ä¿è¯äº†çº¿ç¨‹å®‰å…¨</p><p>å‡å¦‚æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨äº† initTable æ–¹æ³•ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„ <code>U.compareAndSwapInt(this, SIZECTL, sc, -1)</code> ä¼šè¿”å› true èµ°å…¥è¯¥ if ä¸­çš„ä»£ç å»æ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå‡å¦‚æœ‰ç¬¬ä¸‰ä¸ªçº¿ç¨‹æ¥äº†ï¼Œåˆ™ä¼šèµ°å…¥åˆ° Thread.yield() è¿™é‡Œå»è®©å‡ºæ—¶é—´ç¢ç‰‡</p><h3 id="helpTransfer"><a href="#helpTransfer" class="headerlink" title="helpTransfer"></a>helpTransfer</h3><p>å¦‚æœåœ¨æŸä¸ªçº¿ç¨‹åœ¨è¿›è¡Œè½¬ç§»èŠ‚ç‚¹æ•°æ®ï¼Œåˆ™è¿›è¡Œåˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶å°±å¸®åŠ©è½¬ç§»ï¼Œå¹¶è¿”å› table æ•°ç»„ï¼Œä»¥ä¾¿åœ¨ä¸‹æ¬¡å¾ªç¯ä¸­è¿›è¡Œæ’å…¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] nextTab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; (f <span class="keyword">instanceof</span> ForwardingNode) &amp;&amp;</span><br><span class="line">        (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœ tab ä¸ä¸ºç©ºï¼Œä¸”å…¶å¤´èŠ‚ç‚¹ä¸º fwd èŠ‚ç‚¹ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹è¿ç§»</span></span><br><span class="line">        <span class="keyword">int</span> rs = resizeStamp(tab.length);</span><br><span class="line">        <span class="keyword">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;</span><br><span class="line">                (sc = sizeCtl) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//æ»¡è¶³ while ä¸­çš„æ¡ä»¶è¿™é‡Œè¯´æ˜æ­£åœ¨æ‰©å®¹</span></span><br><span class="line">            <span class="comment">//åˆ™å¾ªç¯ï¼Œç›´åˆ°æ‰©å®¹ç»“æŸ</span></span><br><span class="line">            <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                sc == rs + MAX_RESIZERS || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">//ä¿®æ”¹ sizeCtl æˆåŠŸï¼Œä¿®æ”¹æ‰©å®¹çš„çº¿ç¨‹æ•° +1ï¼Œå‚ä¸æ‰©å®¹</span></span><br><span class="line">                transfer(tab, nextTab);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‰©å®¹ç»“æŸï¼Œè¿”å›æ–° table</span></span><br><span class="line">        <span class="keyword">return</span> nextTab;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¤´èŠ‚ç‚¹é fwd èŠ‚ç‚¹ï¼Œåˆ™è¿”å›æ—§ table </span></span><br><span class="line">    <span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="resizeStamp-int-n"><a href="#resizeStamp-int-n" class="headerlink" title="resizeStamp(int n)"></a>resizeStamp(int n)</h3><blockquote><p>ç”±äºä¼ å…¥çš„å‚æ•° n éƒ½æ˜¯ 2 çš„ n æ¬¡å¹‚ï¼Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ç”¨æ¥å°†è¿™ä¸ª n é€šè¿‡ç®—æ³•å°†å…¶è®°å½•åœ¨ä½16ä½ä¸­</p></blockquote><p><em>TL;DR</em> </p><blockquote><p><strong>è¿”å›å€¼é«˜16ä½è®°å½•ä¸º 0ï¼Œä½16ä½è®°å½•çš„æ˜¯ã€Œæ‰©å®¹æ ‡è¯†ã€ï¼Œä¸æ•°ç»„é•¿åº¦æœ‰å…³</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">resizeStamp</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.numberOfLeadingZeros(n) | (<span class="number">1</span> &lt;&lt; (RESIZE_STAMP_BITS- <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>Integer.numberOfLeadingZeros(n)</code> è¿”å› n åœ¨äºŒè¿›åˆ¶ä¸­æœ€é«˜ä½çš„1å‰é¢0çš„ä¸ªæ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æ¯”æ–¹è¯´ <span class="number">1</span> çš„äºŒè¿›åˆ¶ä¸º </span><br><span class="line"><span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0001</span></span><br><span class="line">åˆ™ `Integer.numberOfLeadingZeros(<span class="number">1</span>)` = <span class="number">31</span></span><br><span class="line">æ‰€ä»¥ Integer.numberOfLeadingZeros(<span class="keyword">int</span> n) çš„å€¼çš„èŒƒå›´ä¸º <span class="number">0</span>-<span class="number">32</span></span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹ååŠæ®µï¼Œ*<code>RESIZE_STAMP_BITS</code> å€¼ä¸º  16ï¼Œ*æ‰€ä»¥ <code>(1 &lt;&lt; (*RESIZE_STAMP_BITS - 1 )*</code> å³1å·¦ç§»15ä½ï¼Œå¾—åˆ° <code>0000 0000 0000 0000 1000 0000 0000 0000</code></p><p>æœ€åè¿›è¡Œ <code>|</code> è¿ç®—*(æœ‰1åˆ™ä¸º1)*</p><p>æˆ‘ä»¬ä»¥ resizeStamp(16) ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(åè¿›åˆ¶ <span class="number">16</span>)                            == <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0001</span> <span class="number">0000</span></span><br><span class="line"></span><br><span class="line">Integer.numberOfLeadingZeros(<span class="number">16</span>) = <span class="number">27</span> == <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0001</span> <span class="number">1001</span></span><br><span class="line">              | æˆ–è¿ç®—</span><br><span class="line">(<span class="number">1</span> &lt;&lt; (RESIZE_STAMP_BITS- <span class="number">1</span>)  = <span class="number">1</span>&lt;&lt;<span class="number">15</span> == <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">1000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line">              = ç­‰äº</span><br><span class="line">                                         <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">1000</span> <span class="number">0000</span> <span class="number">0001</span> <span class="number">1001</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯è§ resizeStamp æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª é«˜16ä¸ºéƒ½ä¸º0ï¼Œä½16ä½ä¸ºä¼ å…¥çš„å‚æ•° n çš„ ã€Œæœ€é«˜ä½çš„1å‰é¢0çš„ä¸ªæ•°ã€</p><p>å³é«˜16ä½è®°å½•ä¸º 0ï¼Œç¬¬16ä½ä¸º1ï¼Œä½15ä½è®°å½•çš„æ˜¯ã€Œæœ€é«˜ä½çš„1å‰é¢0çš„ä¸ªæ•°ã€ä½16ä½æ„æˆä¸€ä¸ªã€Œæ‰©å®¹æ ‡è¯†ã€</p><p>å¯è§è¯¥æ–¹æ³•è¿”å›çš„å€¼çš„å–å€¼èŒƒå›´ä¸º [32769,32799]</p><h3 id="treeifyBin-Node-lt-K-V-gt-tab-int-index"><a href="#treeifyBin-Node-lt-K-V-gt-tab-int-index" class="headerlink" title="treeifyBin(Node&lt;K,V&gt;[] tab,int index)"></a>treeifyBin(Node&lt;K,V&gt;[] tab,int index)</h3><p>åœ¨å¾€ ConcurrentHashMap ä¸­æ’å…¥å…ƒç´ åï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œæ‰©å®¹æˆ–è€…å°†é“¾è¡¨è½¬ä¸ºæ ‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; b; <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            <span class="comment">//å¦‚æœ tab çš„é•¿åº¦å°äº MIN_TREEIFY_CAPACITY(64)ï¼Œåˆ™è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">            tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œå¦‚æœ index å¤„çš„èŠ‚ç‚¹ b ä¸ä¸ºç©ºä¸” hash å€¼å¤§äº0</span></span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                <span class="comment">//åŠ é”</span></span><br><span class="line">                <span class="comment">//å†æ¬¡åˆ¤æ–­ï¼Œtab çš„ index å¤„æ˜¯å¦ä¸º b</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    <span class="comment">//è½¬ä¸ºæ ‘ï¼Œç•¥è¿‡ä¸è¡¨</span></span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; p =</span><br><span class="line">                            <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><p>å½“æ’å…¥ä¸€ä¸ªå…ƒç´ åï¼Œå¦‚æœé“¾è¡¨çš„é•¿åº¦è¶…è¿‡<code>TREEIFY_THRESHOLD == 8</code>ï¼Œä½†æ•´ä¸ª table æ•°ç»„é•¿åº¦å°äº  <code>MIN_TREEIFY_CAPACITY</code>&#x3D;&#x3D;64ï¼Œåˆ™è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¦‚æœè¶…è¿‡äº† <code>MIN_TREEIFY_CAPACITY</code> åˆ™å°†é“¾è¡¨è½¬ä¸ºæ ‘</p><h3 id="tryPresize-int-size"><a href="#tryPresize-int-size" class="headerlink" title="tryPresize(int size)"></a>tryPresize(int size)</h3><p>ğŸ’¡ å°è¯•é¢„å¤„ç† table æ•°ç»„çš„å®¹é‡ä»¥å®¹çº³ç»™å®šçš„æ•°é‡çš„å…ƒç´ </p><p>è¿™ä¸ªæ–¹æ³•åªåœ¨ treeifyBin() ä»¥åŠ putAll() ä¸­è¢«è°ƒç”¨</p><p>treeifyBin() æ–¹æ³•ä¼ å…¥çš„ size ä¸º <code>table.length &lt;&lt; 1</code></p><p>putAll() ä¼ å…¥çš„ size ä¸º <code>m.size()</code> å³åŸ Map çš„èŠ‚ç‚¹æ•°</p><p>ä»¥ table.length &#x3D;&#x3D; 16 ä¸ºä¾‹ï¼Œè°ƒç”¨è¯¥æ–¹æ³•æ—¶å€™ï¼Œsize &#x3D; table.length &lt;&lt; 1 å³ 32ï¼Œè®¡ç®—å‡ºæ¥çš„ c ä¸º 64ï¼Œç›´åˆ° c â‰¤ sc æ—¶æ‰ä¼šé€€å‡ºå¾ªç¯ï¼Œåˆ™ sc è‡³å°‘éœ€è¦ä¸º 128 * 0.75 &#x3D; 96 æ‰ä¼šé€€å‡ºå¾ªç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°è¯•è°ƒæ•´ table æ•°ç»„çš„å®¹é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size éœ€è¦è°ƒæ•´åˆ°çš„å®¹é‡</span></span><br><span class="line"><span class="comment"> * è¿™ä¸ªæ–¹æ³•åªåœ¨ treeifyBin() ä»¥åŠ putAll() ä¸­è¢«è°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryPresize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ ¹æ® size çš„å€¼è®¡ç®—çº¦æŸå‡ºä¸ºä¸€ä¸ªæ­£ç¡®çš„ 2çš„æ¬¡å¹‚å€¼</span></span><br><span class="line">    <span class="comment">//ä¸º MAXIMUM_CAPACITY æˆ–è€…æ˜¯å¤§äºç­‰äº (size * 1.5 + 1) çš„æœ€å°çš„ 2æ¬¡å¹‚</span></span><br><span class="line">    <span class="keyword">int</span> c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">        tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// sc ä¸º sizeCtl åœ¨æœ¬æ–¹æ³•ä¸­çš„ä¸´æ—¶å˜é‡</span></span><br><span class="line">    <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//-------â‘ --------</span></span><br><span class="line">            <span class="comment">//å¦‚æœ table è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">            <span class="comment">// n ä¸ºæ–°çš„æ•°ç»„å®¹é‡</span></span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            <span class="comment">//åŒç†ï¼Œif ä¸­çš„è¯­å¥ä¼šé€šè¿‡ cas å°† sizeCtl æ›´æ–°ä¸º -1ï¼Œè¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        <span class="comment">//è®¡ç®— scï¼Œå³ n - 0.25 * n = 0.75 * n</span></span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// è®¾ç½®æ–°çš„é˜ˆå€¼</span></span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">            <span class="comment">//-------â‘¡--------</span></span><br><span class="line">            <span class="comment">// c &lt;= sc è¯´æ˜æ•°ç»„çš„å®¹é‡å·²ç»è¶³å¤Ÿäº†</span></span><br><span class="line">            <span class="comment">// n &gt;= MAXIMUM_CAPACITY è¯´æ˜å·²ç»è¶…è¿‡æœ€å¤§å®¹é‡äº†</span></span><br><span class="line">            <span class="comment">//åˆ™é€€å‡ºå¾ªç¯ï¼Œä¸å¤„ç†</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">            <span class="comment">//-------â‘¢--------</span></span><br><span class="line">            <span class="comment">//è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">            <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜â‘ å’Œâ‘¡çš„æƒ…å†µå·²ç»è¢«æ’é™¤æ‰äº†ï¼Œå³å·²ç» table æ•°ç»„å·²ç»åˆå§‹åŒ–è¿‡äº†</span></span><br><span class="line">            <span class="comment">//å¹¶ä¸”c &lt;= scä¸æˆç«‹ï¼Œå³ sc &lt; c ï¼Œè¯´æ˜è¿˜æ²¡æ‰©å®¹å®Œæˆ</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//n ä¸º table çš„å®¹é‡</span></span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//sc &lt; 0 å› ä¸ºæ•°ç»„å·²ç»åˆå§‹åŒ–äº†ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰©å®¹</span></span><br><span class="line">                Node&lt;K,V&gt;[] nt;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//sc å³ç§»16ä½åï¼Œé«˜16ä½ä¸º0ï¼Œä½16ä½ä¸ºæ•°ç»„é•¿åº¦è®¡ç®—å‡ºçš„æ‰©å®¹æ ‡è¯†</span></span><br><span class="line">                <span class="comment">//(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs:æ‰©å®¹æ ‡è¯†ä¸åŒ</span></span><br><span class="line">                <span class="comment">//è¯´æ˜æ•°ç»„é•¿åº¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯èƒ½æ˜¯åˆ«çš„çº¿ç¨‹è§¦å‘äº†ç¬¬äºŒæ¬¡æ‰©å®¹</span></span><br><span class="line">                <span class="comment">//sc == rs + MAX_RESIZERS:å·²ç»è¾¾åˆ°æœ€å¤§çš„æ‰©å®¹çº¿ç¨‹æ•°é‡äº†</span></span><br><span class="line">                <span class="comment">//(nt = nextTable) == null :nextTable è¿˜æ²¡åˆ›å»º</span></span><br><span class="line">                <span class="comment">//transferIndex &lt;= 0 éœ€è¦è¿ç§»çš„åŒºé—´å·²ç»è¢«åˆ«çš„çº¿ç¨‹åˆ†å®Œäº†</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//å®é™…ä¸Šè¿™é‡Œæœ‰ä¸¤ä¸ª bug</span></span><br><span class="line">                <span class="comment">//1. sc == rs + 1</span></span><br><span class="line">                <span class="comment">//sc ç°åœ¨æ˜¯ä¸ªè´Ÿæ•°ï¼Œrs é«˜16ä½éƒ½ä¸º 0ï¼Œæ— è®ºå¦‚ä½• rs + 1 éƒ½ä¸ä¼šç­‰äº sc</span></span><br><span class="line">                <span class="comment">//fix:</span></span><br><span class="line">                <span class="comment">//sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 1</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//2. sc == rs + MAX_RESIZERS</span></span><br><span class="line">                <span class="comment">//MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1 = (1 &lt;&lt; 16) -1 = 65535</span></span><br><span class="line">                <span class="comment">//rs çš„å–å€¼èŒƒå›´ä¸º [32769,32799] è€Œ rs + MAX_RESIZERS &gt; 0 å¹¶ä¸”è¿˜æ²¡æº¢å‡ºä¸ºè´Ÿæ•°</span></span><br><span class="line">                <span class="comment">//ä¹Ÿæ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰</span></span><br><span class="line">                <span class="comment">//fix:</span></span><br><span class="line">                <span class="comment">//sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + MAX_RESIZERS</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//å°† rs å·¦ç§» 16ä½ï¼Œå…¶é«˜16ä½æ‰æ˜¯æ‰©å®¹æ ‡è¯†ï¼Œä½16ä¸ºå­˜å‚¨æ‰©å®¹çš„çº¿ç¨‹æ•° + 1</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//ä¸‹é¢è¿™é‡Œå¯¹ sizeCtl åŠ ä¸€ï¼Œè¡¨ç¤ºå‚ä¸è¿ç§»çš„çº¿ç¨‹æ•° +1ï¼Œå¹¶è¿›è¡Œè¿ç§»</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¯´æ˜è‡ªå·±æ˜¯ç¬¬ä¸€ä¸ªè¿›è¡Œæ‰©å®¹çš„çº¿ç¨‹ï¼Œåˆ™é€šè¿‡ cas çš„æ–¹å¼ï¼Œå°† rs å·¦ç§» 16ä½å¹¶åŠ 2ï¼Œå­˜å‚¨åœ¨ sizeCtl ä¸­</span></span><br><span class="line">            <span class="comment">//é€šè¿‡å‰é¢çš„ resizeStamp æ–¹æ³•æˆ‘ä»¬ç›´åˆ° rs çš„é«˜16ä½ä¸º0ï¼Œè¿™é‡Œå·¦ç§»16ä½ï¼Œåˆ™ä½16ä½éƒ½ä¸º0ï¼Œå†åŠ 2</span></span><br><span class="line">            <span class="comment">//åˆ™ç”¨ä½16ä¸ºè¡¨ç¤ºæ­£åœ¨æ‰©å®¹çš„çº¿ç¨‹æ•°ï¼Œå¹¶ä¸”ç”¨ 2 è¡¨ç¤ºç¬¬ä¸€ä¸ªæ­£åœ¨æ‰©å®¹çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                            (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="transfer"><a href="#transfer" class="headerlink" title="transfer()"></a>transfer()</h3><p>transfer(Node&lt;K,V&gt; tab, Node&lt;K,V&gt;[] nextTab)<br>ğŸ’¡ å°†æ—§æ•°ç»„çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ä¸­ï¼Œæ”¯æŒå¤šçº¿ç¨‹è¿ç§»</p><h4 id="å­—æ®µè¯´æ˜"><a href="#å­—æ®µè¯´æ˜" class="headerlink" title="å­—æ®µè¯´æ˜"></a><strong>å­—æ®µè¯´æ˜</strong></h4><p><code>transferIndex</code> æ˜¯ä¸ªå…¨å±€å˜é‡ï¼Œé€šè¿‡ volatile ä¿®é¥°ï¼Œå¹¶é€šè¿‡ cas çš„æ–¹å¼è¿›è¡Œä¿®æ”¹ï¼Œç”¨æ¥è¡¨ç¤ºå½“å‰çº¿ç¨‹åº”è¯¥ä»å“ªä¸ªåœ°æ–¹å¼€å§‹å¾€å‰éå†ï¼Œå¦‚æœ transferIndex &lt;&#x3D; 0 è¯´æ˜å¯¹æ•°ç»„çš„è½¬ç§»å·²ç»åˆ°å¤´äº†ï¼Œä¸éœ€è¦å†ç»§ç»­å¤„ç†äº†</p><p><code>i</code> å­—æ®µè¡¨ç¤ºå½“å‰çº¿ç¨‹åœ¨è¿ç§»çš„æ¡¶çš„ç´¢å¼•</p><p><code>bound</code> å­—æ®µè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„éœ€è¦è¿ç§»çš„åŒºé—´çš„ä¸Šè¾¹ç•Œ</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><strong>æ€»ç»“</strong></h4><p>å³æ¯ä¸ªçº¿ç¨‹çš„è¿ç§»åŒºé—´ä¸º [bound,transferIndex)ï¼Œå¹¶é€šè¿‡ i åœ¨è¯¥åŒºé—´ä»åå¾€å‰éå†æ¡¶è¿›è¡Œè¿ç§»å¤„ç†ï¼Œéå†åŒºé—´å®Œæˆåï¼Œä¼šç»§ç»­ç«äº‰ä¸‹ä¸€ä¸ªåŒºé—´</p><p>ä¸ºäº†é«˜æ•ˆçš„è¿›è¡Œè¿ç§»æ•°æ®ï¼Œè¿™é‡Œå…è®¸å¤šä¸ªçº¿ç¨‹è¿›å…¥ï¼Œä½†æ˜¯ç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…äº†æ—§æ•°ç»„çš„ä¸€æ®µåŒºé—´è¿›è¡Œè¿ç§»ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿ç§»åŒä¸ªåŒºé—´ï¼Œä»£ç ä¸­é€šè¿‡ cas çš„æ–¹å¼ï¼Œ</p><p>è®©å¤šä¸ªçº¿ç¨‹é€šè¿‡ cas çš„æ“ä½œç«äº‰ transferIndex å­—æ®µï¼Œå¹¶é€šè¿‡ transferIndex å­—æ®µå’Œ stride è®¡ç®—å‡ºæ¯ä¸ªçº¿ç¨‹çš„è¿ç§»åŒºé—´ï¼Œæ‰€ä»¥çº¿ç¨‹åœ¨å¤„ç†å®Œç«äº‰åˆ°çš„æŸä¸ªåŒºé—´åï¼Œä¼šä¸åœåœ°å¾€å‰ç«äº‰å¤„ç†ä¸‹ä¸€ä¸ªåŒºé—´ï¼Œç›´åˆ°å¤„ç†åˆ°æ•°ç»„æœ€å‰é¢çš„åŒºé—´ï¼Œæ¯”å¦‚è¯´[0,16) çš„åŒºé—´åï¼ŒtransferIndex ç­‰äº 0ï¼Œæ‰€ä»¥ i &#x3D; -1ï¼Œ</p><p>å°±ä¼šå°† sizeCtl ä¸­ä½16ä½ä¸­å­˜å‚¨çš„çº¿ç¨‹æ•°å‡1å returnï¼Œé€€å‡ºè¿ç§»ï¼Œç­‰åˆ°æ‰€æœ‰çš„çº¿ç¨‹å¯¹æ‰€æœ‰çš„åŒºé—´å¤„ç†å®Œæ¯•åï¼Œå…¶ä»–çº¿ç¨‹éƒ½é€€å‡ºè¿ç§»æ“ä½œäº†ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹ä¼šå°† finish è®¾ç½®ä¸º trueï¼Œ</p><p>å†è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯åä¼šå°†æ–°çš„ nextTab èµ‹å€¼ç»™ table å¹¶å°† nextTable ç½®ä¸ºç©º</p><p>ä» HashMap çš„è¿ç§»ç®—æ³•ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´åˆ°ï¼Œå¯¹äºä¸€ä¸ªèŠ‚ç‚¹ï¼Œåœ¨æ‰©å®¹è¿ç§»åï¼Œè¦ä¹ˆè¿˜åœ¨åŸæ¥çš„æ¡¶(å‡è®¾ç´¢å¼•ä¸º index)ä¸­ï¼Œè¦ä¹ˆå°±åœ¨ç´¢å¼•ä¸º 2 * index çš„æ¡¶å¤„</p><p>åŒç†åœ¨ ConcurrentHashMap ä¸­ä¹Ÿæ˜¯è¿™æ ·å­ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è½¬ç§»åˆ°åŒä¸€ä¸ªæ¡¶ä¸­</p><p>é¦–å…ˆä¼šè®¡ç®—æ¯ä¸ªçº¿ç¨‹éœ€è¦è¿›è¡Œè¿ç§»çš„æ­¥é•¿ strideï¼Œå³è¿ç§»çš„æ¡¶çš„æ•°é‡ï¼Œè‡³å°‘ä¸º 16</p><p>åœ¨è¿›è¡Œè¿ç§»æ—¶ï¼Œä¼šä»åå¾€å‰å¯¹ table æ•°ç»„è¿›è¡Œéå†ï¼Œé€æ­¥å¯¹æ¡¶å†…çš„æ•°æ®(é“¾è¡¨æˆ–è€…æ ‘)è¿›è¡Œè¿ç§»</p><p>ç”±äºç¯‡å¹…å¤ªé•¿ï¼Œæˆ‘ä»¬å‡è®¾æ­¥é•¿ stride ä¸º4ï¼Œä¸¾ä¾‹è¿›è¡Œè¯´æ˜</p><p><img src="https://s2.loli.net/2021/12/23/7uBlQZRbcPYH3Fm.png" alt="transfer_concurrenthashmap.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè½¬ç§»æ•°æ®æ—¶ï¼ŒnextTab == nullï¼Œå¦åˆ™ä¸ºå…¨å±€å˜é‡ nextTable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">    <span class="comment">//è®¡ç®—æ­¥é•¿ strideï¼Œè‡³å°‘ä¸º 16</span></span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">        <span class="comment">//nextTab ä¸º null è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè½¬ç§»</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸ºæ—§æ•°ç»„å®¹é‡ä¸¤å€çš„æ–°æ•°ç»„ï¼Œå¹¶èµ‹å€¼ç»™ nextTab</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            <span class="comment">//å¦‚æœäº§ç”Ÿ OOM ç­‰å¼‚å¸¸ï¼Œåˆ™ç›´æ¥é€€å‡ºï¼Œä¸è½¬ç§»äº†</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å°†æ–°æ•°ç»„èµ‹å€¼ç»™ nextTable ï¼Œæ­¤æ—¶æ•°ç»„ä¸ºä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„ç©ºæ•°ç»„</span></span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        <span class="comment">//transferIndex è®°å½•æ—§æ•°ç»„çš„é•¿åº¦ï¼Œè¡¨ç¤ºè½¬ç§»å¼€å§‹çš„ç´¢å¼•å€¼</span></span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//nextn ä¸ºæ–°æ•°ç»„çš„å®¹é‡</span></span><br><span class="line">    <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">    <span class="comment">//fwd æ˜¯ç”¨æ¥æ ‡è¯†æŸä¸ªæ¡¶å¤„æ­£åœ¨è½¬ç§»çš„ï¼Œå­˜å‚¨äº†æ–°æ•°ç»„</span></span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="comment">//advance æ˜¯å¦å‰è¿›ï¼Œç”¨æ¥æ ‡è®°æ˜¯å¦éœ€è¦åœ¨åŒºé—´å†…ç»§ç»­å¾€å‰å‰è¿›å¤„ç†</span></span><br><span class="line">    <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//finishing æ˜¯å¦æ‰«æç»“æŸäº†ï¼Œç”¨æ¥æ ‡è®°æ˜¯å¦å°†æ‰€æœ‰çš„åŒºé—´éƒ½è¿ç§»å®Œæˆäº†</span></span><br><span class="line">    <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œå°† i å’Œ bound åˆå§‹åŒ–ä¸º 0ï¼Œå¹¶å¼€å§‹æ­»å¾ªç¯ï¼Œç›´åˆ°æ•°æ®è½¬ç§»æˆåŠŸåå†é€€å‡ºå¾ªç¯</span></span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡æ‰§è¡Œåˆ°è¿™é‡Œæ—¶</span></span><br><span class="line">        <span class="comment">//--i == -1ï¼Œ bound == 0ï¼Œç¬¬ä¸€ä¸ªåˆ¤æ–­ä¸º false</span></span><br><span class="line">        <span class="comment">//æ³¨æ„è¿™é‡Œæ¯æ¬¡è¿›å…¥ while å¾ªç¯éƒ½ä¼šåšä¸€æ¬¡ --i çš„æ“ä½œï¼Œä½¿å¾— i ä¸æ–­çš„è‡ªå‡</span></span><br><span class="line">        <span class="comment">//nextIndex = transferIndex == n == tab.length å³æ—§æ•°ç»„çš„é•¿åº¦ï¼Œå¤§äº0ï¼Œç¬¬äºŒä¸ªåˆ¤æ–­ä¸º false</span></span><br><span class="line">        <span class="comment">//åˆ™èµ°åˆ°ç¬¬ä¸‰ä¸ªåˆ¤æ–­ä¸­</span></span><br><span class="line">        <span class="comment">//nextBound ä¸ºä¸‹ä¸€ä¸ªçº¿ç¨‹éœ€è¦è¿›è¡Œè½¬ç§»çš„æ•°ç»„çš„ä¸‹è¾¹ç•Œ</span></span><br><span class="line">        <span class="comment">//è®¡ç®— nextBound çš„å€¼ï¼Œå¦‚æœ nextIndex(å³å°±æ•°ç»„çš„é•¿åº¦)å¤§äºæ­¥é•¿ strideï¼Œ</span></span><br><span class="line">        <span class="comment">//åˆ™ nextBound = nextIndex - strideï¼Œå¹¶é€šè¿‡ cas çš„æ–¹å¼èµ‹å€¼</span></span><br><span class="line">        <span class="comment">//ç»™å…¨å±€å˜é‡ transferIndexï¼Œå³ä¸‹ä¸ªçº¿ç¨‹éœ€è¦è½¬ç§»çš„åŒºé—´çš„ä¸‹è¾¹ç•Œ</span></span><br><span class="line">        <span class="comment">//ä¸‹é¢çš„ä»£ç ä¸»è¦å°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œè®¡ç®—å‡ºæ¥ [bound,transferIndex) è¿™ä¸ªåŒºé—´</span></span><br><span class="line">        <span class="comment">//åœ¨ä¸‹ä¸€æ¬¡ for å¾ªç¯åˆ™ä¼šèµ°åˆ°ç¬¬ä¸€ä¸ªåˆ¤æ–­ä¸­ï¼Œç›´åˆ° i &lt; bound æˆ–è€… finishing</span></span><br><span class="line">        <span class="comment">//å½“ i &lt; bound æ—¶ï¼Œå³å½“å‰çº¿ç¨‹å·²ç»æŠŠåˆ†é…ç»™è‡ªå·±çš„åŒºé—´é‡Œçš„æ¡¶éƒ½è½¬ç§»å®Œæ¯•äº†</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ­¤æ—¶åˆ«çš„çº¿ç¨‹è¿˜æ²¡æœ‰å°†æ•´ä¸ªæ•°ç»„è½¬ç§»å®Œæ¯•(transferIndex &lt;= 0 ä¸æˆç«‹)ï¼Œ</span></span><br><span class="line">        <span class="comment">//åˆ™å½“å‰çº¿ç¨‹ä¼šç»§ç»­å¾€å‰ç«äº‰ä¸‹ä¸€ä¸ªåŒºé—´ï¼Œè¿™ä¹Ÿå°±æ˜¯å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è¯ï¼Œä¹Ÿå¯ä»¥è¿ç§»å®Œæˆ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                <span class="comment">//æŸä¸ªçº¿ç¨‹çš„ç¬¬äºŒæ¬¡å¾ªç¯æ—¶å€™æ‰ä¼šèµ°åˆ°è¿™é‡Œæ¥ï¼Œè¯´æ˜ i è¿˜åœ¨è¯¥çº¿ç¨‹éœ€è¦è½¬ç§»çš„åŒºé—´å†…</span></span><br><span class="line">                <span class="comment">//[bound &lt;--&gt; i &lt;--&gt; transferIndex)</span></span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//transferIndex &lt;= 0 è¯´æ˜å°†å·²ç»åˆ°æœ€å‰é¢äº†ï¼Œå°† i èµ‹å€¼ä¸º -1</span></span><br><span class="line">                <span class="comment">//åˆ™ä¼šèµ°åˆ° â‘¢ å¤„æ‰§è¡Œï¼Œç®€å•æ¥è¯´ â‘¢ å¤„ä¼šåšä¸€äº›åˆ¤æ–­æ˜¯å¦è¯¥çº¿ç¨‹è¦é€€å‡ºè¿ç§»æ“ä½œ</span></span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                        (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                        nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                    nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ i &lt; bound ä¸” transferIndex &gt; 0 (å³æ•´ä¸ª table çš„è½¬ç§»è¿˜æ²¡å¤„ç†å®Œæˆ)</span></span><br><span class="line">                <span class="comment">//é€šè¿‡ cas ç»§ç»­è®¤é¢†ä¸€æ®µåŒºé—´è¿›è¡Œè½¬ç§»</span></span><br><span class="line">                <span class="comment">//è®¡ç®—å‡ºå½“å‰çº¿ç¨‹æ‰€éœ€è¦å¤„ç†çš„åŒºé—´</span></span><br><span class="line">                <span class="comment">//nextBound å°±æ˜¯ä¸‹ä¸€ä¸ªçº¿ç¨‹çš„ä¸‹è¾¹ç•Œï¼Œä¹Ÿå°±æ˜¯å½“å…ˆçº¿ç¨‹çš„ä¸Šè¾¹ç•Œ</span></span><br><span class="line">                bound = nextBound;</span><br><span class="line">                <span class="comment">//i ä¸ºç´¢å¼•å€¼ï¼Œæ‰€ä»¥éœ€è¦ - 1</span></span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="comment">//-----â‘¢----</span></span><br><span class="line">            <span class="comment">//å¦‚æœ i &lt; 0 æˆ–è€… i &gt;= n è¯´æ˜å·²ç»è¶…å‡ºäº†æ‰€éœ€è¦å¤„ç†çš„åŒºé—´äº†</span></span><br><span class="line">            <span class="keyword">int</span> sc;</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                <span class="comment">//------â‘ -----</span></span><br><span class="line">                <span class="comment">//å¦‚æœ finishing ä¸º true ï¼Œè¯´æ˜æ‰€æœ‰çš„æ¡¶éƒ½å¤„ç†å®Œäº†</span></span><br><span class="line">                <span class="comment">//åˆ™å°†æ–°çš„æ•°ç»„èµ‹å€¼ç»™ table å¹¶å°† nextTable ç½®ä¸ºç©º</span></span><br><span class="line">                nextTable = <span class="keyword">null</span>;</span><br><span class="line">                table = nextTab;</span><br><span class="line">                <span class="comment">//å¹¶ä¸”è®¾ç½®æ–°çš„é˜ˆå€¼ï¼Œæ–°æ•°ç»„çš„é•¿åº¦ä¸º 2nï¼Œæ‰€ä»¥é˜ˆå€¼åº”è¯¥ä¸º 0.75 * 2nï¼Œå³ 2n - 0.5n</span></span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                <span class="comment">//è¿”å›ï¼Œç»“æŸè¿ç§»</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ finishing ä¸º falseï¼Œå³è¿˜æœªå¤„ç†å®Œæ‰€æœ‰çš„æ¡¶</span></span><br><span class="line">            <span class="comment">//ä½†å½“å‰çº¿ç¨‹éœ€è¦å¤„ç†çš„åŒºé—´å†…çš„æ¡¶å·²ç»å¤„ç†å®Œäº†ï¼Œæ‰€ä»¥å°† sizeCtl å‡ä¸€è¡¨ç¤ºæ­£åœ¨è¿ç§»çš„çº¿ç¨‹æ•° -1</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="comment">//if ä¸­ä¸º true è¯´æ˜å½“å‰çº¿ç¨‹ä¸æ˜¯æœ€åä¸€ä¸ªåœ¨è¿›è¡Œè¿ç§»çš„çº¿ç¨‹ï¼Œè¿”å›ï¼Œç»“æŸæœ¬çº¿ç¨‹çš„è¿ç§»</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªå‚ä¸è¿ç§»çš„çº¿ç¨‹</span></span><br><span class="line">                <span class="comment">//å°† finishing å’Œ advance å‡è®¾ä¸º true</span></span><br><span class="line">                <span class="comment">//å¹¶æŠŠ i è®¾ç½®ä¸º n(å³æ—§æ•°ç»„ table çš„é•¿åº¦)</span></span><br><span class="line">                <span class="comment">//è¿™æ ·ä¸‹ä¸€æ¬¡å¾ªç¯å°±ä¼šèµ°å…¥ â‘  å¤„çš„é€»è¾‘ç»“æŸè¿ç§»</span></span><br><span class="line">                finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                i = n; <span class="comment">// recheck before commit</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//å¦‚æœç´¢å¼•ä¸º i çš„æ¡¶å¤„ä¸º nullï¼Œåˆ™é€šè¿‡ cas æ–¹å¼å°† fwd æ”¾åœ¨è¯¥æ¡¶å¤„</span></span><br><span class="line">            <span class="comment">//æ¥ç€å°† advance è®¾ç½®ä¸º trueï¼Œé€€å‡ºå¾ªç¯ç»§ç»­å¾€å‰</span></span><br><span class="line">            advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">//å¦‚æœç´¢å¼•ä¸º i å¤„çš„æ¡¶ä¸Šçš„æ•°æ®ä¸ä¸ºç©ºï¼Œä¸”å…¶ hash å€¼ä¸º MOVED</span></span><br><span class="line">            <span class="comment">//ä»£è¡¨è¯¥å¤„çš„æ•°æ®å·²ç»è¿ç§»è¿‡äº†ï¼Œå°† advance è®¾ç½®ä¸º trueï¼Œé€€å‡ºå¾ªç¯ç»§ç»­å¾€å‰</span></span><br><span class="line">            advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œç´¢å¼•ä¸º i å¤„çš„æ¡¶ä¸Šæœ‰æ•°æ®ï¼Œåˆ™å¯¹æ¡¶å¤„çš„å¤´èŠ‚ç‚¹åŠ é”</span></span><br><span class="line">            <span class="comment">//è¿›è¡Œè¿ç§»ï¼Œè¿ç§»å®Œæˆåä¼šå°† advance è®¾ç½®ä¸º true</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">//äºŒæ¬¡ç¡®è®¤ç´¢å¼•ä¸º i å¤„çš„æ¡¶çš„èŠ‚ç‚¹ä¸º f</span></span><br><span class="line">                    <span class="comment">//è¿›è¡Œæ•°æ®è¿ç§»ï¼Œè§åæ–‡ç»†è¯´</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é“¾è¡¨-x2F-æ ‘çš„è½¬ç§»"><a href="#é“¾è¡¨-x2F-æ ‘çš„è½¬ç§»" class="headerlink" title="é“¾è¡¨&#x2F;æ ‘çš„è½¬ç§»"></a>é“¾è¡¨&#x2F;æ ‘çš„è½¬ç§»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœå¤´èŠ‚ç‚¹ f çš„ hash å€¼å¤§äº0ï¼Œè¯´æ˜ä¸ºé“¾è¡¨</span></span><br><span class="line">        <span class="comment">//è®¡ç®—å‡º fh å’Œ n çš„ä¸è¿ç®—çš„ç»“æœï¼Œç”±äº n ä¸ºæ•°ç»„çš„é•¿åº¦ï¼Œæ˜¯2çš„æ¬¡å¹‚ï¼Œæ‰€ä»¥åªæœ‰æœ€é«˜ä½ä¸º1ï¼Œå…¶ä»–éƒ½ä¸º0</span></span><br><span class="line">        <span class="comment">//ä¸è¿ç®—è®¡ç®—å‡ºæ¥å runBit è¦ä¹ˆä¸º 0 ï¼Œè¦ä¹ˆä¸º n</span></span><br><span class="line">        <span class="comment">//å¦‚æœ runBid == 0 è¯´æ˜æ‰©å®¹å f ä¾æ—§åœ¨åŸæ¥çš„ index å¤„ï¼Œå¦åˆ™åœ¨ index + n å¤„</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">            <span class="comment">//éå†é“¾è¡¨ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåé¢å…¨éƒ¨ä¸ºç›¸åŒçš„ runBit çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">//ä¸¾ä¸ªä¾‹å­</span></span><br><span class="line">            <span class="comment">//é“¾è¡¨     ï¼š A-&gt;B-&gt;C-&gt;D-&gt;E-&gt;F-&gt;G</span></span><br><span class="line">            <span class="comment">//runBit å€¼ï¼š n-&gt;0-&gt;n-&gt;0-&gt;0-&gt;0-&gt;0</span></span><br><span class="line">            <span class="comment">//åˆ™è¿™ä¸ª for å¾ªç¯è·‘å®Œä»¥åï¼ŒlastRun åˆ™ä¸ºDï¼ŒrunBit = 0</span></span><br><span class="line">            <span class="comment">//åç»­åˆ™å¯ä»¥å°†è¿™ä¸ª D åé¢çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸€èµ·æŒªåŠ¨è¿‡å»ï¼Œå°±ä¸éœ€è¦å†ä¸€ä¸ªä¸€ä¸ªå¤„ç†</span></span><br><span class="line">            <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                runBit = b;</span><br><span class="line">                lastRun = p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ runBit == 0 è¯´æ˜è¿™äº›èŠ‚ç‚¹è¿˜è¦æ”¾åœ¨ç›¸åŒ index çš„æ¡¶é‡Œï¼Œèµ‹å€¼ç»™ ln</span></span><br><span class="line">            ln = lastRun;</span><br><span class="line">            hn = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ runBit == n è¯´æ˜è¿™äº›èŠ‚ç‚¹è¿˜è¦æ”¾åœ¨ç›¸åŒ index + n çš„æ¡¶é‡Œï¼Œèµ‹å€¼ç»™ hn</span></span><br><span class="line">            hn = lastRun;</span><br><span class="line">            ln = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">            <span class="comment">//å¾ªç¯ï¼Œæ„å»ºä¸¤ä¸ªé“¾è¡¨ï¼Œå°†èŠ‚ç‚¹æ’å…¥å¯¹åº”çš„é“¾è¡¨çš„å°¾éƒ¨</span></span><br><span class="line">            <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å°† ln æ’å…¥æ–°çš„ table çš„ i å¤„</span></span><br><span class="line">        setTabAt(nextTab, i, ln);</span><br><span class="line">        <span class="comment">//å°† ln æ’å…¥æ–°çš„ table çš„ i + n å¤„</span></span><br><span class="line">        setTabAt(nextTab, i + n, hn);</span><br><span class="line">        <span class="comment">//å°†æ—§çš„ table i å¤„ç½®ä¸º fwd</span></span><br><span class="line">        setTabAt(tab, i, fwd);</span><br><span class="line">        <span class="comment">//æ›´æ–° advance ä¸º trueï¼Œå‡†å¤‡ä¸‹æ¬¡ for å¾ªç¯</span></span><br><span class="line">        advance = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">        <span class="comment">//åŒç†å¯¹ TreeBin è¿›è¡Œè¿ç§»</span></span><br><span class="line">        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">        TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">        TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            <span class="keyword">int</span> h = e.hash;</span><br><span class="line">            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                    lo = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    loTail.next = p;</span><br><span class="line">                loTail = p;</span><br><span class="line">                ++lc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                    hi = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    hiTail.next = p;</span><br><span class="line">                hiTail = p;</span><br><span class="line">                ++hc;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">        setTabAt(nextTab, i, ln);</span><br><span class="line">        setTabAt(nextTab, i + n, hn);</span><br><span class="line">        setTabAt(tab, i, fwd);</span><br><span class="line">        advance = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…ƒç´ æ•°é‡è®¡æ•°"><a href="#å…ƒç´ æ•°é‡è®¡æ•°" class="headerlink" title="å…ƒç´ æ•°é‡è®¡æ•°"></a>å…ƒç´ æ•°é‡è®¡æ•°</h2><h3 id="size"><a href="#size" class="headerlink" title="size()"></a>size()</h3><blockquote><p>è·å– map ä¸­é”®å€¼å¯¹çš„æ•°é‡</p></blockquote><p>è¿”å› <code>sumCount</code> æ–¹æ³•çš„å€¼ï¼Œå¦‚æœå°äº0ï¼Œåˆ™è¿”å›0ï¼Œå¦‚æœè¶…è¿‡äº† Integer.MAX_VALUEï¼Œåˆ™è¿”å› Integer.MAX_VALUE</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">long</span> n = sumCount();</span><br><span class="line">      <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">              (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">              (<span class="keyword">int</span>)n);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="sumCount"><a href="#sumCount" class="headerlink" title="sumCount()"></a>sumCount()</h3><p>è¿”å› <code>baseCount</code> å’Œ <code>counterCells åˆ—è¡¨ä¸­å€¼çš„æ€»å’Œ</code> çš„å’Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">    <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£è¿™ä¸ª baseCount å’Œ counterCells æ˜¯ä»€ä¹ˆå‘¢ï¼Œæˆ‘ä»¬åœ¨å‰é¢ putVal çš„æµç¨‹ä¸­è¿˜æ²¡æœ‰ä»‹ç» addCount(1L,binCount) è¿™ä¸ªæ–¹æ³•ã€‚é€šè¿‡åå­—æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºæ¥è¿™æ˜¯ä¸ªç”¨æ¥å¢åŠ è®¡æ•°çš„æ–¹æ³•</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªæ–¹æ³•</p><h3 id="addCount-long-x-int-check"><a href="#addCount-long-x-int-check" class="headerlink" title="addCount(long x,int check)"></a>addCount(long x,int check)</h3><p><code>x</code> è¡¨ç¤ºæ–°å¢çš„èŠ‚ç‚¹æ•°</p><p><code>check</code> è¡¨ç¤ºæ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹æ£€æŸ¥ï¼Œå¦‚æœ &lt; 0 åˆ™ä¸è¿›è¡Œæ‰©å®¹</p><p>ä»å‰é¢ putVal ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå½“ä¸€ä¸ªé”®å€¼å¯¹èŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨ä¸­æ—¶ï¼Œ check çš„å€¼ä¸ºé“¾è¡¨çš„é•¿åº¦ï¼Œå½“æ’å…¥åˆ°çº¢é»‘æ ‘ä¸­æ—¶ï¼Œcheck ä¸º 2</p><p>è¿™ä¸ªæ–¹æ³•åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå‰ä¸€éƒ¨åˆ†æ˜¯é€šè¿‡ LongAdder çš„æ–¹å¼ï¼Œè¿›è¡Œè®¡æ•°ï¼ŒååŠéƒ¨åˆ†ä¸­ä¼šè¿›è¡Œæ‰©å®¹è¿ç§»æ“ä½œåï¼Œå†è¿›è¡Œè®¡æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">    CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">    <span class="comment">//ç¬¬ä¸€ä¸ªåˆ¤æ–­ï¼š(as = counterCells) != null</span></span><br><span class="line">    <span class="comment">//è¡¨ç¤º counterCells å·²ç»è¢«åˆå§‹åŒ–äº†</span></span><br><span class="line">    <span class="comment">//ç¬¬äºŒä¸ªåˆ¤æ–­ï¼šå°† baseCount é€šè¿‡ cas çš„æ–¹å¼ä¿®æ”¹ä¸º baseCount + x</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¿®æ”¹æˆåŠŸè¯´æ˜æ²¡æœ‰ç«äº‰</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¿®æ”¹å¤±è´¥ï¼Œè¯´æ˜å­˜åœ¨ç«äº‰ï¼Œåˆ™è¿›å…¥ä¸‹é¢çš„é€»è¾‘å¯¹ counterCells è¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">        !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">        CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//å‰ä¸¤ä¸ªåˆ¤æ–­ as == null || (m = as.length - 1) &lt; 0 </span></span><br><span class="line">        <span class="comment">//åˆ¤æ–­ counterCells æ˜¯å¦åˆå§‹åŒ–äº†ï¼Œå¹¶ä¸”æ•°ç»„ä¸­æ˜¯å¦æœ‰å†…å®¹</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ºè¿˜æœªåˆå§‹åŒ–æˆ–è€…æ•°ç»„ä¸­æ²¡æœ‰å†…å®¹ï¼Œåˆ™è°ƒç”¨ fullAddCount(x, true)</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ä¸ªåˆ¤æ–­æ˜¯åœ¨å‰ä¸¤ä¸ªåˆ¤æ–­éƒ½ä¸º false çš„åŸºç¡€ä¸Š</span></span><br><span class="line">        <span class="comment">//è¿›ä¸€æ­¥è·å– counterCells ä¸­å½“å‰çº¿ç¨‹æ‰€å¯¹åº”çš„ CounterCell å…ƒç´ </span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ºç©ºï¼Œåˆ™è°ƒç”¨ fullAddCount(x, true)</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™å°è¯•å¯¹ CounterCell é€šè¿‡ cas è¿›è¡Œç´¯åŠ ï¼Œç´¯åŠ æˆåŠŸåˆ™è¿›è¡Œä¸‹ä¸€æ­¥</span></span><br><span class="line">        <span class="comment">//ç´¯åŠ ä¸æˆåŠŸè¯´æ˜å­˜åœ¨ç«äº‰ï¼Œåˆ™è°ƒç”¨ fullAddCount(x, false)</span></span><br><span class="line">        <span class="comment">//uncontended ä»£è¡¨æ˜¯å¦æ— ç«äº‰</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            !(uncontended =</span><br><span class="line">              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">            <span class="comment">//è¯¦è§åé¢çš„å°èŠ‚</span></span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å½“ check &gt;= 0ï¼Œåˆ™å°è¯•æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">        <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">//å½“ä¸‹é¢çš„ä¸‰ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ—¶ï¼Œæ‰ä¼šè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">            <span class="comment">//1. å½“ s (èŠ‚ç‚¹æ•°é‡) &gt;= é˜ˆå€¼ sizeCtl äº†</span></span><br><span class="line">            <span class="comment">//2. table ä¸ä¸º null</span></span><br><span class="line">            <span class="comment">//3. table çš„é•¿åº¦å°äºæœ€å¤§å®¹é‡</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//rs çš„é«˜16ä½ä¸º0ï¼Œä½16ä¸ºå­˜å‚¨æ•°ç»„é•¿åº¦ n è®¡ç®—å‡ºæ¥çš„å€¼</span></span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;(</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//sc å³ç§»16ä½åï¼Œé«˜16ä½ä¸º0ï¼Œä½16ä½ä¸ºæ•°ç»„é•¿åº¦è®¡ç®—å‡ºçš„æ‰©å®¹æ ‡è¯†</span></span><br><span class="line">                <span class="comment">//(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs:æ‰©å®¹æ ‡è¯†ä¸åŒï¼Œ</span></span><br><span class="line">                <span class="comment">//  è¯´æ˜æ•°ç»„é•¿åº¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯èƒ½æ˜¯åˆ«çš„çº¿ç¨‹è§¦å‘äº†ç¬¬äºŒæ¬¡æ‰©å®¹</span></span><br><span class="line">                <span class="comment">//sc == rs + MAX_RESIZERS:å·²ç»è¾¾åˆ°æœ€å¤§çš„æ‰©å®¹çº¿ç¨‹æ•°é‡äº†</span></span><br><span class="line">                <span class="comment">//(nt = nextTable) == null :nextTable è¿˜æ²¡åˆ›å»º</span></span><br><span class="line">                <span class="comment">//transferIndex &lt;= 0 éœ€è¦è¿ç§»çš„åŒºé—´å·²ç»è¢«åˆ«çš„çº¿ç¨‹åˆ†å®Œäº†</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//å®é™…ä¸Šè¿™é‡Œæœ‰ä¸¤ä¸ª bug</span></span><br><span class="line">                <span class="comment">//1. sc == rs + 1</span></span><br><span class="line">                <span class="comment">//sc ç°åœ¨æ˜¯ä¸ªè´Ÿæ•°ï¼Œrs é«˜16ä½éƒ½ä¸º 0ï¼Œæ— è®ºå¦‚ä½• rs + 1 éƒ½ä¸ä¼šç­‰äº sc</span></span><br><span class="line">                <span class="comment">//fix:</span></span><br><span class="line">                <span class="comment">//sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 1</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//2. sc == rs + MAX_RESIZERS</span></span><br><span class="line">                <span class="comment">//MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1 = (1 &lt;&lt; 16) -1 = 65535</span></span><br><span class="line">                <span class="comment">//rs çš„å–å€¼èŒƒå›´ä¸º [32769,32799] è€Œ rs + MAX_RESIZERS &gt; 0 ä¸”è¿˜æ²¡æº¢å‡ºä¸ºè´Ÿæ•°</span></span><br><span class="line">                <span class="comment">//ä¹Ÿæ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰</span></span><br><span class="line">                <span class="comment">//fix:</span></span><br><span class="line">                <span class="comment">//sc == (rs &lt;&lt; RESIZE_STAMP_SHIFT) + MAX_RESIZERS</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//å°† rs å·¦ç§» 16ä½ï¼Œå…¶é«˜16ä½æ‰æ˜¯æ‰©å®¹æ ‡è¯†ï¼Œä½16ä¸ºå­˜å‚¨æ‰©å®¹çš„çº¿ç¨‹æ•° + 1</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//ä¸éœ€è¦æ‰©å®¹</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    <span class="comment">//æ­¤æ—¶æœ‰åˆ«çš„çº¿ç¨‹åœ¨æ‰©å®¹äº†ï¼Œåˆ™å¸®åŠ©è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                <span class="comment">//è¿›è¡Œæ‰©å®¹ï¼Œè¿™é‡Œæ˜¯ç¬¬ä¸€ä¸ªè¿›è¡Œæ‰©å®¹çš„çº¿ç¨‹</span></span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//è¿›è¡Œè®¡æ•°</span></span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="fullAddCount"><a href="#fullAddCount" class="headerlink" title="fullAddCount"></a>fullAddCount</h3><p>private final void fullAddCount(long x, boolean wasUncontended)</p><p><code>x</code>è¡¨ç¤ºæ–°å¢çš„èŠ‚ç‚¹æ•°é‡</p><p><code>wasUncontented</code> è¡¨ç¤ºæ˜¯å¦æ— ç«äº‰</p><pre><code>true == è¡¨ç¤ºæ²¡æœ‰ç«äº‰false == è¡¨ç¤ºæœ‰ç«äº‰</code></pre><p>åœ¨ ConcurrentHashMap ä¸­ï¼Œå…¶å®æ˜¯å¤åˆ¶äº†ä¸€ä»½ LongAdder çš„æºç ï¼Œåœ¨ ConcurrentHashMap ä¸­ï¼Œç”±äºå¹¶å‘æƒ…å†µå¤šï¼Œå¦‚æœä½¿ç”¨ AtomicLong çš„æ–¹å¼è¿›è¡Œè®°å½•ï¼Œå¦‚æœ N ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ AtomicLong è¿›è¡Œä¿®æ”¹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä¿®æ”¹æˆåŠŸï¼Œå…¶ä»–çº¿ç¨‹åˆ™ä¼šå¤„äºè‡ªæ—‹ç­‰å¾…çŠ¶æ€ï¼Œè€Œ LongAdder çš„æ–¹å¼æ˜¯ä½¿ç”¨ä¸€ä¸ªå˜é‡ baseCount+æ•°ç»„ CounterCell[]ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å»ç»´æŠ¤è‡ªå·±çš„ä¸€ä¸ªå˜é‡ï¼Œå‡å°‘ç¢°æ’å†²çªï¼Œæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤æ•°ç»„ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸­å­˜å‚¨ä¸€ä¸ªå€¼ï¼›ä» CounterCell[] ä¸­è·å–åˆ°å¯¹åº”çš„å€¼å¹¶è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœä¿®æ”¹å¤±è´¥ï¼Œåˆ™å°è¯•ä¿®æ”¹ baseCount çš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">fullAddCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">if</span> ((h = ThreadLocalRandom.getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">        ThreadLocalRandom.localInit();      <span class="comment">// force initialization</span></span><br><span class="line">        h = ThreadLocalRandom.getProbe();</span><br><span class="line">        <span class="comment">//è¿˜æ²¡åˆå§‹åŒ–ï¼Œæ‰€ä»¥ä¸å­˜åœ¨ç«äº‰ï¼Œå°† wasUncontended è®¾ç½®ä¸º true</span></span><br><span class="line">        wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//collide è¡¨ç¤ºæ˜¯å¦å¤šä¸ªçº¿ç¨‹ hash åˆ°åŒä¸€ä¸ª CounterCell äº§ç”Ÿç¢°æ’äº†</span></span><br><span class="line">    <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        CounterCell[] as; CounterCell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ counterCells ä¸ä¸º null ä¸” counterCells é•¿åº¦å¤§äº 0</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//å–åˆ° counterCells ä¸­å¯¹åº”çº¿ç¨‹çš„ CounterCell ä¸ºç©º</span></span><br><span class="line">                <span class="comment">//cellsBusy å­—æ®µä¸º 1 è¯´æ˜ counterCells æ­£åœ¨åˆå§‹åŒ–æˆ–è€…æ‰©å®¹</span></span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;            <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                    <span class="comment">//ä¸‹é¢ä¸ºå°è¯•åˆ›å»ºä¸€ä¸ª CounterCell å¯¹è±¡å¹¶å­˜åˆ° counterCells æ•°ç»„å¯¹åº”çš„ç´¢å¼•å¤„</span></span><br><span class="line">                    CounterCell r = <span class="keyword">new</span> CounterCell(x); <span class="comment">// Optimistic create</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                        <span class="comment">//counterCells ä¸ºæ­£å¸¸çŠ¶æ€ä¸”ä¿®æ”¹ cellsBusy ä¸º1 æˆåŠŸ</span></span><br><span class="line">                        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            CounterCell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = counterCells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">//j æ˜¯å½“å‰çº¿ç¨‹çš„ hash å€¼è®¡ç®—å¾—å‡ºçš„ç´¢å¼•</span></span><br><span class="line">                                <span class="comment">//å¯¹ counterCells ä¸­ j å¤„çš„å…ƒç´ è¿›è¡Œæ›¿æ¢</span></span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created)</span><br><span class="line">                            <span class="comment">//åˆ›å»ºæˆåŠŸï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//åˆ›å»ºä¸æˆåŠŸï¼Œåˆ™è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                        <span class="comment">//å¯èƒ½æ˜¯å› ä¸º rs[j] != nullï¼Œå³è¯¥å¤„æœ‰å€¼äº†</span></span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       </span><br><span class="line">                <span class="comment">// cas å¤±è´¥äº†ï¼Œåˆ™è®¾ç½®ä¸º trueï¼Œåœ¨ä¸‹æ¬¡å¾ªç¯çš„æ—¶å€™é‡æ–°è®¡ç®— hash å†è¿›è¡Œåˆ†é…</span></span><br><span class="line">                wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))</span><br><span class="line">                <span class="comment">//ä¿®æ”¹å½“å‰ CounterCell ä¸­çš„ value æˆåŠŸï¼Œåˆ™é€€å‡º</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (counterCells != as || n &gt;= NCPU)</span><br><span class="line">                <span class="comment">//counterCells != as è¯´æ˜ counterCells è¢«æ‰©å®¹äº†</span></span><br><span class="line">                <span class="comment">//æˆ–è€… as å¤§äºç­‰äº CPU çš„æ•°é‡äº†ï¼Œç­‰å¾…ä¸‹ä¸€è½®é‡è¯•</span></span><br><span class="line">                collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                <span class="comment">//ä¸Šè¿°æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œè¯´æ˜äº§ç”Ÿäº†ç¢°æ’ï¼Œä¸”ç«äº‰å¤±è´¥äº†</span></span><br><span class="line">                <span class="comment">//å°†å€¼ collide ä¿®æ”¹ä¸º trueï¼Œä¸‹ä¸€æ¬¡å¾ªç¯å°±å¯ä»¥èµ°åˆ°ä¸‹ä¸ª if ä¸­</span></span><br><span class="line">                collide = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">//counterCells å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œä¸”ä¿®æ”¹ cellsBusy å€¼ä¸º1æˆåŠŸ</span></span><br><span class="line">                <span class="comment">//åˆ™å¯¹ counterCells è¿›è¡Œæ‰©å®¹å¹¶è¿ç§»æ•°æ®ï¼Œ</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (counterCells == as) &#123;<span class="comment">// Expand table unless stale</span></span><br><span class="line">                        CounterCell[] rs = <span class="keyword">new</span> CounterCell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        counterCells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é‡æ–°è®¡ç®— hash å€¼</span></span><br><span class="line">            h = ThreadLocalRandom.advanceProbe(h);</span><br><span class="line">        &#125;<span class="comment">//è¿™é‡Œæ˜¯ (as = counterCells) != null &amp;&amp; (n = as.length) &gt; 0 è¿™ä¸ªæ¡ä»¶ç»“æŸçš„åœ°æ–¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; counterCells == as &amp;&amp;</span><br><span class="line">                    U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ counterCells ä¸ºç©ºï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–ï¼Œå®¹é‡ä¸º2ï¼Œå¹¶å°† CounterCell æ”¾è¿›æ•°ç»„ä¸­</span></span><br><span class="line">            <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;                           <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (counterCells == as) &#123;</span><br><span class="line">                    CounterCell[] rs = <span class="keyword">new</span> CounterCell[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> CounterCell(x);</span><br><span class="line">                    counterCells = rs;</span><br><span class="line">                    init = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//èµ°åˆ°è¿™é‡Œè¯´æ˜ counterCells ä¸ºç©ºï¼Œä¸”ç«äº‰åˆå§‹åŒ–å¤±è´¥äº†ï¼Œåˆ™å°è¯•å°† x åŠ åˆ° baseCount ä¸Š</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, v = baseCount, v + x))</span><br><span class="line">            <span class="keyword">break</span>;<span class="comment">// Fall back on using base</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±çœ‹å®Œäº† ConcurrentHashMap ä¸­çš„ put çš„æ–¹æ³•</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://segmentfault.com/a/1190000039055166">é€šä¿—æ˜“æ‡‚çš„JUCæºç å‰–æ-LongAdder&#x2F;LongAccumulator</a></li><li><a href="https://xilidou.com/2018/11/27/LongAdder/">ä» LongAdder ä¸­çª¥è§å¹¶å‘ç»„ä»¶çš„è®¾è®¡æ€è·¯</a></li><li><a href="https://mp.weixin.qq.com/s/9x1V8DG3fv-4bgXYs5b6Hw">ç²¾å¦™ç»ä¼¦çš„å¹¶å‘è‰ºæœ¯å“ â€” ConcurrentHashMapæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„</a></li><li><a href="https://www.cnblogs.com/zerotomax/p/8687425.html">ConcurrentHashMapæºç åˆ†æ(1.8)</a></li><li><a href="https://www.meetkiki.com/archives/%E4%BB%8E%E6%AD%BB%E5%BE%AA%E7%8E%AFBUG%E6%9D%A5%E8%81%8A%E8%81%8AConcurrentHashMap%E7%9A%84%E6%89%A7%E8%A1%8C%E5%86%85%E5%B9%95(%E4%B8%8A)">ä»æ­»å¾ªç¯BUGæ¥èŠèŠConcurrentHashMapçš„æ‰§è¡Œå†…å¹•ï¼ˆä¸Šï¼‰</a></li><li><a href="https://www.hegongshan.com/2020/03/06/java-collections-api-concurrenthashmap/">Javaå®¹å™¨æ¢ç§˜ä¹‹æ—… ConcurrentHashMap</a></li><li><a href="http://ljh.gold/java-10/">ConcurrentHashMap</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡åŸºäº JDK 1.8 åˆ†æ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;HashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œåœ¨å¤šçº¿ç¨‹å¹¶å‘ put å¯¼è‡´ resizeï¼Œåœ¨ transfer è¿‡ç¨‹ä¸­å¯èƒ½å¯¼è‡´æ­»é”æˆ–è€…æ•°æ®ä¸¢å¤±&lt;/p&gt;
&lt;p&gt;è€Œ ConcurrentHashMap åˆ™æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Map ç±»ï¼Œåœ¨ HashMap çš„åŸºç¡€ä¸Šåšäº†çº¿ç¨‹å®‰å…¨çš„å¤„ç†&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Java" scheme="https://ppting.me/categories/Java/"/>
    
    <category term="æºç " scheme="https://ppting.me/categories/%E6%BA%90%E7%A0%81/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://ppting.me/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
    <category term="Map" scheme="https://ppting.me/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>RxJava2 åŸç†è§£æ</title>
    <link href="https://ppting.me/2021/11/24/2021_11_24_rxjava/"/>
    <id>https://ppting.me/2021/11/24/2021_11_24_rxjava/</id>
    <published>2021-11-23T16:00:00.000Z</published>
    <updated>2022-02-12T08:16:58.000Z</updated>
    
    <content type="html"><![CDATA[<br><blockquote><p>RxJava is a Java VM implementation of Reactive Extensions: a library for composing asynchronous and event-based programs by using observable sequences.<br>RxJava æ˜¯ Reactive Extensions çš„ Java VM å®ç°ï¼šä¸€ä¸ªä½¿ç”¨å¯è§‚å¯Ÿåºåˆ—ç»„åˆå¼‚æ­¥å’ŒåŸºäºäº‹ä»¶çš„ç¨‹åºçš„åº“ã€‚</p></blockquote><p>RxJava é€šè¿‡è§‚å¯Ÿè€…è®¢é˜…è¢«è§‚å¯Ÿè€…è¿›è¡Œäº‹ä»¶çš„åˆ†å‘ï¼Œå¹¶æä¾›äº†å¾ˆå¤šè¢«è§‚å¯Ÿè€…(å³äº‹ä»¶å‘é€è€…)çš„åˆ›å»ºæ–¹æ³•å’Œäº‹ä»¶è½¬æ¢çš„æ“ä½œç¬¦å‡½æ•°(mapã€flatmapã€filter ç­‰ç­‰)</p><span id="more"></span><p>ä¸‹é¢ä»¥æœ€ç®€å•çš„ä¸€ä¸ª SingleJust çš„å‘å°„å’Œè®¢é˜…ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹ RxJava ä¸­åˆ°åº•æ˜¯å¦‚ä½•è¿›è¡Œè®¢é˜…çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SingleJust.just(<span class="number">0</span>)</span><br><span class="line">        .map(<span class="keyword">new</span> Function&lt;Integer, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(<span class="meta">@NonNull</span> Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> integer.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹ä¸€ä¸‹ <code>SingleJust.just(1)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CheckReturnValue</span></span><br><span class="line"><span class="meta">@SchedulerSupport(SchedulerSupport.NONE)</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Single&lt;T&gt; <span class="title">just</span><span class="params">(<span class="keyword">final</span> T item)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ£€æŸ¥æ ¡éªŒå‚æ•°ä¸èƒ½ä¸º null</span></span><br><span class="line">    ObjectHelper.requireNonNull(item, <span class="string">&quot;item is null&quot;</span>);</span><br><span class="line">    <span class="comment">//è¿™æ˜¯ä¸ª hook æ–¹æ³•ï¼Œä¸€èˆ¬é»˜è®¤è¿”å›ä¼ å…¥çš„å¯¹è±¡æœ¬èº«</span></span><br><span class="line">    <span class="comment">//å¦‚æœè®¾ç½®äº† hook å¯¹è±¡(Function)ï¼Œåˆ™ä¼šå¯¹å…¶è¿›è¡Œä¸€äº›æ“ä½œåå†è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> SingleJust&lt;T&gt;(item));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//RxJavaPlugins.onAssembly</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Single&lt;T&gt; <span class="title">onAssembly</span><span class="params">(<span class="meta">@NonNull</span> Single&lt;T&gt; source)</span> </span>&#123;</span><br><span class="line">    Function&lt;? <span class="keyword">super</span> Single, ? extends Single&gt; f = onSingleAssembly;</span><br><span class="line">    <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> apply(f, source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹çœ‹ä¸€ä¸‹ <code>SingleJust.java</code> ç±»</p><p>å¾ˆç®€å•çš„ä¸€ä¸ªç±»ï¼Œç»§æ‰¿ Single<T> ç±»ï¼Œæ„é€ æ–¹æ³•ä¸­ä¼ å…¥ä¸€ä¸ª <code>value</code>ï¼Œå¹¶å®ç° <code>subscribeActual()</code> æ–¹æ³•<br>åœ¨ <code>subscribeActual()</code> æ–¹æ³•ä¸­è°ƒç”¨ä¼ å…¥çš„ observer çš„ <code>onSubscribe()</code> æ–¹æ³•å’Œ <code>onSuccess()</code> æ–¹æ³• </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleJust</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Single</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SingleJust</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">        observer.onSubscribe(Disposables.disposed());</span><br><span class="line">        observer.onSuccess(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>subscribeActual()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>observer</code>ï¼ˆè§‚å¯Ÿè€…ï¼‰çš„ <code>onSubscribe()</code> å’Œ <code>onSuccess()</code> æ–¹æ³•<br>è‡³äº <code>subscribeActual()</code> ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„ï¼Œæˆ‘ä»¬ä¸€ä¼šå†çœ‹</p><p>å†æ¥ç€çœ‹ <code>Single.map()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CheckReturnValue</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="meta">@SchedulerSupport(SchedulerSupport.NONE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;R&gt; <span class="function">Single&lt;R&gt; <span class="title">map</span><span class="params">(Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ£€æŸ¥å…¥å‚</span></span><br><span class="line">    ObjectHelper.requireNonNull(mapper, <span class="string">&quot;mapper is null&quot;</span>);</span><br><span class="line">    <span class="comment">//è¿”å›ä¸€ä¸ª SingleMap å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> SingleMap&lt;T, R&gt;(<span class="keyword">this</span>, mapper));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çœ‹ä¸‹ <code>SingleMap</code> çš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleMap</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">Single</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SingleMap</span><span class="params">(SingleSource&lt;? extends T&gt; source, Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> R&gt; t)</span> </span>&#123;</span><br><span class="line">        source.subscribe(<span class="keyword">new</span> MapSingleObserver&lt;T, R&gt;(t, mapper));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapSingleObserver</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">SingleObserver</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> R&gt; t;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper;</span><br><span class="line"></span><br><span class="line">        MapSingleObserver(SingleObserver&lt;? <span class="keyword">super</span> R&gt; t, Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper) &#123;</span><br><span class="line">            <span class="keyword">this</span>.t = t;</span><br><span class="line">            <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">            t.onSubscribe(d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">            R v;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                v = ObjectHelper.requireNonNull(mapper.apply(value), <span class="string">&quot;The mapper function returned a null value.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                Exceptions.throwIfFatal(e);</span><br><span class="line">                onError(e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            t.onSuccess(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">            t.onError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§ SingleMap çš„æ„é€ æ–¹æ³•ä¸­<br>ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•° <code>SingleSource source</code>ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„ SingleSouce å¯¹è±¡<br>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸ª <code>Function mapper</code>ï¼Œå³è½¬æ¢æ–¹æ³•</p><p>åŒæ ·çš„ï¼Œ<code>subscribeActual(final SingleObserver&lt;? super R&gt; t)</code> æ–¹æ³•é‡Œè°ƒç”¨äº† <code>source:SingleSource</code> çš„ subscribe æ–¹æ³•ï¼Œä¼ å…¥äº†ä¸€ä¸ª <code>MapSingleObserver</code> å¯¹è±¡</p><p>MapSingleObserver ç›¸å½“äºä¸€ä¸ªä»£ç†ç±»ï¼Œå¯¹ <code>subscribeActual()</code> æ–¹æ³•ä¸­çš„ t è¿›è¡Œä»£ç†ï¼Œå½“ mapSingleObserver çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå°±ä¼šè°ƒç”¨å…¶æ„é€ æ–¹æ³•ä¸­ä¼ å…¥çš„ t è¿›è¡Œè°ƒç”¨ï¼Œåœ¨ <code>onSuccess()</code> ä¸­å…ˆä½¿ç”¨ mapper å¯¹æ•°æ®è¿›è¡Œå¤„ç†åï¼Œå¾—åˆ° resultï¼Œå†è°ƒç”¨ <code>t.onSuccess(result)</code> è¿›è¡Œå›è°ƒ</p><p>å†å›è¿‡å¤´æ¥çœ‹ <code>subscribe()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Disposable <span class="title">subscribe</span><span class="params">(<span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> T&gt; onSuccess, <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> Throwable&gt; onError)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¯¹å‚æ•°è¿›è¡Œæ£€æŸ¥</span></span><br><span class="line">    ObjectHelper.requireNonNull(onSuccess, <span class="string">&quot;onSuccess is null&quot;</span>);</span><br><span class="line">    ObjectHelper.requireNonNull(onError, <span class="string">&quot;onError is null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯¹ä¼ å…¥çš„è§‚å¯Ÿè€…è¿›è¡ŒåŒ…è£…ä¸ºä¸€ä¸ª ConsumerSingleObserver</span></span><br><span class="line">    ConsumerSingleObserver&lt;T&gt; observer = <span class="keyword">new</span> ConsumerSingleObserver&lt;T&gt;(onSuccess, onError);</span><br><span class="line">    <span class="comment">//å†è°ƒç”¨ subscribe æ–¹æ³•è®¢é˜…</span></span><br><span class="line">    subscribe(observer);</span><br><span class="line">    <span class="keyword">return</span> observer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ä¾æ—§æ˜¯è¿›è¡Œå‚æ•°æ£€æŸ¥</span></span><br><span class="line">    ObjectHelper.requireNonNull(observer, <span class="string">&quot;observer is null&quot;</span>);</span><br><span class="line">    <span class="comment">//åŒä¸Šç†ï¼Œè¿›è¡Œ hook é…ç½®</span></span><br><span class="line">    observer = RxJavaPlugins.onSubscribe(<span class="keyword">this</span>, observer);</span><br><span class="line"></span><br><span class="line">    ObjectHelper.requireNonNull(observer, <span class="string">&quot;The RxJavaPlugins.onSubscribe hook returned a null SingleObserver. Please check the handler provided to RxJavaPlugins.setOnSingleSubscribe for invalid null returns. Further reading: https://github.com/ReactiveX/RxJava/wiki/Plugins&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//é‡ç‚¹åœ¨äºè¿™é‡Œï¼Œè°ƒç”¨äº† subscribeActual æ–¹æ³•</span></span><br><span class="line">        <span class="comment">//subscribeActual æ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å„ä¸ªå­ç±»è¿›è¡Œå®ç°</span></span><br><span class="line">        <span class="comment">//äºæ˜¯è¿™é‡Œå°±ä¼šè°ƒç”¨åˆ°äº†æˆ‘ä»¬ä¸Šé¢æ‰€çœ‹åˆ°çš„ SingleJust ç±»ä¸­çš„ subscribeActual æ–¹æ³•ï¼Œå®Œæˆäº†æ•´ä¸ª RxJava çš„æµç¨‹</span></span><br><span class="line">        subscribeActual(observer);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Exceptions.throwIfFatal(ex);</span><br><span class="line">        NullPointerException npe = <span class="keyword">new</span> NullPointerException(<span class="string">&quot;subscribeActual failed&quot;</span>);</span><br><span class="line">        npe.initCause(ex);</span><br><span class="line">        <span class="keyword">throw</span> npe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šè¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œåœ¨ RxJava ä¸­ï¼Œå°±æ˜¯ç”±æœ€ä¸‹æ¸¸çš„ subscribe() æ–¹æ³•ä¸­çš„å‚æ•° observer ï¼Œæœ€ç»ˆè°ƒç”¨äº‹ä»¶å‘å‡ºè€…çš„ subscribeActual() æ–¹æ³•</p><p>ä¸Šè¿°çš„ä»£ç çš„æµç¨‹æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ä¼ªä»£ç æ¥è¿›è¡Œç†è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æœ€åè¢«æ‰§è¡Œ</span></span><br><span class="line">SingleObserver.subscribeActual()&#123;</span><br><span class="line">    <span class="comment">//ç¬¬äºŒä¸ªè¢«æ‰§è¡Œ</span></span><br><span class="line">    SingleMap.subscribeActual()&#123;</span><br><span class="line">        <span class="comment">//æœ€å…ˆæ‰§è¡Œ</span></span><br><span class="line">        SingleJust.subscribeActual()&#123;</span><br><span class="line">            <span class="comment">//create </span></span><br><span class="line">            onSubscribe()</span><br><span class="line">            onSuccess()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ç†ä¸€ä¸‹ï¼ŒRxJava çš„äº‹ä»¶æµèµ·å§‹åœ¨äºè°ƒç”¨äº† <code>subscribe()</code> æ–¹æ³•ï¼Œç„¶åä¸€å±‚ä¸€å±‚åœ°è°ƒç”¨ä¸Šæ¸¸çš„ <code>subscribeActual(SingleObserver&lt;? super T&gt; observer)</code> æ–¹æ³•ï¼ŒåŒæ—¶ä¹ŸæŠŠæŠŠè‡ªå·±ä¼ ç»™ä¸Šæ¸¸</p><p>å¯¹äºæ“ä½œç¬¦æ¥è¯´ï¼Œå…¶ <code>subscribeActual()</code> æ–¹æ³•ä¼šè°ƒç”¨å…¶ä¸Šæ¸¸çš„ <code>subscribe() -&gt; subscribeActual()</code> æ–¹æ³•ï¼Œç›´åˆ°æœ€ä¸Šæ¸¸çš„ç”Ÿäº§è€…</p><p>å¯¹äºç”Ÿäº§è€…æ¥è¯´ï¼Œå…¶ <code>subscribeActual()</code> æ–¹æ³•åˆ™æ˜¯åœ¨ç”Ÿäº§æ•°æ®ï¼Œè°ƒç”¨ä¸‹æ¸¸è§‚å¯Ÿè€…(å³ä» subscribeActual() æ–¹æ³•ä¸­ä¼ å…¥çš„å‚æ•°) çš„å›è°ƒæ–¹æ³•</p><p>æ‰€ä»¥å®é™…ä¸Šå°±æ˜¯åé¢çš„ observer åœ¨å€’åºåœ°è°ƒç”¨ä¸Šæ¸¸çš„ subscribeActual() æ–¹æ³•ï¼Œç„¶åä¸æ–­è°ƒç”¨ä¸‹æ¸¸çš„ onSuccess&#x2F;onSubscribe&#x2F;onError ç­‰ç­‰æ–¹æ³•</p><blockquote><p>æ“ä½œç¬¦æŒæœ‰è°ƒç”¨å®ƒçš„ä¸Šæ¸¸çš„å¼•ç”¨ï¼Œå¹¶åœ¨è¢«è®¢é˜…çš„æ—¶å€™(<code>subscribeActual()</code>) å°†ä¸‹æ¸¸è¿›è¡Œä»£ç†åï¼Œå»è®¢é˜…å…¶ä¸Šæ¸¸</p></blockquote><p>åŒç†ï¼ŒObservable&#x2F;Flowable ç­‰ RxJava çš„äº‹ä»¶æµä¹Ÿæ˜¯åŒæ ·çš„æµç¨‹</p><p>ç”»ä¸ªæµç¨‹å›¾<br><img src="https://i.loli.net/2021/11/24/j13eldyRuYn6NSv.png" alt="RxJava.drawio _1_.png"></p><h2 id="RxJava-çš„çº¿ç¨‹åˆ‡æ¢"><a href="#RxJava-çš„çº¿ç¨‹åˆ‡æ¢" class="headerlink" title="RxJava çš„çº¿ç¨‹åˆ‡æ¢"></a>RxJava çš„çº¿ç¨‹åˆ‡æ¢</h2><ul><li><p>subscribeOn()</p><blockquote><p>æŒ‡å®šäº‹ä»¶äº§ç”Ÿçš„çº¿ç¨‹</p></blockquote></li><li><p>observeOn()</p><blockquote><p>æŒ‡å®šäº‹ä»¶æ¶ˆè´¹çš„çº¿ç¨‹</p></blockquote></li></ul><p>RxJava ä¸­çš„çº¿ç¨‹è°ƒåº¦æ˜¯é€šè¿‡ <code>subscribeOn(Scheduler scheduler)</code> å’Œ <code>observeOn(Scheduler scheduler)</code> ä¸¤ä¸ªæ–¹æ³•å®Œæˆçš„<br><code>subscribeOn()</code> æ–¹æ³•è°ƒåº¦çš„æ˜¯ä¸Šæ¸¸åˆ°ç¬¬ä¸€ä¸ª <code>observeOn()</code> ä¹‹é—´çš„çš„çº¿ç¨‹<br><code>observeOn()</code> è°ƒåº¦çš„æ˜¯è¯¥ <code>observeOn()</code> åˆ°ä¸‹ä¸€ä¸ª <code>observeOn()</code> ä¹‹é—´çš„çš„çº¿ç¨‹</p><p>æ‰€ä»¥åœ¨ RxJava ä¸­å¯ä»¥è¿›è¡Œä»»æ„çš„çº¿ç¨‹è°ƒåº¦ï¼Œä½†æ˜¯ï¼Œ<code>subscribeOn()</code> æ–¹æ³•åˆ™æœ‰æ‰€åŒºåˆ«ï¼Œå¦‚æœæœ‰å¤šä¸ª <code>subscribeOn()</code> æ–¹æ³•ï¼Œåªæœ‰æœ€é è¿‘ä¸Šæ¸¸çš„ <code>subscribeOn()</code> èµ·ä½œç”¨ï¼Œè€Œå…¶ä»–çš„ <code>subscribeOn()</code> æ–¹æ³•ä¸èµ·ä½œç”¨ï¼Œä½†æ˜¯è¿™å…¶ä¸­ä¹Ÿæœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå½“ä½¿ç”¨ <code>doOnSubscribe()</code> æ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å‘ç”Ÿåœ¨ <code>subscribe()</code> è°ƒç”¨åè€Œä¸”åœ¨äº‹ä»¶å‘é€å‰ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¯ä»¥æŒ‡å®šçº¿ç¨‹çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>doOnSubscribe()</code> æ‰§è¡Œåœ¨ <code>subscribe()</code> å‘ç”Ÿçš„çº¿ç¨‹ï¼›è€Œå¦‚æœåœ¨ <code>doOnSubscribe()</code> ä¹‹åæœ‰ <code>subscribeOn()</code> çš„è¯ï¼Œå®ƒå°†æ‰§è¡Œåœ¨ç¦»å®ƒæœ€è¿‘çš„ <code>subscribeOn()</code> æ‰€æŒ‡å®šçš„çº¿ç¨‹ã€‚</p><p><code>subscribeOn()</code> å’Œ <code>observeOn()</code> æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ª <code>Schedule</code> å¯¹è±¡</p><h3 id="Schedule"><a href="#Schedule" class="headerlink" title="Schedule"></a>Schedule</h3><p><code>Schedule</code> æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶å­ç±»æœ‰æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ <code>Schedulers.io()</code>ã€<code>Schedulers.newThread()</code> ä»¥åŠ <code>AndroidSchedulers.mainThread()</code> ç­‰ç­‰</p><p>ä¸¾ä¸ªä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>)</span><br><span class="line">        <span class="comment">//---------1 start ------------//</span></span><br><span class="line">        .flatMap(<span class="keyword">new</span> Function&lt;Integer, ObservableSource&lt;Integer&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ObservableSource&lt;Integer&gt; <span class="title">apply</span><span class="params">(Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;flatMap&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,Thread.currentThread().toString());</span><br><span class="line">                <span class="keyword">return</span> Observable.just(integer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//---------1 end ------------//</span></span><br><span class="line">        .subscribeOn(Schedulers.newThread())<span class="comment">//è°ƒåº¦ä»ä¸Šæ¸¸åˆ°ç¬¬ä¸€ä¸ª observerOn() æ–¹æ³•ä¹‹é—´çš„çº¿ç¨‹ï¼Œå³ 1 å’Œ 2</span></span><br><span class="line">        <span class="comment">//---------2 start ------------//</span></span><br><span class="line">        .map(<span class="keyword">new</span> Function&lt;Integer, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(Integer integer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;map&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,Thread.currentThread().toString());</span><br><span class="line">                <span class="keyword">return</span> String.valueOf(integer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//---------2 end ------------//</span></span><br><span class="line">        <span class="comment">//---------3 start ------------//</span></span><br><span class="line">        .doOnSubscribe(<span class="keyword">new</span> Consumer&lt;Disposable&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Disposable disposable)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;3&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;doOnSubscribe&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,Thread.currentThread().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//---------3 end ------------//</span></span><br><span class="line">        .observeOn(Schedulers.computation())<span class="comment">//è°ƒåº¦ä¸‹é¢çš„çº¿ç¨‹ï¼Œå³4 å’Œ5</span></span><br><span class="line">        <span class="comment">//---------4 start ------------//</span></span><br><span class="line">        .map(<span class="keyword">new</span> Function&lt;String, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;4&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;map&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,Thread.currentThread().toString());</span><br><span class="line">                <span class="keyword">return</span> s + <span class="string">&quot; map &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//---------4 end ------------//</span></span><br><span class="line">        <span class="comment">//åªèƒ½å†³å®š doOnSubscribe ä¸­çš„çº¿ç¨‹ï¼Œå³3</span></span><br><span class="line">        <span class="comment">//.subscribeOn(Schedulers.newThread())</span></span><br><span class="line">        <span class="comment">//---------5 start ------------//</span></span><br><span class="line">        .subscribe(<span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;5&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;subscribe&quot;</span>);</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,Thread.currentThread().toString());</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;result is &quot;</span>+s);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//---------5 end ------------//</span></span><br></pre></td></tr></table></figure><p>æ‰“å°å‡ºæ¥çš„æ—¥å¿—ä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">D/MainActivity: 3</span><br><span class="line">D/MainActivity: doOnSubscribe</span><br><span class="line">D/MainActivity: Thread[main,5,main]</span><br><span class="line">D/MainActivity: 1</span><br><span class="line">D/MainActivity: flatMap</span><br><span class="line">D/MainActivity: Thread[RxNewThreadScheduler-1,5,main]</span><br><span class="line">D/MainActivity: 2</span><br><span class="line">D/MainActivity: map</span><br><span class="line">D/MainActivity: Thread[RxNewThreadScheduler-1,5,main]</span><br><span class="line">D/MainActivity: 4</span><br><span class="line">D/MainActivity: map</span><br><span class="line">D/MainActivity: Thread[RxComputationThreadPool-1,5,main]</span><br><span class="line">D/MainActivity: 5</span><br><span class="line">D/MainActivity: subscribe</span><br><span class="line">D/MainActivity: Thread[RxComputationThreadPool-1,5,main]</span><br><span class="line">D/MainActivity: result is 1 map </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º doOnSubscribe æ˜¯æœ€å…ˆè¢«æ‰§è¡Œçš„</p><p>ç¬¬ä¸€ä¸ª <code>subscribeOn(Schedulers.io())</code> è°ƒåº¦çš„æ˜¯æœ€ä¸Šæ¸¸çš„ 1 å’Œ 2 ä¸­çš„çº¿ç¨‹<br>ç¬¬äºŒä¸ª <code>subscribeOn(Schedulers.newThread())</code> ä¸èµ·ä½œç”¨ï¼Œåªèƒ½è°ƒåº¦ 3 ä¸­çš„çº¿ç¨‹<br>ç¬¬ä¸‰ä¸ª <code>observeOn(Schedulers.computation())</code> è°ƒåº¦çš„æ˜¯å…¶åé¢çš„ä»£ç çš„çº¿ç¨‹ï¼Œå³ 4 å’Œ 5</p><h3 id="subscribeOn"><a href="#subscribeOn" class="headerlink" title="subscribeOn()"></a>subscribeOn()</h3><p>æˆ‘ä»¬é€šè¿‡æºç ä¸€æ­¥ä¸€æ­¥çœ‹ï¼ŒsubscribeOn åˆ°åº•æ˜¯å¦‚ä½•è°ƒåº¦çº¿ç¨‹çš„</p><p>åŒä¸Šï¼Œä¹Ÿæ˜¯å…ˆæ ¡éªŒ scheduler ä¸ä¸ºç©º<br>ç„¶åå°† scheduler åŒ…è£…ä¸ºä¸€ä¸ª ObservableSubscribeOn å¹¶è¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">io.reactivex.Observable#subscribeOn</span><br><span class="line"><span class="meta">@CheckReturnValue</span></span><br><span class="line"><span class="meta">@SchedulerSupport(SchedulerSupport.CUSTOM)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">subscribeOn</span><span class="params">(Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(scheduler, <span class="string">&quot;scheduler is null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableSubscribeOn&lt;T&gt;(<span class="keyword">this</span>, scheduler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">io.reactivex.internal.operators.observable.ObservableSubscribeOn#<span class="function">ObservableSubscribeOn</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ObservableSubscribeOn</span><span class="params">(ObservableSource&lt;T&gt; source, Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(source);</span><br><span class="line">    <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(<span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SubscribeOnObserver&lt;T&gt; parent = <span class="keyword">new</span> SubscribeOnObserver&lt;T&gt;(observer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨ä¸‹æ¸¸çš„ onSubscribe() æ–¹æ³•ï¼Œ</span></span><br><span class="line">    observer.onSubscribe(parent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//â‘¥</span></span><br><span class="line">    parent.setDisposable(scheduler.scheduleDirect(<span class="keyword">new</span> SubscribeTask(parent)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscribeTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SubscribeOnObserver&lt;T&gt; parent;</span><br><span class="line"></span><br><span class="line">    SubscribeTask(SubscribeOnObserver&lt;T&gt; parent) &#123;</span><br><span class="line">        <span class="keyword">this</span>.parent = parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//â‘¦</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        source.subscribe(parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ObservableSubscribeOn ç±»çš„æ„é€ æ–¹æ³•<br>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>ObservableSource source</code> å³ä¸Šé¢ä¼ å…¥çš„ <code>this</code>(å°±æ˜¯è°ƒç”¨ subscribeOn çš„å¯¹è±¡)<br>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>Scheduler scheduler</code>ï¼Œå³è¦è°ƒåº¦åˆ°çš„çº¿ç¨‹</p><p>å†çœ‹ <code>subscribeActual(final Observer&lt;? super T&gt; observer)</code> æ–¹æ³•<br>ä»ä¸Šæ–‡æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå½“ä¸‹æ¸¸çš„è§‚å¯Ÿè€…è®¢é˜…æ—¶ï¼Œä¼šè°ƒç”¨ä¸Šæ¸¸çš„ <code>subscribeActual()</code> æ–¹æ³•ï¼Œåœ¨æˆ‘ä»¬è¿™é‡Œï¼Œ<code>ObservableSubscribeOn#subscribeActual()</code> çš„èŒè´£å°±æ˜¯åˆ‡æ¢åˆ°æŒ‡å®šçš„çº¿ç¨‹ï¼Œå¹¶åœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­è°ƒç”¨ä¸Šæ¸¸çš„ <code>subscribe()</code> æ–¹æ³•ï¼Œè¾¾åˆ°åˆ‡æ¢ä¸Šæ¸¸çº¿ç¨‹çš„ç›®çš„</p><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šå°†ä¸‹æ¸¸çš„ observer è¿›è¡ŒåŒ…è£…ä¸º <code>SubscribeOnOnserver</code> å¯¹è±¡ <code>parent</code>ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­æŒæœ‰ç€ä¸‹æ¸¸ <code>observer</code></p><p>é‡ç‚¹çœ‹ä¸€ä¸‹ <code>scheduler.scheduleDirect(new SubsribeTask(parent))</code></p><p><code>SubscribeTask</code> æ˜¯ä¸€ä¸ªå®ç°äº† <code>Runnable</code> æ¥å£çš„ç±»ï¼Œé‚£è‚¯å®šä¼šåœ¨æŸä¸ªæ—¶æœºè°ƒç”¨å…¶ <code>run()</code> æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ <code>run()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>source.subscribe(parent)</code>ï¼Œç”±äº <code>SubscribeTask</code> æ˜¯ <code>ObservableSubscribeOn</code> çš„å†…éƒ¨ç±»ï¼Œæ‰€ä»¥è¿™é‡Œçš„ <code>source</code> å°±æ˜¯ <code>ObservableSubscribeOn</code> æ„é€ æ–¹æ³•ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³è°ƒç”¨<code>subscribeOn()</code> çš„ä¸Šæ¸¸å¯¹è±¡ï¼Œè¿™é‡Œçš„ <code>parent</code> åˆ™æ˜¯ä¸Šé¢çš„ <code>SubscribeOnOnserver</code> åŒ…è£…å¯¹è±¡ </p><p><strong>é‚£ä¹ˆé‡ç‚¹åˆè½¬ç§»åˆ°äº† <code>SubscribeTask</code> ä¸­çš„ <code>run()</code> æ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„äº†</strong></p><p>æˆ‘ä»¬ç»§ç»­çœ‹ <code>io.reactivex.Scheduler#scheduleDirect(java.lang.Runnable)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Disposable <span class="title">scheduleDirect</span><span class="params">(<span class="meta">@NonNull</span> Runnable run, <span class="keyword">long</span> delay, <span class="meta">@NonNull</span> TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ª Worker </span></span><br><span class="line">    <span class="keyword">final</span> Worker w = createWorker();</span><br><span class="line">    <span class="comment">//å¯¹ä¼ å…¥çš„ run å¯¹è±¡ï¼ˆå³å‰é¢çš„ SubscribeTask å¯¹è±¡ï¼‰åšé’©å­å¤„ç†</span></span><br><span class="line">    <span class="keyword">final</span> Runnable decoratedRun = RxJavaPlugins.onSchedule(run);</span><br><span class="line">    <span class="comment">//å°† decoratedRun å’Œ w åŒ…è£…æˆä¸€ä¸ª DisposeTask (å³ä¸€ä¸ªå¯ä»¥è¢«å–æ¶ˆçš„ Runnable)</span></span><br><span class="line">    DisposeTask task = <span class="keyword">new</span> DisposeTask(decoratedRun, w);</span><br><span class="line">    <span class="comment">//worker è°ƒç”¨ schedule æ–¹æ³•è¿›è¡Œæ“ä½œ</span></span><br><span class="line">    <span class="comment">//â‘  å…·ä½“çš„å®ç°è§ä¸‹æ–¹</span></span><br><span class="line">    w.schedule(task, delay, unit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ª <code>createWorker()</code> æ–¹æ³•ï¼Œæ˜¯ <code>Scheduler</code> ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œæˆ‘ä»¬ä»¥ Schedulers.newThread() çš„å…·ä½“å®ä¾‹ <code>NewThreadScheduler</code> ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™æ®µä»£ç åˆ°åº•æ˜¯å¦‚ä½•åˆ‡æ¢çº¿ç¨‹çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadScheduler</span> <span class="keyword">extends</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...å¿½ç•¥ä¸€äº›ä»£ç ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NewThreadWorker(threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ <code>NewThreadWorker</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadWorker</span> <span class="keyword">extends</span> <span class="title">Scheduler</span>.<span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executor;</span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewThreadWorker</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å…·ä½“ä»£ç è§ â‘¡</span></span><br><span class="line">        executor = SchedulerPoolFactory.create(threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»ä¸Šæ–‡å¯ä»¥çŸ¥é“ï¼Œâ‘ å¤„çš„ä»£ç ä¼šè°ƒç”¨åˆ°è¿™é‡Œ</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Disposable <span class="title">schedule</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Runnable action, <span class="keyword">long</span> delayTime, <span class="meta">@NonNull</span> TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (disposed) &#123;</span><br><span class="line">            <span class="keyword">return</span> EmptyDisposable.INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scheduleActual(action, delayTime, unit, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//â‘¢</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ScheduledRunnable <span class="title">scheduleActual</span><span class="params">(<span class="keyword">final</span> Runnable run, <span class="keyword">long</span> delayTime, <span class="meta">@NonNull</span> TimeUnit unit, <span class="meta">@Nullable</span> DisposableContainer parent)</span> </span>&#123;</span><br><span class="line">        Runnable decoratedRun = RxJavaPlugins.onSchedule(run);</span><br><span class="line"></span><br><span class="line">        ScheduledRunnable sr = <span class="keyword">new</span> ScheduledRunnable(decoratedRun, parent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!parent.add(sr)) &#123;</span><br><span class="line">                <span class="keyword">return</span> sr;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Future&lt;?&gt; f;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (delayTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                f = executor.submit((Callable&lt;Object&gt;)sr);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                f = executor.schedule((Callable&lt;Object&gt;)sr, delayTime, unit);</span><br><span class="line">            &#125;</span><br><span class="line">            sr.setFuture(f);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RejectedExecutionException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                parent.remove(sr);</span><br><span class="line">            &#125;</span><br><span class="line">            RxJavaPlugins.onError(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sr;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>â‘¡ åˆ›å»ºä¸€ä¸ªåªæœ‰ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹çš„çº¿ç¨‹æ± å¹¶è¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">create</span><span class="params">(ThreadFactory factory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ScheduledExecutorService exec = Executors.newScheduledThreadPool(<span class="number">1</span>, factory);</span><br><span class="line">    tryPutIntoPool(PURGE_ENABLED, exec);</span><br><span class="line">    <span class="keyword">return</span> exec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisposeTask</span> <span class="keyword">implements</span> <span class="title">Disposable</span>, <span class="title">Runnable</span>, <span class="title">SchedulerRunnableIntrospection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="keyword">final</span> Runnable decoratedRun;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="keyword">final</span> Worker w;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        Thread runner;</span><br><span class="line"></span><br><span class="line">        DisposeTask(<span class="meta">@NonNull</span> Runnable decoratedRun, <span class="meta">@NonNull</span> Worker w) &#123;</span><br><span class="line">            <span class="keyword">this</span>.decoratedRun = decoratedRun;</span><br><span class="line">            <span class="keyword">this</span>.w = w;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//â‘£</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            runner = Thread.currentThread();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//â‘¤</span></span><br><span class="line">                decoratedRun.run();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                dispose();</span><br><span class="line">                runner = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (runner == Thread.currentThread() &amp;&amp; w <span class="keyword">instanceof</span> NewThreadWorker) &#123;</span><br><span class="line">                ((NewThreadWorker)w).shutdown();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                w.dispose();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDisposed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> w.isDisposed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Runnable <span class="title">getWrappedRunnable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.decoratedRun;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šè¿°çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<br>â‘  å¤„çš„ worker è°ƒç”¨ schedule() æ–¹æ³•ï¼Œä¼ å…¥åŒ…è£…ç±» DisposeTask çš„å¯¹è±¡(æŒæœ‰ worker å’Œ subscribeTask)ï¼Œä¸€æ­¥æ­¥è°ƒç”¨åˆ° â‘¢ å¤„ï¼Œâ‘¢è¿™é‡Œå°±æ˜¯å°†ä¼ å…¥çš„ <code>run</code> å¯¹è±¡(å³ DisposeTask )ï¼Œæ ¹æ®å»¶è¿Ÿæ—¶é—´ï¼Œäº¤ç»™ â‘¡ å¤„çš„çº¿ç¨‹æ± å»æ‰§è¡Œï¼Œæœ€ç»ˆæ‰§è¡Œåˆ° â‘£ å¤„ DisposeTask çš„ <code>run()</code> æ–¹æ³•ï¼Œ<code>run()</code> æ–¹æ³•ä¸­ä¼šçš„è°ƒç”¨ â‘¤å¤„ çš„ <code>decoratedRun.run()</code>ï¼Œè€Œè¿™ä¸ª <code>decoratedRun</code> å¯¹è±¡å°±æ˜¯æˆ‘ä»¬åœ¨ â‘¥å¤„ ä¼ å…¥çš„ <code>SubscribeTask</code> å¯¹è±¡ï¼Œè‡³æ­¤å°±è°ƒç”¨åˆ°äº†å®ƒçš„ run æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ â‘¦å¤„ çš„ä»£ç ï¼Œå®Œæˆäº†åœ¨ <code>Schedules.newThread()</code> æ‰€æŒ‡å®šçš„çº¿ç¨‹ä¸­è°ƒç”¨ <code>source.subscribe(parent)</code> çš„æ–¹æ³•ï¼Œä½¿å¾—ä¸Šæ¸¸çš„ <code>subscribe() -&gt; å³ subscribeActual()</code> çš„ä»£ç éƒ½è¿è¡Œåœ¨äº† <code>Schedules.newThread()</code> æ‰€æŒ‡å®šçš„çº¿ç¨‹ä¸­</p><h4 id="ä¸ºä½•-subscribeOn-æ–¹æ³•åªæœ‰ç¬¬ä¸€ä¸ªæ‰ç”Ÿæ•ˆ"><a href="#ä¸ºä½•-subscribeOn-æ–¹æ³•åªæœ‰ç¬¬ä¸€ä¸ªæ‰ç”Ÿæ•ˆ" class="headerlink" title="ä¸ºä½• subscribeOn() æ–¹æ³•åªæœ‰ç¬¬ä¸€ä¸ªæ‰ç”Ÿæ•ˆ"></a>ä¸ºä½• subscribeOn() æ–¹æ³•åªæœ‰ç¬¬ä¸€ä¸ªæ‰ç”Ÿæ•ˆ</h4><blockquote><p>ä¸ºäº†é¿å…æ­§ä¹‰ï¼Œè¿™é‡Œå…ˆä¸è®¨è®º doOnSubscribe() çš„æƒ…å†µ</p></blockquote><p>ç”±ä¸Šæ–‡æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒsubscribeOn çš„æ ¸å¿ƒå†…å®¹å°±æ˜¯å°† <code>source.subscribe(parent)</code> æ–¹æ³•æ”¾åˆ°æŒ‡å®šçš„çº¿ç¨‹ä¸­å»æ‰§è¡Œï¼Œå…¶ä¸­ <code>source</code> ä¸ºä¸Šæ¸¸ï¼Œ<code>parent</code> ä¸ºä¸‹æ¸¸çš„ç›‘å¬è€…ï¼Œæ‰€ä»¥ä¸Šæ¸¸çš„ <code>subscribe()</code> æ–¹æ³•ï¼Œå³ <code>subscribeActual()</code> éƒ½ä¼šè¢«æ‰§è¡Œåœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­ã€‚</p><p>è€Œå½“æœ€ä¸Šæ¸¸çš„äº‹ä»¶äº§ç”Ÿè€…æ¥æ”¶åˆ°è®¢é˜…åï¼Œå°±ä¼šå¼€å§‹å‘å°„äº‹ä»¶ï¼Œå³è°ƒç”¨ onNextã€onErrorã€onComplete ç­‰æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¦‚æœæ²¡æœ‰ç»è¿‡ observeOn æŒ‡å®šçº¿ç¨‹ï¼Œåˆ™ä¾ç„¶æ‰§è¡Œåœ¨subscribeOn çš„çº¿ç¨‹ä¸­ï¼Œå¦åˆ™æ‰§è¡Œåœ¨ observeOn æŒ‡å®šçš„çº¿ç¨‹ä¸­ã€‚ </p><p>æ‰€ä»¥ã€ŒsubscribeOn() æ–¹æ³•åªæœ‰ç¬¬ä¸€ä¸ªæ‰ç”Ÿæ•ˆã€è¿™ç§è¯´æ³•æ˜¯æœ‰ç‚¹ä»¤äººè¯¯è§£çš„ï¼Œæ¯ä¸€ä¸ª subscribeOn æ–¹æ³•éƒ½ä¼šä½¿å¾—å…¶ä¸Šæ¸¸çš„ <code>subscribe() -&gt; subscribeActual()</code> æ–¹æ³•æ‰§è¡Œåœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­</p><h3 id="observeOn"><a href="#observeOn" class="headerlink" title="observeOn()"></a>observeOn()</h3><p>åŒä¸Šç†ï¼Œæˆ‘ä»¬ä»æºç å¼€å§‹ç€æ‰‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CheckReturnValue</span></span><br><span class="line"><span class="meta">@SchedulerSupport(SchedulerSupport.CUSTOM)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">observeOn</span><span class="params">(Scheduler scheduler, <span class="keyword">boolean</span> delayError, <span class="keyword">int</span> bufferSize)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(scheduler, <span class="string">&quot;scheduler is null&quot;</span>);</span><br><span class="line">    ObjectHelper.verifyPositive(bufferSize, <span class="string">&quot;bufferSize&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableObserveOn&lt;T&gt;(<span class="keyword">this</span>, scheduler, delayError, bufferSize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableObserveOn</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractObservableWithUpstream</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> delayError;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> bufferSize;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableObserveOn</span><span class="params">(ObservableSource&lt;T&gt; source, Scheduler scheduler, <span class="keyword">boolean</span> delayError, <span class="keyword">int</span> bufferSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">        <span class="keyword">this</span>.delayError = delayError;</span><br><span class="line">        <span class="keyword">this</span>.bufferSize = bufferSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//â‘ </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> TrampolineScheduler) &#123;</span><br><span class="line">            source.subscribe(observer);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Scheduler.Worker w = scheduler.createWorker();</span><br><span class="line"></span><br><span class="line">            source.subscribe(<span class="keyword">new</span> ObserveOnObserver&lt;T&gt;(observer, w, delayError, bufferSize));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸Šæ¸¸è°ƒç”¨ <code>observeOn()</code> ï¼ŒåŒ…è£…æˆä¸€ä¸ª ObservableObserveOn å¯¹è±¡ï¼Œå¹¶ä¼ å…¥ <code>source(å³ä¸Šæ¸¸)</code> å’Œæ‰€éœ€è¦è°ƒåº¦çº¿ç¨‹çš„ scheduler </p><p>ç”±ä¸Šæ–‡æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå½“ä¸‹æ¸¸è°ƒç”¨ <code>subscribe()</code> æ–¹æ³•åï¼Œä¼šè°ƒç”¨åˆ° â‘ å¤„çš„ <code>subscribeActual()</code> æ–¹æ³•ï¼Œ<br>åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ª worker å¯¹è±¡ï¼Œä»ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“è¿™ä¸ª worker æ˜¯ä¸€ä¸ªç”¨æ¥è¿›è¡Œåˆ‡æ¢çº¿ç¨‹çš„æŠ½è±¡ç±»<br>å°† worker å’Œ ä¸‹æ¸¸çš„ observer è¿›è¡Œä»£ç†ä¸ºä¸€ä¸ª <code>ObserveOnObserver</code> å¯¹è±¡ï¼Œå¹¶è®©  <code>source(å³ä¸Šæ¸¸)</code> è®¢é˜…è¿™ä¸ªè¢«ä»£ç†äº†çš„<code>ã€Œä¸‹æ¸¸ observerã€</code></p><p>å½“ä¸Šæ¸¸è°ƒç”¨ä¸‹æ¸¸çš„ <code>onNext()</code>ã€<code>onError()</code>ã€<code>onComplete()</code> ç­‰æ–¹æ³•æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ° <code>ObserveOnObserver</code> è¿™ä¸ªä»£ç†å¯¹è±¡ä¸­çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserveOnObserver</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BasicIntQueueDisposable</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt;, <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">        <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line">        <span class="keyword">final</span> Scheduler.Worker worker;</span><br><span class="line">        Disposable upstream;</span><br><span class="line">        ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">        ObserveOnObserver(Observer&lt;? <span class="keyword">super</span> T&gt; actual, Scheduler.Worker worker, <span class="keyword">boolean</span> delayError, <span class="keyword">int</span> bufferSize) &#123;</span><br><span class="line">            <span class="keyword">this</span>.downstream = actual;</span><br><span class="line">            <span class="keyword">this</span>.worker = worker;</span><br><span class="line">            <span class="keyword">this</span>.delayError = delayError;</span><br><span class="line">            <span class="keyword">this</span>.bufferSize = bufferSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">            ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">            ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">            schedule();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">            ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">            schedule();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">            schedule();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (getAndIncrement() == <span class="number">0</span>) &#123;</span><br><span class="line">                worker.schedule(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//â‘¡</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (outputFused) &#123;</span><br><span class="line">                drainFused();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                drainNormal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨ <code>ObserveOnObserver</code> çš„ <code>onNext()</code>ã€<code>onError()</code>ã€<code>onComplete()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>schedule()</code> æ–¹æ³•ï¼Œè€Œ <code>schedule()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>worker.schedule(this)</code></p><p>åŒç†æˆ‘ä»¬çŸ¥é“ä¼šåœ¨è¯¥ worker çš„çº¿ç¨‹ä¸­æ‰§è¡Œ â‘¡å¤„çš„ run æ–¹æ³•ï¼Œåœ¨ <code>run()</code> æ–¹æ³•ä¸­çš„ <code>drainNormal()</code> å’Œ <code>drainFused()</code> ä¼šè°ƒç”¨ä¼ å…¥çš„ã€Œä¸‹æ¸¸ observerã€ç›¸å¯¹åº”çš„ <code>onNext()</code>ã€<code>onError()</code>ã€<code>onComplete()</code>ç­‰æ–¹æ³•ï¼Œä¹Ÿå°±è¾¾åˆ°äº†åˆ‡æ¢ä¸‹æ¸¸ observer çš„ä»£ç çš„æ‰§è¡Œçº¿ç¨‹ï¼Œä»è¿™é‡Œå°±å®Œæˆäº† observeOn() çš„çº¿ç¨‹åˆ‡æ¢</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä»ä¸Šè¿°çš„ subscribeOn() å’Œ observeOn() çš„æµç¨‹çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹çš„ç»“è®º</p><ol><li>subscribeOn() åˆ‡æ¢çš„æ˜¯ <code>source.subscribe()</code> è¿™è¡Œä»£ç çš„æ‰§è¡Œçº¿ç¨‹ï¼Œæ‰€ä»¥ä»–åªèƒ½å½±å“åˆ°çš„æ˜¯ä»å…¶å¼€å§‹ï¼Œè‡ªä¸‹è€Œä¸Šçš„ <code>subscribe()</code> æ–¹æ³•æ‰§è¡Œçš„çº¿ç¨‹ï¼Œä½†ä»è¡¨è±¡ä¸Šçœ‹å¦‚æœæœ‰å¤šä¸ªçš„è¯ï¼Œç”Ÿæ•ˆçš„åªæœ‰æœ€ä¸Šæ¸¸çš„ <code>subscribeOn()</code>ï¼Œä¸”ä½œç”¨åŸŸæ˜¯ä»æœ€ä¸Šæ¸¸(äº‹ä»¶ç”Ÿäº§è€…)åˆ°ç¬¬ä¸€ä¸ª <code>subscribeOn()</code> ä¹‹é—´ï¼Œè®¢é˜…(subscribe)æ˜¯è‡ªä¸‹è€Œä¸Šçš„ï¼Œä½†äº‹ä»¶æµçœŸæ­£çš„ä¼ é€’(onNextã€onErrorã€onComplete)æ˜¯è‡ªä¸Šè€Œä¸‹çš„</li><li>observeOn() åˆ‡æ¢çš„æ˜¯ <code>onNextã€onErrorã€onComplete</code> ç­‰æ–¹æ³•çš„æ‰§è¡Œçº¿ç¨‹ï¼Œè¿™äº›æ–¹æ³•ä¸­å†è°ƒç”¨ä¸‹æ¸¸çš„ä»£ç è¿›è¡Œè‡ªä¸Šè€Œä¸‹çš„äº‹ä»¶ä¼ é€’ï¼Œæ‰€ä»¥å¤šä¸ª observeOn() çš„è¯ï¼Œä½œç”¨åŸŸçš„å°±æ˜¯å…¶ä¸‹æ¸¸åˆ°ä¸‹ä¸€ä¸ª obserbeOn() ä¹‹é—´çš„ä»£ç </li><li>ç”±äºå¼€å‘è€…å†™çš„ä»£ç éƒ½æ˜¯åœ¨ <code>onNextã€onErrorã€onComplete</code> ä¸­ï¼Œæ‰€ä»¥ä»è¡¨è±¡ä¸Šçœ‹ï¼Œæˆ‘ä»¬æ‰€å†™çš„å„ä¸ªæ“ä½œç¬¦ä¸­çš„ä»£ç éƒ½æ˜¯æ‰§è¡Œåœ¨ <code>observeOn</code> æŒ‡å®šçš„çº¿ç¨‹ä¸­</li></ol><h3 id="doOn-æ“ä½œç¬¦"><a href="#doOn-æ“ä½œç¬¦" class="headerlink" title="doOn æ“ä½œç¬¦"></a>doOn æ“ä½œç¬¦</h3><h4 id="doOnNextã€doOnErrorã€doOnComplete"><a href="#doOnNextã€doOnErrorã€doOnComplete" class="headerlink" title="doOnNextã€doOnErrorã€doOnComplete"></a>doOnNextã€doOnErrorã€doOnComplete</h4><p>ä»¥ä¸Šä¸‰ä¸ª doOn æ“ä½œç¬¦æ‰€åœ¨çš„çº¿ç¨‹ç”± subscribeOn å’Œ observeOn å†³å®š</p><p>çœ‹ä¸‹ doOnNext() çš„æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">doOnNext</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> T&gt; onNext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> doOnEach(onNext, Functions.emptyConsumer(), Functions.EMPTY_ACTION, Functions.EMPTY_ACTION);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Observable&lt;T&gt; <span class="title">doOnEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> T&gt; onNext, Consumer&lt;? <span class="keyword">super</span> Throwable&gt; onError, Action onComplete, Action onAfterTerminate)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(onNext, <span class="string">&quot;onNext is null&quot;</span>);</span><br><span class="line">    ObjectHelper.requireNonNull(onError, <span class="string">&quot;onError is null&quot;</span>);</span><br><span class="line">    ObjectHelper.requireNonNull(onComplete, <span class="string">&quot;onComplete is null&quot;</span>);</span><br><span class="line">    ObjectHelper.requireNonNull(onAfterTerminate, <span class="string">&quot;onAfterTerminate is null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableDoOnEach&lt;T&gt;(<span class="keyword">this</span>, onNext, onError, onComplete, onAfterTerminate));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çŸ¥é“ï¼ŒdoOnError()ã€doOnComplete() æ–¹æ³•åŒæ ·æ˜¯ä¼šè°ƒç”¨ doOnEach() æ–¹æ³•ä¸­ï¼Œé€šè¿‡ ObservableDoOnEach ç±»è¿›è¡Œä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableDoOnEach</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractObservableWithUpstream</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> T&gt; onNext;</span><br><span class="line">    <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> Throwable&gt; onError;</span><br><span class="line">    <span class="keyword">final</span> Action onComplete;</span><br><span class="line">    <span class="keyword">final</span> Action onAfterTerminate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥å¯¹åº”çš„ onNextã€onErrorã€onCompleteã€onAfterTerminate æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source ä¸Šæ–‡ä¸­ä¼ å…¥çš„ thisï¼Œå³ä¸Šæ¸¸çš„ Observable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableDoOnEach</span><span class="params">(ObservableSource&lt;T&gt; source, Consumer&lt;? <span class="keyword">super</span> T&gt; onNext,</span></span></span><br><span class="line"><span class="params"><span class="function">                              Consumer&lt;? <span class="keyword">super</span> Throwable&gt; onError,</span></span></span><br><span class="line"><span class="params"><span class="function">                              Action onComplete,</span></span></span><br><span class="line"><span class="params"><span class="function">                              Action onAfterTerminate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">        <span class="keyword">this</span>.onNext = onNext;</span><br><span class="line">        <span class="keyword">this</span>.onError = onError;</span><br><span class="line">        <span class="keyword">this</span>.onComplete = onComplete;</span><br><span class="line">        <span class="keyword">this</span>.onAfterTerminate = onAfterTerminate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“è°ƒç”¨ subscribe() æ–¹æ³•åä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t ä¸‹æ¸¸æˆ–è€…ä¸‹æ¸¸çš„ä»£ç†åŒ…è£…ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; t)</span> </span>&#123;</span><br><span class="line">          <span class="comment">//è°ƒç”¨ä¸Šæ¸¸çš„ subscribe æ–¹æ³•(-&gt; subscribeActual ) ä¼ é€’ç»™ä¸Šæ¸¸</span></span><br><span class="line">        source.subscribe(<span class="keyword">new</span> DoOnEachObserver&lt;T&gt;(t, onNext, onError, onComplete, onAfterTerminate));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DoOnEachObserver</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt;, <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> T&gt; onNext;</span><br><span class="line">        <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> Throwable&gt; onError;</span><br><span class="line">        <span class="keyword">final</span> Action onComplete;</span><br><span class="line">        <span class="keyword">final</span> Action onAfterTerminate;</span><br><span class="line"></span><br><span class="line">        Disposable upstream;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> done;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> actual ä¸‹æ¸¸ Observer</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> onNext ä¼ å…¥çš„ doOnNext ä¸­çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DoOnEachObserver(</span><br><span class="line">                Observer&lt;? <span class="keyword">super</span> T&gt; actual,</span><br><span class="line">                Consumer&lt;? <span class="keyword">super</span> T&gt; onNext,</span><br><span class="line">                Consumer&lt;? <span class="keyword">super</span> Throwable&gt; onError,</span><br><span class="line">                Action onComplete,</span><br><span class="line">                Action onAfterTerminate) &#123;</span><br><span class="line">            <span class="keyword">this</span>.downstream = actual;</span><br><span class="line">            <span class="keyword">this</span>.onNext = onNext;</span><br><span class="line">            <span class="keyword">this</span>.onError = onError;</span><br><span class="line">            <span class="keyword">this</span>.onComplete = onComplete;</span><br><span class="line">            <span class="keyword">this</span>.onAfterTerminate = onAfterTerminate;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å½“ä¸Šæ¸¸è°ƒç”¨ä¸‹æ¸¸çš„ onNext æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨ onNext çš„ accept æ–¹æ³•</span></span><br><span class="line">                onNext.accept(t);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                Exceptions.throwIfFatal(e);</span><br><span class="line">                upstream.dispose();</span><br><span class="line">                onError(e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å†è°ƒç”¨ä¸‹æ¸¸çš„ onNext æ–¹æ³•</span></span><br><span class="line">            downstream.onNext(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯è§ï¼ŒdoOnXxxx() æ–¹æ³•ä¼šåœ¨ onXxxx() è°ƒç”¨ä¹‹å‰è°ƒç”¨ï¼Œä¸”å…¶æ‰§è¡Œçš„çº¿ç¨‹å’Œå…¶ä»–æ“ä½œç¬¦ä¸€æ ·ç”± <code>subscribeOn()</code> å’Œ <code>observeOn()</code> å†³å®š</p><h4 id="doOnSubscribe"><a href="#doOnSubscribe" class="headerlink" title="doOnSubscribe()"></a>doOnSubscribe()</h4><p>åœ¨ä¸€ä¸ª RxJava çš„è°ƒç”¨é“¾ä¸­ï¼ŒdoOnSubscribe() æ–¹æ³•è¡¨ç¤ºåœ¨è¢« subscribe æ—¶æ‰§è¡Œ</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>doOnSubscribe()</code> æ–¹æ³•æ‰§è¡Œåœ¨ <code>subscribe()</code> æ–¹æ³•è°ƒç”¨çš„çº¿ç¨‹ä¸­ï¼Œä½†å¦‚æœ <code>doOnSubscribe()</code> æ–¹æ³•åæœ‰<code>subscribeOn()</code>æŒ‡å®šäº†çº¿ç¨‹ï¼Œåˆ™æ‰§è¡Œåœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(<span class="meta">@NonNull</span> ObservableEmitter&lt;Integer&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;create thread is &quot;</span> + Thread.currentThread());</span><br><span class="line">        emitter.onNext(<span class="number">1</span>);</span><br><span class="line">        emitter.onComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.subscribeOn(Schedulers.newThread())</span><br><span class="line">.doOnSubscribe(<span class="keyword">new</span> Consumer&lt;Disposable&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Disposable disposable)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;thread is &quot;</span> + Thread.currentThread());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.subscribeOn(Schedulers.io())</span><br><span class="line">.observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">.subscribe();</span><br></pre></td></tr></table></figure><p>æ‰“å°çš„æ—¥å¿—å¦‚ä¸‹<br>thread is Thread[RxCachedThreadScheduler-1,5,main]<br>create thread is Thread[RxNewThreadScheduler-2,5,main]</p><p>è¯´æ˜ create çš„ä»£ç æ‰§è¡Œåœ¨ <code>Schedulers.newThread()</code> çº¿ç¨‹ä¸­ï¼Œè€Œ <code>doOnSubscribe</code> çš„ä»£ç æ‰§è¡Œåœ¨ <code>Schedulers.io()</code> çº¿ç¨‹ä¸­ï¼Œæ¥ç€çœ‹æºç æ¥åˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableCreate</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ObservableOnSubscribe&lt;T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableCreate</span><span class="params">(ObservableOnSubscribe&lt;T&gt; source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">        CreateEmitter&lt;T&gt; parent = <span class="keyword">new</span> CreateEmitter&lt;T&gt;(observer);</span><br><span class="line">        observer.onSubscribe(parent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            source.subscribe(parent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(ex);</span><br><span class="line">            parent.onError(ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">doOnSubscribe</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> Disposable&gt; onSubscribe)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> doOnLifecycle(onSubscribe, Functions.EMPTY_ACTION);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; <span class="title">doOnLifecycle</span><span class="params">(<span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> Disposable&gt; onSubscribe, <span class="keyword">final</span> Action onDispose)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(onSubscribe, <span class="string">&quot;onSubscribe is null&quot;</span>);</span><br><span class="line">    ObjectHelper.requireNonNull(onDispose, <span class="string">&quot;onDispose is null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableDoOnLifecycle&lt;T&gt;(<span class="keyword">this</span>, onSubscribe, onDispose));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒä¸Šç†ï¼Œä¸åºŸè¯ï¼Œç›´æ¥çœ‹ <code>ObservableDoOnLifecycle</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableDoOnLifecycle</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractObservableWithUpstream</span>&lt;<span class="title">T</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> Disposable&gt; onSubscribe;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Action onDispose;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObservableDoOnLifecycle</span><span class="params">(Observable&lt;T&gt; upstream, Consumer&lt;? <span class="keyword">super</span> Disposable&gt; onSubscribe,</span></span></span><br><span class="line"><span class="params"><span class="function">            Action onDispose)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(upstream);</span><br><span class="line">        <span class="keyword">this</span>.onSubscribe = onSubscribe;</span><br><span class="line">        <span class="keyword">this</span>.onDispose = onDispose;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">        source.subscribe(<span class="keyword">new</span> DisposableLambdaObserver&lt;T&gt;(observer, onSubscribe, onDispose));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisposableLambdaObserver</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt;, <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line">    <span class="keyword">final</span> Consumer&lt;? <span class="keyword">super</span> Disposable&gt; onSubscribe;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DisposableLambdaObserver</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; actual,</span></span></span><br><span class="line"><span class="params"><span class="function">            Consumer&lt;? <span class="keyword">super</span> Disposable&gt; onSubscribe,</span></span></span><br><span class="line"><span class="params"><span class="function">            Action onDispose)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.downstream = actual;</span><br><span class="line">        <span class="keyword">this</span>.onSubscribe = onSubscribe;</span><br><span class="line">        <span class="keyword">this</span>.onDispose = onDispose;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">        onSubscribe.accept(d);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>onSubscribe()</code> æ–¹æ³•ä¸­ä¼šè°ƒç”¨ <code>onSubscribe.accept()</code> æ–¹æ³•ï¼Œå³ doOnSubscribe() ä¸­çš„æ¥å£æ–¹æ³•ã€‚</p><p>è€Œä» Create æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ° <code>.onSubscribe()</code> æ–¹æ³•çš„è°ƒç”¨æ˜¯åœ¨ <code>subscribeActual()</code> ä¸­è°ƒç”¨çš„ï¼Œè€Œä»ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“ <code>subscribeActual()</code> æ‰€æ‰§è¡Œçš„çº¿ç¨‹æ˜¯ç”± <code>subscribeOn()</code> æŒ‡å®šçš„ï¼Œæ‰€ä»¥ <code>.onSubscribe()</code> æ–¹æ³•çš„çº¿ç¨‹ä¹Ÿå°±æ‰§è¡Œåœ¨äº† subscribeOn æŒ‡å®šçš„çº¿ç¨‹ä¸­äº†ï¼Œæ‰€ä»¥ doOnSubscribe() æ–¹æ³•çš„çº¿ç¨‹ä¼šå—åˆ° <code>subscribeOn()</code> æ–¹æ³•å½±å“</p>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;blockquote&gt;
&lt;p&gt;RxJava is a Java VM implementation of Reactive Extensions: a library for composing asynchronous and event-based programs by using observable sequences.&lt;br&gt;RxJava æ˜¯ Reactive Extensions çš„ Java VM å®ç°ï¼šä¸€ä¸ªä½¿ç”¨å¯è§‚å¯Ÿåºåˆ—ç»„åˆå¼‚æ­¥å’ŒåŸºäºäº‹ä»¶çš„ç¨‹åºçš„åº“ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;RxJava é€šè¿‡è§‚å¯Ÿè€…è®¢é˜…è¢«è§‚å¯Ÿè€…è¿›è¡Œäº‹ä»¶çš„åˆ†å‘ï¼Œå¹¶æä¾›äº†å¾ˆå¤šè¢«è§‚å¯Ÿè€…(å³äº‹ä»¶å‘é€è€…)çš„åˆ›å»ºæ–¹æ³•å’Œäº‹ä»¶è½¬æ¢çš„æ“ä½œç¬¦å‡½æ•°(mapã€flatmapã€filter ç­‰ç­‰)&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    <category term="æºç " scheme="https://ppting.me/categories/%E6%BA%90%E7%A0%81/"/>
    
    
    <category term="RxJava" scheme="https://ppting.me/tags/RxJava/"/>
    
  </entry>
  
  <entry>
    <title>Java åŠ¨æ€ä»£ç†</title>
    <link href="https://ppting.me/2021/11/21/2021_11_21_java_proxy/"/>
    <id>https://ppting.me/2021/11/21/2021_11_21_java_proxy/</id>
    <published>2021-11-20T16:00:00.000Z</published>
    <updated>2022-02-12T08:16:29.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h3><p>æ‰€è°“ä»£ç†æ¨¡å¼ï¼Œå°±æ˜¯æŒ‡ã€Œä»£ç†å¯¹è±¡ã€(æˆ–è€…æˆ‘ä»¬å½¢è±¡åœ°ç§°å‘¼ä¸ºä¸­ä»‹)ï¼Œé€šè¿‡å®ç°æ¥å£ç±»å…·æœ‰äº†æ¥å£çš„èƒ½åŠ›ï¼Œå¹¶é€šè¿‡å’Œã€Œå®é™…çš„ç”Ÿäº§è€…ã€äº§ç”Ÿè”ç³»ï¼Œå°†ã€Œå®é™…ç”Ÿäº§è€…ã€çš„èƒ½åŠ›é€šè¿‡è‡ªå·±ä¸­è½¬ç»™ã€Œå®¢æˆ·(è°ƒç”¨è€…)ã€</p><p>å®¢æˆ·ä¸ç›´æ¥é€šè¿‡ã€Œå®é™…ç”Ÿäº§è€…ã€è·å–ä¿¡æ¯ï¼Œè€Œæ˜¯è·Ÿã€Œä»£ç†å¯¹è±¡(ä¸­ä»‹)ã€æ‰“äº¤é“è·å–ä¿¡æ¯</p><span id="more"></span><p>æˆ‘ä»¬é€šè¿‡æˆ¿å±‹ç§Ÿèµä½œä¸ºä¾‹å­</p><h3 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h3><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸ª <code>IPriceService.java</code> çš„æ¥å£ï¼Œç”¨äºè·å–æˆ¿å±‹çš„æŠ¥ä»·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPriceService</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬åœ¨ä»£ç é‡Œæˆ‘ä»¬è¿˜ä¼šæœ‰ä¸€ä¸ªç±»å»å®ç°è¿™ä¸ª <code>IPriceService.java</code> æ¥å£ï¼Œä¾‹å¦‚ä¸‹é¢çš„ <code>APriceService.java</code><br>ä»£è¡¨Aæˆ¿ä¸œçš„æŠ¥ä»·ä¸º 100å…ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APriceService</span> <span class="keyword">implements</span> <span class="title">IPriceService</span></span>&#123;</span><br><span class="line">    <span class="function">override <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯èƒ½è¿˜æœ‰ä¸€ä¸ªä»£ç†ç±»ï¼ŒPriceServiceProxyï¼Œå¯¹ APriceService è¿›è¡Œä»£ç†ï¼Œç›¸å½“äºä¸€ä¸ªã€Œä¸­ä»‹ã€ï¼Œä¸è®©ã€Œç§Ÿå®¢ã€å’Œã€Œæˆ¿ä¸œã€æ¥è§¦ï¼Œã€Œä¸­ä»‹ã€å¯ä»¥å¯¹æ•°æ®(å³ä»·æ ¼)è¿›è¡ŒåŠ å·¥å¤„ç†åå†æä¾›ç»™ã€Œç§Ÿå®¢ã€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriceServiceProxy</span> <span class="keyword">implements</span> <span class="title">IPriceService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IPriceService realPriceService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriceServiceProxy</span><span class="params">(IPriceService service)</span></span>&#123;</span><br><span class="line">        <span class="comment">//å½“ç„¶ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡å¤–éƒ¨æ³¨å…¥è¯¥ä¸­ä»‹å¯¹æ¥çš„æˆ¿ä¸œ</span></span><br><span class="line">        realPriceService = service;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">override <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//ä¸­ä»‹è·å–åˆ°äº†æˆ¿ä¸œçš„æŠ¥ä»·</span></span><br><span class="line">        <span class="keyword">int</span> aPrice = realPriceService.getPrice();</span><br><span class="line">        <span class="comment">//å†åœ¨æˆ¿ä¸œæŠ¥ä»·çš„åŸºç¡€ä¸ŠåŠ ä¸Šä¸­ä»‹è´¹ï¼Œè¿”å›ç»™ç§Ÿå®¢</span></span><br><span class="line">        <span class="keyword">return</span> aPrice + <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯é™æ€ä»£ç†ï¼Œä»å·¥ç¨‹ä¸Šæ¥è¯´ï¼Œé™æ€ä»£ç†æ˜¯æ·»åŠ ä¸€ä¸ªã€Œå§”æ‰˜ç±»ã€åœ¨ä¸éœ€è¦ä¿®æ”¹çœŸæ­£çš„å®ç°ç±»çš„åŸºç¡€ä¸Šï¼Œåšåˆ°å¯¹éœ€æ±‚å˜åŠ¨è¿›è¡Œçµæ´»ä¿®æ”¹çš„ç›®çš„ã€‚</p><p>ä¾‹å¦‚æœ‰ä¸€å¤©éœ€æ±‚å˜ä¸ºã€Œæä¾›ç»™ç§Ÿå®¢çš„ä»·æ ¼æ˜¯æˆ¿ä¸œçš„ä»·æ ¼çš„ 9æŠ˜ã€ï¼Œå¦‚æœæ²¡æœ‰ä»£ç†ç±»ï¼Œè€Œæ˜¯ã€Œç§Ÿå®¢ã€å’Œã€Œæˆ¿ä¸œã€ç›´æ¥æ‰“äº¤é“ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä¿®æ”¹æ‰€æœ‰å®ç°äº† IPriceService æ¥å£çš„ç±»ä¸­çš„ <code>getPrice()</code>æ–¹æ³•ï¼Œæœ‰äº†ä»£ç†ç±»ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ä»£ç†ç±»ä¸­çš„ <code>getPrice()</code> æ–¹æ³•ï¼Œåœ¨æˆ¿ä¸œçš„æŠ¥ä»·çš„åŸºç¡€ä¸Š * 0.9 å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriceServiceProxy</span> <span class="keyword">implements</span> <span class="title">IPriceService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IPriceService realPriceService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriceServiceProxy</span><span class="params">(IPriceService service)</span></span>&#123;</span><br><span class="line">        <span class="comment">//å½“ç„¶ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡å¤–éƒ¨æ³¨å…¥è¯¥ä¸­ä»‹å¯¹æ¥çš„æˆ¿ä¸œ</span></span><br><span class="line">        realPriceService = service;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">override <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//ä¸­ä»‹è·å–åˆ°äº†æˆ¿ä¸œçš„æŠ¥ä»·</span></span><br><span class="line">        <span class="keyword">int</span> aPrice = realPriceService.getPrice();</span><br><span class="line">        <span class="comment">//å†åœ¨æˆ¿ä¸œæŠ¥ä»·çš„åŸºç¡€æ‰“9æŠ˜ï¼Œè¿”å›ç»™ç§Ÿå®¢</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(aPrice * <span class="number">0.9f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•æ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    IPriceService priceService = <span class="keyword">new</span> PriceServiceProxy(<span class="keyword">new</span> APriceService());</span><br><span class="line">    System.out.print(<span class="string">&quot;ç§Ÿå®¢è·å–åˆ°çš„æˆ¿å­æŠ¥ä»·ä¸º&quot;</span>+priceService.getPrice());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°çš„ã€Œé™æ€ä»£ç†ã€æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p><ol><li>ã€Œç§Ÿå®¢ã€åªå…³å¿ƒæŠ¥ä»·ï¼Œè€Œä¸å…³å¿ƒæ˜¯è°æä¾›äº†æŠ¥ä»·;<br>å³åªå…³å¿ƒ IPriceService æ¥å£çš„è¿”å›ï¼Œè€Œä¸å…³å¿ƒå®ç° IPriceService æ¥å£çš„å®ä¾‹æ˜¯è°</li><li>å°†ã€Œç§Ÿå®¢ã€å’Œã€Œæˆ¿ä¸œã€åˆ†ç¦»ï¼Œé™ä½äº†ä¸€å®šçš„è€¦åˆæ€§</li><li>ä½†ä¹Ÿéœ€è¦åˆ›å»ºå¾ˆå¤šçš„ä»£ç†ç±»ï¼Œä½¿å¾—ä»£ç é‡å¢åŠ ï¼Œä¸€æ—¦æ¥å£éœ€è¦å˜åŠ¨ï¼Œä»£ç†ç±»å’Œå®é™…ç›®æ ‡ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹</li></ol><h3 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h3><p>åŠ¨æ€ä»£ç†å°±æ˜¯å°†ä¸Šè¿°æˆ‘ä»¬çš„é™æ€ä»£ç†ä¸­çš„ PriceServiceProxy ç±»é€šè¿‡ä»£ç åŠ¨æ€ç”Ÿæˆï¼Œå¹¶é€šè¿‡è¯¥åŠ¨æ€ä»£ç†å¯¹ç›®æ ‡å¯¹è±¡(æˆ¿ä¸œ)è¿›è¡Œè¿›ä¸€æ­¥æ“ä½œï¼Œè¾¾åˆ°ä»£ç†çš„ç›®çš„</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Java ä¸­çš„ <code>java.lang.reflect.Proxy#newProxyInstance</code> ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡<br>å…¶æ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        Class&lt;?&gt;[] interfaces,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        InvocationHandler h)</span></span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥éœ€è¦ä»£ç†çš„æ¥å£çš„ ClassLoader<br>ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥éœ€è¦ä»£ç†çš„æ¥å£ç±»<br>ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥ InvocationHandler å¯¹è±¡ï¼Œå¯¹éœ€è¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡è¿›è¡Œå¤„ç†</p><p>eg.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> aPriceService <span class="keyword">by</span> lazy &#123; APriceService() &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡ä»£ç åŠ¨æ€åˆ›å»ºäº†ä¸€ä¸ªã€Œä¸­ä»‹å¯¹è±¡ã€priceServiceProxy</span></span><br><span class="line"><span class="keyword">val</span> priceServiceProxy = Proxy.newProxyInstance(</span><br><span class="line">            IPriceService::<span class="keyword">class</span>.java.classLoader,</span><br><span class="line">            arrayOf(IPriceService::<span class="keyword">class</span>.java),</span><br><span class="line">            <span class="keyword">object</span> : InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(proxy: <span class="type">Any</span>?, method: <span class="type">Method</span>?, args: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">Any</span>&gt;?)</span></span>: Any? &#123;</span><br><span class="line">                    Log.d(<span class="string">&quot;ProxyDemoActivity&quot;</span>,<span class="string">&quot;method is <span class="subst">$&#123;method?.name&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> (method?.name?:<span class="string">&quot;&quot;</span> == <span class="string">&quot;getPrice&quot;</span>)&#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœæ–¹æ³•æ˜¯ã€ŒgetPriceã€æ–¹æ³•ï¼Œåˆ™è·å–å¯¹è±¡è¿”å›çš„æ•°æ®ï¼Œç„¶åå†åŠ ä¸Š 100 ååœ¨è¿”å›</span></span><br><span class="line">                        <span class="keyword">return</span> (method?.invoke(aPriceService,*(args?: arrayOfNulls(<span class="number">0</span>))) <span class="keyword">as</span> <span class="built_in">Int</span>) + <span class="number">100</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> method?.invoke(aPriceService,*(args?: arrayOfNulls(<span class="number">0</span>)))</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        ) <span class="keyword">as</span> IPriceService</span><br><span class="line"></span><br><span class="line">findViewById&lt;Button&gt;(R.id.btnProxyDemo).setOnClickListener &#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡ä»£ç†å¯¹è±¡è·å–ä»·æ ¼</span></span><br><span class="line">    Log.d(<span class="string">&quot;ProxyDemoActivity&quot;</span>,<span class="string">&quot;price is &quot;</span>+priceServiceProxy.getPrice())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œæˆ‘ä»¬é€šè¿‡ä»£ç  Proxy.newProxyInstance ç”Ÿæˆäº†ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œå¯¹åŸæœ¬çš„ aPriceService å¯¹è±¡è¿›è¡Œä»£ç†ï¼Œä»ä¸­åšä¸€äº›ã€Œå·æ¢æ¢æŸ±ã€çš„æ–¹æ³•</p><p>é‚£è¿™åˆ°åº•æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Œé™æ€ä»£ç†ä¸ä¹Ÿèƒ½åšåˆ°å—ï¼Œä½•å¿…å¤šæ­¤ä¸€ä¸¾å‘¢ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸ªéœ€æ±‚ï¼Œéœ€è¦å¯¹ Android Framework ä¸­çš„ startActivity() æ–¹æ³•åšä¸€äº›æ‹¦æˆªå¤„ç†</p><p>ç„¶è€Œè¿™ä¸ªæ–¹æ³•çš„ä»£ç æ˜¯æˆ‘ä»¬æ— æ³•ç¼–è¾‘çš„ï¼Œä¹Ÿæ— æ³•é€šè¿‡é™æ€ä»£ç†çš„æ–¹å¼ç”Ÿæˆä¸€ä¸ª ActivityManagerProxy å¯¹è±¡è¿›è¡Œä»£ç†ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œå¯¹ activityManager å¯¹è±¡è¿›è¡Œä»£ç†ï¼Œåœ¨ <code>startActivity</code> æ–¹æ³•å‰åè¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class&lt;?&gt; activityManagerNativeClass = <span class="keyword">null</span>;</span><br><span class="line">    Field defaultFiled = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">        activityManagerNativeClass = Class.forName(<span class="string">&quot;android.app.ActivityManager&quot;</span>);</span><br><span class="line">        defaultFiled = activityManagerNativeClass.getDeclaredField(<span class="string">&quot;IActivityManagerSingleton&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        activityManagerNativeClass = Class.forName(<span class="string">&quot;android.app.ActivityManagerNative&quot;</span>);</span><br><span class="line">        defaultFiled = activityManagerNativeClass.getDeclaredField(<span class="string">&quot;gDefault&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    defaultFiled.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Object defaultValue = defaultFiled.get(<span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">//åå°„SingleTon</span></span><br><span class="line">    Class&lt;?&gt; SingletonClass = Class.forName(<span class="string">&quot;android.util.Singleton&quot;</span>);</span><br><span class="line">    Field mInstance = SingletonClass.getDeclaredField(<span class="string">&quot;mInstance&quot;</span>);</span><br><span class="line">    mInstance.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">//åˆ°è¿™é‡Œå·²ç»æ‹¿åˆ°ActivityManagerå¯¹è±¡</span></span><br><span class="line">    Object iActivityManagerObject = mInstance.get(defaultValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼€å§‹åŠ¨æ€ä»£ç†ï¼Œç”¨ä»£ç†å¯¹è±¡æ›¿æ¢æ‰çœŸå®çš„ActivityManagerï¼Œç’å¤©è¿‡æµ·</span></span><br><span class="line">    Class&lt;?&gt; IActivityManagerIntercept = Class.forName(<span class="string">&quot;android.app.IActivityManager&quot;</span>);</span><br><span class="line"></span><br><span class="line">    AmsInvocationHandler handler = <span class="keyword">new</span> AmsInvocationHandler(iActivityManagerObject);</span><br><span class="line"></span><br><span class="line">    Object proxy = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[]&#123;IActivityManagerIntercept&#125;, handler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç°åœ¨æ›¿æ¢æ‰è¿™ä¸ªå¯¹è±¡</span></span><br><span class="line">    mInstance.set(defaultValue, proxy);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    Log.e(<span class="string">&quot;vivid&quot;</span>,<span class="string">&quot;hook å¼‚å¸¸&quot;</span>);</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AmsInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object iActivityManagerObject;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AmsInvocationHandler</span><span class="params">(Object iActivityManagerObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iActivityManagerObject = iActivityManagerObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;startActivity&quot;</span>.contains(method.getName())) &#123;</span><br><span class="line">            <span class="comment">//æˆ‘è¦åœ¨è¿™é‡Œæç‚¹äº‹æƒ…</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(iActivityManagerObject, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç åˆ™æ˜¯é€šè¿‡åå°„è·å–åˆ° ActivityManager å¯¹è±¡ï¼Œç„¶åé€šè¿‡åŠ¨æ€ä»£ç†æ„å»ºå…¶ä¸€ä¸ªä»£ç†ç±»ï¼Œå¹¶åœ¨ <code>invoke</code> æ–¹æ³•ä¸­å¯¹ <code>startActivity</code> æ–¹æ³•è¿›è¡Œåˆ¤æ–­å¤„ç†ï¼Œè¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„</p><h3 id="Retrofit-ä¸­çš„åŠ¨æ€ä»£ç†"><a href="#Retrofit-ä¸­çš„åŠ¨æ€ä»£ç†" class="headerlink" title="Retrofit ä¸­çš„åŠ¨æ€ä»£ç†"></a><code>Retrofit</code> ä¸­çš„åŠ¨æ€ä»£ç†</h3><blockquote><p>ä¸‹æ–‡åŸºäº <code>&quot;com.squareup.retrofit2:retrofit:2.7.1&quot;</code> åˆ†æ</p></blockquote><p>æˆ‘ä»¬çŸ¥é“åœ¨ <code>Retrofit</code> ä¸­ï¼Œapi æ–¹æ³•çš„å®šä¹‰æ˜¯å®šä¹‰åœ¨ä¸€ä¸ª interface ä¸­çš„ï¼Œä¾‹å¦‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPodCastBusiness</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getRss</span><span class="params">(<span class="meta">@Url</span> url: <span class="type">String</span>)</span></span>: Flowable&lt;RssResponse&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œç½‘ç»œè¯·æ±‚æ—¶ï¼Œæ˜¯ä½¿ç”¨ä»¥ä¸‹çš„æ–¹æ³•è¿›è¡Œè¯·æ±‚çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Retrofit.Builder()</span><br><span class="line">    .baseUrl(<span class="string">&quot;xxxx&quot;</span>)</span><br><span class="line">    .client(OkHttpClient())</span><br><span class="line">    .addConverterFactory(SimpleXmlConverterFactory.create())</span><br><span class="line">    .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span><br><span class="line">    .build()</span><br><span class="line">    .create(IPodCastBusiness::class.java)</span><br><span class="line">    .getRss(rssLink)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹è¿™ä¸ª <code>create</code> æ–¹æ³•ï¼Œçœ‹ Retrofit æ˜¯å¦‚ä½•å°†ä¸€ä¸ª <code>IPodCastBusiness</code> çš„æ¥å£è½¬åŒ–ä¸ºä¸€ä¸ªå®ä¾‹çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//ç¬¬ä¸€æ­¥æ ¡éªŒ service æ˜¯å¦æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¸æ˜¯æˆ‘ä»¬ç°åœ¨çš„é‡ç‚¹ï¼Œè·³è¿‡ä¸è¡¨</span></span><br><span class="line">  validateServiceInterface(service);</span><br><span class="line">  <span class="comment">//è¿™é‡Œåˆè§åˆ°äº†æˆ‘ä»¬çš„è€æœ‹å‹äº†ï¼Œåœ¨è¿™é‡Œï¼Œé€šè¿‡ Proxy.newProxyInstance() æ–¹æ³•</span></span><br><span class="line">  <span class="comment">//å°†æˆ‘ä»¬ä¼ å…¥çš„ service æ¥å£æ„å»ºäº†ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡å¹¶è¿”å›</span></span><br><span class="line">  <span class="comment">//å¤–éƒ¨åˆ™å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŠ¨æ€ä»£ç†çš„å®ä¾‹è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œäº†</span></span><br><span class="line">  <span class="comment">//è‡³äºè°ƒç”¨äº†æ¥å£ä¸­å®šä¹‰çš„ HTTP Request æ–¹æ³•æ˜¯å¦‚ä½•è½¬åŒ–æˆè¿”å›ç±»å‹çš„ï¼Œåˆ™éœ€è¦çœ‹ invoke æ–¹æ³•ä¸­çš„å†…å®¹</span></span><br><span class="line">  <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</span><br><span class="line">      <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Object[] emptyArgs = <span class="keyword">new</span> Object[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Object <span class="title">invoke</span><span class="params">(Object proxy, Method method,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Nullable</span> Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">          <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></span><br><span class="line">          <span class="comment">//å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ Object é‡Œçš„æ–¹æ³•ï¼Œåˆ™æ­£å¸¸è°ƒç”¨ï¼Œä¸å¤„ç†</span></span><br><span class="line">          <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> loadServiceMethod(method).invoke(args != <span class="keyword">null</span> ? args : emptyArgs);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±çŸ¥é“äº†åœ¨ Retrofit ä¸­æ˜¯å¦‚ä½•å°†ä¸€ä¸ª Interface è½¬åŒ–æˆä¸€ä¸ªå®ä¾‹å¯¹è±¡äº†çš„<br>å…¶è¿œç¦»å°±æ˜¯é€šè¿‡ Proxy.newProxyInstance() æ–¹æ³•ç”Ÿæˆå…¶ä»£ç†å¯¹è±¡è¿”å›</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;ä»£ç†æ¨¡å¼&quot;&gt;&lt;a href=&quot;#ä»£ç†æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;ä»£ç†æ¨¡å¼&quot;&gt;&lt;/a&gt;ä»£ç†æ¨¡å¼&lt;/h3&gt;&lt;p&gt;æ‰€è°“ä»£ç†æ¨¡å¼ï¼Œå°±æ˜¯æŒ‡ã€Œä»£ç†å¯¹è±¡ã€(æˆ–è€…æˆ‘ä»¬å½¢è±¡åœ°ç§°å‘¼ä¸ºä¸­ä»‹)ï¼Œé€šè¿‡å®ç°æ¥å£ç±»å…·æœ‰äº†æ¥å£çš„èƒ½åŠ›ï¼Œå¹¶é€šè¿‡å’Œã€Œå®é™…çš„ç”Ÿäº§è€…ã€äº§ç”Ÿè”ç³»ï¼Œå°†ã€Œå®é™…ç”Ÿäº§è€…ã€çš„èƒ½åŠ›é€šè¿‡è‡ªå·±ä¸­è½¬ç»™ã€Œå®¢æˆ·(è°ƒç”¨è€…)ã€&lt;/p&gt;
&lt;p&gt;å®¢æˆ·ä¸ç›´æ¥é€šè¿‡ã€Œå®é™…ç”Ÿäº§è€…ã€è·å–ä¿¡æ¯ï¼Œè€Œæ˜¯è·Ÿã€Œä»£ç†å¯¹è±¡(ä¸­ä»‹)ã€æ‰“äº¤é“è·å–ä¿¡æ¯&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Java" scheme="https://ppting.me/categories/Java/"/>
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://ppting.me/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="Proxy" scheme="https://ppting.me/tags/Proxy/"/>
    
  </entry>
  
  <entry>
    <title>Android ä¸­çš„å›¾ç‰‡å†…å­˜</title>
    <link href="https://ppting.me/2021/05/07/2021_05_07_bitmap_in_android/"/>
    <id>https://ppting.me/2021/05/07/2021_05_07_bitmap_in_android/</id>
    <published>2021-05-06T16:00:00.000Z</published>
    <updated>2022-02-12T08:41:31.472Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æå‡ºé—®é¢˜"><a href="#æå‡ºé—®é¢˜" class="headerlink" title="æå‡ºé—®é¢˜"></a>æå‡ºé—®é¢˜</h2><p>å…ˆæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œå°†ä¸¤å¼ åˆ†è¾¨ç‡ç›¸åŒ(48px * 48px)ï¼Œä½†æ–‡ä»¶å¤§å°ä¸åŒçš„ png å›¾ç‰‡ï¼Œæ”¾åœ¨ drawable-xhdpi æ–‡ä»¶å¤¹ä¸‹ï¼Œåœ¨ä¸åŒåˆ†è¾¨ç‡çš„æ‰‹æœºä¸Šï¼Œæ‰€åŠ è½½å‡ºæ¥çš„ Bitmap çš„å ç”¨å†…å­˜å¤§å°åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ</p><span id="more"></span><blockquote><p>PS. ä½¿ç”¨ Bitmap.getByteCount() æ‰€è·å–çš„å€¼ä½œä¸ºå ç”¨å†…å­˜çš„å¤§å°</p></blockquote><p>é€šè¿‡ä»¥ä¸‹ä»£ç è·å– Bitmap æ‰€å ç”¨çš„å†…å­˜å¤§å°</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">       setContentView(R.layout.activity_main)</span><br><span class="line">       <span class="keyword">val</span> bigBitmap = BitmapFactory.decodeResource(resources,R.drawable.big_png)</span><br><span class="line">       <span class="keyword">val</span> smallBitmap = BitmapFactory.decodeResource(resources,R.drawable.small_png)</span><br><span class="line">       Log.d(TAG,<span class="string">&quot;small png bitmap size is <span class="subst">$&#123;smallBitmap.byteCount&#125;</span>&quot;</span>)</span><br><span class="line">       Log.d(TAG,<span class="string">&quot;bid png bitmap size is <span class="subst">$&#123;bigBitmap.byteCount&#125;</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PS. è¡¨æ ¼ä¸­çš„ dpi çš„é€šè¿‡ <code>resources.displayMetrics.densityDpi</code> æ–¹æ³•è·å–</p></blockquote><p><strong>å›¾ç‰‡1</strong> <em><strong>(åˆ†è¾¨ç‡ 48px * 48pxï¼Œæ–‡ä»¶å¤§å° 1.24kb)</strong></em></p><p><strong>å›¾ç‰‡2</strong> <em><strong>(åˆ†è¾¨ç‡ 48px * 48pxï¼Œæ–‡ä»¶å¤§å° 1.27kb)</strong></em></p><table><thead><tr><th>æ‰‹æœº</th><th>åˆ†è¾¨ç‡</th><th>dpi</th><th>å›¾ç‰‡1 çš„ byteCount</th><th>å›¾ç‰‡2 çš„ byteCount</th></tr></thead><tbody><tr><td>Nexus S</td><td>480 * 800</td><td>hdpi&#x2F;240dpi</td><td>5184</td><td>5184</td></tr><tr><td>Nexus 4</td><td>768 * 1280</td><td>xhdpi&#x2F;320dpi</td><td>9216</td><td>9216</td></tr><tr><td>Pixel 1</td><td>1080 * 1920</td><td>420dpi</td><td>15876</td><td>15876</td></tr><tr><td>å°ç±³6</td><td>1080 * 1920</td><td>480dpi</td><td>20736</td><td>20736</td></tr><tr><td>Nexus 5</td><td>1080 * 1920</td><td>xxhdpi&#x2F;480dpi</td><td>20736</td><td>20736</td></tr><tr><td>Pixel 3a</td><td>1080 * 2220</td><td>440dpi</td><td>17424</td><td>17424</td></tr><tr><td>Pixel XL</td><td>1440 * 2560</td><td>560dpi</td><td>28244</td><td>28244</td></tr></tbody></table><p>é€šè¿‡ä»¥ä¸Šçš„æ•°æ®å¯¹æ¯”ï¼Œå¯è§å›¾ç‰‡1å’Œå›¾ç‰‡2çš„å³ä½¿æ–‡ä»¶å¤§å°ä¸åŒï¼Œä½†è¿è¡Œæ—¶æ‰€å çš„å†…å­˜éƒ½æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤æˆ‘ä»¬çŒœæµ‹ï¼š<strong>å›¾ç‰‡è¿è¡Œæ—¶çš„å†…å­˜å¤§å°å’Œæ–‡ä»¶å¤§å°æ— å…³ï¼Œåªä¸å›¾ç‰‡çš„åˆ†è¾¨ç‡æœ‰å…³</strong></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†å°†ä¸¤å¼ å›¾ç‰‡æ”¾åˆ° drawable-xxhdpi æ–‡ä»¶å¤¹ä¸‹ï¼Œå†é€šè¿‡åŒæ ·çš„æ–¹å¼è¿›è¡Œè®¡ç®—ï¼Œå¾—å‡ºä»¥ä¸‹è¡¨æ ¼</p><table><thead><tr><th>æ‰‹æœº</th><th>åˆ†è¾¨ç‡</th><th>dpi</th><th>å›¾ç‰‡1 çš„ byteCount</th><th>å›¾ç‰‡2 çš„ byteCount</th></tr></thead><tbody><tr><td>Nexus S</td><td>480 * 800</td><td>hdpi&#x2F;240dpi</td><td>2304</td><td>2304</td></tr><tr><td>Nexus 4</td><td>768 * 1280</td><td>xhdpi&#x2F;320dpi</td><td>4096</td><td>4096</td></tr><tr><td>Pixel 1</td><td>1080 * 1920</td><td>420dpi</td><td>7056</td><td>7056</td></tr><tr><td>å°ç±³6</td><td>1080 * 1920</td><td>480dpi</td><td>9216</td><td>9216</td></tr><tr><td>Nexus 5</td><td>1080 * 1920</td><td>xxhdpi&#x2F;480dpi</td><td>9216</td><td>9216</td></tr><tr><td>Pixel 3a</td><td>1080 * 2220</td><td>440dpi</td><td>7744</td><td>7744</td></tr><tr><td>Pixel XL</td><td>1440 * 2560</td><td>560dpi</td><td>12544</td><td>12544</td></tr></tbody></table><p>è¿™å›æˆ‘ä»¬åŒæ ·å‘ç°å›¾ç‰‡1å’Œå›¾ç‰‡2æ‰€å çš„å†…å­˜éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ›´åŠ è‚¯å®šäº†æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªè¡¨æ ¼åçš„çŒœæµ‹</p><p>ä½†æ˜¯ï¼Œé€šè¿‡è¡¨æ ¼â‘¡ä¸­çš„ã€ŒPixel 1ã€å°ç±³6 å’Œ Nexus 5ã€çš„çºµå‘å¯¹æ¯”ï¼Œä¸‰ä¸ªæ‰‹æœºçš„åˆ†è¾¨ç‡å‡ä¸º<strong>1080 * 1920</strong>ï¼Œä½†ä¸‰ä¸ªæ‰‹æœºçš„ dpi åˆ†åˆ«ä¸º 420dpiï¼Œ480dpi å’Œ 480dpiï¼Œå ç”¨çš„å†…å­˜ä¸º 7056ã€9216 å’Œ 9216ï¼Œå› æ­¤æˆ‘ä»¬çŒœæµ‹ï¼Œ<strong>å›¾ç‰‡æ‰€å å†…å­˜çš„å¤§å°å˜åŒ–ä¹Ÿè·Ÿæ‰‹æœºçš„ dpi æœ‰å…³ï¼Œè·Ÿæ‰‹æœºçš„åˆ†è¾¨ç‡æ— å…³</strong></p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>æ—¢ç„¶æœ‰ä»¥ä¸Šçš„çŒœæµ‹ï¼Œæˆ‘ä»¬ä¸å¦‚ä»æºç ä¸­æ¢ç´¢ç¼˜ç”±</p><blockquote><p>PS. ä»¥ä¸‹ä»£ç åŸºäº Android 30 ç‰ˆæœ¬</p></blockquote><p>åœ¨åˆ†æ <code>decodeResource</code> æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€äº›åŸºç¡€æ¦‚å¿µ</p><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><h3 id="android-util-DisplayMetrics-density-Float"><a href="#android-util-DisplayMetrics-density-Float" class="headerlink" title="android.util.DisplayMetrics#density: Float"></a>android.util.DisplayMetrics#density: Float</h3><blockquote><p>æ˜¾ç¤ºçš„é€»è¾‘å¯†åº¦ï¼Œè¿™æ˜¯ dip å•ä½çš„æ¯”ä¾‹ç³»æ•°.<br>ä¸€ä¸ª dip å¤§æ¦‚æ˜¯ 160dpi å±å¹•ä¸Šçš„çš„ä¸€ä¸ªåƒç´ (ä¾‹å¦‚åˆ†è¾¨ç‡240x320.å°ºå¯¸ä¸º 1.5â€x2â€çš„å±å¹•)ï¼ŒæŒ‰è¿™ä¸ªæ ‡å‡†æä¾›æ˜¾ç¤ºçš„åŸºå‡†ã€‚<br>å› æ­¤åœ¨ 160dpi çš„å±å¹•ä¸Šï¼Œè¿™ä¸ªå€¼ä¸º1ï¼Œåœ¨120dpi çš„å±å¹•ä¸Šï¼Œè¿™ä¸ªå€¼ä¸º 0.75ï¼Œåœ¨480dpi çš„å±å¹•ä¸Šï¼Œè¿™ä¸ªå€¼ä¸º3.ä¾æ¬¡ç±»æ¨</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è®¡ç®—æ–¹å¼ï¼šdensity = densityDpi/160</span><br></pre></td></tr></table></figure><h3 id="android-util-DisplayMetrics-densityDpi-Int"><a href="#android-util-DisplayMetrics-densityDpi-Int" class="headerlink" title="android.util.DisplayMetrics#densityDpi: Int"></a>android.util.DisplayMetrics#densityDpi: Int</h3><blockquote><p>ç¼©å†™ä¸º dpi<br>dots-per-inch</p></blockquote><p>å±å¹•å¯†åº¦ï¼Œè¡¨ç¤ºæ¯è‹±å¯¸å±å¹•ä¸Šçš„åƒç´ ç‚¹ä¸ªæ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è®¡ç®—æ–¹å¼ä¸º dpi = æ–œè¾¹é•¿/è‹±å¯¸</span><br></pre></td></tr></table></figure><p>åœ¨ Android è®¾å¤‡ä¸­ï¼Œå°† densityDpi å°†è®¾å¤‡åˆ†æˆå¤šä¸ªæ˜¾ç¤ºçº§åˆ«ï¼Œå¦‚ä¸‹è¡¨</p><table><thead><tr><th></th><th>ldpi</th><th>mdpi</th><th>hdpi</th><th>xhdpi</th><th>xxhdpi</th></tr></thead><tbody><tr><td>dpi</td><td>0-120</td><td>120-160</td><td>160-320</td><td>320-480</td><td>480-640</td></tr><tr><td>æ¯”ä¾‹ 1dp</td><td>0.75px</td><td>1px</td><td>2px</td><td>3px</td><td>4px</td></tr></tbody></table><blockquote><p>ç”±äº mdpi ä¸­ 1dp åˆšå¥½ç­‰äº 1px æ‰€ä»¥å°† mdpi ä½œä¸ºåŸºå‡†å±å¹•å¯†åº¦</p><p>ä¸€èˆ¬æ¥è¯´è®¾å¤‡éƒ½ä¼šåœ¨å‡ºå‚æ—¶è®¾ç½®ä¸€ä¸ªé»˜è®¤çš„ dpi ï¼Œè®¾ç½®å…¶èŒƒå›´å†…çš„æœ€å¤§å€¼</p></blockquote><h3 id="dip-x2F-dp"><a href="#dip-x2F-dp" class="headerlink" title="dip&#x2F;dp"></a>dip&#x2F;dp</h3><blockquote><p>å…¨ç§°ä¸º Density Independent Pixel<br>å¯†åº¦ç‹¬ç«‹åƒç´ </p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è®¡ç®—æ–¹å¼ä¸º dip/dp = px / (dpi / 160)</span><br></pre></td></tr></table></figure><h3 id="TypeValue"><a href="#TypeValue" class="headerlink" title="TypeValue"></a>TypeValue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TypedValue typedValue = <span class="keyword">new</span> TypedValue();</span><br><span class="line">Resources resources = getResources();</span><br><span class="line"><span class="keyword">int</span> id = resources.getIdentifier(<span class="string">&quot;ic_launcher&quot;</span>,<span class="string">&quot;mipmap&quot;</span>,getPackageName());</span><br><span class="line">resources.openRawResource(id,typedValue);</span><br><span class="line"><span class="keyword">int</span> density = typedValue.density;</span><br></pre></td></tr></table></figure><h4 id="android-util-TypedValue-density-Int"><a href="#android-util-TypedValue-density-Int" class="headerlink" title="android.util.TypedValue#density: Int"></a>android.util.TypedValue#density: Int</h4><p>å¦‚æœæ˜¯ä» resource ä¸­åŠ è½½çš„å›¾ç‰‡ç­‰ï¼Œè¿™ä¸ªå€¼å°†ä¼šå­˜å‚¨ç›¸å¯¹åº”çš„åƒç´ å¯†åº¦</p><p>ä¾‹å¦‚ï¼š<br>    ä» ldpi åŠ è½½çš„ density &#x3D;&#x3D; 120<br>    ä» mdpi åŠ è½½çš„ density &#x3D;&#x3D; 160</p><h2 id="decodeResource"><a href="#decodeResource" class="headerlink" title="decodeResource"></a>decodeResource</h2><h4 id="decodeResource-Resources-res-int-id"><a href="#decodeResource-Resources-res-int-id" class="headerlink" title="decodeResource(Resources res, int id)"></a>decodeResource(Resources res, int id)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeResource</span><span class="params">(Resources res, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> decodeResource(res, id, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="decodeResource-Resources-res-int-id-Options-opts"><a href="#decodeResource-Resources-res-int-id-Options-opts" class="headerlink" title="decodeResource(Resources res, int id, Options opts)"></a>decodeResource(Resources res, int id, Options opts)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeResource</span><span class="params">(Resources res, <span class="keyword">int</span> id, Options opts)</span> </span>&#123;</span><br><span class="line">    validate(opts);</span><br><span class="line">    Bitmap bm = <span class="keyword">null</span>;</span><br><span class="line">    InputStream is = <span class="keyword">null</span>; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> TypedValue value = <span class="keyword">new</span> TypedValue();</span><br><span class="line">        is = res.openRawResource(id, value);</span><br><span class="line"></span><br><span class="line">        bm = decodeResourceStream(res, value, is, <span class="keyword">null</span>, opts);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">/*  do nothing.</span></span><br><span class="line"><span class="comment">            If the exception happened on open, bm will be null.</span></span><br><span class="line"><span class="comment">            If it happened on close, bm is still valid.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) is.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bm == <span class="keyword">null</span> &amp;&amp; opts != <span class="keyword">null</span> &amp;&amp; opts.inBitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Problem decoding into existing bitmap&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>-&gt; æœ€åèµ°åˆ° <code>android.graphics.BitmapFactory#decodeResourceStream</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeResourceStream</span><span class="params">(<span class="meta">@Nullable</span> Resources res, <span class="meta">@Nullable</span> TypedValue value,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Nullable</span> InputStream is, <span class="meta">@Nullable</span> Rect pad, <span class="meta">@Nullable</span> Options opts)</span> </span>&#123;</span><br><span class="line">    validate(opts);</span><br><span class="line">    <span class="comment">//å¦‚æœ opts ä¸ºç©ºï¼Œåˆ™ new ä¸€ä¸ª Options å¯¹è±¡ï¼Œé»˜è®¤ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (opts == <span class="keyword">null</span>) &#123;</span><br><span class="line">        opts = <span class="keyword">new</span> Options();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½® opts çš„ inDensity å‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (opts.inDensity == <span class="number">0</span> &amp;&amp; value != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//åªæœ‰å½“ opts.inDensity ä¸º0 ä¸” TypedValue ä¸ä¸ºç©ºæ—¶æ‰è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è·å– TypedValue çš„ density å€¼()</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> density = value.density;</span><br><span class="line">        <span class="keyword">if</span> (density == TypedValue.DENSITY_DEFAULT) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ density ä¸ºé»˜è®¤å€¼(0)ï¼Œåˆ™è®¾ç½® inDenisity ä¸º DisplayMetrics.DENSITY_DEFAULT(160)</span></span><br><span class="line">            opts.inDensity = DisplayMetrics.DENSITY_DEFAULT;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (density != TypedValue.DENSITY_NONE) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ density ä¸ä¸º DENSITY_NONE(0xffff)</span></span><br><span class="line">            <span class="comment">//åªæœ‰æ”¾åœ¨ nodpi ä¸­çš„å›¾ç‰‡çš„ density ä¼šè¢«è®¾ç½®ä¸º DENSITY_NONE</span></span><br><span class="line">            opts.inDensity = density;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (opts.inTargetDensity == <span class="number">0</span> &amp;&amp; res != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœ opts çš„ isTargetDenisity ä¸º0ä¸” res ä¸ä¸ºç©ºï¼Œåˆ™å°†è®¾å¤‡çš„ densityDpi èµ‹å€¼ç»™ inTargetDensity</span></span><br><span class="line">        opts.inTargetDensity = res.getDisplayMetrics().densityDpi;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> decodeStream(is, pad, opts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åèµ°åˆ° <code>decodeStream()</code> ä¸­çš„ native æ–¹æ³•ä¸­å¯¹å›¾ç‰‡è¿›è¡Œè§£ç </p><p>åœ¨ native ä»£ç ä¸­ï¼Œä¼šæ ¹æ®å‰é¢çš„æ–¹æ³•ä¸­çš„ BitmapFactory.Options ä¸­è®¾ç½®çš„å‚æ•° inDensity å’Œ inTargetDensity å‚æ•°ï¼Œå¯¹å›¾ç‰‡è¿›è¡Œç¼©æ”¾</p><p>ç®€å•æ¥è¯´ï¼š<br>inDensity ä»£è¡¨èµ„æºæ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹ dpi<br>inTargetDenisity ä»£è¡¨ bitmap ä¼šè¢«ç»˜åˆ¶çš„åœ°æ–¹çš„åƒç´ å¯†åº¦</p><p>ä» <a href="https://android.googlesource.com/platform/frameworks/base/+/5b0971801fdfdd7b6600b03bec3191c9709d0285/core/jni/android/graphics/BitmapFactory.cpp">BitmapFactory.cpp</a> ä¸­å¯ä»¥çœ‹åˆ°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (env-&gt;<span class="built_in">GetBooleanField</span>(options, gOptions_scaledFieldID)) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int</span> density = env-&gt;<span class="built_in">GetIntField</span>(options, gOptions_densityFieldID);</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int</span> targetDensity = env-&gt;<span class="built_in">GetIntField</span>(options, gOptions_targetDensityFieldID);</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">int</span> screenDensity = env-&gt;<span class="built_in">GetIntField</span>(options, gOptions_screenDensityFieldID);</span><br><span class="line">            <span class="keyword">if</span> (density != <span class="number">0</span> &amp;&amp; targetDensity != <span class="number">0</span> &amp;&amp; density != screenDensity) &#123;</span><br><span class="line">                scale = (<span class="keyword">float</span>) targetDensity / density;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å½“ isDenisity ã€inTargetDensity ä¸ä¸º0ï¼Œä¸” isDenisity !&#x3D; inScreenDensity æ—¶å€™ï¼Œä¼šå°†å›¾ç‰‡è¿›è¡Œç¼©æ”¾</p><p>ç¼©æ”¾æ¯”ä¾‹ä¸º (float)inTargetDensity&#x2F;isDenisity</p><h2 id="å†…å­˜å¤§å°è®¡ç®—"><a href="#å†…å­˜å¤§å°è®¡ç®—" class="headerlink" title="å†…å­˜å¤§å°è®¡ç®—"></a>å†…å­˜å¤§å°è®¡ç®—</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å›åˆ°æ–‡ç« å¼€å¤´çš„ä¸¤ä¸ªè¡¨æ ¼ï¼Œæ¥çœ‹ä¸€ä¸‹å›¾ç‰‡æ‰€å ç”¨çš„å†…å­˜æ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„</p><p>åœ¨è®¡ç®—ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜è¦å†çœ‹ä¸€ä¸ªå‚æ•° Bitmap.Config</p><p>åœ¨ BitmapFactory.Options ä¸­ï¼ŒinPreferredConfig æ®µé»˜è®¤ä¸º ARGB_8888<br>è¯¥å‚æ•°ä»£è¡¨å›¾ç‰‡è§£ç æ—¶ä½¿ç”¨çš„é¢œè‰²æ¨¡å¼</p><table><thead><tr><th>Bitmap.Config</th><th>å­—èŠ‚æ•°</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>ALPHA_8</td><td>1</td><td>æ¯ä¸ªåƒç´ å 8bit,å­˜å‚¨å›¾ç‰‡çš„é€æ˜å€¼</td></tr><tr><td>RGB_565</td><td>2</td><td>æ¯ä¸ªåƒç´ å 16bitï¼ŒRGB é€šé“åˆ†åˆ«å ç”¨5ï¼Œ6ï¼Œ5bitï¼Œå­˜å‚¨å›¾ç‰‡çš„ RGB å€¼</td></tr><tr><td>ARGB_4444(å·²åºŸå¼ƒ)</td><td>2</td><td>æ¯ä¸ªåƒç´ å 16bit,å³æ¯ä¸ªé€šé“ç”¨4bitè¡¨ç¤º</td></tr><tr><td>ARGB_8888</td><td>4</td><td>æ¯ä¸ªåƒç´ å 32bit,å³æ¯ä¸ªé€šé“ç”¨8bitè¡¨ç¤º</td></tr><tr><td>RGBA_F16</td><td>8</td><td></td></tr></tbody></table><blockquote><p>å„ä¸ªæšä¸¾ä¸­çš„æ•°å­—ä¹‹å’Œä»£è¡¨å…¶ä½æ•°ï¼Œä¾‹å¦‚ ARGB_8888 åˆ™å ç”¨ 8+8+8+8 &#x3D; 32bit &#x3D; 4byte</p></blockquote><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºä¸€å¼ å›¾ç‰‡åœ¨è§£ç åæ‰€å ç”¨çš„å†…å­˜äº†</p><p>å†…å­˜ &#x3D; (å›¾ç‰‡åƒç´ å®½ * scale ) * (å›¾ç‰‡åƒç´ é«˜ * scale ) * æ¯ä¸ªåƒç´ ç‚¹å†…å­˜å ç”¨</p><p>å…¶ä¸­ scale &#x3D; (float)inTargetDensity&#x2F;inDenisity</p><p>æˆ‘ä»¬æ¥å¯¹ä¸Šè¿°çš„è¡¨æ ¼è¿›è¡ŒéªŒè¯<br>å¯¹äºè¡¨æ ¼1ä¸­<br>ç”±äºæˆ‘ä»¬å°†èµ„æºæ–‡ä»¶æ”¾åœ¨äº† xhdpi æ–‡ä»¶å¤¹ä¸­ï¼Œæ‰€ä»¥ inDenisity &#x3D; 320</p><ul><li><p>Nexus S è®¾å¤‡<br>scale &#x3D; (float)240&#x2F;320 &#x3D; 0.75<br>å›¾ç‰‡çš„å†…å­˜ &#x3D; (48 * 0.75 ) * (48 * 0.75 ) * 4 &#x3D; 5184 </p></li><li><p>Pixel 1<br>scale &#x3D; (float)420&#x2F;320 &#x3D; 1.3125<br>å›¾ç‰‡çš„å†…å­˜ &#x3D; (48 * 1.3125 ) * (48 * 1.3125 ) * 4 &#x3D; 15876</p></li><li><p>å°ç±³6<br>scale &#x3D; (float)480&#x2F;320 &#x3D; 1.5<br>å›¾ç‰‡çš„å†…å­˜ &#x3D; (48 * 1.5 ) * (48 * 1.5 ) * 4 &#x3D; 20736</p></li></ul><p>åŒç†å¯ä»¥éªŒè¯è¡¨æ ¼2 ä¸­çš„æ•°æ®</p><h2 id="å†…å­˜ä¼˜åŒ–"><a href="#å†…å­˜ä¼˜åŒ–" class="headerlink" title="å†…å­˜ä¼˜åŒ–"></a>å†…å­˜ä¼˜åŒ–</h2><p>ç”±ä»¥ä¸Šçš„ Bitmap å†…å­˜å ç”¨å¯çŸ¥ï¼Œè¦ä¼˜åŒ– bitmap çš„å†…å­˜å¤§å°<br>å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å‡ºå‘</p><ol><li>å°†æ­£ç¡®çš„èµ„æºå›¾ç‰‡æ”¾åˆ°æ­£ç¡®çš„ç›®å½•ä¸‹ğŸ¶<blockquote><p>é€šè¿‡è¡¨æ ¼2å’Œè¡¨æ ¼1çš„å¯¹æ¯”ï¼Œå¦‚æœæœ¬åº”æ”¾åœ¨ xxhdpi ä¸‹çš„å›¾ç‰‡å¦‚æœæ”¾åˆ°äº† xhdpi ä¸‹ï¼Œä¼šå¯¼è‡´ bitmap å ç”¨çš„å†…å­˜å˜å¤§</p></blockquote></li><li>å¯¹èµ„æºå›¾ç‰‡è¿›è¡Œå–æ ·ï¼Œæ ¹æ®æ‰€å±•ç¤ºçš„ view çš„å®½é«˜ä¿®æ”¹å›¾ç‰‡è§£ç æ—¶é‡‡æ ·ç‡ï¼Œä»¥é™ä½å›¾ç‰‡çš„åˆ†è¾¨ç‡</li></ol><p>eg.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ImageView è®¾ç½®èµ„æºå›¾</span></span><br><span class="line"><span class="comment"> * ä¼šæ ¹æ®å®½é«˜å¯¹èµ„æºæ–‡ä»¶çš„é‡‡æ ·ç‡è¿›è¡Œå‹ç¼©ï¼Œå‡å°‘å†…å­˜å ç”¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> resId èµ„æºæ–‡ä»¶ id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> width å±•ç¤ºå›¾ç‰‡çš„ View çš„å®½åº¦</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> height å±•ç¤ºå›¾ç‰‡çš„ View çš„é«˜åº¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> ImageView.<span class="title">setImage</span><span class="params">(resId: <span class="type">Int</span>,width: <span class="type">Int</span>,height: <span class="type">Int</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> bitmap = BitmapFactory.Options().run &#123;</span><br><span class="line">        inJustDecodeBounds = <span class="literal">true</span></span><br><span class="line">        BitmapFactory.decodeResource(resources,resId,<span class="keyword">this</span>)</span><br><span class="line">        inSampleSize = calculateInSampleSize(<span class="keyword">this</span>,width,height)</span><br><span class="line"></span><br><span class="line">        inJustDecodeBounds = <span class="literal">false</span></span><br><span class="line">        BitmapFactory.decodeResource(resources,resId,<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    Log.d(<span class="string">&quot;ImageViewExt&quot;</span>,<span class="string">&quot;bitmap size is <span class="subst">$&#123;bitmap.byteCount&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">this</span>.setImageBitmap(bitmap)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®å®½é«˜è®¡ç®—é‡‡æ ·ç‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">calculateInSampleSize</span><span class="params">(options: <span class="type">BitmapFactory</span>.<span class="type">Options</span>, reqWidth: <span class="type">Int</span>, reqHeight: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="comment">// Raw height and width of image</span></span><br><span class="line">    <span class="keyword">val</span> (height: <span class="built_in">Int</span>, width: <span class="built_in">Int</span>) = options.run &#123; outHeight to outWidth &#125;</span><br><span class="line">    <span class="keyword">var</span> inSampleSize = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (height &gt; reqHeight || width &gt; reqWidth) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> halfHeight: <span class="built_in">Int</span> = height / <span class="number">2</span></span><br><span class="line">        <span class="keyword">val</span> halfWidth: <span class="built_in">Int</span> = width / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Calculate the largest inSampleSize value that is a power of 2 and keeps both</span></span><br><span class="line">        <span class="comment">// height and width larger than the requested height and width.</span></span><br><span class="line">        <span class="keyword">while</span> (halfHeight / inSampleSize &gt;= reqHeight &amp;&amp; halfWidth / inSampleSize &gt;= reqWidth) &#123;</span><br><span class="line">            inSampleSize *= <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inSampleSize</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æå‡ºé—®é¢˜&quot;&gt;&lt;a href=&quot;#æå‡ºé—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;æå‡ºé—®é¢˜&quot;&gt;&lt;/a&gt;æå‡ºé—®é¢˜&lt;/h2&gt;&lt;p&gt;å…ˆæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œå°†ä¸¤å¼ åˆ†è¾¨ç‡ç›¸åŒ(48px * 48px)ï¼Œä½†æ–‡ä»¶å¤§å°ä¸åŒçš„ png å›¾ç‰‡ï¼Œæ”¾åœ¨ drawable-xhdpi æ–‡ä»¶å¤¹ä¸‹ï¼Œåœ¨ä¸åŒåˆ†è¾¨ç‡çš„æ‰‹æœºä¸Šï¼Œæ‰€åŠ è½½å‡ºæ¥çš„ Bitmap çš„å ç”¨å†…å­˜å¤§å°åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
    <category term="Bitmap" scheme="https://ppting.me/tags/Bitmap/"/>
    
  </entry>
  
  <entry>
    <title>Handler æ¶ˆæ¯æœºåˆ¶</title>
    <link href="https://ppting.me/2021/04/21/2021_04_21_about_handler_in_android/"/>
    <id>https://ppting.me/2021/04/21/2021_04_21_about_handler_in_android/</id>
    <published>2021-04-20T16:00:00.000Z</published>
    <updated>2022-02-12T08:15:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Android ä¸­ï¼Œä½¿ç”¨ Handler ä¸»è¦ç”¨äºä¸åŒçº¿ç¨‹é—´çš„é€šä¿¡</p><p><em>æœ¬æ–‡åŸºäº Target 30 çš„ Android æºç è¿›è¡Œåˆ†æ</em></p><span id="more"></span><p>å…ˆæ¥çœ‹å‡ ä¸ªç±»</p><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p><strong>Handler</strong> : æ¶ˆæ¯å¤„ç†ç±»ï¼Œç”¨æ¥å‘é€å’Œå¤„ç† Message</p><p><strong>Looper</strong> : å¾ªç¯å™¨ï¼Œå°†æ¶ˆæ¯å‘é€ç»™ Handler è¿›è¡Œå¤„ç†</p><p><strong>MessageQueue</strong> : æ¶ˆæ¯é˜Ÿåˆ—</p><p><strong>Message</strong> : æ¶ˆæ¯</p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><h4 id="Handler-æ¶ˆæ¯æœºåˆ¶-UML-ç±»å›¾"><a href="#Handler-æ¶ˆæ¯æœºåˆ¶-UML-ç±»å›¾" class="headerlink" title="Handler æ¶ˆæ¯æœºåˆ¶ UML ç±»å›¾"></a>Handler æ¶ˆæ¯æœºåˆ¶ UML ç±»å›¾</h4><p><img src="https://i.loli.net/2021/06/08/7exYtmhbEU6k4IW.png" alt="Handler æ¶ˆæ¯æœºåˆ¶ UML"></p><h4 id="æ¶ˆæ¯æœºåˆ¶ç±»æ¯”å›¾"><a href="#æ¶ˆæ¯æœºåˆ¶ç±»æ¯”å›¾" class="headerlink" title="æ¶ˆæ¯æœºåˆ¶ç±»æ¯”å›¾"></a>æ¶ˆæ¯æœºåˆ¶ç±»æ¯”å›¾</h4><p><img src="https://i.loli.net/2021/04/21/Fc6QszDW15xuEiG.png" alt="Handler æ¶ˆæ¯æœºåˆ¶.png"></p><h3 id="1-Example"><a href="#1-Example" class="headerlink" title="1. Example"></a>1. Example</h3><p>å…ˆæ¥çœ‹ä¸ªä¾‹å­</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        <span class="keyword">val</span> button = Button(context)</span><br><span class="line">        setContentView(view, ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,ViewGroup.LayoutParams.MATCH_PARENT))</span><br><span class="line">        button.setOnClickListener &#123;</span><br><span class="line">            thread &#123;</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;thread is <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">                Looper.prepare()</span><br><span class="line">                <span class="keyword">val</span> looper = Looper.myLooper()!!</span><br><span class="line">                <span class="keyword">val</span> handler = MyHandler(looper)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">val</span> message = Message().apply &#123;</span><br><span class="line">                    what = <span class="number">1</span></span><br><span class="line">                    obj = <span class="string">&quot;message&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                handler.sendMessage(message)</span><br><span class="line"></span><br><span class="line">                Looper.loop()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span></span>(looper: Looper) : Handler(looper)&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Subclasses must implement this to receive messages.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.handleMessage(msg)</span><br><span class="line"><span class="comment">//â‘ </span></span><br><span class="line">            Log.d(<span class="string">&quot;MyHandler&quot;</span>,<span class="string">&quot;thread is <span class="subst">$&#123;Thread.currentThread().name&#125;</span> msg.what is <span class="subst">$&#123;msg.what&#125;</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: thread is Thread-<span class="number">3</span></span><br><span class="line">MyHandler: thread is Thread-<span class="number">3</span> msg<span class="variable">.what</span> is <span class="number">1</span></span><br></pre></td></tr></table></figure><p>æ¯ç‚¹å‡»ä¸€æ¬¡æŒ‰é’®ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶åœ¨è¯¥çº¿ç¨‹ä¸­é€šè¿‡ handler å°†æ¶ˆæ¯åˆ†å‘ç»™ <code>MyHandler#handleMessage</code>  è¿›è¡Œå¤„ç†ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>MyHandler#handleMessage</code> å’Œ <code>thread&#123;&#125;</code></p><p>æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶æ²¡æœ‰è·¨çº¿ç¨‹é€šä¿¡ï¼Œæ‰€ä»¥å¯¹äºçº¿ç¨‹é—´çš„é€šä¿¡æ¥è¯´ï¼Œè¿™ä¸ªä¾‹å­å¹¶æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œåªæ˜¯å¤§æ¦‚å‘ŠçŸ¥ä¸€ä¸‹ Handler çš„ä½¿ç”¨ï¼Œä½†äº‹å®ä¸Šï¼Œåœ¨ Android çš„ä¸»çº¿ç¨‹(å³ UI çº¿ç¨‹ã€Main Thread) å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼å¯¹æ¶ˆæ¯è¿›è¡Œåˆ†å‘çš„</p><p>è¯¦è§ <code>ActivityThread#main()</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;ActivityThreadMain&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//......å¿½ç•¥ä¸€äº›ç»†èŠ‚</span></span><br><span class="line"></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//......å¿½ç•¥ä¸€äº›ç»†èŠ‚</span></span><br><span class="line">        ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">        thread.attach(<span class="keyword">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sMainThreadHandler = thread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                    LogPrinter(Log.DEBUG, <span class="string">&quot;ActivityThread&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        Looper.loop();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿›è¡Œè·¨çº¿ç¨‹é€šä¿¡ä¸­ï¼Œä¾‹å¦‚åœ¨å­çº¿ç¨‹ä¸­åšå®Œè€—æ—¶ä»»åŠ¡åï¼Œé€šçŸ¥ä¸»çº¿ç¨‹æ›´æ–°UI</p><p>æˆ‘ä»¬ä¼šåœ¨å­çº¿ç¨‹ä¸­è·å–åˆ°ä¸»çº¿ç¨‹çš„ Looper <code>(Looper.getMainLooper())</code> åï¼Œä½¿ç”¨ä¸€ä¸ªæŒæœ‰è¯¥ Looper çš„ Handler å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œè€Œååœ¨è¯¥ Handler çš„ handlerMessage æ–¹æ³•ä¸­æ¥æ”¶è¯¥æ¶ˆæ¯è¿›è¡Œæ›´æ–°UI ç­‰æ“ä½œ</p><p>eg. å°†ä¸Šè¿°ä¾‹å­ä¸­çš„ Handler çš„ Looper æ›¿æ¢ï¼Œåˆ™åœ¨ </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">thread &#123;</span><br><span class="line">    Log.d(<span class="string">&quot;MainActivity&quot;</span>,<span class="string">&quot;thread is <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> handler = MyHandler(Looper.getMainLooper())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> message = Message().apply &#123;</span><br><span class="line">        what = <span class="number">1</span></span><br><span class="line">        obj = <span class="string">&quot;message&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    handler.sendMessage(message)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¥å¿—å¦‚ä¸‹ï¼š</p><ul><li>å¯è§å·²ç»åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ä¸­æ¥æ”¶åˆ°ä¿¡æ¯äº†</li></ul><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MainActivity: thread is Thread[main,<span class="number">5</span>,main]</span><br><span class="line">MyHandler: thread is main msg<span class="variable">.what</span> is <span class="number">1</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šçš„ä¾‹å­ï¼Œæˆ‘ä»¬æ¥åˆ†æ Android ä¸­çš„æ¶ˆæ¯æœºåˆ¶åˆ°åº•æ˜¯å¦‚ä½•è¿ä½œçš„</p><h2 id="2-Looper"><a href="#2-Looper" class="headerlink" title="2. Looper"></a>2. Looper</h2><h3 id="2-1-prepare"><a href="#2-1-prepare" class="headerlink" title="2.1 prepare()"></a>2.1 prepare()</h3><blockquote><p>å°†å½“å‰çº¿ç¨‹åˆå§‹åŒ–ä¸ºå¾ªç¯çº¿ç¨‹</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ prepare() æ–¹æ³•æ—¶ä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­ new ä¸€ä¸ª Looper å¯¹è±¡ï¼Œå¹¶ä¿å­˜åœ¨è¯¥çº¿ç¨‹çš„ mThreadLocal ä¸­</p><p>è‹¥åœ¨åŒä¸ªçº¿ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨ prepare æ–¹æ³•ï¼Œåˆ™ä¼šèµ°åˆ° if çš„ case ä¸­æŠ›å‡ºå¼‚å¸¸</p><p><em><strong>å› æ­¤ä¿è¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª Looper å¯¹è±¡å­˜åœ¨</strong></em></p><h3 id="2-2-myLooper"><a href="#2-2-myLooper" class="headerlink" title="2.2 myLooper()"></a>2.2 myLooper()</h3><blockquote><p>è·å–å½“å‰çº¿ç¨‹ looper çš„æ–¹æ³•</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    returnsThreadLocal.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å³è¿”å›åœ¨ <code>prepare()</code> æ–¹æ³•ä¸­ä¿å­˜çš„ Looper å¯¹è±¡</p><h3 id="2-3-loop"><a href="#2-3-loop" class="headerlink" title="2.3 loop()"></a>2.3 loop()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">        <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//Looper è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (me.mInLoop) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Loop again would have the queued messages be executed&quot;</span></span><br><span class="line">                    + <span class="string">&quot; before this one completed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        me.mInLoop = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">        <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">        Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow overriding a threshold with a system prop. e.g.</span></span><br><span class="line">        <span class="comment">// adb shell &#x27;setprop log.looper.1000.main.slow 1 &amp;&amp; stop &amp;&amp; start&#x27;</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> thresholdOverride =</span><br><span class="line">                SystemProperties.getInt(<span class="string">&quot;log.looper.&quot;</span></span><br><span class="line">                        + Process.myUid() + <span class="string">&quot;.&quot;</span></span><br><span class="line">                        + Thread.currentThread().getName()</span><br><span class="line">                        + <span class="string">&quot;.slow&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> slowDeliveryDetected = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//å¼€å§‹è¿›å…¥æ­»å¾ªç¯</span></span><br><span class="line">            <span class="comment">//è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œå¯èƒ½å›é˜»å¡</span></span><br><span class="line">            Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœå½“å‰æ²¡æœ‰éœ€è¦å¤„ç†çš„æ¶ˆæ¯ï¼Œåˆ™è¿”å›ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯</span></span><br><span class="line">                <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">            <span class="keyword">final</span> Printer logging = me.mLogging;</span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> +</span><br><span class="line">                        msg.callback + <span class="string">&quot;: &quot;</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Make sure the observer won&#x27;t change while processing a transaction.</span></span><br><span class="line">            <span class="keyword">final</span> Observer observer = sObserver;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> traceTag = me.mTraceTag;</span><br><span class="line">            <span class="keyword">long</span> slowDispatchThresholdMs = me.mSlowDispatchThresholdMs;</span><br><span class="line">            <span class="keyword">long</span> slowDeliveryThresholdMs = me.mSlowDeliveryThresholdMs;</span><br><span class="line">            <span class="keyword">if</span> (thresholdOverride &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                slowDispatchThresholdMs = thresholdOverride;</span><br><span class="line">                slowDeliveryThresholdMs = thresholdOverride;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> logSlowDelivery = (slowDeliveryThresholdMs &gt; <span class="number">0</span>) &amp;&amp; (msg.when &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> logSlowDispatch = (slowDispatchThresholdMs &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> needStartTime = logSlowDelivery || logSlowDispatch;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> needEndTime = logSlowDispatch;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</span><br><span class="line">                Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> dispatchStart = needStartTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> dispatchEnd;</span><br><span class="line">            Object token = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                token = observer.messageDispatchStarting();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> origWorkSource = ThreadLocalWorkSource.setUid(msg.workSourceUid);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//æ¶ˆæ¯ä¸ä¸ºç©ºï¼Œåˆ†å‘ç»™æ¶ˆæ¯å¯¹åº”çš„ target(å³ Handler)å»å¤„ç†</span></span><br><span class="line">                msg.target.dispatchMessage(msg);</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    observer.messageDispatched(token, msg);</span><br><span class="line">                &#125;</span><br><span class="line">                dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    observer.dispatchingThrewException(token, msg, exception);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> exception;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ThreadLocalWorkSource.restore(origWorkSource);</span><br><span class="line">                <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                    Trace.traceEnd(traceTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logSlowDelivery) &#123;</span><br><span class="line">                <span class="keyword">if</span> (slowDeliveryDetected) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((dispatchStart - msg.when) &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">&quot;Drained&quot;</span>);</span><br><span class="line">                        slowDeliveryDetected = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (showSlowLog(slowDeliveryThresholdMs, msg.when, dispatchStart, <span class="string">&quot;delivery&quot;</span>,</span><br><span class="line">                            msg)) &#123;</span><br><span class="line">                        <span class="comment">// Once we write a slow delivery log, suppress until the queue drains.</span></span><br><span class="line">                        slowDeliveryDetected = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logSlowDispatch) &#123;</span><br><span class="line">                showSlowLog(slowDispatchThresholdMs, dispatchStart, dispatchEnd, <span class="string">&quot;dispatch&quot;</span>, msg);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">            <span class="comment">// identity of the thread wasn&#x27;t corrupted.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;Thread identity changed from 0x&quot;</span></span><br><span class="line">                        + Long.toHexString(ident) + <span class="string">&quot; to 0x&quot;</span></span><br><span class="line">                        + Long.toHexString(newIdent) + <span class="string">&quot; while dispatching to &quot;</span></span><br><span class="line">                        + msg.target.getClass().getName() + <span class="string">&quot; &quot;</span></span><br><span class="line">                        + msg.callback + <span class="string">&quot; what=&quot;</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¯¥æ¶ˆæ¯å¤„ç†å®Œäº†ï¼Œå°†å…¶å›æ”¶å¤ç”¨</span></span><br><span class="line">            msg.recycleUnchecked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯è§ loop() æ–¹æ³•ä¸­æ˜¯ä¸€ä¸ª <code>for(;;)</code> çš„æ­»å¾ªç¯</p><p>å¤§æ¦‚åˆ†æˆï¼š</p><ol><li>ä»å½“å‰ looper å¯¹åº”çš„ messageQueue ä¸­é€šè¿‡ ,mQueue.next() æ–¹æ³•è·å–ä¸‹ä¸€ä¸ª Message[è¯¥æ–¹æ³•å¯èƒ½ä¼šé˜»å¡ï¼Œè¯¦è§ 5.2 MessageQueue#next()]</li><li>åˆ†å‘ç»™ Message å¯¹åº”çš„ target (å³ Handler)[ target èµ‹å€¼è§ 4.3.1 android.os.Handler#enqueueMessage] äº¤ç”± Handler çš„ dispatchMessage [è§ 4.4 android.os.Handler#dispatchMessage] å»å¤„ç†</li><li>æœ€åå†å°† Message è¿›è¡Œå›æ”¶åˆ©ç”¨[è§ 3.3 Message#recycleUnchecked()]</li></ol><p>æ¥ç€ä¸æ–­çš„é‡å¤è¿™ä¸ªè¿‡ç¨‹</p><p>ç”±äº loop() æ–¹æ³•ä¸­è¿›è¡Œçš„æ˜¯æ­»å¾ªç¯ï¼Œæ‰€ä»¥åœ¨ loop() æ–¹æ³•åçš„ä»£ç æ˜¯ä¸ä¼šè¢«è°ƒç”¨åˆ°çš„</p><p>loop() æ–¹æ³•ä¸­ï¼Œè·å–ä¸‹ä¸€æ¡æ¶ˆæ¯çš„æ–¹æ³• <code>messageQueue.next()</code> æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥å½“ messageQueue ä¸­æ²¡æœ‰æ–°çš„æ¶ˆæ¯äº†ï¼Œloop() ä¼šé˜»å¡ä½[è§ MessageQueue#next()]ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆ CPU çš„é«˜æ¶ˆè€—</p><h2 id="3-Message"><a href="#3-Message" class="headerlink" title="3. Message"></a>3. Message</h2><p>Message æ˜¯æ•´ä¸ªæ¶ˆæ¯åˆ†äº«æœºåˆ¶ä¸­çš„ã€Œä¿¡ä½¿ã€ï¼Œå°†ä¿¡æ¯ä» A å¸¦ç»™ B</p><p>Message ç±»ä¸­åŒ…å«ä»¥ä¸‹ä¸€äº›å­—æ®µ</p><table><thead><tr><th>æˆå‘˜å˜é‡</th><th>ç±»å‹</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>what</td><td>Int</td><td>å¼€å‘è€…è‡ªå®šä¹‰çš„ä¸€ä¸ª code å­—æ®µï¼Œç”¨æ¥æ ‡è¯†æ˜¯ä»€ä¹ˆç±»å‹çš„æ¶ˆæ¯åç»­è¿›è¡Œå¤„ç†</td></tr><tr><td>arg1</td><td>Int</td><td>arg1 å’Œ arg2 éƒ½æ˜¯ç”¨æ¥å­˜å‚¨æ•°æ®çš„å¤‡é€‰æ–¹æ¡ˆï¼Œå¦‚æœéœ€è¦å­˜å‚¨çš„æ•°æ®ä¸å¤šè€Œä¸æƒ³ä½¿ç”¨ data çš„è¯ï¼Œåˆ™å¯ä»¥è€ƒè™‘ä½¿ç”¨è¯¥å­—æ®µ</td></tr><tr><td>arg2</td><td>Int</td><td>åŒä¸Š</td></tr><tr><td>data</td><td>Bundle</td><td>ç”¨äºåœ¨ Message ä¸­å­˜å‚¨è‡ªå®šä¹‰æ•°æ®</td></tr><tr><td>obj</td><td>Object</td><td>ç”¨äºå‘é€ç»™æ¥å—è€…çš„ä»»æ„å¯¹è±¡ï¼Œæ³¨æ„ï¼Œå¦‚æœä½¿ç”¨ Messager åœ¨è·¨è¿›ç¨‹ä¸­çš„å‘é€æ•°æ®æ—¶ï¼Œåªèƒ½å‘é€ framework ä¸­çš„ Parcelable å¯¹è±¡ï¼Œä¸”ä¸èƒ½ä¸º nullï¼Œä¸èƒ½å‘é€è‡ªå®šä¹‰çš„ Parcelable å¯¹è±¡ï¼Œè¦å‘é€è‡ªå®šä¹‰çš„ Parcelable å¯¹è±¡åº”è¯¥ä½¿ç”¨ setData æ–¹æ³•</td></tr><tr><td>when</td><td>Long</td><td>Message çš„ç›®æ ‡å‘é€å¤„ç†æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯åŸºäºç³»ç»Ÿå¼€æœºæ—¶é—´è®¡ç®—çš„SystemClock#uptimeMillis</td></tr><tr><td>target</td><td>Handler</td><td>ç”¨äºå¤„ç†è¯¥æ¶ˆæ¯çš„ Handler</td></tr><tr><td>callback</td><td>Runable</td><td>Runnable ç±»å‹</td></tr><tr><td>next</td><td>Message</td><td>Message çš„ä¸‹ä¸€ä¸ª Messageï¼Œå¯è§ Message æ˜¯ä¸€ä¸ªå•é“¾è¡¨çš„æ•°æ®ç»“æ„</td></tr><tr><td>sPool</td><td>Message</td><td>ç”¨æ¥åš Message çš„ç¼“å­˜æ± </td></tr></tbody></table><h3 id="3-1-obtain"><a href="#3-1-obtain" class="headerlink" title="3.1 obtain()"></a>3.1 obtain()</h3><blockquote><p>ä» Message ç¼“å­˜æ± ä¸­è·å–ä¸€ä¸ª Message å¯¹è±¡</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">obtain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sPoolSync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sPool != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Message m = sPool;</span><br><span class="line">            sPool = m.next;</span><br><span class="line">            m.next = <span class="keyword">null</span>;</span><br><span class="line">            m.flags = <span class="number">0</span>; <span class="comment">// clear in-use flag</span></span><br><span class="line">            sPoolSize--;</span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Message();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sPoolSync æ˜¯ä¸€ä¸ªé”å¯¹è±¡ï¼Œç”¨æ¥åœ¨å¯¹ Message è¿›è¡Œå¤ç”¨å›æ”¶æ—¶å€™è¿›è¡Œçº¿ç¨‹åŒæ­¥å¤„ç†ï¼Œé¿å…å¤šçº¿ç¨‹è®¿é—®æ—¶çš„å†…å­˜æ•°æ®å…±äº«é”™è¯¯</p><p>é¦–å…ˆé€šè¿‡ä¸Šé¢çš„ Message#next æˆ‘ä»¬çŸ¥é“ Message æ˜¯ä¸€ä¸ªå•é“¾è¡¨çš„æ•°æ®ç»“æ„</p><p>obtain() æ–¹æ³•åˆ¤æ–­å½“ sPool ä¸ä¸ºç©ºæ—¶ï¼Œå³å·²ç»æœ‰è¢«åˆ›å»ºå‡ºæ¥çš„ Message å¯¹è±¡äº†ï¼Œåˆ™èµ‹å€¼ç»™ <code>m</code> å¹¶å°† <a href="http://m.next/"><code>m.next</code></a>  èµ‹å€¼ç»™ sPoolï¼Œå³å°†å•é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å–å‡ºï¼Œå¹¶å°†ç¬¬äºŒä¸ªèŠ‚ç‚¹ä½œä¸º sPool ï¼Œå³å‰©ä¸‹çš„é“¾è¡¨ç»§ç»­ä½œä¸ºç¼“å­˜æ± ï¼ŒåŒæ—¶å°†ç¼“å­˜æ± çš„æ•°é‡å‡ä¸€ã€‚æœ€åå°†éœ€è¦è¿”å›çš„ <code>m</code> çš„ next èµ‹å€¼ä¸º nullï¼Œæ¸…é™¤ flag ç­‰å¹¶è¿”å› <code>m</code></p><h3 id="3-2-recycler"><a href="#3-2-recycler" class="headerlink" title="3.2 recycler()"></a>3.2 recycler()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isInUse()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gCheckRecycle) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;This message cannot be recycled because it &quot;</span></span><br><span class="line">                    + <span class="string">&quot;is still in use.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    recycleUnchecked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæ£€æŸ¥è¯¥ Message æ˜¯å¦è¿˜åœ¨è¢«ä½¿ç”¨ï¼Œå¦‚æœè¿˜åœ¨è¢«ä½¿ç”¨åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™å¯¹è¯¥ Message è¿›è¡Œå›æ”¶ï¼Œè¯¦è§ <strong>3.3 recyclerUnchecked()</strong></p><h3 id="3-3-recyclerUnchecked"><a href="#3-3-recyclerUnchecked" class="headerlink" title="3.3 recyclerUnchecked()"></a>3.3 recyclerUnchecked()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recycleUnchecked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Mark the message as in use while it remains in the recycled object pool.</span></span><br><span class="line">    <span class="comment">// Clear out all other details.</span></span><br><span class="line">    flags = FLAG_IN_USE;</span><br><span class="line">    what = <span class="number">0</span>;</span><br><span class="line">    arg1 = <span class="number">0</span>;</span><br><span class="line">    arg2 = <span class="number">0</span>;</span><br><span class="line">    obj = <span class="keyword">null</span>;</span><br><span class="line">    replyTo = <span class="keyword">null</span>;</span><br><span class="line">    sendingUid = UID_NONE;</span><br><span class="line">    workSourceUid = UID_NONE;</span><br><span class="line">    when = <span class="number">0</span>;</span><br><span class="line">    target = <span class="keyword">null</span>;</span><br><span class="line">    callback = <span class="keyword">null</span>;</span><br><span class="line">    data = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (sPoolSync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;</span><br><span class="line">            next = sPool;</span><br><span class="line">            sPool = <span class="keyword">this</span>;</span><br><span class="line">            sPoolSize++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•å°±å¾ˆç®€å•äº†ï¼Œå°† Message çš„æˆå‘˜å˜é‡éƒ½è¿˜åŸä¸ºåˆå§‹åŒ–çŠ¶æ€ï¼Œæ¥ç€å°†è¯¥ Message æ’å…¥åˆ°ç¼“å­˜æ± é“¾è¡¨çš„å¤´éƒ¨ï¼Œå¹¶æ›´æ–°ç¼“å­˜æ± çš„æ•°é‡</p><h2 id="4-Handler"><a href="#4-Handler" class="headerlink" title="4. Handler"></a>4. Handler</h2><h3 id="4-1-æ„é€ æ–¹æ³•"><a href="#4-1-æ„é€ æ–¹æ³•" class="headerlink" title="4.1 æ„é€ æ–¹æ³•"></a>4.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(<span class="meta">@Nullable</span> Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...å¿½ç•¥...</span></span><br><span class="line"></span><br><span class="line">    mLooper = Looper.myLooper();</span><br><span class="line">    <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">&quot;Can&#x27;t create handler inside thread &quot;</span> + Thread.currentThread()</span><br><span class="line">                    + <span class="string">&quot; that has not called Looper.prepare()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mQueue = mLooper.mQueue;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mAsynchronous = async;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(<span class="meta">@NonNull</span> Looper looper, <span class="meta">@Nullable</span> Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line">    mLooper = looper;</span><br><span class="line">    mQueue = looper.mQueue;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mAsynchronous = async;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ„é€ æ–¹æ³•çš„åŒºåˆ«åœ¨äºæ˜¯å¦æœ‰ Looper å‚æ•°</p><p>å¦‚æœæ²¡æœ‰ä¼ å…¥ Looper å‚æ•°ï¼Œåˆ™ä¼šè°ƒç”¨ Looper.myLooper() æ–¹æ³•è·å–å½“å‰çº¿ç¨‹ä¸­çš„ Looper èµ‹å€¼ç»™ mLooper ï¼Œå¦‚æœå½“å‰çº¿ç¨‹çš„ Looper è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</p><h3 id="4-2-sendMessageDelayed-Message-msg-long-updateMillis"><a href="#4-2-sendMessageDelayed-Message-msg-long-updateMillis" class="headerlink" title="4.2 sendMessageDelayed(Message msg , long updateMillis)"></a>4.2 sendMessageDelayed(Message msg , long updateMillis)</h3><p>Handler ä¸­çš„ <code>post(Runnable r)</code> ã€<code>postDelayed(@NonNull Runnable r, long delayMillis)</code> ç­‰ç­‰æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ <code>boolean sendMessageAtTime(@NonNull Message msg, long uptimeMillis)</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹å¦‚ä½•å°† Runnable è½¬ä¸º Message çš„æ–¹æ³•ï¼Œå†æ¥ç€çœ‹ sendMessageAtTime</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessageDelayed</span><span class="params">(<span class="meta">@NonNull</span> Message msg, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (delayMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        delayMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªå€¼å¾—æ³¨æ„ç‚¹æ˜¯ï¼Œä¼ å…¥ sendMessageAtTime æ–¹æ³•ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨çš„æ˜¯ SystemClock.uptimeMillis() å³å½“å‰è·ç¦»å¼€æœºçš„æ—¶é—´ï¼Œä½¿ç”¨è¿™ä¸ªæ—¶é—´å°±ä¸ä¼šå› ä¸ºæœºå™¨çš„æ—¶é—´æˆ³å˜åŒ–è€Œå¯¼è‡´ä¸å‡†ç¡®çš„é—®é¢˜</p><h3 id="4-2-1-getPostMessage-Runnable-r"><a href="#4-2-1-getPostMessage-Runnable-r" class="headerlink" title="4.2.1  getPostMessage(Runnable r)"></a>4.2.1  getPostMessage(Runnable r)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Message <span class="title">getPostMessage</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">    Message m = Message.obtain();</span><br><span class="line">    m.callback = r;</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å³ä»ç¼“å­˜æ± ä¸­è·å–ä¸€ä¸ª Message å¯¹è±¡ï¼Œå¹¶å°†å…¶ callback è®¾ç½®ä¸ºä¼ å…¥çš„ Runnable å¯¹è±¡</p><p>è‡³äºè¿™ä¸ª callback çš„ä½œç”¨ï¼Œè¯¦è§ 4.4 dispatchMessage</p><h3 id="4-3-sendMessageAtTime-Message-msg-long-uptimeMillis"><a href="#4-3-sendMessageAtTime-Message-msg-long-uptimeMillis" class="headerlink" title="4.3 sendMessageAtTime(Message msg, long uptimeMillis)"></a>4.3 sendMessageAtTime(Message msg, long uptimeMillis)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(<span class="meta">@NonNull</span> Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">    MessageQueue queue = mQueue;</span><br><span class="line">    <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</span><br><span class="line">        RuntimeException e = <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="keyword">this</span> + <span class="string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);</span><br><span class="line">        Log.w(<span class="string">&quot;Looper&quot;</span>, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sendMessageAtTime</code> æ–¹æ³•ä¼šå…ˆåˆ¤æ–­å½“å‰ Handler ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ— mQueue æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™æŠ›å‡ºå¼‚å¸¸å¹¶æ‰“å°æ—¥å¿—è¿”å›</p><p>å¦åˆ™è°ƒç”¨ <code>enqueueMessage(@NonNull MessageQueue queue, @NonNull Message msg,long uptimeMillis)</code> æ–¹æ³•å°†è¯¥ Message æ¶ˆæ¯å¯¹è±¡æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­</p><h3 id="4-3-1-enqueueMessage-MessageQueue-queue-Message-msg-long-updateMillis"><a href="#4-3-1-enqueueMessage-MessageQueue-queue-Message-msg-long-updateMillis" class="headerlink" title="4.3.1 enqueueMessage(MessageQueue queue,Message msg,long updateMillis)"></a>4.3.1 enqueueMessage(MessageQueue queue,Message msg,long updateMillis)</h3><p>å°† Message çš„ target è®¾ç½®ä¸ºå½“å‰çš„ Handler å¯¹è±¡ï¼Œå¹¶å‹å…¥ MessageQueue é˜Ÿåˆ—ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(<span class="meta">@NonNull</span> MessageQueue queue, <span class="meta">@NonNull</span> Message msg,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">    msg.target = <span class="keyword">this</span>;</span><br><span class="line">    msg.workSourceUid = ThreadLocalWorkSource.getUid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MessageQueue çš„ enqueueMessage æ–¹æ³•è¯¦è§ 5.1 MessageQueue#enqueueMessage()</p><h3 id="4-4-dispatchMessage"><a href="#4-4-dispatchMessage" class="headerlink" title="4.4 dispatchMessage"></a>4.4 dispatchMessage</h3><p>åœ¨ 4.3.1 æ–¹æ³•ä¸­ï¼ŒenqueueMessage æ–¹æ³•å°† Message å‹å…¥ MessageQueue åï¼Œä¼šè¢« 2.3 Looper#loop() ä¸åœè·å–é˜Ÿåˆ—ä¸­çš„ Message å¹¶äº¤ç”±å…¶ target(å³ Handler) å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handle system messages here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šåˆ¤æ–­ msg çš„ callback æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨è¯¥ callback çš„ run æ–¹æ³•</p><blockquote><p>ç”± 3. Message ä¸­æˆ‘ä»¬çŸ¥é“ callback å°±æ˜¯ä¸€ä¸ª Runnable å¯¹è±¡</p></blockquote><p>å¦‚æœ callback ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­ Handler çš„æˆå‘˜å˜é‡ mCallback æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å…¶æ¥å£æ–¹æ³• <code>boolean andlerMessage(Message msg)</code> ï¼Œç”±å®ç°äº†è¯¥ Handler.Callback æ¥å£çš„å­ç±»è‡ªè¡Œå¤„ç†</p><p>å¦‚æœ Handler ä¸­è®¾ç½®äº† Handler.Callbackï¼Œåˆ™å›è°ƒå…¶ handleMessage æ–¹æ³•å¯¹æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¦åˆ™åˆ™è°ƒç”¨ <code>public void handleMessage(@NonNull Message msg)</code> æ–¹æ³•ï¼Œç”±å­ç±»  Override è¯¥æ–¹æ³•å¯¹ä¿¡æ¯è¿›è¡Œå¤„ç†</p><blockquote><p>PS. å¦‚æœ Handler.Callback çš„ handleMessage() æ–¹æ³•è¿”å›äº† trueï¼Œåˆ™ä»£è¡¨ä¸å†éœ€è¦å¯¹è¯¥æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¦åˆ™è¿˜ä¼šè°ƒç”¨ handleMessage æ–¹æ³•å¯¹è¯¥æ¶ˆæ¯è¿›è¡Œå¤„ç†</p></blockquote><h2 id="5-MessageQueue"><a href="#5-MessageQueue" class="headerlink" title="5. MessageQueue"></a>5. MessageQueue</h2><blockquote><p>MessageQueue æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</p></blockquote><h3 id="5-1-enqueueMessage"><a href="#5-1-enqueueMessage" class="headerlink" title="5.1 enqueueMessage()"></a>5.1 enqueueMessage()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</span><br><span class="line"><span class="comment">//å¦‚æœ Message æ²¡æœ‰è®¾ç½® target åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Message must have a target.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.isInUse()) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœè¯¥ message å·²ç»åœ¨ä½¿ç”¨äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">&quot; This message is already in use.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">            IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    msg.target + <span class="string">&quot; sending message to a Handler on a dead thread&quot;</span>);</span><br><span class="line">            Log.w(TAG, e.getMessage(), e);</span><br><span class="line">            msg.recycle();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°†æ¶ˆæ¯æ ‡è®°ä¸ºåœ¨ä½¿ç”¨ä¸­</span></span><br><span class="line">        msg.markInUse();</span><br><span class="line">        <span class="comment">//å°†æ‰§è¡Œæ—¶é—´èµ‹å€¼ç»™ when</span></span><br><span class="line">        msg.when = when;</span><br><span class="line">        Message p = mMessages;</span><br><span class="line">        <span class="keyword">boolean</span> needWake;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ p == null(å³å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æ²¡æœ‰æ¶ˆæ¯)</span></span><br><span class="line">            <span class="comment">//æˆ–è€… when == 0(å³è¯¥æ¶ˆæ¯éœ€è¦ç«‹å³å¤„ç†)</span></span><br><span class="line">            <span class="comment">//æˆ–è€… when &lt; p.when(å³è¯¥æ¶ˆæ¯æ¯”å½“å‰é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯çš„éœ€è¦æ‰§è¡Œçš„æ—¶é—´è¦æ—©)</span></span><br><span class="line">            <span class="comment">//åˆ™å°†è¯¥æ¶ˆæ¯æ’å…¥åˆ°æœ€å‰é¢å¤„ç†</span></span><br><span class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">            msg.next = p;</span><br><span class="line">            mMessages = msg;</span><br><span class="line">            needWake = mBlocked;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Inserted within the middle of the queue.  Usually we don&#x27;t have to wake</span></span><br><span class="line">            <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></span><br><span class="line">            <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></span><br><span class="line">            <span class="comment">//å°†æ¶ˆæ¯æ’å…¥åˆ°é˜Ÿåˆ—ä¸­é—´</span></span><br><span class="line">            <span class="comment">//é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¸éœ€è¦å”¤é†’äº‹ä»¶é˜Ÿåˆ—ï¼Œé™¤éåœ¨é˜Ÿåˆ—çš„å¤´æ˜¯ä¸€ä¸ªå±éšœæ¶ˆæ¯(target == null),å¹¶ä¸”è¦æ’å…¥çš„æ¶ˆæ¯æ˜¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line">            Message prev;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//ä¸‹é¢æ˜¯ä¸ªæ­»å¾ªç¯ï¼Œç›´åˆ°æ‰¾åˆ°é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´(when å­—æ®µ)å°äºè¯¥æ’å…¥æ¶ˆæ¯çš„æ—¶é—´çš„ï¼Œæ’åœ¨å…¶å‰é¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ’å…¥åˆ°é˜Ÿåˆ—æœ€åé¢</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                prev = p;</span><br><span class="line">                p = p.next;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœ p æ˜¯å¼‚æ­¥æ¶ˆæ¯ï¼Œè¯´æ˜è¦æ’å…¥çš„æ¶ˆæ¯ä¸æ˜¯ç¬¬ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯(å› ä¸ºèµ°åˆ°è¿™é‡Œæ¥è¯´æ˜è¦æ’å…¥çš„æ¶ˆæ¯æ˜¯æ’å…¥åˆ°äº† p åé¢äº†)æ‰€ä»¥ä¸éœ€è¦å”¤é†’</span></span><br><span class="line">                    needWake = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">            prev.next = msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">        <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">            nativeWake(mPtr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚æ•° <code>when</code> æ˜¯æŒ‡éœ€è¦æ‰§è¡Œçš„æ—¶é—´æˆ³(ç”¨è·ç¦»æœºå™¨å¼€æœºçš„æ—¶é—´æ¥è®¡ç®—)</p><ul><li>å…ˆåˆ¤æ–­ Message çš„ target æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™æŠ›å‡ºå¼‚å¸¸</li><li>å†åˆ¤æ–­ Message æ˜¯å¦è¢«ä½¿ç”¨äº†ï¼Œå¦‚æœè¯¥ Message å·²ç»è¢«ä½¿ç”¨äº†åˆ™æŠ›å‡ºå¼‚å¸¸</li><li>å†åˆ¤æ–­æ˜¯å¦å·²ç»é€€å‡ºäº†ï¼Œå¦‚æœå·²ç»é€€å‡ºäº†åˆ™å°† Message å›æ”¶å¹¶è¿”å› false</li><li>ä»¥ä¸Šæ£€æŸ¥æ— å¼‚å¸¸åï¼Œå°† Message æ ‡è®°ä¸ºåœ¨ä½¿ç”¨</li></ul><p>ç€é‡çœ‹ä¸€ä¸‹åé¢çš„ä¸€æ®µä»£ç </p><p>åˆ¤æ–­ </p><ol><li>p æ˜¯å¦ä¸ºç©º(<em>å³å½“å‰çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©º</em>) </li><li>when &#x3D;&#x3D; 0(<em>å³è¯¥æ¶ˆæ¯éœ€è¦ç«‹å³æ‰§è¡Œ</em>)</li><li>when&lt; p.when(å³è¯¥æ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´æ—©äºæ¶ˆæ¯é˜Ÿåˆ—çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´)</li></ol><p>å¦‚æœæ»¡è¶³ä»¥ä¸Šä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œåˆ™å°†è¯¥ Message æ’å…¥åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨</p><p>å¦åˆ™å¯¹ æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œéå†ï¼Œç›´åˆ°å°†è¯¥æ¶ˆæ¯æ’å…¥åˆ°æ‰§è¡Œæ—¶é—´éƒ½æ¯”è¯¥æ¶ˆæ¯å°çš„æ¶ˆæ¯åé¢</p><p>å¯è§ï¼ŒMessageQueue æ˜¯æŒ‰ç…§ Message.when å¯¹æ¶ˆæ¯è¿›è¡Œæ’åºçš„ï¼Œé“¾è¡¨ä¸­çš„ Message æŒ‰ç…§ when çš„å¤§å°æ’åº</p><h3 id="5-2-next"><a href="#5-2-next" class="headerlink" title="5.2 next()"></a>5.2 next()</h3><p>next() å†…éƒ¨æœ‰ä¸€ä¸ª for(;;) çš„æ­»å¾ªç¯ï¼Œä¸€ç›´ä» Message é“¾è¡¨ä¸­è·å–ç¬¦åˆæ¡ä»¶çš„ Message å¹¶è¿›è¡Œè¿”å›<br>å¦‚æœåœ¨æŸæ¬¡å¾ªç¯ä¸­è·å–ä¸åˆ° msg ï¼Œåˆ™ä¼šå»å¤„ç† idle handler ï¼Œå¤„ç†å®Œåå°† pendingIdleHandlerCount ç½®ä¸º 0ï¼Œä¿è¯ä¸‹æ¬¡å¾ªç¯ä¸å¤„ç† idle äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Return here if the message loop has already quit and been disposed.</span></span><br><span class="line">    <span class="comment">// This can happen if the application tries to restart a looper after quit</span></span><br><span class="line">    <span class="comment">// which is not supported.</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ¶ˆæ¯å¾ªç¯å·²ç»é€€å‡ºå¹¶ä¸”è¢«å¤„ç†äº†ï¼Œåˆ™ä¼šåœ¨è¿™é‡Œ return</span></span><br><span class="line">    <span class="comment">//è¿™ç§æƒ…å†µå¯èƒ½å‘ç”Ÿåœ¨å¦‚æœåº”ç”¨å°è¯•åœ¨é€€å‡ºåé‡å¯ looper </span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¿™é‡Œä¼šè¿›è¡Œä¼‘çœ ï¼Œç›¸å¯¹åº”çš„ nativeWait() ä¼šè¿›è¡Œå”¤é†’</span></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="comment">//å°è¯•æ£€ç´¢ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±è¿”å›</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">            Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">            Message msg = mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//å½“å‰æ¶ˆæ¯é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä¸” target ä¸º nullï¼Œæ³¨æ„è¿™é‡Œçš„ target ä¸º null</span></span><br><span class="line">                <span class="comment">//åˆ™ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰¾åˆ°å¼‚æ­¥çš„ Message</span></span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">                <span class="comment">//msg ä¸ä¸ºç©ºä¸”ä¸ºåŒæ­¥çš„æ¶ˆæ¯ï¼Œåˆ™ç»§ç»­å¾ªç¯ç›´åˆ°æ‰¾åˆ°å¼‚æ­¥çš„æ¶ˆæ¯</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ­¤æ—¶ msg å°±æ˜¯ç¬¬ä¸€ä¸ªéœ€è¦è¿›è¡Œå¤„ç†çš„ Messageï¼ˆå¯èƒ½æ˜¯æ¶ˆæ¯å±éšœåçš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œä¹Ÿå¯èƒ½æ˜¯åŸæœ¬æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å¤´ï¼Œå³ mMessageï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.when) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœå½“å‰æ—¶é—´è¿˜æ²¡åˆ°æ¶ˆæ¯éœ€è¦å¤„ç†çš„æ—¶é—´ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªå»¶æ—¶æ—¶é—´ï¼Œè¿™é‡Œä¸ä¼š return Messageï¼Œ</span></span><br><span class="line">                    <span class="comment">//å¦‚æœè¿˜æ²¡åˆ°æ¶ˆæ¯éœ€è¦å¤„ç†çš„æ—¶é—´ï¼Œæ‰€ä»¥ for å¾ªç¯ä¼šä¸€ç›´è¿›å…¥è¿™ä¸ª case å¯¼è‡´é˜»å¡åœ¨è¿™é‡Œ</span></span><br><span class="line">                    <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">                    nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//æ¶ˆæ¯éœ€è¦å¤„ç†ï¼Œåˆ™å°†è¯¥æ¶ˆæ¯è¿”å›ï¼Œå¹¶å°†é“¾è¡¨çš„ç¬¬äºŒä¸ªæ•°æ®ç§»åˆ°é“¾è¡¨å¤´ï¼Œå¹¶é€€å‡ºå¾ªç¯</span></span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœ prevMsg ä¸ä¸º nullï¼Œè¯´æ˜ msg ä¸ºéœ€è¦å¤„ç†çš„å¼‚æ­¥æ¶ˆæ¯ï¼Œè¢«æå‰å–å‡ºæ¥å¤„ç†äº†</span></span><br><span class="line">                        <span class="comment">//è€Œ prevMsg å°±æ˜¯è¯¥æ¶ˆæ¯çš„å‰ä¸€ä¸ªæ¶ˆæ¯ï¼Œç°åœ¨å°† msg.next é“¾æ¥åˆ° prevMsg.next çš„åé¢ï¼Œ(å…¶å®å°±ç›¸å½“äºåˆ é™¤äº†ä¸­é—´çš„ msg)</span></span><br><span class="line">                        <span class="comment">//æ­¤æ—¶çš„ mMessage è¿˜æ˜¯åŸæ¥çš„ mMessageï¼Œä¸‹æ¬¡è¿›å…¥ next() æ–¹æ³• mMessage è¿˜æ˜¯åŸæ¥çš„é‚£ä¸ª</span></span><br><span class="line">                        prevMsg.next = msg.next;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//å°†é“¾è¡¨çš„ç¬¬äºŒä¸ªæ•°æ®ç§»åˆ°é“¾è¡¨å¤´</span></span><br><span class="line">                        mMessages = msg.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.next = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Returning message: &quot;</span> + msg);</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                dispose();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If first time idle, then get the number of idlers to run.</span></span><br><span class="line">            <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></span><br><span class="line">            <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//å¦‚æœç¬¬ä¸€æ¬¡é—²ç½®ï¼Œåˆ™ä¼šè·å– idleHandlers çš„æ•°é‡</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</span><br><span class="line">                pendingIdleHandlerCount = mIdleHandlers.size();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœ idleHandler æ•°é‡å°äº0ï¼Œåˆ™è·³è¿‡åé¢çš„ idleHandler çš„é€»è¾‘ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª next() å¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                mBlocked = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦åˆ™</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å°†å¤–éƒ¨æ·»åŠ è¿›æ¥çš„ mIdleHandlers åˆ—è¡¨æ‹·è´åˆ° mPendingIdleHandlers æ•°ç»„ä¸­</span></span><br><span class="line">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Run the idle handlers.</span></span><br><span class="line">        <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line">        <span class="comment">//è¿è¡Œ idle Handler çš„é€»è¾‘ï¼Œè¿™é‡Œåªå¯èƒ½åœ¨ç¬¬ä¸€æ¬¡ for å¾ªç¯çš„è¿­ä»£æ—¶è¢«æ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">//(å› ä¸ºåé¢å°† pendingIdleHandlerCount ç½®ä¸º 0äº†ï¼Œæ‰€ä»¥å¯¼è‡´åç»­ pendingIdleHandlerCount ä¸€ç›´ä¸º 0)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</span><br><span class="line">            mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//IdleHandler å„è‡ªå¤„ç†é€»è¾‘ï¼Œå¹¶è¿”å›æ˜¯å¦éœ€è¦è¢«ç§»é™¤</span></span><br><span class="line">                keep = idler.queueIdle();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;IdleHandler threw exception&quot;</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!keep) &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœè¿”å›éœ€è¦è¢«ç§»é™¤ï¼Œåˆ™ç§»é™¤è¯¥ idleHandler</span></span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    mIdleHandlers.remove(idler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></span><br><span class="line">        <span class="comment">//å°†å¾…åŠçš„é—²ç½® IdleHandler çš„æ•°é‡ç½®ä¸º 0 </span></span><br><span class="line">        pendingIdleHandlerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// While calling an idle handler, a new message could have been delivered</span></span><br><span class="line">        <span class="comment">// so go back and look again for a pending message without waiting.</span></span><br><span class="line">        nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-quit"><a href="#5-3-quit" class="headerlink" title="5.3 quit()"></a>5.3 quit()</h3><p>å°† mQuitting æ ‡å¿—ä½ç½®ä¸º trueï¼Œåç»­ MessageQueue çš„ next() æ–¹æ³•ç­‰åœ°æ–¹ ä½¿ç”¨è¯¥å­—æ®µåšåˆ¤æ–­åè¿›è¡Œå¤„ç†</p><h2 id="6-æ¶ˆæ¯åŒæ­¥å±éšœ"><a href="#6-æ¶ˆæ¯åŒæ­¥å±éšœ" class="headerlink" title="6. æ¶ˆæ¯åŒæ­¥å±éšœ"></a>6. æ¶ˆæ¯åŒæ­¥å±éšœ</h2><blockquote><p>åŒæ­¥å±éšœï¼Œé¡¾åæ€ä¹‰ï¼Œå°†åŒæ­¥çš„æ¶ˆæ¯ç»™æŒ¡ä½ï¼Œä¼˜å…ˆå¤„ç†éåŒæ­¥(å³å¼‚æ­¥)çš„æ¶ˆæ¯</p></blockquote><p>ä»ä»¥ä¸Šæˆ‘ä»¬ MessageQueue#next() ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ä» MessageQueue ä¸­è·å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ—¶ï¼Œä¼šä¼˜å…ˆè·å–å¼‚æ­¥çš„æ¶ˆæ¯(msg.isAsynchronous() &#x3D;&#x3D; true)è¿›è¡Œå¤„ç†</p><h3 id="6-1-å¦‚ä½•å¼€å¯åŒæ­¥å±éšœ"><a href="#6-1-å¦‚ä½•å¼€å¯åŒæ­¥å±éšœ" class="headerlink" title="6.1 å¦‚ä½•å¼€å¯åŒæ­¥å±éšœ"></a>6.1 å¦‚ä½•å¼€å¯åŒæ­¥å±éšœ</h3><p>æŒ‰ç†æ¥è¯´ï¼Œè¦å¼€å¯åŒæ­¥å±éšœï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ <code>MessageQueue#postSyncBarrier(long when)</code> æ–¹æ³•ä¸­ï¼Œä¼šåœ¨ MessageQueue æ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿå¤´æ’å…¥ä¸€ä¸ª message(è¿™ä¸ª Message çš„ target ä¸º null) å³å¯</p><p>è¿™ä¸ª message ä»…ä»…ä½œä¸ºä¸€ä¸ªæ ‡å¿—å­˜åœ¨ï¼Œå¹¶ä¸ç”¨æ¥åˆ†å‘äº‹ä»¶ï¼Œ<br>å½“ looper åœ¨è¿›è¡Œå¾ªç¯ğŸ”„æ—¶ï¼Œè°ƒç”¨ queue.next() æ–¹æ³•ï¼Œå½“é‡åˆ° <code>message.target == null</code> ï¼Œåˆ™ä¼šä» MessageQueue ä¸­æ‰¾åˆ°å¼‚æ­¥çš„æ¶ˆæ¯å¹¶è¿”å›</p><p>ä½†æ˜¯ç”±ä¸Šæ–‡å¯çŸ¥ï¼Œåœ¨è°ƒç”¨ <code>enqueueMessage</code> æ–¹æ³•åï¼Œä¼šå°† msg çš„ target èµ‹å€¼ä¸ºå½“å‰çš„ Handler å¯¼è‡´æˆ‘ä»¬çš„ä¸Šé¢æƒ³æ’å…¥ä¸€ä¸ª target &#x3D;&#x3D; null çš„ Message çš„æƒ³æ³•ä¸æˆç«‹</p><p>å¹¶ä¸” <code>MessageQueue#postSyncBarrier()</code> æ–¹æ³•å¹¶ä¸å¼€æ”¾ç»™å¼€å‘è€…ä½¿ç”¨ï¼Œæ‰€ä»¥è¦å¼€å¯åŒæ­¥å±éšœï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡åå°„è¯¥æ–¹æ³•è¿›è¡Œè°ƒç”¨</p><p>è€Œå¦‚æœç›´æ¥ä½¿ç”¨ <code>Handler.sendMessage()</code> ç­‰æ–¹æ³•æ’å…¥æ¶ˆæ¯ï¼Œä¼šæ ¹æ®æ—¶é—´é¡ºåºæ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœè¦ç«‹å³ç”Ÿæ•ˆï¼Œåˆ™éœ€è¦å°†æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—é˜Ÿå¤´ï¼Œå¦‚ä½•å°†æ¶ˆæ¯æ’å…¥åˆ°é˜Ÿåˆ—å¤´éƒ¨ï¼Œè¯¦è§ *** 6.3 å¦‚ä½•å°†æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—å¤´éƒ¨ ***</p><h3 id="6-2-å¦‚ä½•æ’å…¥å¼‚æ­¥æ¶ˆæ¯"><a href="#6-2-å¦‚ä½•æ’å…¥å¼‚æ­¥æ¶ˆæ¯" class="headerlink" title="6.2 å¦‚ä½•æ’å…¥å¼‚æ­¥æ¶ˆæ¯"></a>6.2 å¦‚ä½•æ’å…¥å¼‚æ­¥æ¶ˆæ¯</h3><ol><li><p>æ„é€ å¼‚æ­¥ Handler<br>ä» <code>4.3.1 enqueueMessage</code> ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“ <code>mAsynchronous</code> å­—æ®µä¸º true æ—¶å€™ï¼Œä¼šå°† message è®¾ç½®ä¸ºå¼‚æ­¥æ¶ˆæ¯<br>æ‰€ä»¥åªéœ€è¦åœ¨æ„é€  Handler çš„æ—¶å€™ï¼Œå°†æ„é€ æ–¹æ³•ä¸­çš„ async å­—æ®µè®¾ç½®ä¸º true å³å¯ï¼Œåˆ™åç»­æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šæ˜¯å¼‚æ­¥çš„æ¶ˆæ¯</p></li><li><p>æ„é€ å¼‚æ­¥çš„ Message</p></li></ol><p>åœ¨æ„é€  Message æ—¶ï¼Œé€šè¿‡ <code>setAsynchronous(boolean async)</code> æ–¹æ³•è®¾ç½®è¯¥æ¶ˆæ¯ä¸ºå¼‚æ­¥æ¶ˆæ¯å³å¯</p><h3 id="6-3-å¦‚ä½•å°†æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—å¤´éƒ¨"><a href="#6-3-å¦‚ä½•å°†æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—å¤´éƒ¨" class="headerlink" title="6.3 å¦‚ä½•å°†æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—å¤´éƒ¨"></a>6.3 å¦‚ä½•å°†æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—å¤´éƒ¨</h3><p>ç”±ä¸Šè¿°åˆ†ææˆ‘ä»¬çŸ¥é“é€šè¿‡ <code>Handler#enqueMessage()</code> æ–¹æ³•å°†æ¶ˆæ¯æ’å…¥ <code>MessageQueue</code> ä¸­ï¼Œä¼šæ ¹æ® <code>message.when</code> ç”±å°åˆ°å¤§æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœéœ€è¦å°†æ¶ˆæ¯æ’å…¥åˆ°é˜Ÿå¤´ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿å¾— <code>when</code> ä¸º 0ï¼Œä½† <code>when</code> è¿™ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸æ”¯æŒå¼€å‘è€…ä¿®æ”¹çš„</p><p>ä½†æ˜¯ <code>Handler</code> ä¸­æä¾›äº†ä¸€ä¸ª <code>Handler#postAtFrontOfQueue</code> (æœ€ç»ˆè°ƒç”¨ <code>Handler#sendMessageAtFrontOfQueue</code>) æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•åœ¨å°†æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—å‰ï¼Œä¼šå°† when è®¾ç½®ä¸º0ï¼Œåˆ™ä¼šå°†è¯¥æ¶ˆæ¯æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿå¤´</p><h2 id="7-ä¸¾ä¾‹"><a href="#7-ä¸¾ä¾‹" class="headerlink" title="7. ä¸¾ä¾‹"></a>7. ä¸¾ä¾‹</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> normalHandler <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Handler(Looper.getMainLooper(),<span class="keyword">object</span> : Handler.Callback&#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">            Log.d(TAG,<span class="string">&quot;æ™®é€š Handler å›è°ƒ msg is <span class="variable">$msg</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> asyncHandler <span class="keyword">by</span> lazy &#123;</span><br><span class="line">    Handler.createAsync(Looper.getMainLooper(),<span class="keyword">object</span> : Handler.Callback&#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">            Log.d(TAG,<span class="string">&quot;å¼‚æ­¥ Handler å›è°ƒ msg is <span class="variable">$msg</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">testSendNormalMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Log.d(TAG,<span class="string">&quot;æ™®é€š Handler sendMessage start&quot;</span>)</span><br><span class="line">    normalHandler.sendMessage(Message().apply &#123; obj = <span class="string">&quot;æ™®é€š Handler è°ƒç”¨ sendMessage å‘é€çš„æ¶ˆæ¯&quot;</span> &#125;)</span><br><span class="line">    Log.d(TAG,<span class="string">&quot;æ™®é€š Handler sendMessage end&quot;</span>)</span><br><span class="line"></span><br><span class="line">    Log.d(TAG,<span class="string">&quot;å¼‚æ­¥ Handler sendMessageAtFrontOfQueue start&quot;</span>)</span><br><span class="line">    asyncHandler.sendMessageAtFrontOfQueue(Message().apply &#123; obj = <span class="string">&quot;å¼‚æ­¥ Handler è°ƒç”¨ sendMessageAtFrontOfQueue å‘é€çš„æ¶ˆæ¯&quot;</span> &#125;)</span><br><span class="line">    Log.d(TAG,<span class="string">&quot;å¼‚æ­¥ Handler sendMessageAtFrontOfQueue end&quot;</span>)</span><br><span class="line"></span><br><span class="line">    Log.d(TAG,<span class="string">&quot;å¼‚æ­¥ Handler sendMessage start&quot;</span>)</span><br><span class="line">    asyncHandler.sendMessage(Message().apply &#123; obj = <span class="string">&quot;å¼‚æ­¥ Handler è°ƒç”¨ sendMessage å‘é€çš„æ¶ˆæ¯&quot;</span> &#125;)</span><br><span class="line">    Log.d(TAG,<span class="string">&quot;å¼‚æ­¥ Handler sendMessage end&quot;</span>)</span><br><span class="line"></span><br><span class="line">    Log.d(TAG,<span class="string">&quot;æ™®é€š Handler sendMessageAtFrontOfQueue start&quot;</span>)</span><br><span class="line">    normalHandler.sendMessageAtFrontOfQueue(Message().apply &#123; obj = <span class="string">&quot;æ™®é€š Handler è°ƒç”¨ sendMessageAtFrontOfQueue å‘é€çš„æ¶ˆæ¯&quot;</span> &#125;)</span><br><span class="line">    Log.d(TAG,<span class="string">&quot;æ™®é€š Handler sendMessageAtFrontOfQueue end&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">æ™®é€š Handler sendMessage start</span><br><span class="line">æ™®é€š Handler sendMessage end</span><br><span class="line">å¼‚æ­¥ Handler sendMessageAtFrontOfQueue start</span><br><span class="line">å¼‚æ­¥ Handler sendMessageAtFrontOfQueue end</span><br><span class="line">å¼‚æ­¥ Handler sendMessage start</span><br><span class="line">å¼‚æ­¥ Handler sendMessage end</span><br><span class="line">æ™®é€š Handler sendMessageAtFrontOfQueue start</span><br><span class="line">æ™®é€š Handler sendMessageAtFrontOfQueue end</span><br><span class="line">æ™®é€š Handler å›è°ƒ msg is &#123; when=-4d23h57m46s154ms what=0 obj=åŒæ­¥ Handler è°ƒç”¨ sendMessageAtFrontOfQueue å‘é€çš„æ¶ˆæ¯ target=android.os.Handler &#125;</span><br><span class="line">å¼‚æ­¥ Handler å›è°ƒ msg is &#123; when=-4d23h57m46s154ms what=0 obj=å¼‚æ­¥ Handler è°ƒç”¨ sendMessageAtFrontOfQueue å‘é€çš„æ¶ˆæ¯ target=android.os.Handler &#125;</span><br><span class="line">æ™®é€š Handler å›è°ƒ msg is &#123; when=-13ms what=0 obj=æ™®é€š Handler è°ƒç”¨ sendMessage å‘é€çš„æ¶ˆæ¯ target=android.os.Handler &#125;</span><br><span class="line">å¼‚æ­¥ Handler å›è°ƒ msg is &#123; when=-13ms what=0 obj=å¼‚æ­¥ Handler è°ƒç”¨ sendMessage å‘é€çš„æ¶ˆæ¯ target=android.os.Handler &#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çš„ asyncHandler å¹¶ä¸èƒ½å°†å…¶æ¶ˆæ¯æ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„æœ€å‰é¢ï¼Œè€Œæ˜¯å–å†³äºå…¶æ’å…¥çš„é¡ºåºï¼Œåè°ƒç”¨ <code>sendMessageAtFrontOfQueue</code> çš„æ¶ˆæ¯åæ’å…¥åˆ°å‰é¢å»</p><p>å¦‚æœè¦ä½¿å¾— asyncHandler æ’å…¥çš„æ¶ˆæ¯èƒ½ä¼˜å…ˆå¤„ç†ï¼Œåˆ™éœ€è¦åŒæ­¥å±éšœèµ·ä½œç”¨ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡åå°„å¼€å¯ä¸€ä¸‹åŒæ­¥å±éšœï¼Œå†åœ¨ä½¿ç”¨å®Œæ¯•åå…³é—­åŒæ­¥å±éšœ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private var barrierToken = 0</span><br><span class="line"></span><br><span class="line">fun startReflectPostSyncBarrier(looper: Looper)&#123;</span><br><span class="line">    val method: Method = MessageQueue::class.java.getDeclaredMethod(&quot;postSyncBarrier&quot;)</span><br><span class="line">    barrierToken = method.invoke(looper.queue) as Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun stopReflectPostSyncBarrier(looper: Looper)&#123;</span><br><span class="line">    val method = MessageQueue::class.java</span><br><span class="line">        .getDeclaredMethod(&quot;removeSyncBarrier&quot;, Int::class.javaPrimitiveType)</span><br><span class="line">    method.invoke(looper.queue, barrierToken)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨ <code>testSendNormalMessage</code> æ–¹æ³•å‰å…ˆè°ƒç”¨ <code>startReflectPostSyncBarrier</code> æ–¹æ³•ï¼Œå»ºç«‹èµ·åŒæ­¥å±éšœ</p><p>æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">æ™®é€š Handler sendMessage start</span><br><span class="line">æ™®é€š Handler sendMessage end</span><br><span class="line">å¼‚æ­¥ Handler sendMessageAtFrontOfQueue start</span><br><span class="line">å¼‚æ­¥ Handler sendMessageAtFrontOfQueue end</span><br><span class="line">å¼‚æ­¥ Handler sendMessage start</span><br><span class="line">å¼‚æ­¥ Handler sendMessage end</span><br><span class="line">æ™®é€š Handler sendMessageAtFrontOfQueue start</span><br><span class="line">æ™®é€š Handler sendMessageAtFrontOfQueue end</span><br><span class="line">æ™®é€š Handler å›è°ƒ msg is &#123; when=-5d0h9m7s27ms what=0 obj=æ™®é€š Handler è°ƒç”¨ sendMessageAtFrontOfQueue å‘é€çš„æ¶ˆæ¯ target=android.os.Handler &#125;</span><br><span class="line">å¼‚æ­¥ Handler å›è°ƒ msg is &#123; when=-5d0h9m7s27ms what=0 obj=å¼‚æ­¥ Handler è°ƒç”¨ sendMessageAtFrontOfQueue å‘é€çš„æ¶ˆæ¯ target=android.os.Handler &#125;</span><br><span class="line">å¼‚æ­¥ Handler å›è°ƒ msg is &#123; when=-11ms what=0 obj=å¼‚æ­¥ Handler è°ƒç”¨ sendMessage å‘é€çš„æ¶ˆæ¯ target=android.os.Handler &#125;</span><br></pre></td></tr></table></figure><p><code>startReflectPostSyncBarrier()</code> æ–¹æ³•å»ºç«‹èµ·äº†åŒæ­¥å±éšœï¼Œå³å¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥äº†ä¸€æ¡ target &#x3D; null çš„æ¶ˆæ¯ï¼Œä¸” <code>msg.when</code> çš„å€¼ä¸ºå½“å‰æ—¶é—´<br>ç”±äºæ™®é€š(åŒæ­¥)çš„ Handler å°†æ’å…¥äº†ä¸€æ¡æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœ€å‰é¢ï¼Œwhen &#x3D;&#x3D; 0ï¼Œæ‰€ä»¥å¯¼è‡´ä¼šå…ˆå¤„ç†è¯¥æ™®é€šæ¶ˆæ¯ï¼Œç„¶åå†é‡åˆ°äº† target &#x3D;&#x3D; null çš„æ¶ˆæ¯ï¼Œåˆ™å¼€å§‹éå†å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œå¦‚æœä¸è°ƒç”¨ <code>android.os.MessageQueue#removeSyncBarrier</code> æ–¹æ³•å°† <code>target == null</code> çš„æ¶ˆæ¯ç§»é™¤æ‰ï¼Œåˆ™è¯¥ MessageQueue ä¸­çš„åŒæ­¥æ¶ˆæ¯å°±ä¸€ç›´æ— æ³•å¾—åˆ°å¤„ç†</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç”¨ä»¥ä¸‹ä¸€å¹…å›¾æ¥æ€»ç»“ Android ä¸­çš„æ¶ˆæ¯åˆ†å‘æœºåˆ¶</p><p>Looper åƒæ˜¯ä¸€ä¸ªå‘åŠ¨æœºï¼Œä¸åœåœ°å°†ç”Ÿäº§è€…äº§ç”Ÿçš„ Message ä»ä¼ é€å¸¦(MessageQueue) ä¸­åˆ†å‘ç»™æ¶ˆè´¹è€…å»å¤„ç†</p><p><img src="https://i.loli.net/2021/04/21/Fc6QszDW15xuEiG.png" alt="Handler æ¶ˆæ¯æœºåˆ¶.png"></p><p>æœ¬æ–‡å‚è€ƒï¼š</p><p><a href="http://gityuan.com/2015/12/26/handler-message-framework/">Androidæ¶ˆæ¯æœºåˆ¶1-Handler(Javaå±‚)</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ Android ä¸­ï¼Œä½¿ç”¨ Handler ä¸»è¦ç”¨äºä¸åŒçº¿ç¨‹é—´çš„é€šä¿¡&lt;/p&gt;
&lt;p&gt;&lt;em&gt;æœ¬æ–‡åŸºäº Target 30 çš„ Android æºç è¿›è¡Œåˆ†æ&lt;/em&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    <category term="æºç " scheme="https://ppting.me/categories/%E6%BA%90%E7%A0%81/"/>
    
    
    <category term="Handler" scheme="https://ppting.me/tags/Handler/"/>
    
  </entry>
  
  <entry>
    <title>Java å­—ç¬¦ä¸²ç¼–ç </title>
    <link href="https://ppting.me/2021/04/01/2021_04_01_java_string_encode/"/>
    <id>https://ppting.me/2021/04/01/2021_04_01_java_string_encode/</id>
    <published>2021-03-31T16:00:00.000Z</published>
    <updated>2022-02-12T08:15:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><em>æœ¬æ–‡è§£é‡Š Java ä¸­çš„å­—ç¬¦ä¸²ç¼–ç </em></p><span id="more"></span><h2 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h2><table><thead><tr><th>åè¯</th><th>å•ä½</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>ä½</td><td>bit</td><td>è®¡ç®—æœºä¸­æœ€å°çš„å•ä½ ç”¨0&#x2F;1æ ‡è¯†</td></tr><tr><td>å­—èŠ‚</td><td>byte</td><td>å¯è¡¨ç¤ºå¸¸ç”¨è‹±æ–‡å­—ç¬¦8ä½äºŒè¿›åˆ¶ç§°ä¸ºä¸€å­—èŠ‚ï¼Œä¸€å­—èŠ‚å¯ä»¥å­˜å‚¨2^8(&#x3D;256)ç§çŠ¶æ€</td></tr></tbody></table><blockquote><p>åœ¨ Java ä¸­ï¼Œ char å ä¸¤ä¸ªå­—èŠ‚(2 byte)ï¼Œå³ 16 bits</p></blockquote><h2 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h2><p>Unicode æ˜¯ä¸€ä¸ªå­—ç¬¦é›†ï¼ŒåŒ…å«äº†å…¨ä¸–ç•Œçš„å‡ ä¹æ‰€æœ‰å­—ç¬¦ï¼Œç°æœ‰çš„å­—ç¬¦å¤§çº¦æœ‰ç™¾ä¸‡å¤šä¸ªï¼Œè¯¦è§ <a href="https://home.unicode.org/">https://home.unicode.org/</a></p><h2 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h2><p><code>ç ç‚¹(code point)</code>ä»£è¡¨ Unicode å­—ç¬¦é›†ä¸­çš„ä¸€ä¸ªå€¼ï¼Œä»£è¡¨ä¸€ä¸ªç¬¦å·</p><p><code>ä»£ç å•å…ƒ(code unit)</code>ä»£è¡¨å…·ä½“ç¼–ç å½¢å¼ä¸­çš„æœ€å°å•ä½</p><p>åœ¨ Java ä¸­ï¼Œä½¿ç”¨ <code>UTF-16</code> ä½œä¸ºå†…å­˜ä¸­å­—ç¬¦å­˜å‚¨æ ¼å¼ï¼Œå³ 16ä½ï¼Œä¸¤ä¸ªå­—èŠ‚ï¼Œåªèƒ½å­˜å‚¨ <code>2^16 - 1 = 65535</code> ä¸ªå­—ç¬¦ã€‚ <code>UTF-16</code> ç¼–ç çš„è§„åˆ™å¾ˆç®€å•ï¼šåŸºæœ¬å¹³é¢çš„å­—ç¬¦å ç”¨2ä¸ªå­—èŠ‚ï¼Œè¾…åŠ©å¹³é¢çš„å­—èŠ‚å 4ä¸ªå­—èŠ‚</p><p>åˆ™å…¶ <code>ä»£ç å•å…ƒ(code unit)</code> å°±æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œåœ¨ Java ä¸­ï¼Œä¸€ä¸ª<code>ç ç‚¹(code point)</code>å¯èƒ½ç”±ä¸¤ä¸ª<code>ä»£ç å•å…ƒ(code unit)</code>æˆ–è€…å››ä¸ª<code>ä»£ç å•å…ƒ(code unit)</code>ç»„æˆ</p><p>ä¾‹å¦‚<code>ä¸­</code>å­—çš„ç ç‚¹ä¸º <code>U+4E2D</code>ï¼ŒUTF-16 çš„ç¼–ç ä¸º <code>\u4e2d</code>ï¼Œå ç”¨ä¸¤ä¸ª<code>ä»£ç å•å…ƒ(code unit)</code>ï¼Œä¸€å…±å ç”¨ä¸¤ä¸ªå­—èŠ‚(1ä¸ª char)</p><p>ä½†æ˜¯ï¼Œåœ¨ Unicode å­—ç¬¦é›†å·²ç»è¿œè¿œè¶…è¿‡ 65535 ä¸ªå­—ç¬¦äº†ï¼Œéš¾é“ Java ä¸­ä¸èƒ½è¡¨ç¤º Unicode ä¸­è¶…è¿‡ 65535 çš„å­—ç¬¦äº†å—ï¼Œå½“ç„¶ä¸æ˜¯</p><p>åœ¨ Java ä¸­ï¼Œchar ä¸ºä¸¤ä¸ªå­—èŠ‚ï¼Œå³16ä½ï¼›åœ¨ä»£ç ä¸­å¯ä»¥ä½¿ç”¨ <code>\uxxxx</code> è¡¨ç¤ºæŸä¸ªå­—ç¬¦ï¼Œä½†æ˜¯åªèƒ½è¡¨ç¤º 0x0000~0xFFFF ä¹‹é—´çš„å­—ç¬¦ï¼Œå¦‚æœéœ€è¦è¡¨ç¤ºè¶…è¿‡ 0xFFFFä»¥åçš„å­—ç¬¦ï¼Œåˆ™éœ€è¦ç”¨ä¸¤ä¸ª char æ¥è¡¨ç¤ºï¼Œä¾‹å¦‚ <code>ğŸ’¢  U+1F4A2</code> åˆ™ä½¿ç”¨ <code>\uD83D\uDCA2</code> è¡¨ç¤º</p><p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ª <code>U+1F4A2</code> å·²ç»è¶…è¿‡äº†åŸºæœ¬é¢çš„èŒƒå›´<code>0x0000-0xFFFF</code> </p><p>è¿™ä¸ª<code>\uD83D\uDCA2</code>æ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„å‘¢</p><p>åœ¨ <code>UTF-16</code> ç¼–ç ä¸­ï¼ŒåŸºæœ¬é¢çš„å­—ç¬¦ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œå¦‚ä¸Šçš„<code>ä¸­</code>ï¼Œè¾…åŠ©å¹³é¢çš„å­—ç¬¦ä½¿ç”¨å››ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´åœ¨ <code>UTF-16</code> ä¸­ï¼Œä¸€ä¸ªå­—ç¬¦è¦ä¹ˆä¸ºä¸¤ä¸ªå­—èŠ‚(<strong>ä½äº[U+0000,U+FFFF]é—´</strong>)ï¼Œè¦ä¹ˆä¸ºå››ä¸ªå­—èŠ‚(<strong>ä½äº[U+010000,U+10FFFF]é—´</strong>)</p><p><em><strong>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå½“é‡åˆ°ä¸¤ä¸ªå­—èŠ‚æ—¶ï¼Œæ˜¯æŠŠå®ƒå½“åšå•ç‹¬çš„å­—ç¬¦ï¼Œè¿˜æ˜¯ä¸åé¢çš„ä¸¤ä¸ªå­—èŠ‚ä¸€èµ·å½“æˆä¸€ä¸ªå››å­—èŠ‚çš„å­—ç¬¦å‘¢ï¼Ÿ</strong></em></p><p>åœ¨ UTF-16 ä¸­ï¼Œè¾…åŠ©å¹³é¢çš„å­—ç¬¦ä½¿ç”¨ 20ä¸ª bit è¿›è¡Œè¡¨ç¤ºï¼Œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œé«˜10ä½å’Œä½10ä½</p><p>0000000000 0000000000</p><p>UTF-16ç¼–ç å°†è¶…è¿‡ U+FFFF çš„å­—ç¬¦ï¼Œä¼šå°†å…¶æ‹†æˆä¸¤ä¸ªå­—ç¬¦è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸º<code>H(é«˜ä½ high)</code> å’Œ <code> L (ä½ä½ low)</code><br>å¹¶å°†å…¶æ˜ å°„åˆ° <code>U+D800-U+DBFF</code> å’Œ <code>U+DC00-U+DFFF</code> ä¹‹é—´ï¼ˆåŸºæœ¬å¹³é¢ä¸­[U+D800,U+DFFF] ä¸ºç©ºï¼Œä¸å¯¹åº”ä»»ä½•å­—ç¬¦ï¼‰</p><p>å³ä¸€ä¸ªå››ä¸ªå­—èŠ‚çš„è¾…åŠ©å¹³é¢å­—ç¬¦ä¼šä½¿ç”¨ä¸¤ä¸ªåŸºæœ¬å¹³é¢çš„å­—ç¬¦æ¥è¡¨ç¤º</p><p>å› æ­¤ï¼Œå½“é‡åˆ°ä¸€ä¸ªå­—ç¬¦çš„ç ç‚¹è¶…è¿‡ U+FFFF æ—¶å€™ï¼Œä¾‹å¦‚ <code>ğŸ’¢  U+1F4A2</code> å·²ç»è¶…è¿‡äº† U+FFFFï¼Œåˆ™åœ¨ UTF-16 ä¸­ä½¿ç”¨å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œåˆ™éœ€è¦è¿›è¡Œè®¡ç®—å‡ºä½ä½å’Œé«˜ä½çš„æ•°å€¼</p><p>å…ˆè®¡ç®—é«˜ä½ã€‚<br>å‡å»è¶…è¿‡çš„éƒ¨åˆ†ï¼Œå¾—åˆ°æ•°å€¼ A<br>A &#x3D; 0x1F4A2 - 0x10000 &#x3D; 0xF4A2 , å³ <code>1 11101 00101 00010</code></p><p>å°† A è¡¥é½åˆ°20ä½äºŒè¿›åˆ¶ï¼Œå¾—åˆ° <code>00001 11101 00101 00010</code><br>å°†å‰åä½æ˜ å°„åˆ° <code>U+D800-U+DBFF</code>ä¹‹é—´ï¼Œååä½æ˜ å°„åˆ° <code>U+DC00-U+DFFF</code> ä¹‹é—´</p><p>0xD800 çš„äºŒè¿›åˆ¶ä¸º 110110 00000 00000<br>0xDC00 çš„äºŒè¿›åˆ¶ä¸º 110111 00000 00000</p><p>é«˜ä½ï¼šå°†å‰åä½å’Œ 0xD800 ç›¸åŠ ï¼Œå¾—åˆ° <code>1101100000111101</code> å³ <code>0xD83D</code><br>ä½ä½ï¼šå°†ååä½å’Œ 0xDC00 ç›¸åŠ ï¼Œå¾—åˆ° <code>1101110010100010</code> å³ <code>0xDCA2</code></p><p>åˆ™å¾—åˆ° <code>ğŸ’¢  U+1F4A2</code> çš„ UTF-16 çš„ç¼–ç ä¸º <code>\uDB3D\uDCA2</code></p><p>å…·ä½“çš„è¾…åŠ©å¹³é¢å­—ç¬¦çš„è½¬æ¢ç®—æ³•å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">H = (C - 0x10000) / 0x400 + 0xD800</span><br><span class="line">L = (C - 0x10000) % 0x400 + 0xDC00</span><br><span class="line"></span><br><span class="line">PS. 0x400 å³ äºŒè¿›åˆ¶çš„ 1 00000 00000</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå°†ä¸€ä¸ª Unicode å­—ç¬¦è½¬ä¸º UTF16 çš„ç¼–ç çš„æ–¹æ³•å·²ç»æ¢ç©¶å®Œäº†ï¼Œç°åœ¨åè¿‡æ¥çœ‹ä¸€ä¸‹åœ¨é‡åˆ° UTF16 ç¼–ç æ—¶ï¼Œå¦‚ä½•å°†å…¶è½¬ä¸º Unicode å­—ç¬¦</p><p>è¿˜æ˜¯ä»¥<code>ğŸ’¢  U+1F4A2</code>ä¸ºä¾‹ï¼Œå…¶ UTF-16 ç¼–ç ä¸º <code>\uDB3D\uDCA2</code>ï¼Œå¯è§ç¬¬ä¸€ä¸ªå­—ç¬¦ <code>0xDB3D</code> ä½äº <code>U+D800-U+DBFF</code>ä¹‹é—´ é‚£ä¹ˆå¯ä»¥ç¡®å®š <code>\uDB3D\uDCA2</code> æ˜¯ä¸€ä¸ªå å››ä¸ªå­—èŠ‚çš„å­—ç¬¦</p><p>æ¥ä¸‹æ¥å†è¿›è¡Œç¿»è¯‘</p><p>å°†å‰ä¸€ä¸ªå­—ç¬¦å‡å» 0xDB00 ï¼Œåä¸€ä¸ªå­—ç¬¦å‡å» 0xDC00</p><p>å³<br>0xDB3D - 0xDB00 &#x3D; 0x003D, å³ 00111101<br>0xDCA2 - 0xDC00 &#x3D; 0x00A2, å³ 10100010</p><p>å°†é«˜ä½H å’Œ ä½ä½Lè¡¥é½åˆ°10ä½ï¼Œå³</p><p>0000111101<br>0010100010</p><p>å†æ‹¼æ¥ä¸€èµ·ï¼Œå¾—åˆ° <code>00001 11101 00101 00010</code>ï¼Œå†åŠ ä¸Š 0x10000(äºŒè¿›åˆ¶ä¸º10000000000000000)ï¼Œç­‰äº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00001 11101 00101 00010</span><br><span class="line">00010 00000 00000 00000</span><br><span class="line">-----------------------</span><br><span class="line">00011 11101 00101 00010</span><br></pre></td></tr></table></figure><p>å¾—åˆ° 00011111010010100010(å³0x1F4A2) å³<code>ğŸ’¢  U+1F4A2</code></p><p>Java ä¸­ String.length è¿”å›çš„å­—ç¬¦ä¸²å¯¹åº”çš„ char çš„é•¿åº¦è€Œä¸æ˜¯äººç±»è®¤çŸ¥ä¸­å­—ç¬¦çš„é•¿åº¦</p><p>ä¾‹å¦‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;ğŸ’¢&quot;.length() == 2</span><br><span class="line">&quot;ä¸­æ–‡&quot;.length() == 2</span><br><span class="line">&quot;ä¸­&quot;.length() == 1</span><br></pre></td></tr></table></figure><p>0001000010 1110110111</p><p>åœ¨ Java ä¸­ä½¿ç”¨<code>ç ç‚¹(Code Point)</code> æ¥ä»£è¡¨ Unicode å­—ç¬¦é›†ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼Œå–å€¼ 0x000000<code>(Character.MIN_CODE_POINT)</code>-0x10FFFF<code>(Character.MAX_CODE_POINT)</code></p><p>æœ¬æ–‡å‚è€ƒ <a href="https://liyucang-git.github.io/2019/06/17/%E5%BD%BB%E5%BA%95%E5%BC%84%E6%87%82Unicode%E7%BC%96%E7%A0%81/">å½»åº•å¼„æ‡‚Unicodeç¼–ç </a> æ„Ÿè°¢åˆ†äº«</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;em&gt;æœ¬æ–‡è§£é‡Š Java ä¸­çš„å­—ç¬¦ä¸²ç¼–ç &lt;/em&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Java" scheme="https://ppting.me/categories/Java/"/>
    
    
    <category term="Encode" scheme="https://ppting.me/tags/Encode/"/>
    
  </entry>
  
  <entry>
    <title>Android View çš„æµ‹é‡</title>
    <link href="https://ppting.me/2021/01/01/measure_view/"/>
    <id>https://ppting.me/2021/01/01/measure_view/</id>
    <published>2020-12-31T16:00:00.000Z</published>
    <updated>2022-02-12T08:41:00.429Z</updated>
    
    <content type="html"><![CDATA[<p><em>Android ä¸­ view çš„æµ‹é‡æœºåˆ¶</em></p><span id="more"></span><h2 id="MeasureSpec"><a href="#MeasureSpec" class="headerlink" title="MeasureSpec"></a>MeasureSpec</h2><blockquote><p>MeasureSpec ä½¿ç”¨ä¸€ä¸ª 32ä½çš„ int æ•°å€¼ç”¨æ¥å­˜æ”¾ mode å’Œ size</p><p>å‰2ä½å­˜æ”¾ mode ï¼Œå30ä½å­˜æ”¾ size</p></blockquote><p>å…¶ä¸­ï¼Œmode çš„ç±»å‹ä¸€å…±æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯</p><table><thead><tr><th>mode</th><th>å€¼</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>UNSPECIFIED</td><td>0 &lt;&lt; 30(å³00,000..[ä¸€å…±30ä¸ª0]..000)</td><td>æœªæŒ‡å®šæ¨¡å¼ï¼Œä¸å¯¹<code>å­ view</code> çš„å°ºå¯¸è¿›è¡Œé™åˆ¶</td></tr><tr><td>EXACTLY</td><td>1 &lt;&lt; 30(å³01,000..[ä¸€å…±30ä¸ª0]..000)</td><td>ç²¾ç¡®æ¨¡å¼ï¼Œ<code>å­ view</code> çš„å°ºå¯¸ä¸ºå…·ä½“çš„æ•°å€¼(xxdp)æˆ–è€…çˆ¶ view çš„å¤§å°(match_parent)</td></tr><tr><td>AT_MOST</td><td>2 &lt;&lt; 30(å³10,000..[ä¸€å…±30ä¸ª0]..000)</td><td>æœ€å¤§æ¨¡å¼ï¼Œ<code>å­ view</code> çš„å°ºå¯¸å¯ä»¥åœ¨æŒ‡å®šèŒƒå›´å†…è¦å¤šå¤§å°±å¤šå¤§(wrap_content)</td></tr></tbody></table><blockquote><p><code>UNSPECIFIED</code> å’Œ <code>AT_MOST</code> çš„åŒºåˆ«åœ¨äº <code>UNSPECIFIED</code> ä¸é™åˆ¶ <code>å­ view</code> çš„å¤§å°</p></blockquote><p>åŒæ—¶ï¼ŒMeasureSpec æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œç”¨æ¥è·å– <code>mode</code> å’Œ <code>size</code></p><p>PS.</p><blockquote><p>private static final int MODE_MASK  &#x3D; 0x3 &lt;&lt; 30;<br>å³11,000..[ä¸€å…±30ä¸ª0]..000</p></blockquote><p><em><strong>è·å– mode</strong></em></p><p><code>android.view.View.MeasureSpec#getMode</code></p><blockquote><p>é€šè¿‡ã€Œ&amp;ã€æ–¹æ³•ä¿ç•™å‰ä¸¤ä½æ•°ï¼Œå°†å30ä½å˜ä¸º0</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MeasureSpecMode</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMode</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//noinspection ResourceType</span></span><br><span class="line">    <span class="keyword">return</span> (measureSpec &amp; MODE_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em><strong>è·å– size</strong></em></p><blockquote><p>å…ˆå°† MODE_MASK æŒ‰ä½å–åï¼Œå¾—åˆ°<br>00,111â€¦[ä¸€å…±30ä¸ª1]â€¦111<br>å†é€šè¿‡ã€Œ&amp;ã€æ–¹æ³•ä¿ç•™å30ä½æ•°ï¼Œå°†å‰ä¸¤ä½å˜ä¸º0ï¼Œåˆ™è·å¾— size<br><code>android.view.View.MeasureSpec#getSize</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (measureSpec &amp; ~MODE_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="View-çš„æµ‹é‡"><a href="#View-çš„æµ‹é‡" class="headerlink" title="View çš„æµ‹é‡"></a>View çš„æµ‹é‡</h2><h3 id="onMeasure"><a href="#onMeasure" class="headerlink" title="onMeasure"></a>onMeasure</h3><p>å…ˆæ¥çœ‹ <code>android.view.View#onMeasure</code> æ–¹æ³•</p><blockquote><p>é€šè¿‡ getDefaultSize æ–¹æ³•è·å– view é»˜è®¤çš„å®½&#x2F;é«˜åè¿›è¡Œè®¾ç½®</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>getSuggestedMinimumWidth() å’Œ getSuggestedMinimumHeight() æ–¹æ³•æ˜¯è·å–è¯¥ view çš„æœ€å°å®½åº¦&#x2F;é«˜åº¦</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¦‚æœæ²¡æœ‰èƒŒæ™¯ï¼Œåˆ™è¿”å›è®¾ç½®çš„æœ€å°å®½åº¦(minWidth)</span></span><br><span class="line"><span class="comment"> * å¦åˆ™è¿”å›èƒŒæ™¯æœ€å°å®½åº¦å’Œè®¾ç½®çš„æœ€å°å®½åº¦(minWidth)çš„å¤§è€…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹ getDefaultSize æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size view çš„é»˜è®¤å¤§å°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> measureSpec çˆ¶ view å¯¹å­ view çš„çº¦æŸ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è¿”å›å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = size;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">        <span class="comment">//çˆ¶ view å¯¹å­ view ä¸åšé™åˆ¶ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        result = size;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//çˆ¶ view å¯¹å­ view é™åˆ¶ï¼Œåˆ™ä½¿ç”¨ç‰¹å®šçš„å¤§å°</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        result = specSize;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè°ƒç”¨å­ view çš„ onMeasure() æ–¹æ³•é‡Œçš„å‚æ•°æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Œæˆ‘ä»¬å›åˆ° ViewGroup.measureChild() æ–¹æ³•</p><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨å­ view çš„ measure æ–¹æ³•ï¼Œåœ¨ measure æ–¹æ³•ä¸­ä¼šè°ƒç”¨ onMeasure æ–¹æ³•å»æµ‹é‡è‡ªå·±çš„å®½&#x2F;é«˜ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è®²è¿‡çš„ <code>android.view.View#onMeasure</code> æ–¹æ³•</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> child å­ view</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parentWidthMeasureSpec çˆ¶ view å®½çš„ MeasureSpec</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parentHeightMeasureSpec çˆ¶ view é«˜çš„ MeasureSpec</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChild</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> parentHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> LayoutParams lp = child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">            mPaddingLeft + mPaddingRight, lp.width);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">            mPaddingTop + mPaddingBottom, lp.height);</span><br><span class="line"></span><br><span class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæ ¹æ®parentWidthMeasureSpecã€padding ä»¥åŠ<code>å­ view</code> çš„ LayoutParams çš„è®¾ç½®ï¼Œé€šè¿‡ getChildMeasureSpec() è¯¥æ–¹æ³•ç¡®å®šäº†<code>å­ view</code>çš„ MeasureSpecï¼Œåå†è°ƒç”¨ child.measure æ–¹æ³•å¯¹<code>å­ view</code> è¿›è¡Œæµ‹é‡</p><p>ä¸‹æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ getChildMeasureSpec() è¿™ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * @param spec çˆ¶ view çš„ MeasureSpec</span></span><br><span class="line"><span class="comment">    * @param padding çˆ¶ view è®¾ç½®çš„ padding</span></span><br><span class="line"><span class="comment">    * @param childDimension è¯¥ view å¸Œæœ›è®¾ç½®çš„å¤§å°(å³ LayoutParam çš„ width/height or xml ä¸­è®¾ç½®çš„ layout_width/layout_height)</span></span><br><span class="line"><span class="comment">    * @return è¿”å›è¯¥ view çš„ MeasureSpec</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–çˆ¶ view çš„ mode</span></span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);</span><br><span class="line">    <span class="comment">//è·å–çˆ¶ view çš„ size</span></span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> resultSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> resultMode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="comment">// Parent has imposed an exact size on us</span></span><br><span class="line">    <span class="comment">//çˆ¶ view çš„å¤§å°æ˜¯å›ºå®šçš„</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœå­ view è®¾ç½®äº†å¤§å°ï¼Œåˆ™ä½¿ç”¨å­ view è‡ªå·±è®¾ç½®çš„å¤§å°å’Œï¼Œmode ä¸º EXACTLY</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">//å­ view è®¾ç½®ä¸º MATCH_PARENTï¼Œåˆ™ä½¿ç”¨çˆ¶ view çš„å¤§å°ï¼Œmode ä¸º EXACTLY</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">//å­ view è¦å†³å®šè‡ªå·±çš„å¤§å°(è®¾ç½®ä¸º WRAP_CONTENT)ï¼Œä¸èƒ½è¶…è¿‡çˆ¶ viewï¼Œåˆ™ä½¿ç”¨çˆ¶ view çš„å¤§å°ï¼Œmode ä¸º AT_MOST(æœ€å¤§ä¸èƒ½è¶…è¿‡ size)</span></span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can&#x27;t be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent has imposed a maximum size on us</span></span><br><span class="line">    <span class="comment">//çˆ¶ view æ²¡æœ‰å›ºå®šå¤§å°ï¼Œä½†æœ‰ä¸Šé™</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... so be it</span></span><br><span class="line">            <span class="comment">//å¦‚æœå­ view è®¾ç½®äº†å¤§å°ï¼Œåˆ™ä½¿ç”¨å­ view è‡ªå·±è®¾ç½®çš„å¤§å°ï¼Œmode ä¸º EXACTLY</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">//å­view è¦æ±‚è·Ÿçˆ¶ view ä¸€æ ·å¤§ï¼Œä½†çˆ¶ view æ˜¯ä¸å›ºå®šçš„</span></span><br><span class="line">            <span class="comment">//åªèƒ½çº¦æŸå­ view ä¸è¶…è¿‡çˆ¶ viewï¼Œåˆ™ä½¿ç”¨çˆ¶ view çš„å¤§å°ï¼Œmode ä¸º AT_MOST(æœ€å¤§ä¸èƒ½è¶…è¿‡ size)</span></span><br><span class="line">            <span class="comment">// Child wants to be our size, but our size is not fixed.</span></span><br><span class="line">            <span class="comment">// Constrain child to not be bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">//å­ view è¦å†³å®šè‡ªå·±çš„å¤§å°(è®¾ç½®ä¸º WRAP_CONTENT)ï¼Œä¸èƒ½è¶…è¿‡çˆ¶ viewï¼Œåˆ™ä½¿ç”¨çˆ¶ view çš„å¤§å°ï¼Œmode ä¸º AT_MOST(æœ€å¤§ä¸èƒ½è¶…è¿‡ size)</span></span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can&#x27;t be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent asked to see how big we want to be</span></span><br><span class="line">    <span class="comment">//çˆ¶ view æ²¡æœ‰é™åˆ¶ï¼Œå¯ä»¥ä¸ºä»»ä½•å¤§å°</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœå­ view è®¾ç½®äº†å¤§å°ï¼Œåˆ™ä½¿ç”¨å­ view è‡ªå·±è®¾ç½®çš„å¤§å°ï¼Œmode ä¸º EXACTLY</span></span><br><span class="line">            <span class="comment">// Child wants a specific size... let him have it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">//å­view è¦æ±‚è·Ÿçˆ¶ view ä¸€æ ·å¤§ï¼Œåˆ™ç»§ç»­çœ‹çœ‹å­ viewåº”è¯¥å¤šå¤§</span></span><br><span class="line">            <span class="comment">//åœ¨ Api 23 ä»¥ä¸‹è®¾ç½® size ä¸º 0ï¼ŒApi 23ä»¥ä¸Šä¸ºçˆ¶ view çš„ size</span></span><br><span class="line">            <span class="comment">//mode è®¾ç½®ä¸º UNSPECIFIED</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">//å­ view è¦å†³å®šè‡ªå·±çš„å¤§å°(è®¾ç½®ä¸º WRAP_CONTENT)ï¼Œ</span></span><br><span class="line">            <span class="comment">//åœ¨ Api 23 ä»¥ä¸‹è®¾ç½® size ä¸º 0ï¼ŒApi 23ä»¥ä¸Šä¸ºçˆ¶ view çš„ size</span></span><br><span class="line">            <span class="comment">//mode è®¾ç½®ä¸º UNSPECIFIED</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//noinspection ResourceType</span></span><br><span class="line">    <span class="comment">//æœ€åå°† size å’Œ mode ç»„è£…å¹¶è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ˜¯é€šè¿‡<code>çˆ¶ view</code>å¯¹<code>å­ view</code>çš„é™åˆ¶æ¥è¿›è¡Œè®¡ç®—<code>å­ view</code>åº”æœ‰çš„ size å’Œ mode</p><p>ä¹Ÿå¯ä»¥é€šè¿‡å¦ä¸€ç§è§’åº¦æ¥ç¡®å®š<code>å­ view</code>çš„ size å’Œ mode</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec), specSize = MeasureSpec.getSize(spec);</span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);</span><br><span class="line">    <span class="keyword">int</span> resultSize = <span class="number">0</span>, resultMode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å­å…ƒç´ æŒ‡å®šäº†å…·ä½“çš„å¤§å°ï¼Œå°±ç”¨å­å…ƒç´ çš„å¤§å°ï¼Œmode ä½¿ç”¨ EXACTLY</span></span><br><span class="line">        resultSize = childDimension;</span><br><span class="line">        resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == ViewGroup.LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">        <span class="comment">// å­å…ƒç´ å¸Œæœ›å’Œçˆ¶æ§ä»¶ä¸€æ ·å¤§ï¼Œéœ€è¦è®¾ç½®å…¶ä¸Šé™ï¼Œç„¶åæµ‹é‡æ¨¡å¼ä¸çˆ¶æ§ä»¶ä¸€è‡´å³å¯</span></span><br><span class="line">        <span class="keyword">if</span> (specMode == MeasureSpec.EXACTLY || specMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = specMode;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (specMode == MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">            <span class="comment">// API23ä»¥ä¸‹å°±æ˜¯0ï¼Œçˆ¶æ§ä»¶æ²¡æœ‰æŒ‡å®šå¤§å°çš„æ—¶å€™ï¼Œå­æ§ä»¶åªèƒ½æ˜¯0ï¼›ä»¥ä¸Šæ˜¯size</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">        <span class="comment">// å­å…ƒç´ å¸Œæœ›è‡ªå·±å†³å®šå¤§å°ï¼Œè®¾ç½®å…¶å¤§å°çš„ä¸Šé™æ˜¯çˆ¶æ§ä»¶çš„å¤§å°å³å¯</span></span><br><span class="line">        <span class="keyword">if</span> (specMode == MeasureSpec.EXACTLY || specMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (specMode == MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">            <span class="comment">// API23ä»¥ä¸‹å°±æ˜¯0ï¼Œçˆ¶æ§ä»¶æ²¡æœ‰æŒ‡å®šå¤§å°çš„æ—¶å€™ï¼Œå­æ§ä»¶åªèƒ½æ˜¯0ï¼›ä»¥ä¸Šæ˜¯size</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä½œè€…ï¼šHelloDev</span><br><span class="line">é“¾æ¥ï¼šhttps:<span class="comment">//juejin.cn/post/6844903694073331720</span></span><br><span class="line">æ¥æºï¼šæ˜é‡‘</span><br><span class="line">è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;em&gt;Android ä¸­ view çš„æµ‹é‡æœºåˆ¶&lt;/em&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    <category term="æºç " scheme="https://ppting.me/categories/%E6%BA%90%E7%A0%81/"/>
    
    
    <category term="View" scheme="https://ppting.me/tags/View/"/>
    
  </entry>
  
  <entry>
    <title>Android å­˜å‚¨è®¿é—®æ¡†æ¶ Storage Access Framework</title>
    <link href="https://ppting.me/2020/04/19/2020_04_19_about_Storage_Access_Framework/"/>
    <id>https://ppting.me/2020/04/19/2020_04_19_about_Storage_Access_Framework/</id>
    <published>2020-04-18T16:00:00.000Z</published>
    <updated>2022-02-12T08:14:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Android Kitkat (Android 4.4 Api 19)å¼€å§‹ï¼ŒAndroid æä¾›äº†ä¸€å¥—å­˜å‚¨è®¿é—®æ¡†æ¶(Storage Access Framework)ï¼Œç®€ç§° SAFã€‚å¼€å‘è€…å¯ä»¥åœ¨åº”ç”¨å†…ä½¿ç”¨è¯¥æ¡†æ¶ï¼Œé€šè¿‡ç”¨æˆ·çš„æ“ä½œè·å–&#x2F;ä¿å­˜&#x2F;ä¿®æ”¹æ‰‹æœºä¸­çš„æ–‡ä»¶ç­‰</p><span id="more"></span><p>SAF åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†</p><ul><li><strong>DocumentsProvider</strong><br>  å†…å®¹æä¾›ç¨‹åºï¼Œæä¾›å†…å®¹å­˜å‚¨æœåŠ¡çš„åº”ç”¨å¯ä»¥å®ç°è¯¥ç±»ï¼Œä¾‹å¦‚ Google Driverï¼ŒDropboxï¼ŒOneDriver ç­‰äº‘å­˜å‚¨æœåŠ¡ç”šè‡³æ˜¯æœ¬åœ°å­˜å‚¨æœåŠ¡ï¼Œå®ç°åç”¨æˆ·å¯ä»¥åœ¨ <strong>Picker</strong> ä¸­æ‰¾åˆ°è¯¥ç¨‹åºæ‰€æä¾›çš„å†…å®¹</li><li><strong>Client</strong><br>  å®¢æˆ·ç«¯ç¨‹åºï¼Œå³å‘èµ·å­˜å‚¨è®¿é—®è¯·æ±‚çš„å®¢æˆ·ç«¯</li><li><strong>Picker</strong><br>  ä¸€ä¸ªç³»ç»Ÿç•Œé¢ï¼Œç”¨æˆ·å¯ä»¥åœ¨è¯¥é¡µé¢ä¸Šæ“ä½œç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</li></ul><p>è¿™é‡Œæœ‰ä¸€å¼  Google æ–‡æ¡£ä¸Šçš„å›¾ï¼Œå±•ç¤ºäº†å¦‚ä½•é€šè¿‡ SAF è®¿é—®å­˜å‚¨æ•°æ®</p><p><img src="https://developer.android.google.cn/images/providers/storage_dataflow.png" alt="é€šè¿‡ SAF è®¿é—®å­˜å‚¨æ•°æ®"></p><blockquote><p>é€šè¿‡ SAF è¯»å†™æ–‡ä»¶å¹¶ä¸éœ€è¦ç”³è¯· <code>WRITE_EXTERNAL_STORAGE</code> å’Œ <code>READ_EXTERNAL_STORAGE</code> æƒé™</p></blockquote><h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><p>äº†è§£äº† SAF å¤§è‡´çš„å·¥ä½œåŸç†åï¼Œæˆ‘ä»¬è¿˜æ˜¯å›å½’åˆ°å®è·µä¸­ï¼Œè¿™é‡Œæ¼”ç¤ºä¸€ä¸‹åœ¨åº”ç”¨å¼€å‘ä¸­ï¼Œå¦‚ä½•é€šè¿‡ SAF å»è®¿é—®ç”¨æˆ·æ‰‹æœºä¸Šçš„å†…å®¹</p><p>å…¶å®æœ€ä¸»è¦çš„å°±æ˜¯é€šè¿‡ Intent å”¤èµ· Pickerï¼Œäº¤ç»™ç”¨æˆ·å»æ“ä½œï¼Œç„¶ååœ¨ onActivityResult ä¸­è·å–åˆ°ç›¸å¯¹åº”çš„æ•°æ®å†ç”±å®¢æˆ·ç«¯è¿›è¡Œå¤„ç†</p><h3 id="åˆ›å»ºæ–‡ä»¶"><a href="#åˆ›å»ºæ–‡ä»¶" class="headerlink" title="åˆ›å»ºæ–‡ä»¶"></a>åˆ›å»ºæ–‡ä»¶</h3><blockquote><p>åˆ›å»ºæ–‡ä»¶éœ€è¦è®©ç”¨æˆ·å…ˆé€šè¿‡ Picker åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå†å°†è¯¥å†™å…¥çš„è·¯å¾„æä¾›ç»™ Client ä»¥ä¾›å†™å…¥<br>Intent.ACTION_CREATE_DOCUMENT</p></blockquote><p>é‚£å¦‚ä½•è®©ç”¨æˆ·æ‰“å¼€ Picker å‘¢ï¼Œåˆ™éœ€è¦ Client é€šè¿‡ Intent å”¤èµ· Picker é¡µé¢ï¼Œç”±ç”¨æˆ·é€‰æ‹©ä¿å­˜çš„ä½ç½®å’Œæ–‡ä»¶ååï¼Œç‚¹å‡»ç¡®è®¤åè¿”å›åº”ç”¨å†…ã€‚ç”±å®¢æˆ·ç«¯è·å–åˆ° Uri åå¯¹è¯¥æ–‡ä»¶è¿›è¡Œå†™å…¥ç­‰</p><p><img src="https://i.loli.net/2020/04/19/6vy3JM7LxtSRbBC.jpg"></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é‡ç‚¹åœ¨äºè¿™é‡Œçš„ Intent Action</span></span><br><span class="line"><span class="keyword">val</span> intent = Intent(Intent.ACTION_CREATE_DOCUMENT).apply &#123;</span><br><span class="line">                addCategory(Intent.CATEGORY_OPENABLE)</span><br><span class="line">                <span class="comment">//å‘ŠçŸ¥è¦ä¿å­˜çš„æ–‡ä»¶çš„ MIME ç±»å‹</span></span><br><span class="line">                type = <span class="string">&quot;image/png&quot;</span></span><br><span class="line">                <span class="comment">//æä¾›ä¿å­˜çš„æ–‡ä»¶åï¼Œå¯é€‰</span></span><br><span class="line">                putExtra(Intent.EXTRA_TITLE,<span class="string">&quot;myPicture.png&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">startActivityForResult(intent, REQUEST_CODE_FOR_WRITE_IMAGE)</span><br></pre></td></tr></table></figure><h3 id="è¯»å–æ–‡ä»¶"><a href="#è¯»å–æ–‡ä»¶" class="headerlink" title="è¯»å–æ–‡ä»¶"></a>è¯»å–æ–‡ä»¶</h3><blockquote><p>è¯»å–æ–‡ä»¶éœ€è¦ç”¨æˆ·é€‰æ‹©æ–‡ä»¶åæä¾›ç»™ Client<br><strong>Intent.ACTION_OPEN_DOCUMENT</strong></p></blockquote><p>æ¯”æ–¹è¯´ï¼Œæˆ‘éœ€è¦ç”¨æˆ·é€‰æ‹©ä¸€å¼ å›¾ç‰‡ä½œä¸ºå¤´åƒ</p><p>åˆ™éœ€è¦é€šè¿‡ Intent å”¤èµ· Picker </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">companion</span> <span class="keyword">object</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> REQUEST_CODE_FOR_IMAGE = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> intent = Intent(Intent.ACTION_OPEN_DOCUMENT).apply&#123;</span><br><span class="line">    <span class="comment">//å¯¹ç»“æœè¿›è¡Œè¿‡æ»¤ï¼Œåªæ˜¾ç¤ºå¯æ‰“å¼€çš„æ–‡ä»¶</span></span><br><span class="line">    addCategory(Intent.CATEGORY_OPENABLE)</span><br><span class="line">    <span class="comment">//è¿‡æ»¤é image ç±»å‹çš„æ–‡ä»¶</span></span><br><span class="line">    type = <span class="string">&quot;image/*&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">startActivityForResult(intent,REQUEST_CODE_FOR_IMAGE)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å†åœ¨ Activity çš„ onActivityResult() å›è°ƒä¸­è·å–ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶çš„ Uri(å³ data.data)</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityResult</span><span class="params">(requestCode: <span class="type">Int</span>, resultCode: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="keyword">data</span>)</span><br><span class="line">    <span class="keyword">if</span> (resultCode == Activity.RESULT_OK)&#123;</span><br><span class="line">        <span class="keyword">when</span>(requestCode)&#123;</span><br><span class="line">            REQUEST_CODE_FOR_IMAGE -&gt;&#123;</span><br><span class="line">                <span class="keyword">data</span>?.<span class="keyword">data</span>?.let &#123; showImage(it) &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–åˆ°è¯¥ Uri ååˆ™å¯ä»¥å°†è¯¥ Uri è½¬æˆ Bitmap å±•ç¤ºåœ¨ ImageView ä¸­</p><h3 id="ç¼–è¾‘æ–‡ä»¶"><a href="#ç¼–è¾‘æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘æ–‡ä»¶"></a>ç¼–è¾‘æ–‡ä»¶</h3><blockquote><p>ç¼–è¾‘æ–‡ä»¶ï¼ŒåŒæ ·çš„é“ç†ï¼Œä½ åªéœ€è¦é€šè¿‡ Intent å”¤èµ· Pickerï¼Œè®©ç”¨æˆ·é€‰å–æ–‡ä»¶åè¿›è¡Œè¯»å†™å³å¯</p></blockquote><h3 id="åˆ é™¤æ–‡ä»¶"><a href="#åˆ é™¤æ–‡ä»¶" class="headerlink" title="åˆ é™¤æ–‡ä»¶"></a>åˆ é™¤æ–‡ä»¶</h3><blockquote><p>åŒæ ·çš„ï¼Œåˆ é™¤æ–‡ä»¶ä¹Ÿéœ€è¦è·å–åˆ°è¯¥æ–‡ä»¶çš„ uri åæ‰èƒ½è¿›è¡Œæ“ä½œ<br>é€šè¿‡ Picker è·å– Uri çš„ä»£ç å¯ä»¥å‚è€ƒä¸Šæ–‡çš„<strong>è·å–æ–‡ä»¶</strong></p></blockquote><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DocumentsContract.deleteDocument(contentResolver, uri)</span><br></pre></td></tr></table></figure><h2 id="è·å–æ–‡ä»¶å¤¹æƒé™"><a href="#è·å–æ–‡ä»¶å¤¹æƒé™" class="headerlink" title="è·å–æ–‡ä»¶å¤¹æƒé™"></a>è·å–æ–‡ä»¶å¤¹æƒé™</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">val</span> intent = Intent(Intent.ACTION_OPEN_DOCUMENT_TREE)</span><br><span class="line">startActivityForResult(intent,REQUEST_CODE_FOR_DIR)</span><br></pre></td></tr></table></figure><p>é€šè¿‡å”¤èµ· Picker ï¼Œè®©ç”¨æˆ·é€‰æ‹©ç›®å½•æˆäºˆ Client è¯¥æ–‡ä»¶å¤¹çš„å®Œæ•´è®¿é—®æƒé™ï¼ŒåŒ…æ‹¬å½“å‰å­˜å‚¨åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ä»¥åŠæ—¥åå­˜å‚¨åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶</p><p>åŒç†ï¼Œåœ¨ <code>onActivityResult</code> ä¸­å¯ä»¥è·å–åˆ°è¯¥æ–‡ä»¶å¤¹çš„ <code>Uri</code> å¹¶è¿›è¡Œè¯»å†™æ“ä½œã€‚</p><p>åœ¨ç”¨æˆ·ç‚¹å‡»ã€Œå…è®¸è®¿é—® xx ã€æ—¶ï¼Œä¼šå¼¹å‡ºä¸€ä¸ªæˆæƒæç¤ºï¼Œå¦‚ä¸‹å›¾<br><img src="https://i.loli.net/2020/04/19/hs9CGO3q7u5KxLm.png" alt="Screenshot_20200418-221258"></p><p>å¦‚æœç”¨æˆ·æˆæƒä¹‹åï¼Œåœ¨åº”ç”¨ç®¡ç†ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°è¯¥ APP å¤šäº†ä¸€ä¸ªã€Œå–æ¶ˆè®¿é—®æƒé™ã€çš„æŒ‰é’®</p><p><img src="https://i.loli.net/2020/04/19/gFfYa7u5jnqLOlp.png" alt="Screenshot_20200418-221628"></p><p>ä¸€æ—¦ç”¨æˆ·ç‚¹å‡»ã€Œå–æ¶ˆè®¿é—®é™åˆ¶ã€ï¼Œä¸Šå›¾ä¸­ã€Œæ€»è®¡ã€ä¸‹é¢æ‰€ç½—åˆ—å‡ºæ¥çš„å­˜å‚¨ä½ç½®çš„æƒé™éƒ½ä¼šè¢«å–æ¶ˆï¼Œå¹¶ä¸” App ä¸ä¼šåƒç‚¹å‡»åº”ç”¨ç®¡ç†ä¸­çš„ ã€Œæ¸…é™¤ç¼“å­˜ã€é‚£æ ·è¢«æ€æ­»ï¼Œè€Œæ˜¯è¿˜ä¼šç»§ç»­åœ¨è¿è¡Œï¼Œæ‰€ä»¥å¯¹äºåº”ç”¨æ¥è¯´ï¼Œè¦å¤„ç†å¥½å¯¹äºæ–‡ä»¶å¤¹ Uri çš„æƒé™å¤„ç†</p><h2 id="Uri-æƒé™"><a href="#Uri-æƒé™" class="headerlink" title="Uri æƒé™"></a>Uri æƒé™</h2><h3 id="æƒé™æ—¶é—´"><a href="#æƒé™æ—¶é—´" class="headerlink" title="æƒé™æ—¶é—´"></a>æƒé™æ—¶é—´</h3><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£æ‰€è¿°ï¼Œæˆ‘ä»¬é€šè¿‡ä¸Šè¿°çš„æ–¹å¼è·å–åˆ°çš„ Uri ï¼Œäº‹å®ä¸Šç³»ç»Ÿä¼šå¯¹è¯¥ Uri å¯¹æˆ‘ä»¬çš„ Client è¿›è¡Œæˆæƒï¼Œç›´åˆ°ç”¨æˆ·é‡å¯è®¾å¤‡(æ­£å¸¸æƒ…å†µä¸‹æ˜¯è¿™æ ·)</p><p><em>å› ä¸ºäº‹å®ä¸Šè¿˜å¯èƒ½æœ‰ä¸Šè¿°å–æ¶ˆè®¿é—®æƒé™çš„æƒ…å†µ</em></p><p>ä¾‹å¦‚è¯´ï¼Œå¦‚æœæˆ‘ä»¬å°†è·å–åˆ°çš„ Uri è¿›è¡Œä¿å­˜(å­˜ä¸ºå­—ç¬¦ä¸²å½¢å¼)ï¼Œåç»­å†é€šè¿‡ <code>Uri.parse(String urlString)</code> æ–¹æ³•æ„å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œä¹Ÿæ˜¯å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œè®¿é—®çš„(åœ¨ç”¨æˆ·æˆæƒåè‡³é‡å¯ä¹‹é—´)</p><p>å¦‚æœéœ€è¦åœ¨è®¾å¤‡é‡å¯åè¿˜æ‹¥æœ‰å¯¹è¯¥ Uri çš„æƒé™ï¼Œåˆ™éœ€è¦è·å–ç³»ç»Ÿæä¾›çš„ Uri æŒä¹…æˆæƒï¼Œè¿™æ ·ç”¨æˆ·åˆ™å¯ä»¥åœ¨è®¾å¤‡é‡å¯åç»§ç»­åœ¨è¯¥ App Client ä¸­æŒç»­è®¿é—®è¯¥æ–‡ä»¶</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯¹ Uri æƒé™è¿›è¡ŒæŒä¹…åŒ–</span></span><br><span class="line"><span class="keyword">val</span> takeFlags: <span class="built_in">Int</span> = intent.flags and</span><br><span class="line">        (Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_GRANT_WRITE_URI_PERMISSION)</span><br><span class="line">contentResolver.takePersistableUriPermission(uri, takeFlags)</span><br></pre></td></tr></table></figure><blockquote><p>Caution: Even after calling takePersistableUriPermission(), your app doesnâ€™t retain access to the URI if the associated document is moved or deleted. In those cases, you need to ask permission again to regain access to the URI.<br>è¿˜æœ‰æœ€åä¸€ä¸ªæ­¥éª¤ã€‚åº”ç”¨æœ€è¿‘è®¿é—®çš„ URI å¯èƒ½ä¸å†æœ‰æ•ˆï¼ŒåŸå› æ˜¯å¦ä¸€ä¸ªåº”ç”¨å¯èƒ½åˆ é™¤æˆ–ä¿®æ”¹äº†æ–‡æ¡£ã€‚å› æ­¤ï¼Œæ‚¨åº”å§‹ç»ˆè°ƒç”¨ getContentResolver().takePersistableUriPermission()ï¼Œä»¥æ£€æŸ¥æœ‰æ— æœ€æ–°æ•°æ®ã€‚</p></blockquote><p>å®˜æ–¹æ–‡æ¡£ä¸Šè¿˜æœ‰ä¸Šè¿°è¿™ä¸€æ®µæè¿°ï¼Œä½†æ˜¯æˆ‘çš„ç†è§£ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶è¢«ç§»åŠ¨æˆ–è€…åˆ é™¤äº†ï¼Œé‚£å®ƒæ‰€å¯¹åº”çš„ Uri å³ä¾¿é€šè¿‡ <code>takePersistableUriPermission</code> æ–¹æ³•å†æ¬¡æˆæƒäº†ï¼Œä¹Ÿæ˜¯æ²¡æœ‰å¤šå¤§ä½œç”¨çš„å‘€ï¼Ÿï¼Ÿè¿™ä¸ªæ–¹æ³•æœ¬èº«ä¸ä¼šæœ‰è¿”å›å€¼å‘ŠçŸ¥å¼€å‘è€…è¯¥ Uri æ˜¯å¦è¿˜èƒ½ç»§ç»­ç”¨ï¼Œé€šè¿‡æˆ‘çš„å®éªŒï¼Œåœ¨è·å–åˆ° Uri åï¼Œé€šè¿‡æ–‡ä»¶ç®¡ç†å™¨ç­‰å°†æ–‡ä»¶è¿›è¡Œåˆ é™¤ï¼Œè°ƒç”¨ <code>takePersistableUriPermission</code> æ–¹æ³•ä¹Ÿä¸ä¼š throw  Exceptionï¼Œæ‰€ä»¥å®˜æ–¹æ–‡æ¡£ä¸Šçš„è¿™ä¸ª <code>move or deleted</code> æˆ‘æŠ±æœ‰ç–‘é—®ï¼Œæœ›èµæ•™</p><h3 id="è¿è¡Œæ—¶æƒé™å¤„ç†"><a href="#è¿è¡Œæ—¶æƒé™å¤„ç†" class="headerlink" title="è¿è¡Œæ—¶æƒé™å¤„ç†"></a>è¿è¡Œæ—¶æƒé™å¤„ç†</h3><p>å¦‚æœç”¨æˆ·åœ¨åº”ç”¨ç®¡ç†ä¸­å–æ¶ˆäº†è®¿é—®æƒé™ï¼Œåœ¨ App ä¸­é€šè¿‡ <code>contentResolver.takePersistableUriPermission</code>æ–¹æ³•å¯¹è¯¥ Uri è¿›è¡Œæƒé™ç”³è¯·åˆ™ä¼š throw ä¸‹é¢çš„ Exception </p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.SecurityException: No persistable permission grants found <span class="keyword">for</span> UID <span class="number">10200</span> and Uri  [user <span class="number">0</span>]</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ try catch åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰å¯¹è¯¥ç›®å½•çš„è®¿é—®æƒé™ï¼Ÿ</p><p>å…¶å®å¤§å¯ä¸å¿…ï¼Œé€šè¿‡ <code>contentResolver.getPersistedUriPermissions</code> æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥åº”ç”¨å½“å‰æ‰€æ‹¥æœ‰çš„æƒé™åˆ—è¡¨ï¼Œåˆ¤æ–­è¦ä½¿ç”¨çš„æƒé™æ˜¯å¦åœ¨åˆ—è¡¨å½“ä¸­å³å¯</p><p>å¦å¤–ï¼Œæˆäºˆäº†çš„ Uri æƒé™ä¹Ÿå¯ä»¥é€šè¿‡ <code>contentResolver.releasePersistableUriPermission</code> æ–¹æ³•ä¸»åŠ¨é‡Šæ”¾</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>SAF å…¶å®å°±æ˜¯é€šè¿‡ç”¨æˆ·åœ¨ Picker è·å– DocumentProvider æä¾›çš„å†…å®¹ï¼Œè½¬ä¸º Uri å¯¹è±¡æä¾›ç»™ Client å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ Client ç›´æ¥é€šè¿‡ File Api æ“ä½œ External Storage ï¼Œé€šè¿‡å°†æƒé™ç”±å¼€å‘è€…ç”³è¯·è½¬å˜ä¸ºäº†è®©ç”¨æˆ·è‡ªè¡Œé€šè¿‡ç³»ç»Ÿæ”¹çš„ Picker é€‰æ‹©ï¼Œä»è€Œé¿å…äº†ç”³è¯· <code>WRITE_EXTERNAL_STORAGE</code> å’Œ <code>READ_EXTERNAL_STORAGE</code> æƒé™ </p><h2 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h2><p>å®˜æ–¹æ–‡æ¡£:<br>ä¸­æ–‡ç‰ˆ:<a href="https://developer.android.google.cn/guide/topics/providers/document-provider#kotlin">ä½¿ç”¨å­˜å‚¨è®¿é—®æ¡†æ¶æ‰“å¼€æ–‡ä»¶</a><br>è‹±æ–‡ç‰ˆ:<a href="https://developer.android.com/training/data-storage/shared/documents-files">Access documents and other files from shared storage</a></p><h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><p>å¯¹äº <code>Uri</code> æ¥è¯´ï¼Œå¯ä»¥é€šè¿‡ <code>ContentResolver</code> çš„ Api å¯¹æ–‡ä»¶è¿›è¡Œå¤„ç†</p><p>ä¾‹å¦‚ä¸Šæ–‡ä¸­æåˆ°çš„å°† Uri å¤„ç†ä¸º Bitmap çš„æ–¹æ³•<br>åç»­æœ‰ç©ºå†æ¥ç ”ç©¶ä¸€ä¸‹è¿™äº› api ä»¥åŠ FileStream çš„ä½¿ç”¨</p><p>ä¸‹æ–‡ä»£ç å¤§å¤šè½¬è½½äºä¸Šè¿°å‚è€ƒæ–‡ç« ä¸­çš„ Google å®˜æ–¹æ–‡æ¡£</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†å›¾ç‰‡ Uri è½¬ä¸º Bitmap</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showImage</span><span class="params">(uri: <span class="type">Uri</span>)</span></span>&#123;</span><br><span class="line">    GlobalScope.launch(Dispatchers.Main)&#123;</span><br><span class="line">        imageView.setImageBitmap(getBitmapFromUri(<span class="keyword">this</span><span class="symbol">@SAFActivity</span>,uri))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">getBitmapFromUri</span><span class="params">(context: <span class="type">Context</span>,uri: <span class="type">Uri</span>)</span></span>: Bitmap&#123;</span><br><span class="line">    <span class="keyword">return</span> withContext(Dispatchers.IO)&#123;</span><br><span class="line">        <span class="keyword">val</span> parcelFileDescriptor = context.contentResolver.openFileDescriptor(uri,<span class="string">&quot;r&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> fileDescriptor = parcelFileDescriptor?.fileDescriptor</span><br><span class="line">        <span class="keyword">val</span> image = BitmapFactory.decodeFileDescriptor(fileDescriptor)</span><br><span class="line">        parcelFileDescriptor?.close()</span><br><span class="line">        <span class="keyword">return</span><span class="symbol">@withContext</span> image</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¼–è¾‘æ–‡æœ¬æ–‡ä»¶ Uri çš„å†…å®¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">alterDocument</span><span class="params">(uri: <span class="type">Uri</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//&quot;w&quot; æŒ‡å†™(write)æƒé™</span></span><br><span class="line">        <span class="comment">//å¦‚æœä»…éœ€è¦è¯»(read)æƒé™ï¼Œä¼ å…¥ &quot;r&quot; å³å¯</span></span><br><span class="line">        contentResolver.openFileDescriptor(uri, <span class="string">&quot;w&quot;</span>)?.use &#123;</span><br><span class="line">            <span class="comment">// use&#123;&#125; lets the document provider know you&#x27;re done by automatically closing the stream</span></span><br><span class="line">            FileOutputStream(it.fileDescriptor).use &#123;</span><br><span class="line">                it.write(</span><br><span class="line">                    (<span class="string">&quot;Overwritten by MyCloud at <span class="subst">$&#123;System.currentTimeMillis()&#125;</span>\n&quot;</span>).toByteArray()</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: FileNotFoundException) &#123;</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¯»å–æ–‡æœ¬ Uri ä¸­çš„å†…å®¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTextFromUri</span><span class="params">(uri: <span class="type">Uri</span>)</span></span>: String&#123;</span><br><span class="line">    <span class="keyword">val</span> text = StringBuilder()</span><br><span class="line">    contentResolver.openFileDescriptor(uri,<span class="string">&quot;r&quot;</span>)?.use &#123;</span><br><span class="line">        FileInputStream(it.fileDescriptor).use&#123;</span><br><span class="line">            BufferedReader(InputStreamReader(it)).use &#123; bufferedReader-&gt;</span><br><span class="line">                <span class="keyword">var</span> line: String? = bufferedReader.readLine()</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">null</span> != line)&#123;</span><br><span class="line">                    text.append(line)</span><br><span class="line">                    line = bufferedReader.readLine()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text.toString()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ Android Kitkat (Android 4.4 Api 19)å¼€å§‹ï¼ŒAndroid æä¾›äº†ä¸€å¥—å­˜å‚¨è®¿é—®æ¡†æ¶(Storage Access Framework)ï¼Œç®€ç§° SAFã€‚å¼€å‘è€…å¯ä»¥åœ¨åº”ç”¨å†…ä½¿ç”¨è¯¥æ¡†æ¶ï¼Œé€šè¿‡ç”¨æˆ·çš„æ“ä½œè·å–&amp;#x2F;ä¿å­˜&amp;#x2F;ä¿®æ”¹æ‰‹æœºä¸­çš„æ–‡ä»¶ç­‰&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
    <category term="Storage" scheme="https://ppting.me/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>Android MediaStore Api ä½¿ç”¨</title>
    <link href="https://ppting.me/2020/04/19/2020_04_19_how_to_use_Android_MediaStore_Api/"/>
    <id>https://ppting.me/2020/04/19/2020_04_19_how_to_use_Android_MediaStore_Api/</id>
    <published>2020-04-18T16:00:00.000Z</published>
    <updated>2022-02-12T08:14:36.000Z</updated>
    
    <content type="html"><![CDATA[<br><blockquote><p>æœ¬æ–‡æ˜¯å¯¹ <a href="">å…³äº Android çš„æ–‡ä»¶å­˜å‚¨ç›®å½•</a>çš„è¡¥å……</p></blockquote><p>åœ¨ Android Q åï¼Œ<em>è·å¾— External Storage çš„æƒé™å ä½¿ç”¨ Environment.getExternalStorageDirectory å’Œ File Api å¯¹å¤–ç½®å­˜å‚¨ä¸­çš„æ–‡ä»¶è¿›è¡Œæ“ä½œ</em> è¿™ç§æ–¹å¼å·²ç»ä¸è¢«å…è®¸äº†ï¼Œéœ€è¦å¼€å‘è€…è¿›è¡Œé€‚é…ï¼Œåç»­å¼€å‘è€…éœ€è¦é€šè¿‡ <a href="https://ppting.me/2020/04/19/2020_04_19_about_Storage_Access_Framework/"><strong>Storage Access Framework</strong></a> æˆ–è€… <strong>MediaStore</strong> çš„ Api æ¥å¯¹ External Storage ä¸­çš„æ–‡ä»¶è¿›è¡Œæ“ä½œ</p><span id="more"></span><h2 id="å…³äºæƒé™"><a href="#å…³äºæƒé™" class="headerlink" title="å…³äºæƒé™"></a>å…³äºæƒé™</h2><blockquote><p>READ_EXTERNAL_STORAGE WRITE_EXTERNAL_STORAGE</p></blockquote><p>é€šè¿‡ MediaStore Api è®¿é—®åº”ç”¨è‡ªèº«å­˜æ”¾åˆ°å…¬å…±ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸éœ€è¦ç”³è¯·æƒé™ï¼Œè€Œå¦‚æœè¦è®¿é—®å…¶ä»–åº”ç”¨ä¿å­˜åˆ°å…¬å…±ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ™éœ€è¦ç”³è¯·æƒé™</p><h2 id="å…³äº-MimeType"><a href="#å…³äº-MimeType" class="headerlink" title="å…³äº MimeType"></a>å…³äº MimeType</h2><p>ä» <a href=""><code>com.android.media.MediaFormat</code></a> æºç ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ° Android å®šä¹‰å¥½çš„ä¸€äº› MineType</p><p>ä¾‹å¦‚ï¼š<br><img src="https://i.loli.net/2020/04/19/GQZdv4CSf7qVt2o.png" alt="carbon"></p><h2 id="åˆ›å»º-x2F-ä¿å­˜æ–‡ä»¶"><a href="#åˆ›å»º-x2F-ä¿å­˜æ–‡ä»¶" class="headerlink" title="åˆ›å»º&#x2F;ä¿å­˜æ–‡ä»¶"></a>åˆ›å»º&#x2F;ä¿å­˜æ–‡ä»¶</h2><p>æ„é€ ä¸€ä¸ª ContentValues å¯¹è±¡ï¼Œé€šè¿‡ ContentResolver.insert æ’å…¥åˆ°å¯¹åº”çš„ç›®å½•ä¸­ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª Uriï¼Œé€šè¿‡å¯¹è¯¥ Uri è¿›è¡Œæ–‡ä»¶æµå†™å…¥å³å¯</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">saveImage</span><span class="params">(bitmap: <span class="type">Bitmap</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">val</span> values = ContentValues()</span><br><span class="line">    <span class="keyword">val</span> insertUri = contentResolver.insert(MediaStore.Images.Media.EXTERNAL_CONTENT_URI,values)</span><br><span class="line">    insertUri?.let &#123;</span><br><span class="line">        contentResolver.openOutputStream(it).use &#123;outputStream-&gt;</span><br><span class="line">            bitmap.compress(Bitmap.CompressFormat.PNG,<span class="number">100</span>,outputStream)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><ul><li>ContentValues å…¶å®æ˜¯å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ª ArrayMap çš„æ•°æ®ç»“æ„ç”¨æ¥å­˜æ”¾æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬éœ€è¦ä¿å­˜çš„æ–‡ä»¶ä¿¡æ¯ï¼Œç»™ ContentValues è®¾ç½®å¯¹åº”çš„å€¼<br>ä¾‹å¦‚ï¼š</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> values = ContentValues().apply &#123;</span><br><span class="line">            put(MediaStore.Images.Media.MIME_TYPE,<span class="string">&quot;image/png&quot;</span>)</span><br><span class="line">            put(MediaStore.Images.Media.DISPLAY_NAME,<span class="string">&quot;<span class="subst">$&#123;System.currentTimeMillis()&#125;</span>.png&quot;</span>)</span><br><span class="line">            put(MediaStore.Images.Media.RELATIVE_PATH,<span class="string">&quot;Pictures/DemoPicture&quot;</span>)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“ä¸¾å‡ ä¸ªä¾‹å­ï¼Œå¯è§ä¸‹é¢çš„è¡¨æ ¼</p><table><thead><tr><th>key</th><th>value</th></tr></thead><tbody><tr><td>mime_type</td><td>è®¾ç½®æ–‡ä»¶çš„ MimeType</td></tr><tr><td>_display_name</td><td>æŒ‡å®šä¿å­˜çš„æ–‡ä»¶åï¼Œå¦‚æœä¸è®¾ç½®ï¼Œåˆ™ç³»ç»Ÿä¼šå–å½“å‰çš„æ—¶é—´æˆ³ä½œä¸ºæ–‡ä»¶å</td></tr><tr><td>relative_path</td><td>æŒ‡å®šä¿å­˜çš„æ–‡ä»¶ç›®å½•ï¼Œä¾‹å¦‚ä¸Šæ–‡æˆ‘ä»¬å°†è¿™ä¸ªå›¾ç‰‡ä¿å­˜åˆ°äº† Pictures&#x2F;DemoPicture æ–‡ä»¶å¤¹ä¸‹ï¼Œå¦‚æœä¸è®¾ç½®è¿™ä¸ªå€¼ï¼Œåˆ™ä¼šè¢«é»˜è®¤ä¿å­˜åˆ°å¯¹åº”çš„åª’ä½“ç±»å‹çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œä¾‹å¦‚ï¼Œå›¾ç‰‡æ–‡ä»¶(mimeType &#x3D; image&#x2F;*)ä¼šè¢«ä¿å­˜åˆ° Pictures(Environment#DIRECTORY_PICTURES) ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸èƒ½å°†æ–‡ä»¶æ”¾ç½®åˆ°ä¸å¯¹åº”çš„é¡¶çº§æ–‡ä»¶å¤¹ä¸‹ï¼Œæ¯”å¦‚å°†ä¸€ä¸ª mimeType ä¸º <code>audio/mpeg</code> æ”¾å¤§ Pictures è¿™æ ·çš„è¡Œä¸ºæ˜¯ä¸è¢«å…è®¸çš„ï¼Œä¹Ÿå°±æ˜¯å¦‚æœè®¾ç½® MIME_TYPE &#x3D; audia&#x2F;* å¹¶å°† RELATIVE_PATH è®¾ç½®ä¸º Environment#DIRECTORY_PICTURES è¿™æ ·æ˜¯ä¼š Throw IllegalArgumentException çš„</td></tr></tbody></table><p>ä¾‹å¦‚ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> values = ContentValues().apply &#123;</span><br><span class="line">            put(MediaStore.Images.Media.MIME_TYPE,<span class="string">&quot;image/png&quot;</span>)</span><br><span class="line">            <span class="comment">//è¿™é‡Œå°† Movies è®¾ç½®ä¸ºäº† Primary directory </span></span><br><span class="line">            put(MediaStore.Images.Media.RELATIVE_PATH,<span class="string">&quot;<span class="subst">$&#123;Environment.DIRECTORY_MOVIES&#125;</span>/DemoPicture&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> insertUri = contentResolver.insert(MediaStore.Images.Media.EXTERNAL_CONTENT_URI,values)</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalArgumentException: Primary directory Video not allowed <span class="keyword">for</span> content:<span class="comment">//media/external/images/media; allowed directories are [DCIM, Pictures]</span></span><br><span class="line">        at android.database.DatabaseUtils.readExceptionFromParcel(DatabaseUtils.java:<span class="number">170</span>)</span><br><span class="line">        at android.database.DatabaseUtils.readExceptionFromParcel(DatabaseUtils.java:<span class="number">140</span>)</span><br><span class="line">        at android.content.ContentProviderProxy.insert(ContentProviderNative.java:<span class="number">481</span>)</span><br><span class="line">        at android.content.ContentResolver.insert(ContentResolver.java:<span class="number">1828</span>)</span><br></pre></td></tr></table></figure><p>Android å¤–éƒ¨å­˜å‚¨ä¸­çš„æ ‡å‡†å­˜å‚¨æ–‡ä»¶ç›®å½•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">               sdcard</span><br><span class="line">audio/*        â”œâ”€â”€ Alarms                  </span><br><span class="line">------         â”œâ”€â”€ Audiobooks           </span><br><span class="line">image/*        â”œâ”€â”€ DCIM                 </span><br><span class="line">file/*         â”œâ”€â”€ Documents            </span><br><span class="line">NA             â”œâ”€â”€ Download             </span><br><span class="line">video/*        â”œâ”€â”€ Movies               </span><br><span class="line">audio/*        â”œâ”€â”€ Music                        </span><br><span class="line">audio/*        â”œâ”€â”€ Notifications        </span><br><span class="line">image/*        â”œâ”€â”€ Pictures             </span><br><span class="line">               â”‚Â Â  â””â”€â”€ Screenshots      </span><br><span class="line">audio/*        â”œâ”€â”€ Podcasts             </span><br><span class="line">audio/*        â””â”€â”€ Ringtones            </span><br></pre></td></tr></table></figure><blockquote><p>å‰é¢ä¸€åˆ—ä¸º MimeType ï¼Œåä¸€åˆ—ä¸ºå…¶å¯¹åº”çš„ Primary Directory<br>â€”â€” è¡¨ç¤ºæœªçŸ¥</p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº Android ä¸­çš„åª’ä½“ç±»å‹ï¼Œå¦‚æœæ˜¯éœ€è¦æä¾›ç»™å…¶ä»–åº”ç”¨ä½¿ç”¨çš„ï¼Œåœ¨å¸è½½åä»éœ€ä¿ç•™çš„åª’ä½“æ–‡ä»¶ï¼ŒæŒ‰ç…§è§„èŒƒï¼Œåº”å½“æ”¾åˆ°å¯¹åº”çš„å…¬å…±ç›®å½•åª’ä½“æ–‡ä»¶å¤¹ä¸‹</p><table><thead><tr><th>MimeType</th><th>å¯¹åº”æ–‡ä»¶å¤¹</th></tr></thead><tbody><tr><td>å›¾ç‰‡(image&#x2F;*)</td><td>DCIM,Pictures</td></tr><tr><td>éŸ³é¢‘(audio&#x2F;*)</td><td>Alarms, Music, Notifications, Podcasts, Ringtones</td></tr><tr><td>è§†é¢‘(video&#x2F;*)</td><td>Movies</td></tr><tr><td>æ–‡æ¡£(file&#x2F;*)</td><td>Documents,Download</td></tr></tbody></table><p>å½“ç„¶ï¼Œè¿™äº›ä¹Ÿéƒ½å¯ä»¥é€šè¿‡ MediaStore æ”¾åˆ° <code>Downloads</code> æ–‡ä»¶å¤¹ä¸‹</p><ul><li>ContentValues çš„ key å€¼å¯ä»¥é€šè¿‡ <code>MediaStore.XXX.Media.YYY</code> è·å–åˆ°<br> XXX: å¯¹åº”çš„åª’ä½“ç±»å‹<br> YYY: å¯¹åº”çš„å­—æ®µå¸¸é‡</li><li>RELATIVE_PATH çš„ String å€¼ä¸éœ€è¦ä»¥ <code>/</code> å¼€å¤´</li><li>insert(uri: Uri,value: ContentValues) çš„ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥é€šè¿‡ MediaStore ä¸­çš„å¸¸é‡è·å–ï¼Œå…·ä½“å¦‚ä¸‹</li></ul><h4 id="è·å–-insert-æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå…¥å‚çš„æ–¹å¼"><a href="#è·å–-insert-æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå…¥å‚çš„æ–¹å¼" class="headerlink" title="è·å– insert æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå…¥å‚çš„æ–¹å¼"></a>è·å– insert æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå…¥å‚çš„æ–¹å¼</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* Images</span><br><span class="line">MediaStore.Images.Media.EXTERNAL_CONTENT_URI</span><br><span class="line">* Audio</span><br><span class="line">MediaStore.Audio.Media.EXTERNAL_CONTENT_URI</span><br><span class="line">* Video</span><br><span class="line">MediaStore.Video.Media.EXTERNAL_CONTENT_URI</span><br><span class="line">* Download</span><br><span class="line">MediaStore.Downloads.EXTERNAL_CONTENT_URI</span><br><span class="line">* Documents</span><br><span class="line"><span class="comment">//Documents ç¨å¾®æœ‰äº›ç‰¹æ®Šï¼Œéœ€è¦é€šè¿‡ Files è·å–</span></span><br><span class="line">MediaStore.Files.getContentUri(<span class="string">&quot;external&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="ç–‘é—®-1"><a href="#ç–‘é—®-1" class="headerlink" title="ç–‘é—® 1"></a>ç–‘é—® 1</h4><p>æœ‰ä¸ªç–‘é—®æ˜¯å‰æ–‡å›¾æ ‡ä¸­æ ‡è®°ä¸º <code>------</code> æœªçŸ¥çš„åœ°æ–¹ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼ŒAudiobooks æ˜¯å¯ä»¥å­˜æ”¾ <code>audio/*</code> ç±»å‹çš„æ–‡ä»¶çš„ï¼Œä½†é€šè¿‡ä»¥ä¸‹ä»£ç æ’å…¥ä¸€ä¸ª  <code>audio/*</code> ç±»å‹çš„æ–‡ä»¶å´æŠ›å‡ºå¼‚å¸¸äº†</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> values = ContentValues().apply &#123;</span><br><span class="line">            put(MediaStore.Audio.Media.MIME_TYPE,<span class="string">&quot;audio/*&quot;</span>)</span><br><span class="line">            put(MediaStore.Audio.Media.RELATIVE_PATH,<span class="string">&quot;<span class="subst">$&#123;Environment.DIRECTORY_AUDIOBOOKS&#125;</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> insertUri = contentResolver.insert(MediaStore.Audio.Media.EXTERNAL_CONTENT_URI,values)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Exception ä¿¡æ¯</span></span><br><span class="line">Primary directory Audiobooks not allowed <span class="keyword">for</span> content:<span class="comment">//media/external/audio/media; allowed directories are [Alarms, Music, Notifications, Podcasts, Ringtones]</span></span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ Android ä¼šå¸®æˆ‘ä»¬å°†è¿™äº›åª’ä½“æ•°æ®å­˜æ”¾åˆ°ä¸€ä¸ªæ•°æ®åº“ä¸­ï¼Œè¿™äº›æˆ‘ä»¬è®¾ç½®çš„æ•°æ®éƒ½æ˜¯æ•°æ®åº“è¡¨ä¸­çš„å­—æ®µï¼Œé™¤äº†ä¸Šé¢è¡¨æ ¼ä¸­ç½—åˆ—çš„ä¸€äº›å¸¸ç”¨çš„ä¿¡æ¯ï¼Œè¿˜æœ‰å¾ˆå¤šæ•°æ®å¯ä»¥è®¾ç½®ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒ <code>android.media.MediaStore.MediaColumns</code> ç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¸­æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ª <code>owner_package_name</code> çš„å­—æ®µï¼Œè¿™ä¸ªå­—æ®µçš„ä½œç”¨ï¼Œæˆ‘ä»¬åé¢å†è¯´</p><h2 id="åˆ é™¤è‡ªå·±åº”ç”¨åˆ›å»ºçš„æ–‡ä»¶"><a href="#åˆ é™¤è‡ªå·±åº”ç”¨åˆ›å»ºçš„æ–‡ä»¶" class="headerlink" title="åˆ é™¤è‡ªå·±åº”ç”¨åˆ›å»ºçš„æ–‡ä»¶"></a>åˆ é™¤è‡ªå·±åº”ç”¨åˆ›å»ºçš„æ–‡ä»¶</h2><p>åŒ SAF ï¼Œè·å–åˆ° Uri åå³å¯é€šè¿‡<br><code>contentResolver.delete(uri,null,null)</code> åˆ é™¤å³å¯</p><h2 id="æŸ¥è¯¢è‡ªå·±åº”ç”¨çš„æ–‡ä»¶"><a href="#æŸ¥è¯¢è‡ªå·±åº”ç”¨çš„æ–‡ä»¶" class="headerlink" title="æŸ¥è¯¢è‡ªå·±åº”ç”¨çš„æ–‡ä»¶"></a>æŸ¥è¯¢è‡ªå·±åº”ç”¨çš„æ–‡ä»¶</h2><blockquote><p>é€šè¿‡ <code>Cursor query(@RequiresPermission.Read @NonNull Uri uri,@Nullable String[] projection, @Nullable String selection,@Nullable String[] selectionArgs, @Nullable String sortOrder)</code> æ–¹æ³•</p></blockquote><p>å‚æ•°è§£é‡Š:</p><table><thead><tr><th>å‚æ•°</th><th>ç±»å‹</th><th>é‡Šä¹‰</th></tr></thead><tbody><tr><td>uri</td><td>Uri</td><td>æä¾›æ£€ç´¢å†…å®¹çš„ Uriï¼Œå…¶ scheme æ˜¯<code>content://</code></td></tr><tr><td>projection</td><td>String[]</td><td>è¿”å›çš„åˆ—ï¼Œå¦‚æœä¼ é€’ null åˆ™æ‰€æœ‰åˆ—éƒ½è¿”å›(æ•ˆç‡ä½ä¸‹)</td></tr><tr><td>selection</td><td>String</td><td>è¿‡æ»¤æ¡ä»¶ï¼Œå³ SQL ä¸­çš„ <code>WHERE</code> è¯­å¥(ä½†ä¸éœ€è¦å†™ <code>where</code> æœ¬èº«)ï¼Œå¦‚æœä¼  null åˆ™è¿”å›æ‰€æœ‰çš„æ•°æ®</td></tr><tr><td>selectionArgs</td><td>String[]</td><td>å¦‚æœä½ åœ¨ selection çš„å‚æ•°åŠ äº† <code>?</code> åˆ™ä¼šè¢«æœ¬å­—æ®µä¸­çš„æ•°æ®æŒ‰é¡ºåºæ›¿æ¢æ‰</td></tr><tr><td>sortOrder</td><td>String</td><td>ç”¨æ¥å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œå³ SQL è¯­å¥ä¸­çš„ <code>ORDER BY</code>(å•ä¸éœ€è¦å†™<code>ORDER BY</code> æœ¬èº«)ï¼Œå¦‚æœä¼  null åˆ™æŒ‰ç…§é»˜è®¤é¡ºåºæ’åº(å¯èƒ½æ˜¯æ— åºçš„)</td></tr></tbody></table><p>ä¸¾ä¸ªğŸŒ°</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getImages</span><span class="params">()</span></span>: List&lt;Uri&gt;&#123;</span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">external</span> = MediaStore.Images.Media.EXTERNAL_CONTENT_URI</span><br><span class="line">    <span class="keyword">val</span> filesUris = mutableListOf&lt;Uri&gt;()</span><br><span class="line">    contentResolver.query(</span><br><span class="line">        <span class="comment">//ä»å›¾ç‰‡åª’ä½“ä¿¡æ¯ä¸­è¿›è¡ŒæŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">external</span>,</span><br><span class="line">        <span class="comment">//åªè¿”å› |_ID|WIDTH|HEIGHT| å›¾ç‰‡çš„ idå’Œå®½é«˜çš„åˆ—ä¿¡æ¯</span></span><br><span class="line">        arrayOf(MediaStore.Images.Media._ID,MediaStore.Images.Media.WIDTH,MediaStore.Images.Media.HEIGHT) ,</span><br><span class="line">        <span class="comment">//è¿‡æ»¤æ‰ id ä¸æ»¡è¶³å¤§äº 230 çš„å›¾ç‰‡</span></span><br><span class="line">        <span class="string">&quot;<span class="subst">$&#123;MediaStore.Images.Media._ID&#125;</span> &gt; ? &quot;</span>,</span><br><span class="line">        arrayOf(<span class="string">&quot;230&quot;</span>),</span><br><span class="line">        <span class="comment">//è¿”å›çš„æ•°æ®æŒ‰ç…§ id é™åºæ’åº</span></span><br><span class="line">        <span class="string">&quot;<span class="subst">$&#123;MediaStore.Images.Media._ID&#125;</span> DESC&quot;</span>)</span><br><span class="line">        ?.use &#123;</span><br><span class="line">            <span class="keyword">while</span> (it.moveToNext())&#123;</span><br><span class="line">                <span class="keyword">val</span> index = it.getColumnIndex(MediaStore.Images.Media._ID)</span><br><span class="line">                filesUris.add(ContentUris.withAppendedId(<span class="keyword">external</span>,it.getLong(index)))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> filesUris</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="è®¿é—®å…¶ä»–-App-çš„æ–‡ä»¶"><a href="#è®¿é—®å…¶ä»–-App-çš„æ–‡ä»¶" class="headerlink" title="è®¿é—®å…¶ä»– App çš„æ–‡ä»¶"></a>è®¿é—®å…¶ä»– App çš„æ–‡ä»¶</h2><p>ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰çœ‹åˆ°ä¸Šé¢çš„æ ‡é¢˜å†™çš„éƒ½æ˜¯ã€Œè‡ªå·±åº”ç”¨ã€çš„æ–‡ä»¶ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„ App è‡³ä»Šè¿˜æœªç”³è¯· <code>READ_EXTERNAL_STORAGE</code> å’Œ <code>WRITE_EXTERNAL_STORAGE</code> æƒé™ï¼Œé€šè¿‡ MediaStore Api å¯¹è‡ªå·±åº”ç”¨åˆ›å»ºçš„æ–‡ä»¶ï¼Œæ˜¯ä¸éœ€è¦æƒé™çš„ã€‚è¿™æ—¶å› ä¸ºåœ¨åˆ›å»ºçš„æ—¶å€™ç³»ç»Ÿä¼šå°†æˆ‘ä»¬çš„åº”ç”¨çš„ <code>packageName</code> å†™å…¥ <code>owner_package_name</code> å­—æ®µä»è€Œåœ¨åç»­çš„ä½¿ç”¨ä¸­åˆ¤æ–­è¿™ä¸ªæ–‡ä»¶æ˜¯å“ªä¸ªåº”ç”¨åˆ›å»ºçš„ã€‚</p><p>é‚£å¦‚æœåº”ç”¨éœ€è¦è®¿é—®æˆ–è€…ä¿®æ”¹å…¶ä»–åº”ç”¨çš„æ–‡ä»¶æ€ä¹ˆåŠå‘¢ã€‚</p><ol><li><p>å¦‚æœåªæ˜¯è¦è¯»å–ï¼Œåˆ™ç”³è¯· <code>READ_EXTERNAL_STORAGE</code> æƒé™åå³å¯é€šè¿‡ MediaStore Api è¿›è¡Œè¯»å–</p><p> ä¾‹å¦‚æˆ‘ä»¬ä¸Šè¿°çš„<code>æŸ¥è¯¢è‡ªå·±åº”ç”¨çš„æ–‡ä»¶</code>ä¸­çš„æŸ¥è¯¢è¯­å¥ï¼Œå¦‚æœç”³è¯·äº†è¯»å–å¤–ç½®å­˜å‚¨çš„æƒé™åï¼Œè¿”å›çš„æ•°æ®å°±ä¼šåŒ…å«äº†å…¶ä»– App æä¾›ç»™ Media çš„å›¾ç‰‡äº†<br> å¦‚ä¸‹å›¾ï¼š<br> æ²¡æœ‰è¯»å–æƒé™æ—¶ï¼š<br> <img src="https://i.loli.net/2020/04/19/bz23sLSNlneFACZ.jpg"></p><p> è·å¾—è¯»å–æƒé™åï¼š<br> <img src="https://i.loli.net/2020/04/19/zbYNDKIyV7vci6m.jpg"></p></li></ol><p>å¤šå‡ºæ¥å‡ å¼ å…¶ä»– App äº§ç”Ÿçš„å›¾ç‰‡</p><ol start="2"><li><p>å¦‚æœéœ€è¦ç¼–è¾‘ä¿®æ”¹ç”šè‡³åˆ é™¤å…¶ä»–åº”ç”¨çš„æ–‡ä»¶ï¼Œåˆ™éœ€è¦ç”³è¯· <code>WRITE_EXTERNAL_STORAGE</code> æƒé™ã€‚</p><p> å¦‚æœå½“åº”ç”¨æ²¡æœ‰ <code>WRITE_EXTERNAL_STORAGE</code> æƒé™æ—¶ï¼Œå»ä¿®æ”¹å…¶ä»– App çš„æ–‡ä»¶æ—¶ï¼Œåˆ™ä¼š throw <code>java.lang.SecurityException: xxxx has no access to content://media/external/images/media/243</code> çš„å¼‚å¸¸</p><p> å½“åº”ç”¨æ‹¥æœ‰äº† <code>WRITE_EXTERNAL_STORAGE</code> æƒé™åï¼Œå½“ä¿®æ”¹å…¶ä»– App çš„æ–‡ä»¶æ—¶ï¼Œä¼š throw å¦ä¸€ä¸ª Exception <code>android.app.RecoverableSecurityException: xxxxxx has no access to content://media/external/images/media/243</code></p><p> å¦‚æœæˆ‘ä»¬å°†è¿™ä¸ª RecoverableSecurityException ç»™ Catch ä½ï¼Œå¹¶å‘ç”¨æˆ·ç”³è¯·ä¿®æ”¹è¯¥å›¾ç‰‡çš„æƒé™ï¼Œç”¨æˆ·æ“ä½œåï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ onActivityResult å›è°ƒä¸­æ‹¿åˆ°ç»“æœè¿›è¡Œæ“ä½œäº†</p></li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> editImageUri = Uri.parse(<span class="string">&quot;content://media/external/images/media/<span class="subst">$&#123;editOtherAppMediaId.text&#125;</span>&quot;</span>)</span><br><span class="line">    editImage(editImageUri)</span><br><span class="line">&#125;<span class="keyword">catch</span> (rse : RecoverableSecurityException)&#123;</span><br><span class="line"></span><br><span class="line">    rse.printStackTrace()</span><br><span class="line">    requestForOtherAppFiles(REQUEST_CODE_FOR_EDIT_IMAGE,rse)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestForOtherAppFiles</span><span class="params">(requestCode: <span class="type">Int</span>, rse: <span class="type">RecoverableSecurityException</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In your code, handle IntentSender.SendIntentException.</span></span><br><span class="line">        startIntentSenderForResult(</span><br><span class="line">            rse.userAction.actionIntent.intentSender</span><br><span class="line">            , requestCode,</span><br><span class="line">            <span class="literal">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityResult</span><span class="params">(requestCode: <span class="type">Int</span>, resultCode: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="keyword">data</span>)</span><br><span class="line">    <span class="keyword">if</span> (resultCode == Activity.RESULT_OK)&#123;</span><br><span class="line">        <span class="keyword">when</span>(requestCode)&#123;</span><br><span class="line">            REQUEST_CODE_FOR_EDIT_IMAGE -&gt;&#123;</span><br><span class="line">                editImage(editImageUri)</span><br><span class="line">            &#125;</span><br><span class="line">            REQUEST_CODE_FOR_DELETE_IMAGE -&gt;&#123;</span><br><span class="line">                contentResolver.delete(deleteImageUri,<span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹å›¾ï¼Œç”¨æˆ·ä¼šæ”¶åˆ°è¿™æ ·çš„æç¤ºæ¡†ã€‚<br><img src="https://i.loli.net/2020/04/19/htFfIQ94J25XpBV.jpg"></p><p>PS. å½“ç”¨æˆ·æˆæƒåï¼Œæˆ‘ä»¬å¯¹è¯¥æ–‡ä»¶è¿›è¡Œä¿®æ”¹åï¼Œåç»­å¯¹è¿™ä¸ªæ–‡ä»¶çš„ä¿®æ”¹å°±ä¸å†ä¼šæŠ›å‡º <code>RecoverableSecurityException</code> äº†</p>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡æ˜¯å¯¹ &lt;a href=&quot;&quot;&gt;å…³äº Android çš„æ–‡ä»¶å­˜å‚¨ç›®å½•&lt;/a&gt;çš„è¡¥å……&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨ Android Q åï¼Œ&lt;em&gt;è·å¾— External Storage çš„æƒé™å ä½¿ç”¨ Environment.getExternalStorageDirectory å’Œ File Api å¯¹å¤–ç½®å­˜å‚¨ä¸­çš„æ–‡ä»¶è¿›è¡Œæ“ä½œ&lt;/em&gt; è¿™ç§æ–¹å¼å·²ç»ä¸è¢«å…è®¸äº†ï¼Œéœ€è¦å¼€å‘è€…è¿›è¡Œé€‚é…ï¼Œåç»­å¼€å‘è€…éœ€è¦é€šè¿‡ &lt;a href=&quot;https://ppting.me/2020/04/19/2020_04_19_about_Storage_Access_Framework/&quot;&gt;&lt;strong&gt;Storage Access Framework&lt;/strong&gt;&lt;/a&gt; æˆ–è€… &lt;strong&gt;MediaStore&lt;/strong&gt; çš„ Api æ¥å¯¹ External Storage ä¸­çš„æ–‡ä»¶è¿›è¡Œæ“ä½œ&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
    <category term="Storage" scheme="https://ppting.me/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>é‚£äº›å’Œ so åº“æœ‰å…³çš„é—®é¢˜</title>
    <link href="https://ppting.me/2020/04/12/2020_04_12_about_android_so_lib/"/>
    <id>https://ppting.me/2020/04/12/2020_04_12_about_android_so_lib/</id>
    <published>2020-04-11T16:00:00.000Z</published>
    <updated>2022-02-12T08:14:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ—§æ–‡æ–°å‘ï¼Œçœ‹äº†è‡ªå·±çš„ç¬”è®°åº”ç”¨ï¼Œè¿™æ˜¯ 18 å¹´å†™çš„äº†ï¼Œæ„Ÿè§‰åº”è¯¥è¿˜æŒºæœ‰ç”¨ï¼Œåˆ†äº«ä¸€ä¸‹å§</p><span id="more"></span><h2 id="ABI"><a href="#ABI" class="headerlink" title="ABI"></a>ABI</h2><blockquote><p>ä¸åŒ Android æ‰‹æœºä½¿ç”¨ä¸åŒçš„ CPUï¼Œå› æ­¤æ”¯æŒä¸åŒçš„æŒ‡ä»¤é›†ã€‚CPU ä¸æŒ‡ä»¤é›†çš„æ¯ç§ç»„åˆéƒ½æœ‰å…¶è‡ªå·±çš„åº”ç”¨äºŒè¿›åˆ¶ç•Œé¢ï¼ˆæˆ– ABIï¼‰ã€‚ ABI å¯ä»¥éå¸¸ç²¾ç¡®åœ°å®šä¹‰åº”ç”¨çš„æœºå™¨ä»£ç åœ¨è¿è¡Œæ—¶å¦‚ä½•ä¸ç³»ç»Ÿäº¤äº’ã€‚ æ‚¨å¿…é¡»ä¸ºåº”ç”¨è¦ä½¿ç”¨çš„æ¯ä¸ª CPU æ¶æ„æŒ‡å®š ABIã€‚</p></blockquote><p>Android ä¸Šæ”¯æŒçš„ ABI</p><p><img src="https://i.loli.net/2020/04/12/e73kWqZw5zfPFsJ.jpg"></p><h2 id="å­˜æ”¾ä½ç½®"><a href="#å­˜æ”¾ä½ç½®" class="headerlink" title="å­˜æ”¾ä½ç½®"></a>å­˜æ”¾ä½ç½®</h2><p>åœ¨ <code>Android Studio</code> ä¸­ï¼Œåº”è¯¥å°† <code>so</code> æ–‡ä»¶æŒ‰ç…§ <code>ABI</code> åˆ†ç±»å¹¶æ”¾ç½®åœ¨ <code>jniLibs</code> æ–‡ä»¶å¤¹ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ jniLibs</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ armeabi-v7a</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ libjcore110.so</span><br><span class="line">â”‚Â Â  â””â”€â”€ x86</span><br><span class="line">â”‚Â Â      â””â”€â”€ libjcore110.so</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹-Android-è®¾å¤‡æ”¯æŒçš„-ABI-ç±»å‹"><a href="#æŸ¥çœ‹-Android-è®¾å¤‡æ”¯æŒçš„-ABI-ç±»å‹" class="headerlink" title="æŸ¥çœ‹ Android è®¾å¤‡æ”¯æŒçš„ ABI ç±»å‹"></a>æŸ¥çœ‹ Android è®¾å¤‡æ”¯æŒçš„ ABI ç±»å‹</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œè®¾å¤‡ ABI éƒ½æ˜¯å›ºå®šçš„ï¼Œè¿™æ˜¯ç³»ç»Ÿåœ¨ç¼–è¯‘æ—¶å†³å®šçš„ï¼Œåœ¨ <code>/system/build.prop</code> æŒ‡å®šäº†è®¾å¤‡çš„ ABI ç±»å‹</p><blockquote><p>primary ABIï¼ˆä¸»ABIï¼‰ï¼šå¯¹åº”å½“å‰ç³»ç»Ÿä¸­ä½¿ç”¨çš„æœºå™¨ç ç±»å‹<br>secondary ABIï¼ˆå‰¯ABIï¼‰ï¼šè¡¨ç¤ºå½“å‰ç³»ç»Ÿæ”¯æŒçš„å…¶ä»–ABIç±»å‹</p></blockquote><p>æ¯”å¦‚ Nexus 5 çš„ <code>build.prop</code> æ–‡ä»¶ä¸­æ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ro.product.cpu.abi=armeabi-v7a</span><br><span class="line">ro.product.cpu.abi2=armeabi</span><br><span class="line">ro.product.cpu.abilist=armeabi-v7a,armeabi</span><br><span class="line">ro.product.cpu.abilist32=armeabi-v7a,armeabi</span><br><span class="line">ro.product.cpu.abilist64=</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ adb å‘½ä»¤æŸ¥çœ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">getprop | grep abilist</span><br></pre></td></tr></table></figure><p>å¯ä»¥æŸ¥çœ‹å½“å‰è®¾å¤‡æ”¯æŒçš„ ABI ç±»å‹ã€‚<br>ä¾‹å¦‚ Nexus 5 æ‰€æ”¯æŒçš„ ABI ç±»å‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ro.product.cpu.abilist]: [armeabi-v7a,armeabi]</span><br><span class="line">[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]</span><br><span class="line">[ro.product.cpu.abilist64]: []</span><br></pre></td></tr></table></figure><p>æˆ–è€…åœ¨ <code>Java</code> ä»£ç ä¸­ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç è·å–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Build.CPU_ABI//String ç±»å‹ primary ABI</span><br><span class="line">Build.CPU_ABI2//String ç±»å‹ secondary ABI</span><br><span class="line">Build.SUPPORTED_ABIS//String[] ç±»å‹ æ”¯æŒçš„ ABI åˆ—è¡¨</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯¥è®¾å¤‡(Nexus 5)çš„ä¸» ABI æ˜¯ armeabi-v7aï¼Œå‰¯ ABI æ˜¯ armeabi</p><h2 id="apk-å®‰è£…è¿‡ç¨‹"><a href="#apk-å®‰è£…è¿‡ç¨‹" class="headerlink" title="apk å®‰è£…è¿‡ç¨‹"></a>apk å®‰è£…è¿‡ç¨‹</h2><p>apk åœ¨å®‰è£…çš„æ—¶å€™ï¼ŒPackage Manager ä¼šæ‰«æ apk æ–‡ä»¶ï¼Œå¯»æ‰¾ç¬¦åˆæ¡ä»¶çš„ so åº“ã€‚<br>ç°æ ¹æ®å½“å‰è®¾å¤‡çš„ primary-abi å€¼ï¼Œå¯»æ‰¾å¯¹åº”çš„ so æ–‡ä»¶ï¼Œå½“ä¸å­˜åœ¨ primary çš„ so åº“æ—¶ï¼Œä¼šå¯»æ‰¾ secondary çš„ so åº“ã€‚</p><blockquote><p>å³ lib&#x2F;{primary-abi}&#x2F;libName.so<br>æˆ–è€… lib&#x2F;{secondary-abi}&#x2F;libName.so</p></blockquote><p>å³å½“å®‰è£…åº”ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®å½“å‰è®¾å¤‡çš„ CPU æ¶æ„å¯»æ‰¾æœ€ä¼˜çš„ ABI é€‚é…ï¼Œå¦‚æœæ‰¾åˆ°åˆé€‚çš„ so æ–‡ä»¶ï¼Œåˆ™ä¼šå°†æ•´ä¸ª abi æ–‡ä»¶å¤¹ä¸‹çš„ so æ–‡ä»¶å¤åˆ¶åˆ° <code>/data/data/&#123;package.name&#125;/lib</code> ç›®å½•ä¸‹ã€‚</p><blockquote><p>æ³¨æ„ï¼šapkå®‰è£…è¿‡ç¨‹å¯¹soé€‰æ‹©æ˜¯åŸºäºæ•´ä¸ªABIæ–‡ä»¶å¤¹çš„ï¼Œè€Œéä»¥å•ä¸ªsoæ–‡ä»¶ä¸ºç²’åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠlib&#x2F;armeabi ã€lib&#x2F;armeabi-v7aã€lib&#x2F;x86ç­‰ç­‰æ–‡ä»¶å¤¹çš„å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶å¤¹å†…æ‰€æœ‰.soå¤åˆ¶åˆ°åº”ç”¨çš„dataç›®å½•ä¸‹ã€‚</p></blockquote><h2 id="ç»éªŒ"><a href="#ç»éªŒ" class="headerlink" title="ç»éªŒ"></a>ç»éªŒ</h2><p>åœ¨æˆ‘çš„ä¸€ä¸ª app ä¸­ï¼Œç”±äºä½¿ç”¨äº†æŸä¸ªç¬¬ä¸‰æ–¹çš„ SDK ï¼Œè¿™ä¸ªç¬¬ä¸‰æ–¹ SDK åªæä¾›äº† armeabi-v7a çš„ so åº“ï¼Œå¹¶ä¸”æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®ä¸­è¿˜å¼•ç”¨äº† React Native ï¼ŒReact Native ä¸­åŒ…å«äº† x86 å’Œ armeabi-v7a çš„ so åº“ã€‚<br>æ‰€ä»¥å½“æˆ‘åœ¨ Pad ä¸Šå®‰è£…å®Œåï¼Œæ‰“å¼€åº”ç”¨åå°±å¥”æºƒäº†ï¼Œå¥”æºƒæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.facebook.soloader.SoLoader$WrongAbiError: APK was built for a different platform</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>Native Libs Monitor</code> è¿™ä¸ªè½¯ä»¶æŸ¥çœ‹è¯¥ app å®‰è£…çš„ so åº“æ—¶å‘ç°ï¼Œè¯¥ app ä½¿ç”¨çš„å…¨æ˜¯ <code>armeabi-v7a</code> çš„ so æ–‡ä»¶ï¼Œæ‰€ä»¥å¯¼è‡´äº†Crashã€‚</p><p><em><strong>è§£å†³æ–¹æ¡ˆ</strong></em></p><ul><li>æ–¹æ¡ˆä¸€ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è¡¥é½ x86 ä¸‹çš„ so æ–‡ä»¶</span><br></pre></td></tr></table></figure><ul><li>æ–¹æ¡ˆäºŒï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å°†ç¬¬ä¸‰æ–¹ SDK æä¾›çš„ so æ–‡ä»¶å¤åˆ¶ä¸€ä»½åˆ° x86 æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶åœ¨ä½¿ç”¨åˆ°è¿™ä¸ª SDK çš„åŠŸèƒ½æ—¶è¿›è¡Œåˆ¤æ–­å½“å‰è®¾å¤‡çš„ ABI ï¼Œå¦‚æœæ˜¯ x86 åˆ™æç¤ºç”¨æˆ·è¯¥åŠŸèƒ½ä¸å¯ç”¨ã€‚</span><br></pre></td></tr></table></figure><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><h3 id="ndkFilter"><a href="#ndkFilter" class="headerlink" title="ndkFilter"></a>ndkFilter</h3><p>åœ¨ <code>build.gradle</code> ä¸­è®¾ç½® ndkFilter</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">defaultConfig&#123;</span><br><span class="line">    ndk &#123;</span><br><span class="line">         abiFilters &quot;armeabi-v7a&quot;,&quot;x86&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„é…ç½®ä¼šä½¿å¾—æ‰“åŒ…åçš„ apk æ–‡ä»¶ä¸­åªä¿ç•™ <code>armeabi-v7a</code> å’Œ <code>x86</code> çš„æ–‡ä»¶å¤¹ã€‚</p><h3 id="splits"><a href="#splits" class="headerlink" title="splits"></a>splits</h3><p>å¯ä»¥é€šè¿‡ splits ç”ŸæˆæŒ‡å®šçš„apkæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">splits &#123;</span><br><span class="line">    abi &#123;</span><br><span class="line">        enable true</span><br><span class="line">        reset()</span><br><span class="line">        include &#x27;x86&#x27;, &#x27;armeabi&#x27;, &#x27;armeabi-v7a&#x27;, &#x27;mips&#x27; //é€‰æ‹©éœ€è¦ä¸º apk ç¼–è¯‘çš„ ndk abi</span><br><span class="line">        universalApk false //æ˜¯å¦æ‰“åŒ…ä¸€ä¸ªåŒ…å«æ‰€æœ‰ abi çš„ apk åŒ…</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="http://allenfeng.com/2016/11/06/what-you-should-know-about-android-abi-and-so/">è°ˆè°ˆ Android çš„ so</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ—§æ–‡æ–°å‘ï¼Œçœ‹äº†è‡ªå·±çš„ç¬”è®°åº”ç”¨ï¼Œè¿™æ˜¯ 18 å¹´å†™çš„äº†ï¼Œæ„Ÿè§‰åº”è¯¥è¿˜æŒºæœ‰ç”¨ï¼Œåˆ†äº«ä¸€ä¸‹å§&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>å…³äº Android çš„æ–‡ä»¶å­˜å‚¨ç›®å½•</title>
    <link href="https://ppting.me/2020/04/12/2020_04_12_about_android_file_path/"/>
    <id>https://ppting.me/2020/04/12/2020_04_12_about_android_file_path/</id>
    <published>2020-04-11T16:00:00.000Z</published>
    <updated>2022-02-12T08:14:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨ Android ä¸­ï¼Œæ–‡ä»¶çš„å­˜å‚¨æœ‰å¤šä¸ªè·¯å¾„å¯ä¾›å­˜å‚¨ï¼Œä¹Ÿæä¾›äº†å¤šä¸ª Api ä½¿ç”¨ï¼Œé‚£è¿™äº› Api åˆ°åº•æ˜¯ç”¨æ¥æ˜¯å“ªä¸ªç›®å½•ï¼Œåˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ã€‚</p><span id="more"></span><h2 id="å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨"><a href="#å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨" class="headerlink" title="å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨"></a>å†…éƒ¨å­˜å‚¨å’Œå¤–éƒ¨å­˜å‚¨</h2><p>é¦–å…ˆï¼Œè¦å…ˆçŸ¥é“ Android å­˜å‚¨ä¸­åˆ†ä¸ºå†…éƒ¨å­˜å‚¨(Internal storage)å’Œå¤–éƒ¨å­˜å‚¨(External storage)</p><blockquote><p>ä¸‹é¢ç”¨ com.application.id ä½œä¸ºæˆ‘ä»¬çš„ applicationId æ¥ä¸¾ä¾‹</p></blockquote><h3 id="å†…éƒ¨å­˜å‚¨"><a href="#å†…éƒ¨å­˜å‚¨" class="headerlink" title="å†…éƒ¨å­˜å‚¨"></a>å†…éƒ¨å­˜å‚¨</h3><ul><li>å†…éƒ¨å­˜å‚¨æŒ‡çš„æ˜¯ App ç§æœ‰çš„ç›®å½•ï¼Œå³ &#x2F;data&#x2F;data&#x2F;com.application.id&#x2F;<blockquote><p>æœ‰äº›æ‰‹æœºçš„ç›®å½•æ˜¯ &#x2F;data&#x2F;user&#x2F;0&#x2F;com.application.id&#x2F;<br>å®é™…ä¸Šæ˜¯åŒä¸€ä¸ªç›®å½•ï¼Œä»ä¸‹å›¾å¯è§ï¼Œ<code>/data/user/0</code> ç›®å½•æ˜¯ä¸€ä¸ªè½¯è¿æ¥ï¼Œå…¶å®é™…æŒ‡å‘çš„ç›®å½•å³ <code>/data/data</code></p></blockquote></li></ul><p>å­˜å‚¨åœ¨è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶æ˜¯ App ç§æœ‰çš„ï¼Œå…¶ä»– App æ— æ³•è¯»å†™(root ç”¨æˆ·é™¤å¤–)ï¼Œç›®å½•ä¼šéšç€ App çš„å¸è½½è€Œè¢«åˆ é™¤<br><img src="https://i.loli.net/2020/04/12/vKrRneJ5ysNDgLm.jpg"></p><h3 id="å¤–éƒ¨å­˜å‚¨"><a href="#å¤–éƒ¨å­˜å‚¨" class="headerlink" title="å¤–éƒ¨å­˜å‚¨"></a>å¤–éƒ¨å­˜å‚¨</h3><blockquote><p>å¤–éƒ¨å­˜å‚¨åŒ…å«ç§æœ‰å¤–éƒ¨å­˜å‚¨å’Œå…¬å…±ç›®å½•å­˜å‚¨</p></blockquote><h4 id="ç§æœ‰å¤–éƒ¨å­˜å‚¨"><a href="#ç§æœ‰å¤–éƒ¨å­˜å‚¨" class="headerlink" title="ç§æœ‰å¤–éƒ¨å­˜å‚¨"></a>ç§æœ‰å¤–éƒ¨å­˜å‚¨</h4><p>ç§æœ‰å¤–éƒ¨å­˜å‚¨æ˜¯æŒ‡ <code>/storage/emulated/0/Android/data/com.application.id</code> </p><p>æˆ‘ä»¬ä¼šåœ¨æ ¹ç›®å½•é‡Œçœ‹åˆ° <code>/sdcard</code>ã€<code>/mnt/sdcard</code>ã€<code>/storage/emulated/self/primary</code> ä¸‹çš„æ–‡ä»¶éƒ½è·Ÿä¸Šè¿°çš„ <code>/storage/emulated/0</code> ä¸­çš„æ–‡ä»¶ä¸€æ¨¡ä¸€æ ·ï¼Œè¿™ä¸ç¦ä¼šè®©äººæ„Ÿåˆ°ç–‘æƒ‘ï¼Œå®é™…ä¸Šï¼Œé€šè¿‡è°ƒç ”å‘ç°è¿™äº›ç›®å½•ä¹Ÿéƒ½æ˜¯è½¯è¿æ¥ï¼Œå¯ä»¥çœ‹åˆ°å…¶å¯¹åº”å®é™…ç›®å½•</p><blockquote><p><code>/sdcard</code> -&gt; <code>/storage/self/primary</code></p><p><code>/storage/self/primary</code> -&gt; <code>/mnt/user/0/primary</code></p><p><code>/mnt/user/0/primary</code> -&gt; <code>/storage/emulated/0</code></p></blockquote><p>æ‰€ä»¥å…¶å®åˆ°æœ€åï¼Œå…¶ç›®å½•æŒ‡å‘çš„éƒ½æ˜¯æˆ‘ä»¬çš„ <code>/storage/emulated/0</code> ç›®å½•</p><p>åœ¨ç§æœ‰å¤–éƒ¨å­˜å‚¨ä¸­ï¼ŒApp å¯ä»¥è¯»å†™è‡ªå·±çš„ç›®å½•(<code>/storage/emulated/0/Android/data/com.application.id</code>)ä¸‹çš„æ–‡ä»¶ï¼Œå¦‚æœ Api å¤§äº 19ï¼Œä¸éœ€è¦ç”³è¯·å†™æƒé™ã€‚<br>å¦‚æœéœ€è¦è¯»å†™å…¶ä»– App çš„ç§æœ‰å¤–éƒ¨å­˜å‚¨ç›®å½•ï¼Œåˆ™éœ€è¦å£°æ˜è¯»å†™æƒé™ï¼Œè‹¥é«˜äº 23ï¼Œè¿˜éœ€è¦åŠ¨æ€è¿›è¡Œæƒé™ç”³è¯·ã€‚</p><p>ç§æœ‰å¤–éƒ¨å­˜å‚¨çš„ç›®å½•ä¹Ÿä¼šéšç€ App çš„å¸è½½è€Œè¢«åˆ é™¤</p><blockquote><p>å†™æƒé™ android.permission.WRITE_EXTERNAL_STORAGE</p></blockquote><p><strong>é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„è®¾è®¡å‘¢ï¼Ÿè¿™ä¸ª 0 åˆä»£è¡¨ä»€ä¹ˆ</strong><br>æˆ‘çš„çŒœæµ‹æ˜¯ Android ç³»ç»Ÿä¸­å¯ä»¥æœ‰å¤šç”¨æˆ·ï¼Œè¿™ä¸ª 0 ä»£è¡¨äº†å½“å‰ç”¨æˆ·ï¼Œå¦‚æœæœ‰ç¬¬äºŒä¸ªç”¨æˆ·ï¼Œåº”è¯¥å°±ä¼šæœ‰ 1 çš„å‡ºç°ï¼Œä½¿ç”¨è½¯è¿æ¥çš„æ–¹å¼ï¼Œä¼šä¿è¯åœ¨ä½¿ç”¨ api è·å–åˆ°ç›¸å¯¹åº”çš„è·¯å¾„æ—¶ï¼ŒæŒ‡å‘æ­£ç¡®çš„ç”¨æˆ·ä¸‹çš„æ–‡ä»¶ç›®å½•ï¼Œé¿å…å¤šä¸ªç”¨æˆ·ä¹‹é—´çš„æ–‡ä»¶ç³»ç»Ÿæ··ä¹±<br>å½“ç„¶ï¼Œè¿™åªæ˜¯æˆ‘çš„çŒœæµ‹ï¼Œæœªæ›¾éªŒè¯</p><h4 id="å…¬å…±ç›®å½•å­˜å‚¨"><a href="#å…¬å…±ç›®å½•å­˜å‚¨" class="headerlink" title="å…¬å…±ç›®å½•å­˜å‚¨"></a>å…¬å…±ç›®å½•å­˜å‚¨</h4><p>æ˜¯æŒ‡ sdcard ä¸­æ ¹ç›®å½•ä¸­çš„å…¬å…±ç›®å½•ï¼Œå³ <code>/storage/emulated/0</code>ï¼Œä¾‹å¦‚å›¾ç‰‡æ–‡ä»¶å¤¹(<code>/storage/emulated/0/DCIM</code>)ï¼ŒéŸ³ä¹æ–‡ä»¶(<code>/storage/emulated/0/Music</code>)</p><p>è¿™éƒ¨åˆ†çš„ç›®å½•æ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥å¦‚æœ App å¾€è¿™ä¸ªç›®å½•ä¸‹è¯»å†™æ–‡ä»¶ï¼Œéœ€è¦ç”³è¯·è¯»å†™æƒé™ï¼Œå¹¶ä¸”åœ¨ App å¸è½½åä¸ä¼šè¢«åˆ é™¤ã€‚</p><h2 id="é‚£æˆ‘ä»¬æ¥ç€çœ‹-Api-çš„ä½¿ç”¨"><a href="#é‚£æˆ‘ä»¬æ¥ç€çœ‹-Api-çš„ä½¿ç”¨" class="headerlink" title="é‚£æˆ‘ä»¬æ¥ç€çœ‹ Api çš„ä½¿ç”¨"></a>é‚£æˆ‘ä»¬æ¥ç€çœ‹ Api çš„ä½¿ç”¨</h2><h3 id="è·å–å†…éƒ¨å­˜å‚¨ç›®å½•"><a href="#è·å–å†…éƒ¨å­˜å‚¨ç›®å½•" class="headerlink" title="è·å–å†…éƒ¨å­˜å‚¨ç›®å½•"></a>è·å–å†…éƒ¨å­˜å‚¨ç›®å½•</h3><blockquote><p>æ— éœ€ç”³è¯·æƒé™</p></blockquote><ul><li><p>Context.getFilesDir()</p><blockquote><p>è·å–å†…éƒ¨å­˜å‚¨ä¸­ files ç›®å½•<br><br>&#x2F;data&#x2F;data&#x2F;com.application.id&#x2F;files</p></blockquote></li><li><p>Context.getCacheDir()</p><blockquote><p>è·å–å†…éƒ¨å­˜å‚¨ä¸­ cache ç›®å½•<br><br>&#x2F;data&#x2F;data&#x2F;com.application.id&#x2F;cache</p></blockquote></li><li><p>Context.getDataDir()&#x2F;&#x2F;Api &gt;&#x3D; 24</p><blockquote><p>è·å–å†…éƒ¨å­˜å‚¨çš„å­˜å‚¨ç›®å½•çš„ç»å¯¹è·¯å¾„<br><br>&#x2F;data&#x2F;data&#x2F;com.application.id</p></blockquote></li></ul><h3 id="è·å–å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•"><a href="#è·å–å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•" class="headerlink" title="è·å–å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•"></a>è·å–å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•</h3><blockquote><p>æ— éœ€ç”³è¯·æƒé™</p></blockquote><ul><li><p>Context.getExternalFilesDir(String type)</p><blockquote><p>è·å–å¤–éƒ¨ç§æœ‰å­˜å‚¨ä¸­çš„ files ç›®å½•æˆ–å…¶å­æ–‡ä»¶å¤¹<br><br>&#x2F;storage&#x2F;emulated&#x2F;0&#x2F;Android&#x2F;data&#x2F;com.application.id&#x2F;files<br><br>or <br><br>&#x2F;storage&#x2F;emulated&#x2F;0&#x2F;Android&#x2F;data&#x2F;com.application.id&#x2F;files&#x2F;type</p></blockquote></li><li><p>Context.getExternalCacheDir()</p><blockquote><p>è·å–å¤–éƒ¨ç§æœ‰å­˜å‚¨ä¸­çš„ cache ç›®å½•<br><br>&#x2F;storage&#x2F;emulated&#x2F;0&#x2F;Android&#x2F;data&#x2F;com.application.id&#x2F;cache</p></blockquote></li></ul><h3 id="è·å–å…¬æœ‰ç›®å½•"><a href="#è·å–å…¬æœ‰ç›®å½•" class="headerlink" title="è·å–å…¬æœ‰ç›®å½•"></a>è·å–å…¬æœ‰ç›®å½•</h3><blockquote><p>è¯»å†™éœ€è¦æƒé™<br>å†™å…¥æƒé™ android.Manifest.permission#WRITE_EXTERNAL_STORAGE<br>è¯»å–æƒé™ android.Manifest.permission#READ_EXTERNAL_STORAGE</p></blockquote><h4 id="å¯¹åº”çš„-API"><a href="#å¯¹åº”çš„-API" class="headerlink" title="å¯¹åº”çš„ API"></a>å¯¹åº”çš„ API</h4><ul><li><p>Environment.getExternalStorageDirectory()</p><blockquote><p>è·å–å…¬æœ‰ç›®å½•<br>&#x2F;storage&#x2F;emulated&#x2F;0</p></blockquote>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * type</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_MUSIC</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_PODCASTS</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_RINGTONES</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_ALARMS</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_NOTIFICATIONS</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_PICTURES</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_MOVIES</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_DOWNLOADS</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_DCIM</span></span><br><span class="line"><span class="comment"> * #DIRECTORY_DOCUMENTS</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></li><li><p>Environment.getExternalStoragePublicDirectory(String type)</p><blockquote><p>è·å–å…¬æœ‰ç›®å½•ä¸‹å¯¹åº”çš„ç±»å‹æ–‡ä»¶å¤¹<br><br>&#x2F;storage&#x2F;emulated&#x2F;0&#x2F;DCIM ç­‰</p></blockquote></li></ul><h2 id="Android-10-åˆ†åŒºå­˜å‚¨æœºåˆ¶"><a href="#Android-10-åˆ†åŒºå­˜å‚¨æœºåˆ¶" class="headerlink" title="Android 10 åˆ†åŒºå­˜å‚¨æœºåˆ¶"></a>Android 10 åˆ†åŒºå­˜å‚¨æœºåˆ¶</h2><p>ç„¶è€Œï¼Œåœ¨ Android 10(Api 29) ä¸Šï¼Œæˆ‘ä»¬å‘ç°é€šè¿‡ <code>Environment</code> è·å–è·¯å¾„çš„ api å·²ç»è¢«æ ‡è®°ä¸º Deprecated çš„äº†</p><p><img src="https://i.loli.net/2020/04/12/S6x5utifrnPIRGz.jpg"></p><p>è¿™â€¦å¯å’‹æ•´å‘¢</p><p>å…¶å®ï¼Œè¿™å¯¹äº Android ç”¨æˆ·æ¥è¯´ï¼Œæ˜¯ä¸€ä»¶å¥½äº‹æ¥ç€ã€‚<br>éšç€ Android çš„å‘å±•ï¼ŒGoogle å¯¹ç”¨æˆ·çš„éšç§è¶Šæ¥è¶Šçœ‹é‡äº†ï¼Œæ…¢æ…¢åœ°æ”¶ç´§äº†å¼€å‘è€…å¯¹ç”¨æˆ·è®¾å¤‡ sdcard çš„è¯»å†™æƒé™</p><p>ä» Android 10 å¼€å§‹ï¼Œå¯¹äº Target Api ä¸º 29 çš„åº”ç”¨ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£æ‰€æè¿°ï¼Œå…¶è®¿é—®æƒé™èŒƒå›´é™å®šä¸ºå¤–éƒ¨å­˜å‚¨ï¼Œå³åˆ†åŒºå­˜å‚¨(Scoped Storage)</p><p>ç®€å•æ¥è¯´ï¼Œåº”ç”¨åªèƒ½é€šè¿‡è®¿é—®<code>Context.getFilesDir()</code> ç­‰ api è®¿é—®è‡ªå·±çš„ç§æœ‰ç›®å½•(<code>/data/data/packagename/</code>)ï¼Œä»¥åŠé€šè¿‡<code>Context.getExternalFilesDir(&quot;&quot;)</code> ç­‰ api è®¿é—®å¤–éƒ¨å­˜å‚¨ä¸­è‡ªå·±åº”ç”¨çš„ç›®å½•(<code>/Android/data/packagename/</code>)ï¼Œæ— éœ€ç”³è¯·æƒé™ï¼Œè¿™ä¸ªè¡Œä¸ºåŒä¹‹å‰ä¸€æ ·ï¼Œæ²¡æœ‰å˜åŠ¨ã€‚</p><p>åœ¨ <code>Target api &lt; 29</code> æ—¶ï¼Œåªè¦åº”ç”¨è·å–åˆ°äº† <code>WRITE_EXTERNAL_STORAGE</code> æƒé™ï¼Œå°±å¯ä»¥å¯¹æ•´ä¸ª sdcard ç›®å½•è¿›è¡Œè¯»å–ï¼ŒåŒ…æ‹¬å…¶ä»–åº”ç”¨çš„ <code>å¤–éƒ¨ç§æœ‰å­˜å‚¨ç›®å½•(/Android/data/otherAppPackageName/)</code></p><p>ä½†æ˜¯ï¼Œåœ¨ <code>Target Api &gt;=29</code> åï¼Œåœ¨ Android 10 è®¾å¤‡ä¸Š<strong>å…¨æ–°å®‰è£…</strong>çš„åº”ç”¨ï¼Œå³ä¾¿åº”ç”¨è·å¾—äº†<code>WRITE_EXTERNAL_STORAGE</code>æƒé™åï¼Œåº”ç”¨ä¹Ÿæ— æ³•ç›´æ¥é€šè¿‡ <code>Java File Api</code> (ä¾‹å¦‚ <code>Environment.getExternalStorageDirectory()</code>) å¯¹ sdcard ä¸­çš„éè‡ªå·±åº”ç”¨åˆ›å»ºçš„æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œã€‚</p><blockquote><p>è¿™é‡Œçš„å…¨æ–°å®‰è£…åŠ äº†ç€é‡æç¤ºï¼Œåº”ç”¨æ˜¯ä» Target Api &#x3D; 28 è¦†ç›–å®‰è£…å‡çº§åˆ° Target Api 29 çš„è¯ï¼Œå³ä¾¿æ˜¯å®‰è£…åœ¨ Android 10 çš„æ‰‹æœºä¸Šï¼Œè‹¥è·å¾—äº†<code>WRITE_EXTERNAL_STORAGE</code>æƒé™ï¼Œé€šè¿‡ Java File Api ä»ç„¶èƒ½å¤Ÿå¯¹ sdcard ä¸­çš„ä»»æ„æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œ</p></blockquote><p>é‚£â€¦é—®é¢˜æ¥äº†ï¼Œåœ¨ Target Api &gt;&#x3D; 29 ä¸Š</p><ol><li>åº”ç”¨è‡ªèº«éœ€è¦å°†å¤šåª’ä½“æ–‡ä»¶è¿›è¡Œå­˜å‚¨è¯»å–ï¼Œè¯¥æ€ä¹ˆåšå‘¢ã€‚</li><li>éœ€è¦è®¿é—®ç”¨æˆ·å…¶ä»– APP å­˜å‚¨çš„æ–‡ä»¶(ä¾‹å¦‚ç…§ç‰‡ï¼Œè§†é¢‘)ï¼Œåˆè¯¥å¦‚ä½•é€‚é…å‘¢</li></ol><p>åœ¨ Android çš„è§„èŒƒä¸­ï¼Œå¦‚æœç”¨æˆ·éœ€è¦ä¿å­˜å¤šåª’ä½“æ–‡ä»¶åˆ°æ‰‹æœºä¸­ï¼Œåº”ä¿å­˜åˆ°å…±äº«ç›®å½•(Share storage)ä¸­ï¼Œä»¥ä¾¿å…¶ä»–åº”ç”¨è®¿é—®ï¼Œä¾‹å¦‚éŸ³ä¹åº”ç”¨ä¸­ç”¨æˆ·ä¸‹è½½çš„éŸ³ä¹ï¼Œæ‹ç…§åº”ç”¨ç”¨æˆ·æ‹æ‘„çš„ç…§ç‰‡ï¼Œè§†é¢‘ç­‰</p><p>ä¸‹é¢çš„è¡¨æ ¼æ€»ç»“äº†ä»¥ä¸Šçš„å†…å®¹ï¼Œè€Œè‡³äºå¦‚ä½•é€šè¿‡ MediaStore Api å’Œ Storage Access Framework è¿›è¡Œå¢åˆ æŸ¥æ”¹ï¼Œæˆ‘ä»¬<del>ä¸‹æ–‡å†ç»­</del></p><p>ä¸‹æ–‡æ¥å•¦ï¼š</p><p><a href="https://ppting.me/2020/04/19/2020_04_19_how_to_use_Android_MediaStore_Api/">Android MediaStore Api ä½¿ç”¨</a></p><p><a href="https://ppting.me/2020/04/19/2020_04_19_about_Storage_Access_Framework/">Android å­˜å‚¨è®¿é—®æ¡†æ¶ Storage Access Framework</a></p><p><img src="https://i.loli.net/2020/04/12/68YELOjySGlI4PN.jpg" alt="-w1235"></p><p>å¦‚æœ‰é”™è¯¯ï¼Œæœ›å„ä½æ–§æ­£</p><p>Google å®˜æ–¹æ–‡æ¡£ï¼š<br><a href="https://developer.android.com/about/versions/10/privacy/changes">Android 10 ä¸­çš„éšç§æƒå˜æ›´</a><br><a href="https://developer.android.com/training/data-storage/files/external">å°†æ–‡ä»¶ä¿å­˜åˆ°å¤–éƒ¨å­˜å‚¨</a><br><a href="https://developer.android.com/training/data-storage/files/external-scoped">ç®¡ç†åˆ†åŒºå¤–éƒ¨å­˜å‚¨è®¿é—®</a><br><a href="https://developer.android.com/training/data-storage">Data and file storage overview</a><br><a href="https://developer.android.com/guide/topics/providers/document-provider">ä½¿ç”¨å­˜å‚¨è®¿é—®æ¡†æ¶æ‰“å¼€æ–‡ä»¶</a><br><a href="https://developer.android.com/training/data-storage/shared">Overview of shared storage</a></p><p>æœ¬æ–‡å‚è€ƒæ–‡ç« ï¼š</p><blockquote><p>æ„Ÿè°¢å„ä½å¤§å¤§çš„åˆ†äº«</p></blockquote><p><a href="https://feng.moe/archives/47/">Android Q å­˜å‚¨æœºåˆ¶å¤§å˜åŒ–</a><br><a href="https://www.liaohuqiu.net/cn/posts/storage-in-android/">Android å­˜å‚¨ä½¿ç”¨å‚è€ƒ</a><br><a href="https://juejin.im/post/5e43ab2bf265da572660f777">Android 10 åˆ†åŒºå­˜å‚¨ä»‹ç»åŠç™¾åº¦APPé€‚é…å®è·µ</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨ Android ä¸­ï¼Œæ–‡ä»¶çš„å­˜å‚¨æœ‰å¤šä¸ªè·¯å¾„å¯ä¾›å­˜å‚¨ï¼Œä¹Ÿæä¾›äº†å¤šä¸ª Api ä½¿ç”¨ï¼Œé‚£è¿™äº› Api åˆ°åº•æ˜¯ç”¨æ¥æ˜¯å“ªä¸ªç›®å½•ï¼Œåˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
    <category term="Storage" scheme="https://ppting.me/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>ä»ä¸€æ¬¡æ¸ é“åŒ…çš„æ¸ é“ä¸ŠæŠ¥å¤±è´¥æŸ¥çœ‹ ApplicationContext çš„èµ‹å€¼è¿‡ç¨‹</title>
    <link href="https://ppting.me/2020/02/01/2020_02_01_application_lifecycle/"/>
    <id>https://ppting.me/2020/02/01/2020_02_01_application_lifecycle/</id>
    <published>2020-02-01T07:34:22.000Z</published>
    <updated>2022-02-12T08:13:42.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä¹‹å‰åœ¨é¡¹ç›®çš„å¼€å‘ä¸­ï¼ŒåŒäº‹é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜</p><blockquote><p>åœ¨æŸä¸ªç‰ˆæœ¬åäº¤ç»™å¸‚åœºéƒ¨é—¨åŒäº‹çš„ apk æ–‡ä»¶ï¼Œå¸‚åœºçš„åŒäº‹åé¦ˆï¼Œçº¿ä¸Šçš„ç”¨æˆ·æ–°è£…åçš„ä¸ŠæŠ¥çš„æ¸ é“å…¨æ˜¯å®˜æ–¹æ¸ é“</p><p>PS. é¡¹ç›®ä¸­ä½¿ç”¨ç¾å›¢çš„ <a href="https://github.com/Meituan-Dianping/walle">Walle</a> è¿›è¡Œå¤šæ¸ é“æ‰“åŒ…</p></blockquote><span id="more"></span><h2 id="é—®é¢˜æ’æŸ¥"><a href="#é—®é¢˜æ’æŸ¥" class="headerlink" title="é—®é¢˜æ’æŸ¥"></a>é—®é¢˜æ’æŸ¥</h2><p>ç»„é‡Œçš„å¦ä¸€ä¸ªåŒäº‹å¼€å§‹æ’æŸ¥é—®é¢˜ï¼Œå…ˆæ˜¯æ’æŸ¥äº†äº¤ç»™å¸‚åœºåŒäº‹çš„ç­¾æ¸ é“çš„å·¥å…·æ˜¯ä¸æ˜¯å‡ºäº†é—®é¢˜ã€‚äºæ˜¯å…ˆè‡ªå·±ç”¨è¯¥å·¥å…·å¯¹ apk è¿›è¡Œæ¸ é“ç­¾å…¥è¿›è¡Œæ£€æŸ¥ï¼Œå‘ç°ç¡®å®ä¸è¡Œã€‚äºæ˜¯æ‰‹åŠ¨å†™å…¥æ¸ é“ï¼ŒDebug å‘ç°é€šè¿‡ <code>WalleChannelReader.getChannel(this.getApplicationContext())</code>æ–¹æ³•è·å–åˆ°çš„å€¼ä¸€ç›´ä¸ºç©º</p><p>åæ¥ï¼Œç»„å†…çš„åŒäº‹æ¥æ‰¾æˆ‘è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼ŒåŒäº‹çŒœæµ‹æ˜¯å¦è·Ÿä¹‹å‰å¼•å…¥äº†æŸä¸ªä¾èµ–åº“æœ‰å…³ç³»ï¼Œè€ŒæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œç¾å›¢çš„æ¸ é“è·å–æ˜¯é€šè¿‡è·å–åˆ° .apk æ–‡ä»¶ç„¶åä»è¯¥æ–‡ä»¶ä¸­çš„æŸä¸ªåˆ†åŒºé‡Œè·å–å†™å…¥çš„æ¸ é“çš„ï¼Œæ‰€ä»¥åº”è¯¥è·Ÿè¿™ä¸ªé—®é¢˜ä¸ä¼šæœ‰å…³ç³»ã€‚</p><p>æˆ‘å¼€å§‹çœ‹é¡¹ç›®ä¸­çš„ä»£ç ï¼Œçœ‹ä¼¼æ²¡æœ‰é—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#XXXXApplication.<span class="function">java </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String channel = WalleChannelReader.getChannel(getApplicationContext(), <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(channel)) &#123;</span><br><span class="line">        channel = <span class="string">&quot;xxxx&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> channel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®åœ¨æ²¡è¾™äº†ï¼Œåªå¥½é€šè¿‡ git commit å¯¹æ¯”åœ¨å‡ºç°é—®é¢˜å‰çš„ä»£ç ï¼Œçœ‹æ˜¯å¦åœ¨åšæŸä¸ªéœ€æ±‚æ—¶ä¸å°å¿ƒæ”¹åŠ¨äº†æ­¤å¤„çš„ä»£ç ã€‚</p><p>æœä¸å…¶ç„¶ï¼Œå‘ç°æ˜¯å¦ä¸€ä¸ªåŒäº‹åœ¨åšå¦ä¸€ä¸ªéœ€æ±‚çš„æ—¶å€™ï¼Œä¸å°å¿ƒå°† <code>getChannel()</code> çš„è°ƒç”¨æ”¾åˆ°äº† <code>Application#attachBaseContext()</code> æ–¹æ³•ä¸­ã€‚</p><p>è€Œé€šè¿‡æŸ¥çœ‹<code>walle</code> çš„æºç ï¼Œå‘ç° <code>WalleChannelReader.getChannel(Context context)</code> ä¸­éœ€è¦é€šè¿‡ <code>applicationContext</code> è·å–åˆ° .apk æ–‡ä»¶çš„åœ°å€(path) æ‰èƒ½è·å–åˆ°å†™åœ¨åˆ†åŒºå†…çš„æ¸ é“ã€‚</p><p>walle æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™é‡Œçš„ context å³ WalleChannelReader.getChannel(Context context) ä¸­ä¼ å…¥çš„ context</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥è¿™é‡Œçš„ context.getApplicationInfo() ä¸º null</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getApkPath</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Context context)</span> </span>&#123;</span><br><span class="line">    String apkPath = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> ApplicationInfo applicationInfo = context.getApplicationInfo();</span><br><span class="line">        <span class="keyword">if</span> (applicationInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        apkPath = applicationInfo.sourceDir;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> apkPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äºæ˜¯ï¼Œbug è§£å†³äº†ï¼Œå°†ä¸ŠæŠ¥æ¸ é“çš„ä»£ç é‡æ–°æ¢å¤åˆ° <code>onCreate()</code> åå³å¯</p><p>ä½†ï¼Œä»…ä»…æ˜¯ä¿®å¤äº† bug ï¼Œä½†é—®é¢˜çš„èƒŒåï¼Œè¿˜æœ‰å¾ˆå¤šä¸äº†è§£çš„åœ°æ–¹ã€‚</p><h2 id="æ€è€ƒğŸ¤”"><a href="#æ€è€ƒğŸ¤”" class="headerlink" title="æ€è€ƒğŸ¤”"></a>æ€è€ƒğŸ¤”</h2><p>äºæ˜¯æˆ‘å¼€å§‹æ€è€ƒ</p><p><strong>ä¸ºä½•åœ¨ <code>attachBaseContext(base: Context?)</code> æ–¹æ³•ä¸­è·å–ä¸åˆ° applicationContext</strong></p><p>é¦–å…ˆï¼Œçœ‹ä¸€ä¸‹ application çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»–æ˜¯å¦‚ä½•è¢«åˆ›å»ºå‡ºæ¥çš„ï¼Œè¿™å°±è¦ä» App å¯åŠ¨æµç¨‹è¯´èµ·ï¼Œä½†è¿™æ˜¯ä¸ªæ¯”è¾ƒå¤æ‚çš„è¿‡ç¨‹ï¼Œä½†å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æŸ¥çœ‹æºç æ—¶åªå…³æ³¨è·Ÿ context ç›¸å…³çš„ä»£ç ï¼Œå¿½ç•¥å…¶ä»–ä»£ç ï¼Œé¿å…åœ¨å…¶ä¸­æµªè´¹å¤ªå¤šæ—¶é—´å’Œæ¶ˆè€—æ— è°“çš„ç²¾åŠ›</p><p>é¦–å…ˆçœ‹ä¸€ä¸‹ <code>getApplicationContext()</code> æ–¹æ³•çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°</p><p><code>ContextWrapper.java</code> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Context getApplicationContext() &#123;</span><br><span class="line">    return mBase.getApplicationContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¸ªï¼Œçœ‹ä¸€ä¸‹ <code>mBase.getApplicationContext()</code> è¿”å›çš„æ˜¯ä»€ä¹ˆ</p><p>åœ¨ <code>Context.java</code> ä¸­å¯è§ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡(<code>abstract</code>)ç±»ï¼Œå…¶ <code>Context getApplicaitonContext()</code> æ˜¯ä¸ªæŠ½è±¡(<code>abstract</code>)æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Return the context of the single, global Application object of the</span><br><span class="line"> * current process.  This generally should only be used if you need a</span><br><span class="line"> * Context whose lifecycle is separate from the current context, that is</span><br><span class="line"> * tied to the lifetime of the process rather than the current component.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;Consider for example how this interacts with</span><br><span class="line"> * &#123;@link #registerReceiver(BroadcastReceiver, IntentFilter)&#125;:</span><br><span class="line"> * &lt;ul&gt;</span><br><span class="line"> * &lt;li&gt; &lt;p&gt;If used from an Activity context, the receiver is being registered</span><br><span class="line"> * within that activity.  This means that you are expected to unregister</span><br><span class="line"> * before the activity is done being destroyed; in fact if you do not do</span><br><span class="line"> * so, the framework will clean up your leaked registration as it removes</span><br><span class="line"> * the activity and log an error.  Thus, if you use the Activity context</span><br><span class="line"> * to register a receiver that is static (global to the process, not</span><br><span class="line"> * associated with an Activity instance) then that registration will be</span><br><span class="line"> * removed on you at whatever point the activity you used is destroyed.</span><br><span class="line"> * &lt;li&gt; &lt;p&gt;If used from the Context returned here, the receiver is being</span><br><span class="line"> * registered with the global state associated with your application.  Thus</span><br><span class="line"> * it will never be unregistered for you.  This is necessary if the receiver</span><br><span class="line"> * is associated with static data, not a particular component.  However</span><br><span class="line"> * using the ApplicationContext elsewhere can easily lead to serious leaks</span><br><span class="line"> * if you forget to unregister, unbind, etc.</span><br><span class="line"> * &lt;/ul&gt;</span><br><span class="line"> */</span><br><span class="line">public abstract Context getApplicationContext();</span><br></pre></td></tr></table></figure><blockquote><p>ç®€å•è§£é‡Šä¸€ä¸‹è¿™æ®µæ³¨é‡Š</p><p>è¿”å›å½“å‰è¿›ç¨‹çš„å…¨å±€å”¯ä¸€çš„ Application å•ä¾‹å¯¹è±¡</p><p>é€šå¸¸æ¥è¯´ï¼Œä»…å½“éœ€è¦ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå’Œå½“å‰ä¸Šä¸‹æ–‡åˆ†å¼€çš„ Context æ—¶æ‰ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œè¯¥ Context çš„ç”Ÿå‘½å‘¨æœŸå’Œè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³ï¼Œè€Œå’Œå½“å‰çš„ç»„ä»¶æ— å…³</p><p>æ€è€ƒä¸€ä¸‹ä¾‹å¦‚å¦‚ä½•ä¸ registerReceiver(BroadcastReceiver, IntentFilter) äº¤äº’</p><p>å¦‚æœä½¿ç”¨ä¸€ä¸ª Activity Context ï¼Œæ¥æ”¶å™¨ä¼šåœ¨ Activity å†…è¢«æ³¨å†Œï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦åœ¨ Activity é”€æ¯ä¹‹å‰å–æ¶ˆæ³¨å†Œï¼Œå¦åˆ™ framework ä¼šåœ¨ activity ç§»é™¤æ—¶æ¸…ç†æ‰ä½ æ³„æ¼çš„æ³¨å†Œå¹¶è®°å½•ä¸‹é”™è¯¯ã€‚å› æ­¤ï¼Œå¦‚æœä½ ä½¿ç”¨ Activity Context æ³¨å†Œä¸€ä¸ªé™æ€çš„æ¥æ”¶å™¨ï¼ˆè¿›ç¨‹å†…å…¨å±€çš„ï¼Œä¸è¯¥ Activity å®ä¾‹æ— å…³ï¼‰ é‚£ä¹ˆæ— è®ºä½ ä½¿ç”¨çš„ Activity ä»€ä¹ˆæ—¶å€™è¢«é”€æ¯ï¼Œè¿™ä¸ªæ³¨å†Œéƒ½ä¼šè¢«ç§»é™¤</p><p>å¦‚æœä½¿ç”¨è¿™é‡Œè¿”å›çš„ Context ï¼Œåˆ™ä¼šå‘ä½ çš„åº”ç”¨ç¨‹åºç›¸å…³çš„å…¨å±€çŠ¶æ€æ³¨å†Œæ¥æ”¶å™¨ï¼Œå› æ­¤ä»–æ°¸è¿œä¸ä¼šä¸ºä½ æ³¨é”€ã€‚æ¥æ”¶å™¨ä¸é™æ€æ•°æ®è€Œä¸æ˜¯ç‰¹å®šçš„ç»„ä»¶ç›¸å…³è”ï¼Œè¿™æ˜¯æœ‰å¿…è¦çš„ã€‚</p><p>ä½†æ˜¯å¦‚æœä½ å¿˜è®°æ³¨é”€ï¼Œå–æ¶ˆç»‘å®šç­‰ï¼Œåˆ™åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ Application Context å¯èƒ½å®¹æ˜“å¯¼è‡´ä¸¥é‡çš„æ³„æ¼</p></blockquote><p>é‚£æˆ‘ä»¬å°±æ¥ç€çœ‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œæ­£æ˜¯åœ¨ <code>ContextWrapper.java</code> ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>ContextWrapper</code> ç»§æ‰¿è‡ª <code>Context</code>ï¼Œå¹¶å®ç°äº†è¯¥æ–¹æ³•</p><p>é‚£æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ª <code>mBase</code> æ˜¯ä»€ä¹ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Context mBase;</span><br><span class="line">public ContextWrapper(Context base)&#123;</span><br><span class="line">    mBase = base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected void attachBaseContext(Context base)&#123;</span><br><span class="line">    if(mBase == null)&#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Base context already set&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    mBase = base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆä¸ç®¡ mBase æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¢«èµ‹å€¼çš„ï¼Œå…ˆå»çœ‹ mBase çš„ getApplicationContext() æ–¹æ³•åˆ°åº•åšäº†äº›ä»€ä¹ˆã€‚<br>ç”±æ–­ç‚¹å¤„çš„ä¿¡æ¯å¯è§ï¼ŒmBase å³ <code>ContextImpl</code> çš„å®ä¾‹ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“ Context åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œå³ <code>ContextImpl</code>ï¼Œæ‰¾åˆ° <code>ContextImpl.java</code> ç±»ã€‚æ‰¾åˆ° <code>getApplicaitonContext()</code> æ–¹æ³•çš„å®ç°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Context <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mPackageInfo != <span class="keyword">null</span>) ?</span><br><span class="line">            mPackageInfo.getApplication() : mMainThread.getApplication();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±çŸ¥é“ <code>getApplicaitonContext()</code> æ–¹æ³•è¿”å›çš„è¦ä¹ˆæ˜¯<code>mPackageInfo.getApplication()</code> è¦ä¹ˆæ˜¯ <code>mMainThread.getApplication()</code></p><p>é‚£ä¹ˆåœ¨ <code>attachBaseContext()</code> æ–¹æ³•æ—¶å€™è°ƒç”¨ <code>getApplicaitonContext()</code> æ–¹æ³•åˆ°åº•æ˜¯è¿”å›å“ªä¸ªå‘¢ï¼Œè¿™å–å†³äº <code>mPackageInfo</code> æ˜¯å¦ä¸ºç©ºã€‚</p><p>é‚£ç»§ç»­çœ‹ <code>mPackageInfo</code> æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¢«èµ‹å€¼çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ContextImpl</span><span class="params">(<span class="meta">@Nullable</span> ContextImpl container, <span class="meta">@NonNull</span> ActivityThread mainThread,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> LoadedApk packageInfo, <span class="meta">@Nullable</span> String splitName,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Nullable</span> IBinder activityToken, <span class="meta">@Nullable</span> UserHandle user, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Nullable</span> ClassLoader classLoader, <span class="meta">@Nullable</span> String overrideOpPackageName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å¿½ç•¥å¯¹æˆ‘ä»¬æ¥è¯´æš‚æ—¶ä¸é‡è¦çš„å…¶ä»–ä»£ç </span></span><br><span class="line">        ...</span><br><span class="line">        mPackageInfo = packageInfo;</span><br><span class="line">        <span class="comment">//å¿½ç•¥å¯¹æˆ‘ä»¬æ¥è¯´æš‚æ—¶ä¸é‡è¦çš„å…¶ä»–ä»£ç </span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å³ <code>mPackageInfo</code> æ˜¯åœ¨ ContextImpl çš„æ„é€ æ–¹æ³•ä¸­èµ‹å€¼çš„ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´éç‰¹æ®Šæƒ…å†µä¸‹ï¼Œ<code>mPackageInfo</code> æ˜¯ä¸ä¼šä¸º <code>null</code> çš„ã€‚</p><p>é‚£æˆ‘ä»¬æ¥ç€çœ‹ <code>mPackageInfo.getApplication()</code> çš„è¿”å›å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#LoadedApk.java</span><br><span class="line"><span class="keyword">private</span> Application mApplication;</span><br><span class="line"></span><br><span class="line"><span class="function">Application <span class="title">getApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mApplication;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ <code>LoadedApk</code> å®ä¾‹ä¸­çš„ä¸€ä¸ªç§æœ‰å˜é‡ï¼Œç»§ç»­çœ‹æ˜¯ä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,</span></span></span><br><span class="line"><span class="params"><span class="function">            Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mApplication;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;makeApplication&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        String appClass = mApplicationInfo.className;</span><br><span class="line">        <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            appClass = <span class="string">&quot;android.app.Application&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (!mPackageName.equals(<span class="string">&quot;android&quot;</span>)) &#123;</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,</span><br><span class="line">                        <span class="string">&quot;initializeJavaContextClassLoader&quot;</span>);</span><br><span class="line">                initializeJavaContextClassLoader();</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line">            ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//â‘ </span></span><br><span class="line">            app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                    cl, appClass, appContext);</span><br><span class="line">            appContext.setOuterContext(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Unable to instantiate application &quot;</span> + appClass</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mActivityThread.mAllApplications.add(app);</span><br><span class="line">        <span class="comment">//â‘¡</span></span><br><span class="line">        mApplication = app;</span><br><span class="line">        <span class="comment">//å¿½ç•¥æš‚æ—¶ä¸å…³å¿ƒçš„ä»£ç </span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â‘ </span><br><span class="line">app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext);</span><br></pre></td></tr></table></figure><p>è·Ÿè¸ªä¸€ä¸‹ <code>newApplication()</code> è¿™ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(ClassLoader cl, String className, Context context)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    Application app = getFactory(context.getPackageName())</span><br><span class="line">            .instantiateApplication(cl, className);</span><br><span class="line">    app.attach(context);</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œåœ¨è¿™é‡Œè°ƒç”¨äº† Application çš„ <code>attach(Context context)</code> æ–¹æ³•</p><p>è€Œ  <code>Application</code> è¿™ä¸ªç±»ä¸­çš„ <code>attach</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>attachBaseContext(Context context)</code> æ–¹æ³•ï¼Œè€Œè¿™ä¸ªï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨è‡ªå®šä¹‰çš„ <code>XXApplication</code> ä¸­ Override çš„ <code>attachBaseContext(Context context)</code> ï¼Œè€Œæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“æ­¤æ—¶è¿˜æœªç»™ â‘¡<code>mApplication</code> èµ‹å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ <code>attachBaseContext(Context context)</code> æ–¹æ³•ä¸­è°ƒç”¨ <code>getApplicaitonContext()</code> å°±ä¸º null</p><p>åˆ°æ­¤ï¼ŒçœŸç›¸å¤§ç™½</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;ä¹‹å‰åœ¨é¡¹ç›®çš„å¼€å‘ä¸­ï¼ŒåŒäº‹é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;åœ¨æŸä¸ªç‰ˆæœ¬åäº¤ç»™å¸‚åœºéƒ¨é—¨åŒäº‹çš„ apk æ–‡ä»¶ï¼Œå¸‚åœºçš„åŒäº‹åé¦ˆï¼Œçº¿ä¸Šçš„ç”¨æˆ·æ–°è£…åçš„ä¸ŠæŠ¥çš„æ¸ é“å…¨æ˜¯å®˜æ–¹æ¸ é“&lt;/p&gt;
&lt;p&gt;PS. é¡¹ç›®ä¸­ä½¿ç”¨ç¾å›¢çš„ &lt;a href=&quot;https://github.com/Meituan-Dianping/walle&quot;&gt;Walle&lt;/a&gt; è¿›è¡Œå¤šæ¸ é“æ‰“åŒ…&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    <category term="è®°å½•" scheme="https://ppting.me/categories/%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="HTTP" scheme="https://ppting.me/tags/HTTP/"/>
    
    <category term="FixBug" scheme="https://ppting.me/tags/FixBug/"/>
    
    <category term="WebView" scheme="https://ppting.me/tags/WebView/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Lint è¿›è¡Œä»£ç æ£€æŸ¥</title>
    <link href="https://ppting.me/2019/10/25/2019_10_26_lint_check_code/"/>
    <id>https://ppting.me/2019/10/25/2019_10_26_lint_check_code/</id>
    <published>2019-10-25T12:37:24.000Z</published>
    <updated>2022-02-12T08:13:01.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä½¿ç”¨-Lint-è¿›è¡Œä»£ç æ£€æŸ¥"><a href="#ä½¿ç”¨-Lint-è¿›è¡Œä»£ç æ£€æŸ¥" class="headerlink" title="ä½¿ç”¨ Lint è¿›è¡Œä»£ç æ£€æŸ¥"></a>ä½¿ç”¨ Lint è¿›è¡Œä»£ç æ£€æŸ¥</h1><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä¸ºäº†è¿›ä¸€æ­¥è§„èŒƒååŒåˆä½œä¸­çš„ä»£ç è§„èŒƒï¼Œé¿å…å†™ä½çº§ Bug å’Œå¯¹ä»£ç è¿›è¡Œè§„çº¦ï¼Œåœ¨è°ƒç ”äº†å¤šç§æ–¹æ¡ˆåï¼Œå†³å®šä½¿ç”¨è¯¥ç§æ–¹æ¡ˆå¯¹ä»£ç è¿›è¡Œè‡ªåŠ¨åŒ–æ£€æŸ¥å’Œè§„çº¦</p><span id="more"></span><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>Github å¼€æºåœ°å€ï¼š<a href="https://github.com/PPTing/AwesomeLint">https://github.com/PPTing/AwesomeLint</a></p><ol><li>å…ˆåœ¨é…ç½®æ–‡ä»¶(<code>local.properties</code>)ä¸­é…ç½® <code>nexusUrl</code> çš„å€¼ä¸ºæœ¬åœ°ä»“åº“çš„åœ°å€</li><li>å¤åˆ¶ git hook è„šæœ¬<br></li></ol><p>2.1 åœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œæ‰§è¡Œ<br>Windows:</p><p>  2.1.1 ä¿®æ”¹ <code>pre-commit-windows</code> æ–‡ä»¶ä¸­çš„ç¬¬ä¸€è¡Œä»£ç ä¸­çš„<code>D:/Git</code>ä¸ºè‡ªå·±æœ¬æœºç”µè„‘çš„ <code>Git</code> å®‰è£…ç›®å½•ï¼Œå³ç¬¬ä¸€è¡Œä»£ç ä¸ºå£°æ˜ <code>sh.exe</code> çš„ç›®å½•<br>  2.1.2 æ‰§è¡Œ <code>gradle installGitHooks</code></p><p>Mac OS&#x2F;Linux:  <code>./gradlew installGitHooks</code><br></p><p>æˆ–è€…åœ¨ <code>Android Studio</code> ä¸­å³è¾¹é¢æ¿ä¸Šæ‰¾åˆ° <code>root-Tasks-other-installGitHooks</code> å¹¶åŒå‡»æ‰§è¡Œ</p><p>2.2 èµ‹äºˆæ‰§è¡Œè„šæœ¬å¯æ‰§è¡Œæƒé™ <code>chmod +x .git/hooks/pre-commit</code><br></p><h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><p>ä½¿ç”¨<strong>gitæäº¤å¢é‡æ£€æŸ¥</strong>æ—¶éœ€è¦é…ç½®ANDROID_HOMEç¯å¢ƒå˜é‡(éœ€è¦ä»¥ANDROID_HOMEå‘½åå¹¶åŠ å…¥åˆ°pathä¸­ï¼Œå› ä¸ºåœ¨Lintæ¡†æ¶ä¸­æ‰§è¡ŒLintæ£€æŸ¥æ—¶éœ€è¦è·å–Androidç¯å¢ƒå˜é‡)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Windowsç¯å¢ƒï¼šåœ¨ç”µè„‘-&gt;å±æ€§-&gt;ç¯å¢ƒå˜é‡ä¸­ç¼–è¾‘å³å¯</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Mac OS/Linuxç¯å¢ƒï¼šç¼–è¾‘ ~/.bashrcå³å¯</span><br><span class="line">vi ~./bashrc</span><br><span class="line"><span class="built_in">export</span> ANDROID_HOME=<span class="variable">$HOME</span>/&#123;Android SDK è·¯å¾„&#125;</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ANDROID_HOME</span>/tools</span><br></pre></td></tr></table></figure><h3 id="å®æ—¶æç¤º"><a href="#å®æ—¶æç¤º" class="headerlink" title="å®æ—¶æç¤º"></a>å®æ—¶æç¤º</h3><blockquote><p>åœ¨ Android Studio ä¸­è¿›è¡Œå®æ—¶æç¤º</p></blockquote><h4 id="è¿›è¡Œé…ç½®"><a href="#è¿›è¡Œé…ç½®" class="headerlink" title="è¿›è¡Œé…ç½®"></a>è¿›è¡Œé…ç½®</h4><p><strong>æ–¹æ³•ä¸€</strong></p><ul><li>å°†è‡ªå®šä¹‰ Lint è§„åˆ™çš„ aar åŒ…æ”¾å…¥é¡¹ç›®ä¸­ï¼Œä¾‹å¦‚ <code>$&#123;root&#125;/libs</code> ç›®å½•â‘ </li><li>åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹çš„ <code>build.gradle</code> æ–‡ä»¶å†…çš„ <code>repositories</code> block ä¸­ä¸ºæ‰€æœ‰çš„ module æ·»åŠ  aar çš„è·¯å¾„(ä¸»è¦æ˜¯ä¾¿äºç®¡ç†ï¼Œä¸éœ€è¦æ‰€æœ‰ module çš„ build.gradle æ–‡ä»¶éƒ½å†™ä¸€é aar è·¯å¾„)</li></ul><p>eg</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">allprojects&#123;</span><br><span class="line">    repositories&#123;</span><br><span class="line">        flatDir&#123;</span><br><span class="line">            dirs &quot;../$&#123;root&#125;/libs&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨æ¯ä¸ª module ä¸­çš„ <code>dependencies</code> ä¸­åŠ å…¥ <code>implementation (name:&#39;AARçš„åå­—&#39;, ext:&#39;aar&#39;)</code> å³å¯</li></ul><p><strong>æ–¹æ³•äºŒ</strong></p><p>å°† <code>lintRules</code> å‘å¸ƒåˆ°ä»“åº“ä¸­ï¼Œå†é€šè¿‡è¿œç¨‹ä¾èµ–åœ¨æ¯ä¸ª module ä¸­è¿›è¡Œä¾èµ–<br>å³ <code>implementation &#39;me.ppting.plugin:lintPreview:1.0.0.beta&#39;</code></p><h5 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h5><blockquote><p>ç›®å‰åªè‡ªå®šä¹‰äº†å‡ ä¸ªè§„åˆ™ï¼Œä¾‹å¦‚</p></blockquote><ul><li>ç±»åå’Œæ–¹æ³•åçš„å‘½åéœ€è¦ç¬¦åˆé©¼å³°å‘½åæ³•</li></ul><p>æ•ˆæœå¦‚ä¸‹ <img src="https://raw.githubusercontent.com/PPTing/AwesomeLint/master/images/Xnip2019-09-16_16-00-10.png" alt="Lint æ£€æµ‹åçš„å±•ç¤ºæ•ˆæœ"></p><p>åœ¨ IDE ä¸­ä¼šæ ¹æ®é”™è¯¯çº§åˆ«è¿›è¡Œç›¸åº”çš„æç¤ºï¼Œåœ¨ <code>Darcula</code> ä¸»é¢˜ä¸‹é»˜è®¤ä¼šä»¥é»„è‰²çš„å‰æ™¯è‰²è¿›è¡Œæç¤ºï¼Œå°†é¼ æ ‡ç§»è‡³è¯¥ä»£ç å—åˆ™ä¼šæœ‰æµ®çª—æç¤ºé—®é¢˜</p><h4 id="å»é™¤æç¤º-SuppressLint"><a href="#å»é™¤æç¤º-SuppressLint" class="headerlink" title="å»é™¤æç¤º(SuppressLint)"></a>å»é™¤æç¤º(SuppressLint)</h4><p>å‡å¦‚æŸä¸ª Lint è§„åˆ™æç¤ºä»£ç æœ‰è¯¯ï¼Œä½†å®é™…ä¸Šæ˜¯å› ä¸ºè‡ªå®šä¹‰è§„åˆ™çš„æ£€æµ‹æœ‰è¯¯å¯¼è‡´è¯¯æŠ¥ï¼Œæˆ–è€…ä»£ç å¹¶æ²¡æœ‰é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>@SuppressLint</code> å¯¹è¯¥ä»£ç æ®µè¿›è¡Œæ³¨è§£ï¼Œæ³¨è§£çš„å‚æ•°å¡«å†™ Lint è§„åˆ™çš„ idï¼Œä¸€èˆ¬ä¼šåœ¨æµ®çª—ä¸­å±•ç¤ºè¯¥è§„åˆ™ idã€‚</p><p>å¦‚æœå®åœ¨ä¸çŸ¥é“è¯¥è§„åˆ™ id ï¼Œå¯ä»¥ä½¿ç”¨ <code>@SuppressLint(&quot;All&quot;)</code> å¿½ç•¥æ‰€æœ‰çš„è§„åˆ™ï¼Œä½†è¿™æ ·å°±ä¼šå¯¼è‡´è¯¥æ–¹æ³•å†…æ–°å¢çš„ä»£ç ä¹Ÿæ— æ³•è¿›è¡Œ Lint è§„åˆ™æ£€æµ‹ï¼Œè¯·<em><strong>è°¨æ…ä½¿ç”¨</strong></em></p><p>è¿™æ ·è¯¥æ–¹æ³•å°±ä¼šå¿½ç•¥è¯¥è§„åˆ™çš„æ£€æµ‹</p><h4 id="è‡ªå®šä¹‰è§„åˆ™"><a href="#è‡ªå®šä¹‰è§„åˆ™" class="headerlink" title="è‡ªå®šä¹‰è§„åˆ™"></a>è‡ªå®šä¹‰è§„åˆ™</h4><h4 id="ç¼–å†™è§„åˆ™"><a href="#ç¼–å†™è§„åˆ™" class="headerlink" title="ç¼–å†™è§„åˆ™"></a>ç¼–å†™è§„åˆ™</h4><p>åœ¨ lintRules module ä¸­ç¼–å†™è§„åˆ™</p><ul><li>åˆ›å»ºä¸€ä¸ª<code>ç»§æ‰¿ Detector çš„ç±»</code></li><li>ç±»ä¸­åˆ›å»ºä¸€ä¸ª ISSUE è¡¨ç¤ºè¯¥ç±»ç”¨æ¥æ£€æµ‹çš„é—®é¢˜</li><li>åœ¨ Register ç±»ä¸­å¯¹è¯¥ issue è¿›è¡Œæ³¨å†Œ</li></ul><blockquote><p>å…·ä½“å‚è€ƒç°æœ‰çš„ä»£ç </p></blockquote><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><ul><li>æ‰§è¡Œ lintAAR<code>ä¸­çš„</code>copyAAR&#96; çš„ task å³å¯ç¼–è¯‘å‡º aar æ–‡ä»¶å¹¶å¤åˆ¶åˆ° app module ä¸­ï¼Œ</li><li>Sync Project With Gradle Files (ç‚¹å‡» Gradle çš„åŒæ­¥æŒ‰é’®)</li></ul><p>å³å¯åœ¨ app module ä¸­æµ‹è¯•å„ä¸ªè§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ</p><h4 id="å‘å¸ƒ"><a href="#å‘å¸ƒ" class="headerlink" title="å‘å¸ƒ"></a>å‘å¸ƒ</h4><p>æµ‹è¯•å®Œæ¯•ï¼Œå°† aar æ–‡ä»¶å¤åˆ¶åˆ°å…¶ä»–åº”ç”¨åˆ°å®ƒçš„åœ°æ–¹å³å¯ï¼Œå¹¶åŒæ­¥å³å¯ç”Ÿæ•ˆ</p><blockquote><p>PS. å¦‚æœä¸ç”Ÿæ•ˆï¼Œå°è¯•é‡å¯ Android Studio </p></blockquote><h3 id="COMMIT-HOOKS"><a href="#COMMIT-HOOKS" class="headerlink" title="COMMIT HOOKS"></a>COMMIT HOOKS</h3><blockquote><p>ä¸ºäº†å¼ºåˆ¶è¿›è¡Œä¸€äº›ç¼–ç è§„èŒƒç­‰çš„æ‰§è¡Œï¼Œä¼šåœ¨ git hooks åœ¨è¿›è¡Œ commit ååšæ£€æŸ¥ï¼Œå¦‚æœæ£€æµ‹ä¸é€šè¿‡ï¼Œåˆ™ä¼šè§¦å‘ git reset è¿›è¡Œå›æ»šæ­¤æ¬¡æäº¤ï¼Œå¹¶å°†é”™è¯¯æç¤ºæ—¥å¿—æ‰“å°åˆ° <code>lint-check-result.log</code> æ–‡ä»¶ä¸­</p></blockquote><h4 id="å¤§æ¦‚åŸç†"><a href="#å¤§æ¦‚åŸç†" class="headerlink" title="å¤§æ¦‚åŸç†"></a>å¤§æ¦‚åŸç†</h4><p>i. åœ¨é¡¹ç›®ä¸­åº”ç”¨ gradle pluginï¼Œåœ¨æ¯æ¬¡ git commit åï¼Œåœ¨ <code>.git/hooks</code> ä¸­çš„ <code>pre-commit</code> hook ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä¼šåˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ <code>./gradlew lintCheck -PisLintCheck</code></p><p>ii. lintCheck ä¼šé€šè¿‡ <code>git diff</code> è·å–æš‚å­˜åŒºä¸­çš„ä»£ç ä¿®æ”¹ï¼Œå¹¶è®°å½•å…¶è¡Œæ•°å’Œæ–‡ä»¶å</p><p>iii. å°†æ‰€æœ‰çš„æ”¹åŠ¨çš„æ–‡ä»¶è¿›è¡Œ lint æ“ä½œï¼Œå¹¶è®°å½•å…¶ issueï¼Œå¦‚æœæŸä¸ª issue å¯¹åº”çš„ä»£ç è¡Œæ­£å¥½æ˜¯æ”¹åŠ¨çš„ä»£ç è¡Œï¼Œåˆ™å°†è®°å½•æ•°(è®°ä¸º K)åŠ ä¸€</p><p>iiii. å½“ç»“æŸ lintCheck åï¼Œå¦‚æœ K &gt; 0 ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œä½¿æœ¬æ¬¡æäº¤å¤±è´¥</p><p>PS. å¦‚æœè¯¥ <code>Issue</code> æ˜¯ <code>Warning</code> çº§åˆ«çš„ï¼ŒAndroid Studio ä¸ä¼šè¿›è¡Œæç¤ºï¼Œå¦‚æœè¯¥ <code>Issue</code> æ˜¯ <code>Error</code> çº§åˆ«çš„ï¼ŒAndroid Studio ä¼šæœ‰é”™è¯¯æç¤ºå¼¹çª—</p><h4 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h4><ol><li><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ <code>build.gradle</code> ä¸­åº”ç”¨æ’ä»¶ </p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin:&quot;me.ppting.plugin.lint&quot;</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½® lintCheck é…ç½®</p><p> åœ¨ æ ¹ç›®å½•ä¸‹çš„ <code>build.gradle</code> ä¸­æ·»åŠ  lintCheck é…ç½®</p><p> eg.</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lintConfig &#123;</span><br><span class="line">    //é…ç½®Lintæ£€æŸ¥æ–‡ä»¶çš„ç±»å‹</span><br><span class="line">    lintCheckFileType = &quot;.java,.xml,.kt&quot;</span><br><span class="line">    //æ˜¯å¦å°†æ£€æŸ¥æ–‡ä»¶çš„æ‰€æœ‰æ‰«æç»“æœéƒ½è¾“å‡º</span><br><span class="line">    lintReportAll = true</span><br><span class="line">    //æ˜¯å¦è¿›è¡Œ lint æ£€æŸ¥ï¼Œé»˜è®¤ä¸º true</span><br><span class="line">    isOpenLint = false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¤åˆ¶ <code>pre-commit</code> è„šæœ¬åˆ°æœ¬åœ°çš„ <code>.git/hooks</code> ç›®å½•ä¸‹</p><p> åœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œæ‰§è¡Œ  </p><blockquote><p>Mac&#x2F;Linux: <code>./gradlew installGitHooks</code><br><br>Windows: <code>gradle installGitHooks</code></p></blockquote><p> æˆ–è€…åœ¨ <code>Android Studio</code> ä¸­å³è¾¹é¢æ¿ä¸Šæ‰¾åˆ° <code>root-Tasks-other-installGitHooks</code> å¹¶åŒå‡»æ‰§è¡Œ</p></li></ol><p>PS. å¦‚æœæ— æ³•æ‰§è¡Œ <code>pre-commit</code> è„šæœ¬ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜ï¼Œç»™è¯¥è„šæœ¬åŠ ä¸Šå¯æ‰§è¡Œæƒé™</p><p><code>chmod +x .git/hooks/pre-commit</code></p><p>PSS. <strong>å¼ºåˆ¶å…³é—­ hook æ“ä½œ</strong></p><ul><li>å¦‚æœè¦å¼ºåˆ¶å…³é—­åœ¨ commit ä¹‹åçš„ hook æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ <code>deleteGitHooks</code> task å°† <code>.git/hooks/pre-commit</code> æ–‡ä»¶åˆ é™¤</li><li>æˆ–è€…åœ¨ commit æ—¶å€™åŠ ä¸Š <code> --no-verify</code> å‚æ•°</li></ul><h3 id="é‡åˆ°çš„ä¸€äº›å‘å’Œè§£å†³æ–¹æ¡ˆ"><a href="#é‡åˆ°çš„ä¸€äº›å‘å’Œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="é‡åˆ°çš„ä¸€äº›å‘å’Œè§£å†³æ–¹æ¡ˆ"></a>é‡åˆ°çš„ä¸€äº›å‘å’Œè§£å†³æ–¹æ¡ˆ</h3><p><em><strong>å‘ 1ï¼š</strong></em> ç”±äº lint çš„ api ä¾èµ–äº kotlin-compiler ï¼Œè€Œè¿™ä¼šé€ æˆ Android Studio çš„ Kotlin-Plugin å†²çªï¼Œè€Œå¯¼è‡´æ— æ³•ç¼–è¯‘</p><p><strong>é”™è¯¯æç¤ºï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FAILURE: Build failed with an exception.</span><br><span class="line"></span><br><span class="line">* What went wrong:</span><br><span class="line">org.jetbrains.kotlin.cli.common.arguments.K2JVMCompilerArguments.setAllowNoSourceFiles(Z)V</span><br><span class="line"></span><br><span class="line">* Try:</span><br><span class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.</span><br><span class="line"></span><br><span class="line">* Get more help at https://help.gradle.org</span><br><span class="line"></span><br><span class="line">Deprecated Gradle features were used in this build, making it incompatible with Gradle 6.0.</span><br><span class="line">Use &#x27;--warning-mode all&#x27; to show the individual deprecation warnings.</span><br><span class="line">See https://docs.gradle.org/5.4.1/userguide/command_line_interface.html#sec:command_line_warnings</span><br><span class="line"></span><br><span class="line">BUILD FAILED in 20s</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p><p>åœ¨ buildSrc&#x2F;build.gradle æ–‡ä»¶ä¸­æ§åˆ¶ lint api çš„ä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configurations &#123;</span><br><span class="line">    all*.exclude group: &#x27;com.android.tools.external.com-intellij&#x27;,module:&quot;kotlin-compiler&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯ä»¥ç¼–è¯‘ï¼Œä½†ä¼šå¯¼è‡´ lintCheck task å¤±è´¥<br>äºæ˜¯æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå˜é‡ <code>isLintCheck</code> æ¥æ§åˆ¶ lint api æ˜¯å¦è¦ exclude æ‰ kotlin-compiler çš„ä¾èµ–</p><p>å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* lintCheck éœ€è¦æœ‰ kotlin-compiler</span><br><span class="line">* run ä¸éœ€è¦ kotlin-compiler</span><br><span class="line">*/</span><br><span class="line">configurations &#123;</span><br><span class="line">    boolean isLintCheck = project.hasProperty(&quot;isLintCheck&quot;)</span><br><span class="line">    if (!isLintCheck) &#123;</span><br><span class="line">        all*.exclude group: &#x27;com.android.tools.external.com-intellij&#x27;,module:&quot;kotlin-compiler&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¦æ±‚æˆ‘ä»¬åœ¨æ‰§è¡Œ lintCheck ä»»åŠ¡æ—¶åŠ ä¸Šå‚æ•° -PisLintCheck </p><p><em><strong>å‘ 2ï¼š</strong></em> å°† plugin å‘å¸ƒåˆ°ä»“åº“ä¸­ä½œä¸ºæ’ä»¶ä½¿ç”¨</p><blockquote><p>å½“å°è¯•å°† plugin å‘å¸ƒåˆ°ä»“åº“ä¸­ï¼Œå¹¶åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ classpath è¿›è¡Œä¾èµ–è¯¥æ’ä»¶ï¼Œä¼šå¯¼è‡´æ— æ³•ç¼–è¯‘</p></blockquote><p><strong>é”™è¯¯æç¤ºï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.jetbrains.kotlin.resolve.diagnostics.DiagnosticSuppressor$Companion.getEP_NAME()Lcom/intellij/openapi/extensions/ExtensionPointName;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><p>åªèƒ½å°†æ’ä»¶é¡¹ç›®é€šè¿‡ buildSrc module çš„æ–¹å¼å¼•å…¥åˆ°éœ€è¦ä½¿ç”¨ lint çš„é¡¹ç›®ä¸­</p><p><em><strong>å‘ 3ï¼š</strong></em> walle æŠ¥é”™</p><blockquote><p>ç”±äºå‡çº§äº† Gradle çš„ç‰ˆæœ¬ï¼Œé¡¹ç›®ä¸­ä¹Ÿä½¿ç”¨äº†ç¾å›¢çš„ walle ä½œä¸ºå¤šæ¸ é“æ‰“åŒ…çš„æ–¹æ¡ˆï¼Œåœ¨ç¼–è¯‘é˜¶æ®µä¼šæŠ¥é”™</p></blockquote><p><strong>é”™è¯¯æç¤ºï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">API &#x27;variantOutput.getPackageApplication()&#x27; is obsolete and has been replaced with &#x27;variant.getPackageApplicationProvider()&#x27;. It will be removed at the end of 2019.</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><p>walle å·²ç»ä¿®å¤äº†è¯¥<a href="https://github.com/Meituan-Dianping/walle/pull/285">é—®é¢˜</a>ï¼Œè¯¦æƒ…è¯·æŸ¥é˜… <a href="https://github.com/Meituan-Dianping/walle/commit/c3869bbce43254c2fd44d67edf81fc9ea925b037">fixAPI â€˜variant.getAssemble()â€™ is obsolete and has been replaced withâ€¦</a><br><br>ä½† walle å¹¶æœªå°†ä¿®å¤çš„ç‰ˆæœ¬å‘å¸ƒ(æ‘Šæ‰‹)ï¼Œå¯ä»¥è‡ªè¡Œä¸‹è½½<a href="https://github.com/Meituan-Dianping/walle">æºç </a>ç¼–è¯‘åˆ°è‡ªå·±çš„ä»“åº“ä¸­å¼•ç”¨</p><h2 id="å¦‚ä½•ç”Ÿäº§è¿›è¡Œå®æ—¶-lintRules-çš„-aar"><a href="#å¦‚ä½•ç”Ÿäº§è¿›è¡Œå®æ—¶-lintRules-çš„-aar" class="headerlink" title="å¦‚ä½•ç”Ÿäº§è¿›è¡Œå®æ—¶ lintRules çš„ aar"></a>å¦‚ä½•ç”Ÿäº§è¿›è¡Œå®æ—¶ lintRules çš„ aar</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å‘å¸ƒ aarï¼Œç›´æ¥è¿è¡Œ `lintRules-uploadArchives` çš„ task å³å¯å‘å¸ƒåˆ°ä»“åº“ä¸­</span><br></pre></td></tr></table></figure><h3 id="å¤‡æ³¨"><a href="#å¤‡æ³¨" class="headerlink" title="å¤‡æ³¨"></a>å¤‡æ³¨</h3><p>â‘  ${root} å³é¡¹ç›®çš„æ ¹åœ°å€æ–‡ä»¶å¤¹åï¼Œè¯·æŒ‰éœ€ä¿®æ”¹</p><h3 id="æ„Ÿè°¢"><a href="#æ„Ÿè°¢" class="headerlink" title="æ„Ÿè°¢"></a>æ„Ÿè°¢</h3><p>æœ¬æ–‡æ˜¯åœ¨å·¨äººçš„è‚©è†€ä¸Šè¿›è¡Œæ¢ç´¢å¹¶å®è·µçš„ï¼Œæ„Ÿè°¢ <br><br>â‘ <a href="https://github.com/lsc1993">lsc1993</a> çš„<a href="https://github.com/lsc1993/AwesomeLint">AwesomeLint</a> <br><br>â‘¡<a href="https://juejin.im/user/5995c9f2f265da248c3934a5">GitCode8</a> çš„ <a href="https://juejin.im/post/5d307615f265da1b6b1d0dd9">ä»£ç æ´ç™–ç—‡çš„æˆ‘ï¼Œå­¦ä¹ Lintå­¦åˆ°å¿ƒæ€çˆ†ç‚¸</a><br><br>æœ¬å®è·µä¹Ÿæ˜¯åœ¨è¯¥åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›å¹¶åº”ç”¨åˆ°é¡¹ç›®ä¸­çš„ï¼Œä»£ç ä¹Ÿæ˜¯ fork è‡ªè¯¥é¡¹ç›®ã€‚åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œæ·»åŠ äº†å¯¹ Kotlin çš„æ”¯æŒï¼Œå¹¶åœ¨åº”ç”¨åˆ°é¡¹ç›®ä¸­æ—¶è¸©äº†å¾ˆå¤šå‘ä¹Ÿå°†å…¶å¡«å®Œäº†ã€‚å€Ÿæ­¤ä¹Ÿå°†å¡«å‘ç»éªŒåˆ†äº«å‡ºæ¥ï¼Œä»¥ä¾›å€Ÿé‰´<br></p><p><strong>è¯šæƒ¶è¯šæï¼Œè‹¥æœ‰é”™è¯¯ï¼Œä¸åèµæ•™</strong></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ä½¿ç”¨-Lint-è¿›è¡Œä»£ç æ£€æŸ¥&quot;&gt;&lt;a href=&quot;#ä½¿ç”¨-Lint-è¿›è¡Œä»£ç æ£€æŸ¥&quot; class=&quot;headerlink&quot; title=&quot;ä½¿ç”¨ Lint è¿›è¡Œä»£ç æ£€æŸ¥&quot;&gt;&lt;/a&gt;ä½¿ç”¨ Lint è¿›è¡Œä»£ç æ£€æŸ¥&lt;/h1&gt;&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;ä¸ºäº†è¿›ä¸€æ­¥è§„èŒƒååŒåˆä½œä¸­çš„ä»£ç è§„èŒƒï¼Œé¿å…å†™ä½çº§ Bug å’Œå¯¹ä»£ç è¿›è¡Œè§„çº¦ï¼Œåœ¨è°ƒç ”äº†å¤šç§æ–¹æ¡ˆåï¼Œå†³å®šä½¿ç”¨è¯¥ç§æ–¹æ¡ˆå¯¹ä»£ç è¿›è¡Œè‡ªåŠ¨åŒ–æ£€æŸ¥å’Œè§„çº¦&lt;/p&gt;</summary>
    
    
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
    <category term="Lint" scheme="https://ppting.me/tags/Lint/"/>
    
    <category term="æ•ˆç‡" scheme="https://ppting.me/tags/%E6%95%88%E7%8E%87/"/>
    
  </entry>
  
  <entry>
    <title>è®°å½•ä¸€æ¬¡ Android å†…åµŒ WebView ç™½å±æ— æ³•åŠ è½½å†…å®¹çš„äº‹æ•…</title>
    <link href="https://ppting.me/2019/08/09/record-an-white-screen-accident-for-webview-safe-browse/"/>
    <id>https://ppting.me/2019/08/09/record-an-white-screen-accident-for-webview-safe-browse/</id>
    <published>2019-08-09T01:32:44.000Z</published>
    <updated>2022-02-12T08:20:44.000Z</updated>
    
    <content type="html"><![CDATA[<br><blockquote><p>æ˜¨å¤©ä¸‹åˆï¼Œäº§å“ç»ç†çªç„¶å‘æ¥äº†ä¸€å¼ æˆªå›¾ï¼Œå†…å®¹æ˜¯æˆ‘ä»¬çš„ APP å› ä¸ºè¿åäº† Google Play çš„æŸäº›è§„å®šè¢«ä¸‹æ¶äº†ã€‚</p></blockquote><p>è¿™å½“ç„¶æ˜¯é©¬ä¸Šæ’æŸ¥åŸå› å¹¶ fix ç„¶åæ‰“åŒ…ç»™æµ‹è¯•åŒäº‹é‡æ–°æµ‹è¯•ä¸€éç„¶åå†æå®¡å•¦ã€‚<br>ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œæµ‹è¯•çš„åŒäº‹å‘ç° App å†…çš„æ‰€æœ‰ HTML5 çš„é¡µé¢éƒ½æ— æ³•æ‰“å¼€äº†ï¼Œè€Œä¸»åŒ…(å›½å†…ç‰ˆæœ¬)å´æ˜¯æ­£å¸¸çš„ã€‚</p><p>è¿™æ€ä¹ˆå¯èƒ½ä¼šå‘ç”Ÿå‘¢ï¼Œfix è¢«ä¸‹æ¶çš„é—®é¢˜å¹¶æ²¡æœ‰ä¿®æ”¹åˆ° WebView ä¸šåŠ¡ç›¸å…³çš„ä»£ç ï¼Œè¿™å°±ç™¾æ€ä¸å¾—å…¶è§£äº†ã€‚ç”šè‡³ä¸€åº¦ä»¥ä¸ºæ˜¯å‰ç«¯åŒäº‹åˆšä¸Šçº¿çš„ä»£ç å½±å“åˆ°äº†æµ·å¤–ç‰ˆæœ¬çš„ä¸šåŠ¡æƒ³ç”©é”…ã€‚</p><p>æ‹¿èµ·è‡ªå·±çš„æ‰‹æœºè£…ä¸Š Google Play ç‰ˆæœ¬çš„åŒ…æ‰“å¼€å¯¹åº”çš„é¡µé¢ä¸€çœ‹ï¼ŒåŸºæœ¬ä¸Šæ˜¯ç¬¬ä¸€æ¬¡èƒ½æ­£å¸¸åŠ è½½ï¼Œé€€å‡ºåå†æ¬¡ç‚¹å‡»è¿›å…¥ WebView é¡µé¢å°±æ— æ³•åŠ è½½äº†ã€‚</p><span id="more"></span><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><ol><li><p>å…ˆæŠ“åŒ…çœ‹ HTTP Request æ˜¯å¦æœ‰è¿”å›æ•°æ®ï¼Œç”±äºæ˜¯ HTTPS çš„é¡µé¢ï¼Œå°è¯•ä½¿ç”¨ Charles çš„ Enable SSL Proxy è§£å¼€ SSL åŠ å¯†ï¼Œæ— æ³•è§£å¼€(<strong>è¿™é‡Œä¸ºè‡ªå·±æŒ–äº†ä¸ªå‘</strong>)ï¼ŒæŸ¥çœ‹å…¶ä»– HTTP çš„é¡µé¢ä¹Ÿå‘ç° HTML5 çš„é¡µé¢ URL è¿”å›çš„ Response éƒ½æ˜¯æ­£å¸¸çš„ã€‚</p></li><li><p>å°è¯•å¯¹æ¯”ä¸»åŒ…å’Œæµ·å¤–ç‰ˆçš„ HTML5 é¡µé¢çš„ HTTP Request çš„åŒºåˆ«ï¼Œå‘ç°åªæœ‰ User Agent æœ‰æ‰€åŒºåˆ«ï¼Œè¯•ç€å°†æµ·å¤–ç‰ˆçš„ User Agent ä¿®æ”¹æˆå’Œä¸»åŒ…ä¸€æ ·ï¼Œç»“æœç›¸åŒï¼Œè¿˜æ˜¯æ— æ³•åŠ è½½</p></li><li><p>åªå¥½å°è¯•ç€è°ƒè¯• WebView<br>é¦–å…ˆæ‰“å¼€ WebView çš„ debug æ¨¡å¼</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebView.setWebContentsDebuggingEnabled(true);</span><br></pre></td></tr></table></figure><p>å°†æ‰‹æœºè¿æ¥åˆ°ç”µè„‘ï¼Œæ‰“å¼€ Chromeï¼Œè¾“å…¥ <code>chrome://inspect</code> é€šè¿‡ Chrome DevTools è°ƒè¯•æ‰‹æœºä¸Šçš„ WebView é¡µé¢<br><img src="https://i.loli.net/2020/04/12/aGMBfkn7rITUi1W.jpg" alt="Chrome DevTools"><br>è¿›å…¥ <code>Devices Tab</code>ï¼Œçœ‹åˆ°è‡ªå·±çš„æ‰‹æœºè®¾å¤‡å’Œå½“å‰æ‰“å¼€çš„ HTML5 é¡µé¢ï¼Œç‚¹å‡» <code>inspect</code> æ‰“å¼€ DevTools ï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæç¤ºâ€™å®‰å…¨é”™è¯¯â€™ï¼Œå¹¶ä¸”åœ¨åˆ·æ–°é‡æ–°åŠ è½½çš„æ—¶å€™å‘ç°é¡µé¢å¶å°”ä¼šä¸€é—ªè€Œè¿‡ä¸€ä¸ªçº¢è‰²çš„é¡µé¢ã€‚</p><p>ä¸€å¼€å§‹ä¸ä»¥ä¸ºç„¶ï¼Œä»¥ä¸ºæ˜¯è‡ªå·±ä¸ºäº†è§£å¼€ HTTPS è€Œå¯¼è‡´çš„å°±æ²¡æ”¾åœ¨å¿ƒä¸Šï¼Œè¿™æ—¶å‰ç«¯çš„åŒäº‹è®©æˆ‘ç»™ä»–è£…ä¸ªå¯ä»¥è°ƒè¯•çš„åŒ…ç»™ä»–æ’æŸ¥ä¸€ä¸‹é—®é¢˜ï¼Œæˆ‘æŠŠ apk æ–‡ä»¶ç»™åˆ°ä»–åï¼Œåœ¨ä»–çš„æ‰‹æœºä¸Šæ‰“å¼€ HTML5 çš„é¡µé¢æ˜¯éƒ½æ­£å¸¸å¯ä»¥è®¿é—®çš„ã€‚</p><p>è¿™å°±æ›´è®©äººç™¾æ€ä¸å¾—å…¶è§£äº†ã€‚<br><img src="https://i.loli.net/2020/04/12/yOxHaYCfMDZGLPr.jpg" alt="çº¢å±é¡µé¢"></p><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><p>åæ¥ç»æµ‹è¯•çš„å¦ä¸€ä¸ªåŒäº‹æé†’ï¼Œè¯´ä¼šä¸ä¼šæ˜¯å› ä¸ºä»€ä¹ˆåŸå› å¯¼è‡´è®¿é—®ä¼šæç¤ºä¸å®‰å…¨äº†</p><p>äºæ˜¯ä¹ä¸Šç½‘ Google äº†ä¸€ä¸‹ â€œæ‚¨è¦è®¿é—®çš„ç½‘ç«™åŒ…å«æœ‰å®³åº”ç”¨â€ è¿™ä¸ªå…³é”®å­—æ— æœï¼Œç´§æ¥ç€åœ¨å…¶å‰é¢åŠ ä¸Š WebViewï¼Œæœå‡ºæ¥äº†ä¸€ç¯‡ CSDN ä¸Šçš„ Blogï¼Œç»ˆäºæ‰¾åˆ°äº†é—®é¢˜æ‰€åœ¨ã€‚</p><blockquote><p>è‡ª 2018 å¹´ 4 æœˆèµ·ï¼Œéšç€ WebView 66 å‘å¸ƒï¼ŒGoogle Play ä¿æŠ¤æœºåˆ¶ï¼Œå°†åœ¨ WebView ä¸­é»˜è®¤å¼€å§‹æ­¤å®‰å…¨æµè§ˆç­–ç•¥ã€‚<br>è€Œ Android å¼€å‘è€…åœ¨ä½¿ç”¨ WebView æ—¶ï¼Œæ— éœ€å†è¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå³å¯äº«å—æ­¤é¡¹ä¿æŠ¤æœåŠ¡ã€‚è‡ª Android 8.0 å¼€å§‹ï¼ŒWebView ä¸­å³å·²ç»é›†æˆå®‰å…¨æµè§ˆåŠŸèƒ½ï¼Œå¹¶ä¸”ä¸ Android ç‰ˆçš„ Chrome é‡‡ç”¨ç›¸åŒçš„åº•å±‚æŠ€æœ¯ã€‚<br>ä¸€æ—¦è§¦å‘ WebView çš„å®‰å…¨æœºåˆ¶ï¼Œå°±ä¼šå‡ºç°ç±»ä¼¼è¿™æ ·çš„â€œçº¢å±â€è­¦å‘Šã€‚</p><p>ä½œè€…ï¼šæ‰¿é¦™å¢¨å½±<br>é“¾æ¥ï¼š<a href="https://juejin.im/post/5c8899c56fb9a049b41d5432">https://juejin.im/post/5c8899c56fb9a049b41d5432</a></p><p>æ¥æºï¼šæ˜é‡‘</p></blockquote><p>åŸæ¥åœ¨ Android O ä»¥åï¼ŒWebView çš„å®‰å…¨æµè§ˆç­–ç•¥(Google Safe Browsing) ä¼šåœ¨ WebView ä¸­é»˜è®¤å¼€å¯ï¼ŒGoogle è‡ªå·±ä¼šç»´æŠ¤ä¸€ä»½æ¸…å•åˆ¤æ–­å“ªäº›ç½‘ç«™æ˜¯â€æœ‰å®³çš„â€œæé†’ç”¨æˆ·ï¼Œå¹¶é€šè¿‡ Google Play Service åŒæ­¥åˆ°ç”¨æˆ·è®¾å¤‡ä¸­ï¼Œè€Œæˆ‘ä»¬çš„åŸŸååˆšå¥½è¢« Google è®¤ä¸ºæ˜¯â€æœ‰å®³çš„â€œï¼Œå¯¼è‡´äº†æˆ‘ä»¬çš„ HTML5 ä¸šåŠ¡çš„é¡µé¢æ— æ³•æ‰“å¼€ã€‚</p><p>è€Œè¿™ä¹Ÿæ­£å¥½è§£å†³äº†æˆ‘çš„ç–‘é—®ï¼šä¸ºä»€ä¹ˆå‰ç«¯åŒäº‹çš„æ‰‹æœºå¯ä»¥æ­£å¸¸æ‰“å¼€ï¼Œè€Œæˆ‘å’Œæµ‹è¯•åŒäº‹çš„æ‰‹æœºå´ä¸è¡Œï¼Œå› ä¸ºæˆ‘å’Œæµ‹è¯•åŒäº‹çš„æ‰‹æœºä¸ºäº†æµ‹è¯•æµ·å¤–ç‰ˆçš„æ”¯ä»˜åŠŸèƒ½éƒ½å®‰è£…äº† Google Play Service è€Œå‰ç«¯åŒäº‹çš„æ‰‹æœºæ²¡æœ‰å®‰è£… Google Play Service ã€‚æ‰€ä»¥æ²¡æœ‰åŒæ­¥â€æœ‰å®³ç½‘ç«™â€œ</p><p>çŸ¥é“äº†åŸå› åè§£å†³èµ·æ¥å°±å¾ˆå®¹æ˜“äº†</p><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><h4 id="ç”³è¯‰"><a href="#ç”³è¯‰" class="headerlink" title="ç”³è¯‰"></a>ç”³è¯‰</h4><p><a href="https://support.google.com/chrome/answer/99020">ç®¡ç†æœ‰å…³ä¸å®‰å…¨ç½‘ç«™çš„è­¦å‘Š</a></p><p><a href="https://developers.google.com/web/fundamentals/security/hacked/request_review">è¯·æ±‚å®¡æ ¸çš„åœ°å€</a></p><h4 id="ä»£ç ä¸­å¼ºåˆ¶è®¾ç½®ä¸ä½¿ç”¨ã€å®‰å…¨æµè§ˆç­–ç•¥ã€"><a href="#ä»£ç ä¸­å¼ºåˆ¶è®¾ç½®ä¸ä½¿ç”¨ã€å®‰å…¨æµè§ˆç­–ç•¥ã€" class="headerlink" title="ä»£ç ä¸­å¼ºåˆ¶è®¾ç½®ä¸ä½¿ç”¨ã€å®‰å…¨æµè§ˆç­–ç•¥ã€"></a>ä»£ç ä¸­å¼ºåˆ¶è®¾ç½®ä¸ä½¿ç”¨ã€å®‰å…¨æµè§ˆç­–ç•¥ã€</h4><ul><li><p>Android O ä»¥ä¸Š</p><p>  <code>webviewSetting.setSafeBrowsingEnabled(false)</code></p><p>  ä½†è¿™ä¸ªæ–¹æ³•åªèƒ½ç”¨äº API 26 ä»¥ä¸Šï¼Œå¦‚æœåœ¨ API 26 ä¸€ä¸‹ï¼Œåˆ™éœ€è¦åœ¨ AndroidManifest ä¸­è¿›è¡Œå£°æ˜</p></li><li><p>Android O ä»¥ä¸‹</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;android.webkit.WebView.EnableSafeBrowsing&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">android:value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å¦‚æœè§‰å¾—è¿™æ ·ä¸€åˆ€åˆ‡çš„æ–¹æ¡ˆæœ‰ç‚¹ç®€å•ç²—æš´ï¼ŒWebView-è¿˜æä¾›äº†ä¸€ä¸ªè®¾ç½®ç™½åå•çš„æ–¹æ³•ï¼Œå¯ä»¥å°†ä¸šåŠ¡ä¸Šç”¨åˆ°çš„åŸŸååˆ—å…¥åº”ç”¨çš„ç™½åå•"><a href="#å¦‚æœè§‰å¾—è¿™æ ·ä¸€åˆ€åˆ‡çš„æ–¹æ¡ˆæœ‰ç‚¹ç®€å•ç²—æš´ï¼ŒWebView-è¿˜æä¾›äº†ä¸€ä¸ªè®¾ç½®ç™½åå•çš„æ–¹æ³•ï¼Œå¯ä»¥å°†ä¸šåŠ¡ä¸Šç”¨åˆ°çš„åŸŸååˆ—å…¥åº”ç”¨çš„ç™½åå•" class="headerlink" title="å¦‚æœè§‰å¾—è¿™æ ·ä¸€åˆ€åˆ‡çš„æ–¹æ¡ˆæœ‰ç‚¹ç®€å•ç²—æš´ï¼ŒWebView è¿˜æä¾›äº†ä¸€ä¸ªè®¾ç½®ç™½åå•çš„æ–¹æ³•ï¼Œå¯ä»¥å°†ä¸šåŠ¡ä¸Šç”¨åˆ°çš„åŸŸååˆ—å…¥åº”ç”¨çš„ç™½åå•"></a>å¦‚æœè§‰å¾—è¿™æ ·ä¸€åˆ€åˆ‡çš„æ–¹æ¡ˆæœ‰ç‚¹ç®€å•ç²—æš´ï¼ŒWebView è¿˜æä¾›äº†ä¸€ä¸ªè®¾ç½®ç™½åå•çš„æ–¹æ³•ï¼Œå¯ä»¥å°†ä¸šåŠ¡ä¸Šç”¨åˆ°çš„åŸŸååˆ—å…¥åº”ç”¨çš„ç™½åå•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebView.setSafeBrowsingWhitelist(List&lt;String&gt; hosts, ValueCallback&lt;Boolean&gt; callback)</span><br></pre></td></tr></table></figure><h4 id="ç”šè‡³è¿˜å¯ä»¥åœ¨-WebView-ä¸­è®¾ç½®æ˜¯å¦è¢«å®‰å…¨æœºåˆ¶æ‹¦æˆªçš„ç›‘å¬å›è°ƒï¼Œåœ¨æ¥æ”¶åˆ°è¢«å®‰å…¨æ‹¦æˆªåï¼Œè¿›è¡Œå¤„ç†"><a href="#ç”šè‡³è¿˜å¯ä»¥åœ¨-WebView-ä¸­è®¾ç½®æ˜¯å¦è¢«å®‰å…¨æœºåˆ¶æ‹¦æˆªçš„ç›‘å¬å›è°ƒï¼Œåœ¨æ¥æ”¶åˆ°è¢«å®‰å…¨æ‹¦æˆªåï¼Œè¿›è¡Œå¤„ç†" class="headerlink" title="ç”šè‡³è¿˜å¯ä»¥åœ¨ WebView ä¸­è®¾ç½®æ˜¯å¦è¢«å®‰å…¨æœºåˆ¶æ‹¦æˆªçš„ç›‘å¬å›è°ƒï¼Œåœ¨æ¥æ”¶åˆ°è¢«å®‰å…¨æ‹¦æˆªåï¼Œè¿›è¡Œå¤„ç†"></a>ç”šè‡³è¿˜å¯ä»¥åœ¨ WebView ä¸­è®¾ç½®æ˜¯å¦è¢«å®‰å…¨æœºåˆ¶æ‹¦æˆªçš„ç›‘å¬å›è°ƒï¼Œåœ¨æ¥æ”¶åˆ°è¢«å®‰å…¨æ‹¦æˆªåï¼Œè¿›è¡Œå¤„ç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWebViewClient</span> : <span class="title">WebViewClient</span>() </span>&#123;</span><br><span class="line">    <span class="comment">// Automatically go &quot;back to safety&quot; when attempting to load a website that</span></span><br><span class="line">    <span class="comment">// Google has identified as a known threat. An instance of WebView calls</span></span><br><span class="line">    <span class="comment">// this method only after Safe Browsing is initialized, so there&#x27;s no</span></span><br><span class="line">    <span class="comment">// conditional logic needed here.</span></span><br><span class="line">    <span class="function">override fun <span class="title">onSafeBrowsingHit</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            view: WebView,</span></span></span><br><span class="line"><span class="params"><span class="function">            request: WebResourceRequest,</span></span></span><br><span class="line"><span class="params"><span class="function">            threatType: Int,</span></span></span><br><span class="line"><span class="params"><span class="function">            callback: SafeBrowsingResponse</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>&#123;</span><br><span class="line">        <span class="comment">// The &quot;true&quot; argument indicates that your app reports incidents like</span></span><br><span class="line">        <span class="comment">// this one to Safe Browsing.</span></span><br><span class="line">        <span class="comment">//åœ¨è¿™é‡Œå¤„ç†è¢«å®‰å…¨æµè§ˆæœºåˆ¶æ‹¦æˆª</span></span><br><span class="line">        callback.backToSafety(<span class="keyword">true</span>)</span><br><span class="line">        Toast.makeText(view.context, <span class="string">&quot;Unsafe web page blocked.&quot;</span>, Toast.LENGTH_LONG).show()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ„Ÿè°¢æµ‹è¯•åŒäº‹ï¼Œåˆè®©æˆ‘æ¶¨çŸ¥è¯†äº†</p><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a href="https://blog.csdn.net/u010207898/article/details/89238551">Android webviewï¼ˆå®‰å…¨ç­–ç•¥ï¼‰ å‡ºç° æ‚¨è¦è®¿é—®çš„ç½‘ç«™åŒ…å«æœ‰å®³åº”ç”¨</a>(PS. è¿™ç¯‡æ–‡ç« æœ€åçš„ AndroidManifest ä¸­çš„å†™æ³•æ˜¯é”™è¯¯çš„)</p><p><a href="https://juejin.im/post/5c8899c56fb9a049b41d5432">WebViewï¼Œæˆ‘å·²ç»é•¿å¤§äº†ï¼ŒçŸ¥é“è‡ªå·±åŒºåˆ†æ˜¯å¦å®‰å…¨äº†ï¼</a></p><p>æœ€é‡è¦çš„ï¼ï¼ï¼è¿˜æ˜¯ Google å®˜æ–¹æ–‡æ¡£å•Š</p><p><a href="https://developer.android.com/guide/webapps/managing-webview">ç®¡ç† WebView å¯¹è±¡</a></p><p><a href="https://developer.android.com/about/versions/oreo/android-8.1">Android 8.1 Features and APIs</a></p>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;blockquote&gt;
&lt;p&gt;æ˜¨å¤©ä¸‹åˆï¼Œäº§å“ç»ç†çªç„¶å‘æ¥äº†ä¸€å¼ æˆªå›¾ï¼Œå†…å®¹æ˜¯æˆ‘ä»¬çš„ APP å› ä¸ºè¿åäº† Google Play çš„æŸäº›è§„å®šè¢«ä¸‹æ¶äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™å½“ç„¶æ˜¯é©¬ä¸Šæ’æŸ¥åŸå› å¹¶ fix ç„¶åæ‰“åŒ…ç»™æµ‹è¯•åŒäº‹é‡æ–°æµ‹è¯•ä¸€éç„¶åå†æå®¡å•¦ã€‚&lt;br&gt;ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œæµ‹è¯•çš„åŒäº‹å‘ç° App å†…çš„æ‰€æœ‰ HTML5 çš„é¡µé¢éƒ½æ— æ³•æ‰“å¼€äº†ï¼Œè€Œä¸»åŒ…(å›½å†…ç‰ˆæœ¬)å´æ˜¯æ­£å¸¸çš„ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ€ä¹ˆå¯èƒ½ä¼šå‘ç”Ÿå‘¢ï¼Œfix è¢«ä¸‹æ¶çš„é—®é¢˜å¹¶æ²¡æœ‰ä¿®æ”¹åˆ° WebView ä¸šåŠ¡ç›¸å…³çš„ä»£ç ï¼Œè¿™å°±ç™¾æ€ä¸å¾—å…¶è§£äº†ã€‚ç”šè‡³ä¸€åº¦ä»¥ä¸ºæ˜¯å‰ç«¯åŒäº‹åˆšä¸Šçº¿çš„ä»£ç å½±å“åˆ°äº†æµ·å¤–ç‰ˆæœ¬çš„ä¸šåŠ¡æƒ³ç”©é”…ã€‚&lt;/p&gt;
&lt;p&gt;æ‹¿èµ·è‡ªå·±çš„æ‰‹æœºè£…ä¸Š Google Play ç‰ˆæœ¬çš„åŒ…æ‰“å¼€å¯¹åº”çš„é¡µé¢ä¸€çœ‹ï¼ŒåŸºæœ¬ä¸Šæ˜¯ç¬¬ä¸€æ¬¡èƒ½æ­£å¸¸åŠ è½½ï¼Œé€€å‡ºåå†æ¬¡ç‚¹å‡»è¿›å…¥ WebView é¡µé¢å°±æ— æ³•åŠ è½½äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
    <category term="WebView" scheme="https://ppting.me/tags/WebView/"/>
    
  </entry>
  
  <entry>
    <title>Charles ä½¿ç”¨</title>
    <link href="https://ppting.me/2019/03/13/how_to_used_charles/"/>
    <id>https://ppting.me/2019/03/13/how_to_used_charles/</id>
    <published>2019-03-13T03:46:16.000Z</published>
    <updated>2022-02-12T08:18:22.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ç®€å•ä»‹ç» Charles çš„ä½¿ç”¨</p><h2 id="Rewrite-åŠŸèƒ½"><a href="#Rewrite-åŠŸèƒ½" class="headerlink" title="Rewrite åŠŸèƒ½"></a>Rewrite åŠŸèƒ½</h2><blockquote><p>å‡ ä¹å¯ä»¥ç”¨æ¥ä¿®æ”¹ HTTP è¯·æ±‚ä¸­çš„æ‰€æœ‰æ•°æ®<br>ä¾‹å¦‚ Request ä¸­çš„ pathã€query param ç­‰ç­‰</p></blockquote><p>è¿™æ ·çš„å¥½å¤„æ˜¯åªéœ€è¦ç¯¡æ”¹è¯·æ±‚ä¸­çš„æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œé¿å…é‡æ–°ç¼–è¯‘ï¼Œå¯ä»¥èŠ‚çœæ—¶é—´ï¼Œä¹Ÿä¸ä¼šæ±¡æŸ“ä»£ç ï¼Œé€ æˆå‘ç‰ˆæ—¶å¿˜è®°ä¿®æ”¹å›æ¥çš„é—®é¢˜ã€‚</p><span id="more"></span><p>å…·ä½“æ“ä½œå¦‚ä¸‹ï¼Œæˆ‘ä»¬ä»¥ <strong>å°†è¯·æ±‚ä¸­çš„ versionCode&#x3D;46 ä¿®æ”¹ä¸º 1111111ä¸ºä¾‹</strong></p><ul><li>ç‚¹å‡» Tools - Rewrite</li></ul><p><img src="https://i.loli.net/2020/05/02/PAwzqcU2b6O1hGI.jpg" alt="7bdcf253ly1g4rmbcpfs2j20uq0qstpi.jpg"></p><ul><li><p>æ–°å¢è§„åˆ™<br> åœ¨é¢æ¿ä¸Šåˆ†æˆäº†ä¸‰ä¸ªåŒºåŸŸï¼Œå¦‚ä¸‹<br> ç¬¬ä¸€ä¸ªåŒºåŸŸä¸º <strong>é…ç½®åŒº</strong> ï¼Œç”¨æ¥ç®¡ç†å„ç§é…ç½®<br> ç¬¬äºŒä¸ªåŒºåŸŸä¸º <strong>åŒ¹é…åŒº</strong> ç”¨æ¥åŒ¹é… Location<br> ç¬¬ä¸‰ä¸ªåŒºåŸŸä¸º <strong>é‡å†™è§„åˆ™åŒº</strong> åœ¨è¿™é‡Œæ–°å¢å„ç§é‡å†™è§„åˆ™<br> <img src="https://i.loli.net/2020/05/02/qkCX3UbHzj8o6Ny.jpg"></p></li><li><p>ç¼–è¾‘ Location<br><img src="https://i.loli.net/2020/05/02/NYft7WjZ4L3ks6S.jpg" alt="7bdcf253ly1g4rm7k5dmgj20uo0lewhp.jpg"></p><p>  è¿™é‡Œä¸€å…±æœ‰äº”ä¸ªåœ°æ–¹ï¼Œåˆ†åˆ«æ˜¯<br>  Protocol å¡«å†™åè®®<br>  Host å¡«å†™åŸŸå<br>  Prot å¡«å†™ç«¯å£<br>  Path å¡«å†™è·¯å¾„<br>  Query å¡«å†™æŸ¥è¯¢çš„å€¼</p></li></ul><p>å¦‚æœä¸å¡«å†™å°†ä¼šåŒ¹é…æ‰€æœ‰çš„å€¼ï¼Œè¿™é‡Œå¯ä»¥å¡«å†™ <strong>*</strong> å’Œ <strong>?</strong> é€šé…ç¬¦</p><h3 id="ä¿®æ”¹-Request"><a href="#ä¿®æ”¹-Request" class="headerlink" title="ä¿®æ”¹ Request"></a>ä¿®æ”¹ Request</h3><ul><li><p>å¡«å†™ Rewrite è§„åˆ™<br><img src="https://i.loli.net/2020/05/02/cd4egkLMaFTh2ZJ.jpg" alt="7bdcf253ly1g4rmhp99qzj211e0z2dok.jpg"></p><ol><li><p>é¦–å…ˆé€‰æ‹© Type(ç±»å‹) Modify Query Param </p><blockquote><p>å³ä¿®æ”¹ Query å‚æ•°</p></blockquote></li><li><p>åœ¨ Match ä¸­å¡«å†™éœ€è¦ä¿®æ”¹çš„å‚æ•°çš„ name ä»¥åŠå¯¹åº”çš„ value</p></li></ol><p>   <em><strong>åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå°±æ˜¯ versionCode åŠ 46</strong></em><br>  3. åœ¨ Replace ä¸­å¡«å†™ç›¸å¯¹åº”è¦ä¿®æ”¹çš„å‚æ•°åå’Œå€¼<br>  <em><strong>åœ¨æˆ‘ä»¬çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°† versionCode çš„å€¼æ”¹æˆ 1111111</strong></em>ï¼Œæ‰€ä»¥åªéœ€è¦å°† Replace ä¸­çš„ Value å¡«å†™ä¸º 1111111</p></li></ul><p>è¿™æ ·å°±å¯ä»¥å°† HTTP è¯·æ±‚ä¸­çš„æ•°æ®è¿›è¡Œä¿®æ”¹äº†ï¼Œä¸éœ€è¦ä¿®æ”¹ä»£ç å’Œé‡æ–°ç¼–è¯‘ã€‚èŠ‚çœäº†å¤§é‡çš„æ—¶é—´</p><h3 id="ä¿®æ”¹-Response"><a href="#ä¿®æ”¹-Response" class="headerlink" title="ä¿®æ”¹ Response"></a>ä¿®æ”¹ Response</h3><p>åŒç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹ HTTP è¯·æ±‚ä¸­çš„ Response ä¸­çš„æ•°æ®ï¼Œä¿®æ”¹æˆæˆ‘ä»¬è°ƒè¯•æ‰€éœ€è¦çš„ä¿¡æ¯</p><p>åªéœ€è¦åœ¨ Rewrite Rule ä¸­çš„ Type ä¸­é€‰æ‹©æ‰€éœ€è¦ä¿®æ”¹çš„ç±»å‹ï¼Œä¾‹å¦‚ <code>Response Status</code>ã€<code>Modify Header</code>ã€<code>Body</code> ç­‰</p><p><img src="https://i.loli.net/2020/05/02/buNi497D5W2qzRm.jpg" alt="7bdcf253ly1g4rm8gorolj21080y67aw.jpg"></p><p>å¹¶åœ¨ <code>Where</code> ä¸­é€‰æ‹©æ˜¯ä¿®æ”¹ <code>Request</code> è¿˜æ˜¯ <code>Response</code> ï¼Œä¸‹é¢çš„è§„åˆ™åŒç†ã€‚</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>Location Match åŒ…å«äº†å¯ç”¨äºåŒ¹é…è¯·æ±‚URLçš„åè®®ï¼Œä¸»æœºï¼Œç«¯å£å’Œè·¯å¾„å­—æ®µã€‚<br>ä»»ä½•å­—æ®µéƒ½å¯ä»¥ç•™ç©ºï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šåŒ¹é…ä¸Šä»»ä½•å€¼ã€‚</p><ul><li>é€šé…ç¬¦(Wildcards)<br>é€šé…ç¬¦æ”¯æŒä½¿ç”¨ <strong>*</strong> ã€**?** å’Œ <strong>[â€¦]</strong></li></ul><p><strong>*</strong> åŒ¹é…0ä¸ªæˆ–è€…å¤šä¸ªå­—ç¬¦ï¼Œ**?<strong>åŒ¹é…ä¸€ä¸ªå­—ç¬¦ï¼Œå­—ç¬¦èŒƒå›´</strong>[â€¦]** åŒ¹é…èŒƒå›´å†…çš„ä¸€ä¸ªå­—ç¬¦ï¼Œä¾‹å¦‚ [a-z] æˆ–è€… [aeiou]</p><ul><li>è·¯å¾„(Paths)<br>è¦åŒ¹é…å­è·¯å¾„ï¼Œå¿…é¡»ä½¿ç”¨<code>/*</code>ç»“å°¾<br>æ³¨æ„ï¼šåœ¨ä¹‹å‰çš„ Charles ç‰ˆæœ¬ä¸­è¿™æ˜¯éšå«çš„ï¼Œä½†ç°åœ¨æ˜¯å¿…é¡»çš„</li><li>æŸ¥è¯¢å€¼(Query)<br>æŸ¥è¯¢å­—æ®µå’ŒæŸ¥è¯¢å­—ç¬¦ä¸²å†…å®¹ç›¸åŒ¹é…ï¼Œå¹¶ä¸åŒ¹é…ä»¥ <code>?</code> å¼€å¤´çš„å­—ç¬¦ï¼Œè¦æ³¨æ„åˆ°<code>ï¼Ÿ</code>æ˜¯ä¸€ä¸ªé€šé…ç¬¦<br>æŸ¥è¯¢å­—æ®µå’Œå…¶ä»–å­—æ®µä¸€æ ·å¯ä»¥åŒ…å«é€šé…ç¬¦ï¼Œå› æ­¤ä½ å¯ä»¥åƒè¿™æ ·ï¼Œåœ¨ Query ä¸­ä»»ä½•åœ°æ–¹ä½¿ç”¨ <code>*page=1*</code> å»åŒ¹é… <code>page=1</code></li><li>å¸¸è§ç”¨é€”<br>è¦å°†æ¯ä¸ªè¯·æ±‚å’Œç»™å®šçš„ host åŒ¹é…ï¼Œå¡«å…¥ host å¹¶å°†å…¶ä»–å­—æ®µç•™ç©º<br> è¦å°†æ¯ä¸ªè¯·æ±‚å’Œç»™å®šçš„ host ä»¥åŠè·¯å¾„åŒ¹é…ï¼Œå¡«å…¥ host å¹¶æŠŠè·¯å¾„å·² <code>/</code> ç»“å°¾ï¼Œå¹¶æŠŠå…¶ä»–å­—æ®µç•™ç©º<br> è¦å°†æ¯ä¸ªæ–‡ä»¶å’Œç»™å®šçš„ host ä¸Šçš„åç¼€(suffix)ç›¸åŒ¹é…ï¼Œåˆ™å¡«å…¥ host å’Œ <code>/*.suffix</code>ï¼Œå¹¶å°†å…¶ä»–å­—æ®µç•™ç©º</li></ul><table><thead><tr><th>Host</th><th>Path</th><th>Result</th></tr></thead><tbody><tr><td>charlesproxy.com</td><td></td><td>åŒ¹é…æ‰€æœ‰åˆ° charlesproxy.com çš„è¯·æ±‚</td></tr><tr><td>*.charlesproxy.com</td><td></td><td>åŒ¹é…æ‰€æœ‰ host ä»¥ .charlesproxy.com ç»“å°¾çš„è¯·æ±‚</td></tr><tr><td>charlesproxy.com</td><td>&#x2F;charles&#x2F;</td><td>åªä¼šåŒ¹é…æ‰€æœ‰åˆ° charlesproxy.com&#x2F;charles&#x2F; çš„è¯·æ±‚</td></tr><tr><td>charlesproxy.com</td><td>&#x2F;charles&#x2F;*</td><td>åŒ¹é…æ‰€æœ‰åˆ° charlesproxy.com&#x2F;charles&#x2F; çš„è¯·æ±‚ï¼ŒåŒ…æ‹¬æ–‡ä»¶å’Œå­è·¯å¾„</td></tr><tr><td>charlesproxy.com</td><td>&#x2F;charles</td><td>åªä¼šåŒ¹é…æ‰€æœ‰åˆ° charlesproxy.com&#x2F;charles çš„è¯·æ±‚</td></tr><tr><td>charlesproxy.com</td><td>&#x2F;index.html</td><td>åªä¼šåŒ¹é…æ‰€æœ‰åˆ° charlesproxy.com&#x2F;charles.html çš„è¯·æ±‚</td></tr><tr><td>charlesproxy.com</td><td>&#x2F;*.html</td><td>åŒ¹é…æ‰€æœ‰åˆ° charlesproxy.com å¹¶ä¸”ä»¥ .html ç»“å°¾çš„æ‰€æœ‰è¯·æ±‚</td></tr><tr><td></td><td>&#x2F;charles&#x2F;*.html</td><td>åŒ¹é…ä»»ä½• host çš„æ‰€æœ‰åœ¨è·¯å¾„(åŒ…æ‹¬å­è·¯å¾„) &#x2F;charles&#x2F; ä¸­ä»¥ .html ç»“å°¾çš„æ‰€æœ‰è¯·æ±‚</td></tr></tbody></table><p>å¯ä»¥å°†åè®®å’Œç«¯å£åŒ¹é…æ·»åŠ åˆ°ä¸Šé¢ä»¥è¿›ä¸€æ­¥ç¼©å°ä½ç½®åŒ¹é…ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡ç®€å•ä»‹ç» Charles çš„ä½¿ç”¨&lt;/p&gt;
&lt;h2 id=&quot;Rewrite-åŠŸèƒ½&quot;&gt;&lt;a href=&quot;#Rewrite-åŠŸèƒ½&quot; class=&quot;headerlink&quot; title=&quot;Rewrite åŠŸèƒ½&quot;&gt;&lt;/a&gt;Rewrite åŠŸèƒ½&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;å‡ ä¹å¯ä»¥ç”¨æ¥ä¿®æ”¹ HTTP è¯·æ±‚ä¸­çš„æ‰€æœ‰æ•°æ®&lt;br&gt;ä¾‹å¦‚ Request ä¸­çš„ pathã€query param ç­‰ç­‰&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™æ ·çš„å¥½å¤„æ˜¯åªéœ€è¦ç¯¡æ”¹è¯·æ±‚ä¸­çš„æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œé¿å…é‡æ–°ç¼–è¯‘ï¼Œå¯ä»¥èŠ‚çœæ—¶é—´ï¼Œä¹Ÿä¸ä¼šæ±¡æŸ“ä»£ç ï¼Œé€ æˆå‘ç‰ˆæ—¶å¿˜è®°ä¿®æ”¹å›æ¥çš„é—®é¢˜ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ•™ç¨‹" scheme="https://ppting.me/categories/%E6%95%99%E7%A8%8B/"/>
    
    
    <category term="Charles" scheme="https://ppting.me/tags/Charles/"/>
    
  </entry>
  
  <entry>
    <title>HTTPS æ˜¯å¦‚ä½•ä¿è¯å®‰å…¨çš„</title>
    <link href="https://ppting.me/2019/01/01/communication-with-https/"/>
    <id>https://ppting.me/2019/01/01/communication-with-https/</id>
    <published>2019-01-01T09:04:50.000Z</published>
    <updated>2022-02-12T08:17:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒHTTP åè®®æ˜¯æ˜æ–‡ä¼ è¾“çš„ï¼Œåœ¨ç½‘ç»œä¸–ç•Œé‡Œç”¨ HTTP åè®®å‘é€æŠ¥æ–‡ç›¸å½“äºè£¸å¥”ï¼Œäºæ˜¯å°±æœ‰äº† HTTPS<br>è¿™ä¸ª S æ˜¯ä»€ä¹ˆå‘¢ï¼Œæ˜¯å¦‚ä½•ä¿è¯æˆ‘ä»¬å‘é€çš„æŠ¥æ–‡å°±ä¸è¢«çªƒå–å’Œç¯¡æ”¹äº†å‘¢ï¼Œè®©æˆ‘ä»¬æ…¢æ…¢é“æ¥</p><span id="more"></span><p>å…¶å®è¿™ä¸ª S æŒ‡çš„å°±æ˜¯ SSL&#x2F;TLS<br>æˆ‘ä»¬çŸ¥é“ HTTP åœ¨ç½‘ç»œåè®®ä¸­å±äºåº”ç”¨å±‚ï¼Œåœ¨å‘é€æŠ¥æ–‡æ—¶ä¼šå°†æŠ¥æ–‡äº¤ç»™ TCP è¿›è¡Œä¼ è¾“ï¼Œè€Œ TCP å±‚é¢åˆ™æ˜¯æ˜æ–‡çš„ï¼Œäºæ˜¯ HTTPS åœ¨å°†æŠ¥æ–‡å‘ç»™ TCP ä¹‹å‰ï¼Œé€šè¿‡ TLS å°†æŠ¥æ–‡è¿›è¡ŒåŠ å¯†åå†é€šè¿‡ TCP è¿›è¡Œä¼ è¾“</p><p>é‚£ä¹ˆ HTTPS æ˜¯å¦‚ä½•è¿›è¡ŒåŠ å¯†çš„å‘¢</p><p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ¥äº†è§£ä¸€ä¸‹åŠ å¯†ç®—æ³• </p><h2 id="å¯¹ç§°åŠ å¯†"><a href="#å¯¹ç§°åŠ å¯†" class="headerlink" title="å¯¹ç§°åŠ å¯†"></a>å¯¹ç§°åŠ å¯†</h2><p>æ‰€è°“å¯¹ç§°åŠ å¯†ï¼Œå°±æ˜¯ç”¨æ¥åŠ å¯†å’Œè§£å¯†çš„å¯†é’¥éƒ½æ˜¯åŒä¸€ä¸ªï¼Œ å½“æˆ‘ä»¬ä½¿ç”¨å¯¹ç§°åŠ å¯†çš„æ—¶å€™ï¼Œå°±æ˜¯ç”¨å¯†é’¥å°†å…ƒæ•°æ®é€šè¿‡åŠ å¯†ç®—æ³•ï¼Œè½¬å˜æˆå¯†æ–‡ï¼Œå½“å¦ä¸€æ–¹éœ€è¦å°†å¯†æ–‡è½¬æˆåŸæ–‡çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åŒä¸€ä¸ªå¯†é’¥å’Œç›¸å¯¹åº”çš„è§£å¯†ç®—æ³•ï¼Œå°†å¯†æ–‡ç»™è¿˜åŸæˆåŸæ–‡ã€‚<br>ä½†å¯¹ç§°åŠ å¯†çš„ç¼ºé™·åœ¨äºï¼Œå¦‚ä½•ä¿è¯<strong>å¯†é’¥</strong>çš„å®‰å…¨æ€§ï¼Œå¦‚ä½•ä¿è¯åªæœ‰é€šä¿¡çš„åŒæ–¹æ‰æŒæœ‰è¯¥å¯†é’¥è€Œä¸è¢«å…¶ä»–äººçªƒå–ï¼Œè€Œ<em>éå¯¹ç§°åŠ å¯†</em>å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„</p><h2 id="éå¯¹ç§°åŠ å¯†"><a href="#éå¯¹ç§°åŠ å¯†" class="headerlink" title="éå¯¹ç§°åŠ å¯†"></a>éå¯¹ç§°åŠ å¯†</h2><p>éå¯¹ç§°åŠ å¯†ï¼Œæ˜¯å› ä¸ºæ•°å­¦å®¶ä»¬ç ”ç©¶å‡ºäº†ä¸€ç§ç®—æ³•ï¼Œè¿™ç§ç®—æ³•ä¸¤ä¸ªä¸åŒçš„å¯†é’¥ï¼Œé€šè¿‡å¯†é’¥ A å¯¹åŸæ–‡è¿›è¡ŒåŠ å¯†åï¼Œåªèƒ½é€šè¿‡å¯†é’¥ B è¿›è¡Œè§£å¯†ã€‚å’Œå¯¹ç§°åŠ å¯†ä¸åŒçš„æ˜¯ï¼Œéå¯¹ç§°åŠ å¯†åªæœ‰ä¸€ä¸ªç®—æ³•ï¼Œä¸éœ€è¦ã€åŠ å¯†ç®—æ³•ã€å’Œã€è§£å¯†ç®—æ³•ã€ï¼Œä¹Ÿå°±æ˜¯è¯´åŒä¸€ä¸ªç®—æ³•ï¼Œç»è¿‡å¯†é’¥ A åŠ å¯†è¿‡çš„å¯†æ–‡åªèƒ½ç”±å¯†é’¥ B è§£å¯†ã€‚</p><p>ä½†æ‰€è°“çš„ã€åŸæ–‡ã€å’Œã€å¯†æ–‡ã€åªæ˜¯ç›¸å¯¹çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æ‰€è°“çš„ã€åŸæ–‡ã€å½“åšè¢«åŠ å¯†è¿‡çš„æ•°æ®ï¼Œè€ŒæŠŠã€å¯†æ–‡ã€å½“åšåŠ å¯†å‰çš„æ•°æ®ï¼Œæ‰€ä»¥ä»ä¸‹å›¾çœ‹ï¼Œå¯†é’¥ A å’Œå¯†é’¥ B å…¶å®ä¹Ÿæ˜¯å¯ä»¥ç›¸äº’äº¤æ¢çš„ï¼Œå¯†é’¥ B å¯ä»¥ç”¨æ¥å½“åšåŠ å¯†ç”¨çš„å¯†é’¥ï¼Œè€Œè®©å¯†é’¥ A å½“åšè§£å¯†ç”¨çš„å¯†é’¥ã€‚<br><img src="https://i.loli.net/2020/07/30/HlKVyet7nGdLAi5.jpg" alt="0071ouepgy1fyr6z2wl0dj30w80f0q55.jpg"><br>ä½†ä¸€èˆ¬æ¥è¯´ä¸ä¼šè¿™ä¹ˆåšï¼Œè¿™æ˜¯å› ä¸ºéå¯¹ç§°åŠ å¯†çš„ç®—æ³•æ˜¯æœ‰å¾ˆå¤šç§çš„ï¼Œè€Œå¯†é’¥ A å’Œå¯†é’¥ B æ˜¯æˆå¯¹å­˜åœ¨çš„ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ä¸èƒ½ç›¸äº’æ¨å¯¼çš„ï¼Œå³æˆ‘ä¸èƒ½é€šè¿‡å¯†é’¥ A è®¡ç®—å‡ºå¯†é’¥ Bï¼Œä¹Ÿä¸èƒ½é€šè¿‡å¯†é’¥ B è®¡ç®—å‡ºå¯†é’¥ Aï¼Œä½†ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œå…¶å®ä¹Ÿæ˜¯å¯ä»¥æ¨å¯¼å‡ºæ¥çš„ï¼Œåªä¸è¿‡å¯¹äºå¦‚ä»Šçš„è®¡ç®—è¿åŠ›æ¥è¯´ä¸è¶³ä»¥åœ¨çŸ­æ—¶é—´å†…æ¨å¯¼å‡ºæ¥ï¼Œå¯èƒ½éœ€è¦ä¸Šç™¾å¹´ä¸Šåƒå¹´ï¼Œæ‰€ä»¥æˆ‘ä»¬å§‘ä¸”è®¤ä¸ºæ˜¯æ— æ³•æ¨å¯¼å‡ºæ¥çš„ã€‚<br>ä½†ä¹Ÿæœ‰ä¸€äº›éå¯¹ç§°åŠ å¯†ç®—æ³•æ˜¯ä¾‹å¤–çš„ï¼Œæœ‰äº›éå¯¹ç§°åŠ å¯†çš„ç®—æ³•æ˜¯å¯ä»¥é€šè¿‡å¯†é’¥ A è®¡ç®—å‡ºæ¥å¯†é’¥ B çš„ã€‚<br>æ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ç”¨å¯†é’¥ B è¿›è¡ŒåŠ å¯†è€ŒæŠŠå¯†é’¥ A å…¬å¼€äº†ã€‚å› ä¸ºè¿™æ ·çš„è¯ï¼Œå°±ç›¸å½“äºæ‰€æœ‰äººéƒ½çŸ¥é“äº†å¯†é’¥ A å’Œ å¯†é’¥ B æ˜¯ä»€ä¹ˆï¼Œå°±ç›¸å½“äºæ²¡æœ‰åŠ å¯†äº†ã€‚</p><p>è€Œå¯†é’¥ A ï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸ºç§é’¥ï¼Œå¯†é’¥ B ç§°ä¸ºå…¬é’¥ã€‚<br>æ‰€è°“ç§é’¥ï¼Œå°±æ˜¯è¦å¯¹ä¿¡æ¯è¿›è¡ŒåŠ å¯†çš„æŒæœ‰è€…æ‰€æŒæœ‰çš„å¯†é’¥ï¼Œè¿™ä¸ªå¯†é’¥åªèƒ½è‡ªå·±æŒæœ‰ï¼Œä¸èƒ½å…¬å¼€ï¼Œè€Œå…¬é’¥æ˜¯å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹å…¬å¼€çš„ï¼Œåªæœ‰æŒæœ‰ç§é’¥çš„ä¸€æ–¹æ‰å¯ä»¥å°†è¢«å…¬é’¥åŠ å¯†è¿‡çš„ä¿¡æ¯è§£å¯†å¾—åˆ°åŸæ–‡ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚æˆ‘è¦å‘é€ä¸€ä¸ªæ¶ˆæ¯ç»™å¯¹æ–¹ï¼Œæˆ‘éœ€è¦å…ˆå¾—åˆ°å¯¹æ–¹çš„å…¬é’¥ï¼Œç„¶åç”¨å¯¹æ–¹çš„å…¬é’¥å¯¹ä¿¡æ¯è¿›è¡ŒåŠ å¯†åå†å‘é€ç»™å¯¹æ–¹ï¼Œè€Œåªæœ‰å¯¹æ–¹(å…¬é’¥å¯¹åº”çš„ç§é’¥æ‹¥æœ‰è€…)æ‰èƒ½å°†ä¿¡æ¯è¿˜åŸæˆåŸæ–‡</p><p>åœ¨æ¶ˆæ¯çš„å‘é€å‰ï¼Œå‘é€æ–¹éœ€è¦è·å–åˆ°æ¥æ”¶æ–¹çš„å…¬é’¥ï¼Œè€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå‘é€æ–¹æ˜¯å¦‚ä½•ç¡®å®šè¿™ä¸ªå…¬é’¥å°±çœŸçš„æ˜¯æ¥æ”¶æ–¹çš„å…¬é’¥è€Œä¸æ˜¯è¢«ç¯¡æ”¹è¿‡çš„å‘¢ã€‚<br>ä¸”å¬æˆ‘å¨“å¨“é“æ¥ã€‚<br>è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªçŸ¥è¯†ç‚¹(æ•²é»‘æ¿)</p><h3 id="éå¯¹ç§°åŠ å¯†çš„åº”ç”¨"><a href="#éå¯¹ç§°åŠ å¯†çš„åº”ç”¨" class="headerlink" title="éå¯¹ç§°åŠ å¯†çš„åº”ç”¨"></a>éå¯¹ç§°åŠ å¯†çš„åº”ç”¨</h3><h4 id="æ•°å­—ç­¾å"><a href="#æ•°å­—ç­¾å" class="headerlink" title="æ•°å­—ç­¾å"></a>æ•°å­—ç­¾å</h4><p>æ‰€è°“æ•°å­—ç­¾åï¼Œå°±æ˜¯è¯æ˜è¿™ä¸ªä¸œè¥¿æ˜¯æˆ‘å‘å‡ºçš„<br>åœ¨ç½‘ç»œä¸–ç•Œé‡Œï¼Œæ‰€æœ‰çš„æ•°æ®åŒ…éƒ½æœ‰å¯èƒ½è¢«æˆªè·ç¯¡æ”¹ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬æ”¶åˆ°æŸä¸ªæ¶ˆæ¯æ—¶ï¼Œå¦‚ä½•ç¡®å®šè¿™æ¡æ¶ˆæ¯å°±æ˜¯æˆ‘è®¤ä¸ºçš„é‚£ä¸ªäººå‘å‡ºçš„å‘¢ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°ã€éå¯¹ç§°åŠ å¯†ã€çš„ä¸€ä¸ªåº”ç”¨â€“ã€æ•°å­—ç­¾åã€äº†ã€‚<br><img src="https://i.loli.net/2020/07/30/NaQ6ygMsRo1LGlD.jpg" alt="0071ouepgy1fyr6w822t9j31iw0petdo.jpg"><br>é€šè¿‡ä¸Šå›¾å¯è§ï¼Œå½“æ¥æ”¶æ–¹å¯¹æ¯” <em><strong>æ‘˜è¦</strong></em> å’Œ <em><strong>æ‘˜è¦â€™</strong></em> ç›¸åŒæ—¶ï¼Œå°±å¯ä»¥è®¤ä¸ºè¿™æ¡æ¶ˆæ¯æ˜¯æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡çš„ï¼Œæ˜¯æ¥è‡ªäºè¿™ä¸ªå…¬é’¥æ‰€å¯¹åº”çš„ç§é’¥çš„æ‹¥æœ‰è€…å‘å‡ºçš„ã€‚</p><p>ä½†åœ¨æˆ‘ä»¬çš„æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ä¸­è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œæ¥æ”¶æ–¹æ€ä¹ˆå°±çŸ¥é“è¿™ä¸ªå…¬é’¥å°±æ˜¯æˆ‘è®¤ä¸ºçš„æ¶ˆæ¯çš„å‘é€è€…çš„å‘¢ã€‚ä¸‡ä¸€ä¸­é—´æœ‰äººæŠŠæ‰€æœ‰çš„ä¿¡æ¯(å…¬é’¥ä¿®æ”¹äº†ï¼ŒåŒæ—¶ç”¨æ–°çš„å…¬é’¥è®¡ç®—å‡ºå¯†æ–‡å’Œ hash)éƒ½ä¿®æ”¹äº†ï¼Œé‚£æ¥æ”¶æ–¹é€šè¿‡è¿™ç§æ–¹å¼éªŒè¯å‡ºæ¥çš„ç»“æœéƒ½æ˜¯æ­£ç¡®çš„ï¼Œé‚£æ€ä¹ˆåŠã€‚</p><p>äºæ˜¯é—®é¢˜çš„ç—›ç‚¹å°±è½åœ¨äº†æˆ‘ä»¬éœ€è¦ä¿è¯å…¬é’¥çš„æ­£ç¡®æ€§ä¸Š</p><p>è¿™å°±éœ€è¦è¯ä¹¦äº†</p><h4 id="æ•°å­—è¯ä¹¦"><a href="#æ•°å­—è¯ä¹¦" class="headerlink" title="æ•°å­—è¯ä¹¦"></a>æ•°å­—è¯ä¹¦</h4><p>ä¸ºäº†è§£å†³æ— æ³•è¯æ˜å…¬é’¥çš„æ­£ç¡®æ€§çš„é—®é¢˜ï¼Œæœ‰äº†æ•°å­—è¯ä¹¦ã€‚<br>æ•°å­—è¯ä¹¦æ˜¯ç”±æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ï¼ˆCAï¼ŒCertificate Authorityï¼‰å’Œå…¶ç›¸å…³æœºå…³é¢å‘çš„ã€‚æ•°å­—è¯ä¹¦è®¤è¯æœºæ„å¤„äºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åŒæ–¹éƒ½å¯ä¿¡èµ–çš„ç¬¬ä¸‰æ–¹æœºæ„çš„ç«‹åœºä¸Šã€‚</p><p>è¦å¾—åˆ°ä¸€ä»½æ•°å­—è¯ä¹¦ï¼Œéœ€è¦ç”±æœåŠ¡å™¨ç«¯çš„(æˆ–è€…è¯´æ˜¯ä¿¡æ¯çš„å‘é€æ–¹)åˆ°æ•°å­—è¯ä¹¦è®¤è¯æœºæ„å»ç”³è¯·ï¼Œè€Œ CA ç¡®è®¤è¯¥èº«ä»½åé€šè¿‡ç”³è¯·ï¼Œåˆ™ä¼šç»™è¯¥ç”³è¯·è€…ä¸€ä¸ªåŒ…å«ç»è¿‡ CA ç­¾åçš„å…¬é’¥çš„æ•°å­—è¯ä¹¦ã€‚</p><p>æ•°å­—è¯ä¹¦ä¸­åŒ…æ‹¬äº†ã€Œç­¾åã€+ã€Œcsr æ–‡ä»¶ã€</p><p>å…¶ä¸­ï¼Œcsr æ–‡ä»¶åŒ…æ‹¬ä¿¡æ¯å‘é€æ–¹çš„ã€Œå…¬é’¥ã€ã€ã€Œç”³è¯·è€…ä¿¡æ¯ã€ã€ã€ŒåŸŸåã€ç­‰<br>CA æœºæ„é€šè¿‡å¯¹è¿™äº›ä¿¡æ¯é€šè¿‡æ‘˜è¦ç®—æ³•è®¡ç®—å‡ºæ‘˜è¦(è®°ä¸ºæ‘˜è¦ A)ï¼Œå¹¶ç”¨ç§é’¥è¿›è¡ŒåŠ å¯†ï¼Œå¾—åˆ°ã€Œç­¾å Aã€ï¼Œå¹¶æŠŠã€Œç­¾å Aã€ å’Œ csr æ–‡ä»¶å†…å®¹æ‰“åŒ…æˆè¯ä¹¦</p><p>åœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œæ¥æ”¶è€…å°±ä¼šæ‹¿åˆ°è¿™ä¸ªè¯ä¹¦ï¼Œè¿›è¡ŒéªŒè¯</p><p>é¦–å…ˆæ¥æ”¶è€…çš„ç³»ç»Ÿ&#x2F;æµè§ˆå™¨ä¸­å†…ç½®äº† CA æœºæ„çš„å…¬é’¥ï¼Œæ‹¿åˆ°å…¬é’¥åå¯¹æ¥æ”¶åˆ°çš„è¯ä¹¦ä¸­çš„ã€Œç­¾å Aã€è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°ã€Œæ‘˜è¦ Aã€ï¼Œå†ä½¿ç”¨ç›¸åŒçš„æ‘˜è¦ç®—æ³•å¯¹ csr æ–‡ä»¶è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°ã€Œæ‘˜è¦ Bã€ï¼Œæ¯”å¯¹ã€Œæ‘˜è¦ Aã€å’Œã€Œæ‘˜è¦ Bã€ï¼Œå¦‚æœæ— æ³•è®¡ç®—å‡ºã€Œæ‘˜è¦ Aã€æˆ–è€…ã€Œæ‘˜è¦ Aã€å’Œã€Œæ‘˜è¦ Bã€ä¸ç›¸åŒï¼Œåˆ™è®¤ä¸ºè¿™ä¸ªè¯ä¹¦ä¸å¯ä¿¡ï¼Œå¦åˆ™åˆ™è®¤ä¸ºè¿™ä¸ªè¯ä¹¦å¯ä¿¡ï¼Œåˆ™å¯ä»¥è·å–åˆ° csr æ–‡ä»¶ä¸­ä¿¡æ¯å‘é€è€…çš„å…¬é’¥</p><p>è‡³æ­¤å°±å®Œæˆäº†ä¿¡æ¯å‘é€è€…çš„å…¬é’¥çš„å®‰å…¨ä¼ è¾“è¿‡ç¨‹(é˜²æ­¢è¢«ç¯¡æ”¹å’Œæ›¿æ¢)</p><p><img src="https://i.loli.net/2021/11/11/YINwnzfej45QX2q.jpg" alt="æ•°å­—è¯ä¹¦.jpg"></p><blockquote><p>å›¾ç‰‡æ¥æºäº <a href="https://network.51cto.com/art/202010/628890.htm">æ•°å­—è¯ä¹¦ã€ç­¾ååˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿè¿™ç¯‡æ–‡ç« è®²å¾—å¤ªå¥½äº†</a></p></blockquote><h2 id="TLS-å››æ¬¡æ¡æ‰‹"><a href="#TLS-å››æ¬¡æ¡æ‰‹" class="headerlink" title="TLS å››æ¬¡æ¡æ‰‹"></a>TLS å››æ¬¡æ¡æ‰‹</h2><h3 id="Client-Hello"><a href="#Client-Hello" class="headerlink" title="Client Hello"></a>Client Hello</h3><blockquote><p>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€</p></blockquote><ul><li>TLS æ”¯æŒçš„ç‰ˆæœ¬</li><li>æ”¯æŒçš„åŠ å¯†ç®—æ³•ä»¥åŠç‰ˆæœ¬</li><li>æ”¯æŒçš„å‹ç¼©ç®—æ³•</li><li>Client Random A</li></ul><h3 id="Server-Helloã€Certificateã€Server-Hello-Done"><a href="#Server-Helloã€Certificateã€Server-Hello-Done" class="headerlink" title="Server Helloã€Certificateã€Server Hello Done"></a>Server Helloã€Certificateã€Server Hello Done</h3><blockquote><p>æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿›è¡Œå“åº”</p></blockquote><ul><li>é€‰æ‹©çš„ TLS ç‰ˆæœ¬</li><li>é€‰æ‹©çš„åŠ å¯†ç®—æ³•</li><li>Client Random B</li></ul><h4 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h4><ul><li>å‘é€æœåŠ¡å™¨çš„è¯ä¹¦<br>Client åœ¨æ”¶åˆ° Server å‘é€è¿‡æ¥çš„è¯ä¹¦åä¼šå¯¹è¯ä¹¦è¿›è¡Œæ ¡éªŒ</li></ul><h4 id="Server-Hello-Done"><a href="#Server-Hello-Done" class="headerlink" title="Server Hello Done"></a>Server Hello Done</h4><h3 id="Client-Key-Exchange-Change-Clpher-Spec-Finish"><a href="#Client-Key-Exchange-Change-Clpher-Spec-Finish" class="headerlink" title="Client Key Exchange,Change Clpher Spec,Finish"></a>Client Key Exchange,Change Clpher Spec,Finish</h3><h4 id="Client-Key-Exchange"><a href="#Client-Key-Exchange" class="headerlink" title="Client Key Exchange"></a>Client Key Exchange</h4><ul><li>è¯ä¹¦æ ¡éªŒé€šè¿‡åï¼ŒClient ä¼šä½¿ç”¨ Random A å’Œ Random B  ç”Ÿæˆä¸€ä¸ª pre-master çš„å€¼ï¼Œ<br>é€šè¿‡ Server çš„ Public Key å¯¹ pre-master è¿›è¡ŒåŠ å¯†åå‘é€ç»™ Server</li></ul><h4 id="Change-Clpher-Spec"><a href="#Change-Clpher-Spec" class="headerlink" title="Change Clpher Spec:"></a>Change Clpher Spec:</h4><ul><li>å¹¶å‘ŠçŸ¥æœåŠ¡ç«¯åç»­ä½¿ç”¨ç®—æ³•è®¡ç®—å‡ºæ¥çš„ key å¯¹é€šä¿¡å†…å®¹è¿›è¡ŒåŠ å¯†<blockquote><p>æ­¤æ—¶ Client å·²ç»æ‹¥æœ‰äº† Random A ã€ Random B å’Œ pre-masterï¼Œç”¨è¿™ä¸‰ä¸ªå€¼å¯ä»¥è®¡ç®—å‡º session-keyï¼Œç”¨äºä½œä¸ºå¯¹ç§°åŠ å¯†çš„å¯†é’¥</p></blockquote></li></ul><h4 id="Finish"><a href="#Finish" class="headerlink" title="Finish:"></a>Finish:</h4><ul><li>å¯¹ä¸Šè¿°æ‰€æœ‰æ¡æ‰‹è¿‡ç¨‹ä¸­çš„æ•°æ®ä½¿ç”¨å•†é‡å¥½çš„ Hash ç®—æ³•è®¡ç®— HashCodeï¼Œå¹¶ä½¿ç”¨ session-key è¿›è¡ŒåŠ å¯†</li></ul><h3 id="New-Session-Ticket-Change-Cliper-Spec-Finish"><a href="#New-Session-Ticket-Change-Cliper-Spec-Finish" class="headerlink" title="New Session Ticket,Change Cliper Spec,Finish"></a>New Session Ticket,Change Cliper Spec,Finish</h3><p>Server ä½¿ç”¨è‡ªå·±çš„ç§é’¥å¯¹ä¸Šä¸€æ­¥ä¸­å‘æ¥åŠ å¯†è¿‡çš„ pre-master è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°æ˜æ–‡çš„ pre-master<br>æ­¤æ—¶ Server ä¹Ÿæ‹¥æœ‰äº† Random A ã€ Random B å’Œ pre-master ï¼Œä½¿ç”¨å•†é‡å¥½çš„ç®—æ³•è®¡ç®—å‡º session-key<br>å¹¶ä½¿ç”¨ session-key å¯¹ä¸Šä¸€æ­¥ä¸­ Client ä¸­å‘æ¥çš„æ•°æ®å’Œ HashCode è¿›è¡Œæ ¡éªŒï¼Œ<br>ä»¥ç”¨æ¥è¯æ˜ Client è®¡ç®—çš„ session-key æ˜¯æ­£ç¡®çš„</p><h4 id="New-Session-Ticket"><a href="#New-Session-Ticket" class="headerlink" title="New Session Ticket"></a>New Session Ticket</h4><p>Server å‘é€ç»™ Client çš„ Sessionï¼Œç”¨äºä¸‹ä¸€æ¬¡ä¼šè¯ä½¿ç”¨ï¼ŒClient çš„ä¸‹ä¸€æ¬¡è¯·æ±‚åœ¨ Client Hello ä¸­å¸¦ä¸Š Session Ticketï¼ŒServer åˆ¤æ–­è¯¥ Session Ticket æœ‰æ•ˆä¸”æ­£ç¡®åˆ™å¯ä»¥è·³è¿‡æ¡æ‰‹ä¸­çš„éƒ¨åˆ†è¿‡ç¨‹</p><h4 id="Change-Cliper-Spec"><a href="#Change-Cliper-Spec" class="headerlink" title="Change Cliper Spec:"></a>Change Cliper Spec:</h4><ul><li>å‘ŠçŸ¥ Client åç»­çš„ä¿¡æ¯éƒ½é€šè¿‡ session-key è¿›è¡ŒåŠ å¯†</li></ul><h4 id="Finish-1"><a href="#Finish-1" class="headerlink" title="Finish:"></a>Finish:</h4><ul><li>å¯¹ä¸Šè¿°æ‰€æœ‰æ¡æ‰‹è¿‡ç¨‹ä¸­çš„æ•°æ®ä½¿ç”¨å•†é‡å¥½çš„ Hash ç®—æ³•è®¡ç®— HashCodeï¼Œå¹¶ä½¿ç”¨ session-key è¿›è¡ŒåŠ å¯†</li></ul><h3 id="Application-Data"><a href="#Application-Data" class="headerlink" title="Application Data"></a>Application Data</h3><p>è¿™ä¸€æ­¥ä¸ç®—æ˜¯ TLS çš„èŒƒç•´äº†è€Œæ˜¯ HTTP åè®®çš„èŒƒç•´<br>Client ä½¿ç”¨å•†é‡å‡ºæ¥çš„ session-key å¯¹æ•°æ®è¿›è¡Œå¯¹ç§°åŠ å¯†å‘é€ç»™ Server ï¼ŒServer æ¥æ”¶åˆ°æ•°æ®åä½¿ç”¨ session-key è¿›è¡Œè§£å¯†å¾—åˆ°æ˜æ–‡æ•°æ®ï¼Œå†å°†ç»“æœè¿›è¡ŒåŠ å¯†åè¿”å›ç»™ Client</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><blockquote><p>TLS çš„æ¡æ‰‹ç¤ºæ„è¿‡ç¨‹å¦‚ä¸‹</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">|----------Client----------|----------Server----------|</span><br><span class="line">|      Client Hello       --&gt;                         |</span><br><span class="line">|-----------------------------------------------------|</span><br><span class="line">|                          |     Server Hello         |</span><br><span class="line">|                          |     Certificate          |</span><br><span class="line">|                         &lt;--  Server Hello Done      |</span><br><span class="line">|-----------------------------------------------------|</span><br><span class="line">|   Client Key Exchange    |                          |</span><br><span class="line">|   Change Cipher Spec     |                          |</span><br><span class="line">|          Finish         --&gt;                         |</span><br><span class="line">|-----------------------------------------------------|</span><br><span class="line">|                          |    New Session Ticket    |</span><br><span class="line">|                          |    Change Cipher Spec    |</span><br><span class="line">|                         &lt;--         Finish          |</span><br><span class="line">|-----------------------------------------------------|</span><br><span class="line">|     Application Data    &lt;-&gt;      Application Data   |</span><br><span class="line">|-----------------------------------------------------|</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Wireshark æŠ“åŒ…çš„æ¡æ‰‹è¿‡ç¨‹<br><img src="https://i.loli.net/2021/11/17/yqW1mkZHCn5hKTI.jpg" alt="Xnip2020-07-12_15-26-06.jpg"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://network.51cto.com/art/202010/628890.htm">æ•°å­—è¯ä¹¦ã€ç­¾ååˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿè¿™ç¯‡æ–‡ç« è®²å¾—å¤ªå¥½äº†</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼ŒHTTP åè®®æ˜¯æ˜æ–‡ä¼ è¾“çš„ï¼Œåœ¨ç½‘ç»œä¸–ç•Œé‡Œç”¨ HTTP åè®®å‘é€æŠ¥æ–‡ç›¸å½“äºè£¸å¥”ï¼Œäºæ˜¯å°±æœ‰äº† HTTPS&lt;br&gt;è¿™ä¸ª S æ˜¯ä»€ä¹ˆå‘¢ï¼Œæ˜¯å¦‚ä½•ä¿è¯æˆ‘ä»¬å‘é€çš„æŠ¥æ–‡å°±ä¸è¢«çªƒå–å’Œç¯¡æ”¹äº†å‘¢ï¼Œè®©æˆ‘ä»¬æ…¢æ…¢é“æ¥&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="HTTP" scheme="https://ppting.me/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ tools å‘½åç©ºé—´å®ç° View çš„é¢„è§ˆ</title>
    <link href="https://ppting.me/2019/01/01/preview_recyclerview_in_preview_window/"/>
    <id>https://ppting.me/2019/01/01/preview_recyclerview_in_preview_window/</id>
    <published>2019-01-01T08:30:36.000Z</published>
    <updated>2022-02-12T08:19:55.000Z</updated>
    
    <content type="html"><![CDATA[<br><blockquote><p>ä½¿ç”¨ tools å‘½åç©ºé—´å®ç° View çš„é¢„è§ˆ</p></blockquote><p><a href="https://developer.android.google.cn/studio/write/tool-attributes">å®˜æ–¹æ–‡æ¡£</a></p><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦å¯¹ View è¿›è¡Œé¢„è§ˆï¼Œä»¥å‰éœ€è¦æŠŠ application run åˆ°æ‰‹æœºæˆ–è€…æ˜¯æ¨¡æ‹Ÿå™¨ä¸Šåæ‰èƒ½çœ‹åˆ°æ•ˆæœï¼Œç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†æ›´åŠ æ–¹ä¾¿å¿«æ·çš„æ–¹æ³•ã€‚</p><span id="more"></span><p>å¯¹äºä¸€ä¸ª <code>RecyclerView</code> æ¥è¯´ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šåœ¨ xml æ–‡ä»¶ä¸­å†™ä¸‹é¢è¿™æ ·çš„ä»£ç </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/rv_list&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ä¼šåœ¨<code>Android  Studio</code> å³è¾¹çš„é¢„è§ˆçª—å£ä¸­çœ‹åˆ°è¿™æ ·çš„ç”»é¢<br><img src="https://i.loli.net/2020/05/02/S7PseZAKHoquLbI.png" alt="Android_Studio_Preview_View_01.png"></p><p>è¿™æ—¶å€™æˆ‘ä»¬ä¼šåœ¨æƒ³ï¼Œèƒ½ä¸èƒ½æŠŠæˆ‘ä»¬çš„ item çš„å¸ƒå±€æ–‡ä»¶ä¹Ÿç»™å±•ç¤ºå‡ºæ¥å‘¢ï¼Œè¿™æ ·å°±å¯ä»¥é¢„è§ˆæ•ˆæœäº†ã€‚</p><p>å½“ç„¶å¯ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© tools å‘½åç©ºé—´æ¥å®ç°è¿™ä¸ªæƒ³æ³•ã€‚<br>è¦ä½¿ç”¨ <code>tools</code> çš„ä¸€äº› xml å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ xml æ–‡ä»¶çš„æ ¹å¸ƒå±€ä¸­æ·»åŠ  tools çš„å‘½åç©ºé—´ï¼Œå¦‚ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RootTag</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span> &gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ä½¿ç”¨ä¸€äº›å±æ€§äº†ã€‚</p><p>æˆ‘ä»¬ç»™ RecyclerView æ·»åŠ  <code>tools:listitem=&quot;@layout/xxxx&quot;</code> çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é¢„è§ˆåˆ°æ¯ä¸ª Item åœ¨ RecyclerView ä¸­çš„æ ·å­äº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://i.loli.net/2020/05/02/CrcQpP9RkfS4aBW.png" alt="Android_Studio_Preview_View_02.png"></p><p>ä½†è¿™æ—¶å€™ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ª item éƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ²¡æ³•é¢„è§ˆå’Œæ¨¡æ‹ŸçœŸå®çš„æƒ…æ™¯å‘€ã€‚<br>ä¸ç”¨æ€•ï¼ŒAndroid Studio 3.0 ç»™æˆ‘ä»¬æä¾›äº†è¿™ä¹ˆä¸€ä¸ªåŠŸèƒ½ã€‚</p><p>|<strong>â€œ@tools:sample&#x2F;*â€ resources</strong></p><p>æˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ª Item ä¸­ä½¿ç”¨è¿™äº›æä¾›ç»™æˆ‘ä»¬ä½¿ç”¨çš„èµ„æºæ–‡ä»¶ï¼Œè¿™äº›å±æ€§å…è®¸æ‚¨å°†å ä½ç¬¦æ•°æ®æˆ–å›¾åƒæ’å…¥åˆ°è§†å›¾ä¸­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¦æµ‹è¯•å¸ƒå±€å¦‚ä½•ä¸æ–‡æœ¬è¡Œä¸ºç›¸å…³ï¼Œä½†å°šæœªä¸ºåº”ç”¨ç¨‹åºå®šåˆ¶UIæ–‡æœ¬ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å ä½ç¬¦æ–‡æœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:text</span>=<span class="string">&quot;@tools:sample/lorem&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://i.loli.net/2020/05/02/9mjdkyTSoprqIga.png" alt="Android_Studio_Preview_View_03.png"></p><p>ç³»ç»Ÿç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šçš„ sample resource ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤º</p><table><thead><tr><th>Attribute value</th><th>Description of placeholder data</th></tr></thead><tbody><tr><td>@tools:sample&#x2F;full_names</td><td>Full names that are randomly generated from the combination of @tools:sample&#x2F;first_names and @tools:sample&#x2F;last_names.</td></tr><tr><td>@tools:sample&#x2F;first_names</td><td>Common first names.</td></tr><tr><td>@tools:sample&#x2F;last_names</td><td>Common last names.</td></tr><tr><td>@tools:sample&#x2F;cities</td><td>Names of cities from across the world.</td></tr><tr><td>@tools:sample&#x2F;us_zipcodes</td><td>Randomly generated US zipcodes.</td></tr><tr><td>@tools:sample&#x2F;us_phones</td><td>Randomly generated phone numbers with the following format: (800) 555-xxxx.</td></tr><tr><td>@tools:sample&#x2F;lorem</td><td>Placeholder text that is derived from Latin.</td></tr><tr><td>@tools:sample&#x2F;date&#x2F;day_of_week</td><td>Randomized dates and times for the specified format.</td></tr><tr><td>@tools:sample&#x2F;date&#x2F;ddmmyy</td><td></td></tr><tr><td>@tools:sample&#x2F;date&#x2F;mmddyy</td><td></td></tr><tr><td>@tools:sample&#x2F;date&#x2F;hhmm</td><td></td></tr><tr><td>@tools:sample&#x2F;date&#x2F;hhmmss</td><td></td></tr><tr><td>@tools:sample&#x2F;avatars</td><td>Vector drawables that you can use as profile avatars.</td></tr><tr><td>@tools:sample&#x2F;backgrounds&#x2F;scenic</td><td>Images that you can use as backgrounds.</td></tr></tbody></table><p>ä½†æ˜¯æˆ‘ä»¬è¿˜ä¼šå‘ç°ï¼Œæˆ‘ä»¬å…¶å®è¿œè¿œä¸æ»¡è¶³äºç³»ç»Ÿæä¾›çš„è¿™äº›æ¨¡æ‹Ÿèµ„æºæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å®šä¹‰ä¸€äº›æ•°æ®æ¥æºæ€ä¹ˆåŠï¼Ÿ</p><p>å½“ç„¶ä¹Ÿæ²¡é—®é¢˜</p><p>åœ¨ Android Studio ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ª <code>Sample Data Directory</code> æ–‡ä»¶å¤¹ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰ä¸€äº› json æ•°æ®æ¥æºï¼Œå¹¶ä¸”æ›´é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹é‡Œçš„èµ„æºæ–‡ä»¶å¹¶ä¸ä¼šè¢«æ‰“åŒ…åˆ°æˆ‘ä»¬çš„ apk æ–‡ä»¶ä¸­ã€‚<br><img src="https://i.loli.net/2020/05/02/jYuhBiIfso91Ew8.png" alt="Android_Studio_Preview_View_04.png"><br>ä¾‹å¦‚æˆ‘ä»¬æ–°å»ºä¸€ä¸ª <code>mockData.json</code> æ–‡ä»¶ï¼Œç”¨æ¥å­˜æ”¾æˆ‘ä»¬è¿™ä¸ª RecyclerView æ‰€å¯¹åº”çš„æ¨¡æ‹Ÿæ•°æ®ï¼Œæ¯”å¦‚è¯´</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;menus&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;menuUrl&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;menuIcon&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;menuName&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;showOrder&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;iconUrl&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;avatar&quot;</span>:<span class="string">&quot;@tools:sample/avatars&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;menuUrl&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;menuIcon&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;menuName&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;showOrder&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;iconUrl&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;avatar&quot;</span>:<span class="string">&quot;@tools:sample/avatars&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ç¼–è¾‘å®Œæ¯•åï¼Œæˆ‘ä»¬éœ€è¦ build ä¸€ä¸‹å·¥ç¨‹ï¼Œæ‰èƒ½å¼•ç”¨åˆ°è¿™é‡Œçš„æ•°æ®</p></blockquote><p>åœ¨ build å®Œæ¯•åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>tools:text=&quot;@sample/mockdata.json/menus/menuName&quot;</code> è¿™æ ·çš„æ–¹å¼å¼•ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ json é‡Œçš„æ•°æ®äº†</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„ item å¸ƒå±€æ˜¯è¿™æ ·çš„</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;94dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/item_work_icon&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;42dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;42dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:src</span>=<span class="string">&quot;@sample/mockdata.json/menus/avatar&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:scaleType</span>=<span class="string">&quot;centerCrop&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/item_work_text&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;9dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:text</span>=<span class="string">&quot;@sample/mockdata.json/menus/menuName&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨é¢„è§ˆçª—çœ‹åˆ°æˆ‘ä»¬çš„é¢„è§ˆé¡µé¢æ˜¯è¿™æ ·çš„ï¼Œå·²ç»å°†æ–‡å­—æ›¿æ¢æˆæˆ‘ä»¬è‡ªå®šä¹‰çš„ json æ–‡ä»¶é‡Œçš„æ•°æ®äº†ã€‚</p><p><img src="https://i.loli.net/2020/05/02/uCfRzJpXcsQZVke.png" alt="Android_Studio_Preview_View_05.png"></p><p>æ¥ç€å†æ¥çœ‹æˆ‘ä»¬çš„ RecyclerView çš„é¢„è§ˆçª—å£ï¼Œæˆ‘ä»¬æŠŠ RecyclerView çš„ <code>tools:listitem</code> çš„å€¼æ¢æˆæˆ‘ä»¬ä¸Šé¢çš„è¿™ä¸ªå¸ƒå±€ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„é¢„è§ˆçª—å£å˜æˆäº†è¿™æ ·<br><img src="https://i.loli.net/2020/05/02/YHUA7FBm4Mxeh8G.png" alt="Android_Studio_Preview_View_06.png"><br>é»˜è®¤çš„ RecyclerView æ˜¯ä½¿ç”¨å‚ç›´çš„LinearLayoutManagerï¼Œé‚£å¦‚æœæˆ‘ä»¬æƒ³ä¿®æ”¹æˆä¹å®«æ ¼çš„å‘¢ï¼Œä¹Ÿæ²¡é—®é¢˜ã€‚</p><p>RecyclerView ä¸­æä¾›äº†ä¸‹é¢çš„å‡ ä¸ªå±æ€§å¯ä¾›æˆ‘ä»¬ä¿®æ”¹ã€‚</p><table><thead><tr><th>å±æ€§</th><th>ä»‹ç»</th><th>å€¼</th></tr></thead><tbody><tr><td>itemCount</td><td>è®¾ç½®å±•ç¤º item çš„æ•°é‡</td><td>æ•°å­—ï¼Œä¾‹å¦‚6</td></tr><tr><td>layoutManager</td><td>è®¾ç½®å¸ƒå±€æ–¹å¼ï¼Œä¸‰ç§æ–¹å¼å¯ä¾›é€‰æ‹©</td><td>GridLayoutManagerã€LinearLayoutManager ä»¥åŠ StaggeredGridLayoutManager</td></tr><tr><td>listitem</td><td>item çš„å¸ƒå±€</td><td>@layout&#x2F;xxxx</td></tr><tr><td>orientation</td><td>å¸ƒå±€çš„æ–¹å‘</td><td>horizontal vertical</td></tr><tr><td>spanCount</td><td>å¸ƒå±€æ¨ªã€çºµçš„åˆ—æ•°</td><td>æ•°å­—ï¼Œä¾‹å¦‚3</td></tr></tbody></table><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æˆ‘ä»¬çš„ RecyclerView æ˜¯è¦ä½œä¸ºä¹å®«æ ¼èœå•ä½¿ç”¨çš„ï¼Œå¹³æ—¶æˆ‘ä»¬åªèƒ½åœ¨ Java ä»£ç ä¸­è®¾ç½®å…¶ LayoutManager ä»¥åŠ spanCount ï¼Œç­‰åˆ°è·‘åœ¨æ‰‹æœºä¸Šä»¥åæˆ‘ä»¬æ‰èƒ½é¢„è§ˆåˆ°æ•ˆæœï¼Œä½†ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ tools å°†è¿™ä¸ªæ­¥éª¤åœ¨å¼€å‘é˜¶æ®µå°±æå‰ï¼Œåœ¨ç¼–å†™ xml æ–‡ä»¶æ—¶å€™å°±å¯ä»¥ç›´æ¥é¢„è§ˆäº†ï¼Œä¾‹å¦‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">android.support.v7.widget.RecyclerView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/rv_third_list&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:listitem</span>=<span class="string">&quot;@layout/item_menu&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:layoutManager</span>=<span class="string">&quot;GridLayoutManager&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:spanCount</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>é¢„è§ˆå›¾å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://i.loli.net/2020/05/02/2hsRXOJ57qadmpI.png" alt="Android_Studio_Preview_View_07.png"></p>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;blockquote&gt;
&lt;p&gt;ä½¿ç”¨ tools å‘½åç©ºé—´å®ç° View çš„é¢„è§ˆ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://developer.android.google.cn/studio/write/tool-attributes&quot;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦å¯¹ View è¿›è¡Œé¢„è§ˆï¼Œä»¥å‰éœ€è¦æŠŠ application run åˆ°æ‰‹æœºæˆ–è€…æ˜¯æ¨¡æ‹Ÿå™¨ä¸Šåæ‰èƒ½çœ‹åˆ°æ•ˆæœï¼Œç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†æ›´åŠ æ–¹ä¾¿å¿«æ·çš„æ–¹æ³•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
    <category term="Trick" scheme="https://ppting.me/tags/Trick/"/>
    
    <category term="RecyclerView" scheme="https://ppting.me/tags/RecyclerView/"/>
    
  </entry>
  
  <entry>
    <title>HashMap æºç é˜…è¯»ç¬”è®°</title>
    <link href="https://ppting.me/2018/06/07/hashmap/"/>
    <id>https://ppting.me/2018/06/07/hashmap/</id>
    <published>2018-06-07T15:01:16.000Z</published>
    <updated>2022-02-12T08:17:37.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="ä½è¿ç®—ç¬¦"><a href="#ä½è¿ç®—ç¬¦" class="headerlink" title="ä½è¿ç®—ç¬¦"></a>ä½è¿ç®—ç¬¦</h3><ul><li>ä½ä¸ <code>&amp;</code></li></ul><blockquote><p>1 &amp; 1 &#x3D; 1 ï¼Œå…¶ä½™éƒ½æ˜¯ 0 </p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sample : </span><br><span class="line">0011</span><br><span class="line">1010</span><br><span class="line">0010</span><br><span class="line">å³ `3 &amp; 10 = 2`</span><br></pre></td></tr></table></figure><span id="more"></span><ul><li>ä½æˆ– <code>|</code></li></ul><blockquote><p>0 | 0 &#x3D; 0 ï¼Œå…¶ä½™éƒ½æ˜¯ 1</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sample : </span><br><span class="line">0011</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">å³ `3 | 10 = 11`</span><br></pre></td></tr></table></figure><ul><li>ä½å¼‚æˆ– <code>^</code></li></ul><blockquote><p>ç›¸åŒä¸º 0ï¼Œ ä¸åŒä¸º1</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sample : </span><br><span class="line">0011</span><br><span class="line">1010</span><br><span class="line">1001</span><br><span class="line">å³ `3 ^ 10 = 9`</span><br></pre></td></tr></table></figure><ul><li>é <code>~</code></li></ul><blockquote><p>æŒ‰ä½å–å</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sample : </span><br><span class="line">0011</span><br><span class="line">1100</span><br><span class="line">å³ `~3 = -4`</span><br></pre></td></tr></table></figure><p><strong>Tips</strong></p><blockquote><p><code>&amp;</code> æ˜¯éƒ½å¾—ä¸º1æ‰èƒ½å¾—åˆ°1 ï¼Œ<code>|</code> æ˜¯åªè¦æœ‰1å°±ä¸º1ï¼Œ<code>^</code> æ˜¯ç›¸åŒåˆ™ä¸º 0ï¼Œä¸åŒåˆ™ä¸º 1ã€‚</p></blockquote><ul><li>åŸç <br>ç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ï¼Œ<code>1</code> æ˜¯è´Ÿæ•°ï¼Œ<code>0</code>æ˜¯æ­£æ•°</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1000,1000 æ˜¯ -8</span><br><span class="line">0000,1000 æ˜¯ +8</span><br></pre></td></tr></table></figure><p>å› æ­¤å¯ç”¨çš„èŒƒå›´åªæ˜¯åä¸ƒä½ï¼Œå³8è¿›åˆ¶çš„æ•°å€¼èŒƒå›´æ˜¯ [1111 1111,0111 1111]ï¼Œç”¨åè¿›åˆ¶è¡¨ç¤ºæ˜¯ -(2^7 -1) ~ (2^7 -1 ) å³ [-127,127]</p><ul><li>åç </li></ul><p>æ­£æ•°çš„åç æ˜¯å…¶åŸç æœ¬èº«<br>è´Ÿæ•°çš„åç æ˜¯åœ¨ç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™çš„æŒ‰ä½å–å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+10ï¼š[0000 1010]åŸ == [0000 1010]å</span><br><span class="line">-10ï¼š[1000 1010]åŸ == [1111 0101]å</span><br></pre></td></tr></table></figure><ul><li>è¡¥ç </li></ul><p>æ­£æ•°çš„è¡¥ç æ˜¯å…¶åŸç æœ¬èº«<br>è´Ÿæ•°çš„è¡¥ç æ˜¯ç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™çš„æŒ‰ä½å–åï¼Œå†åŠ ä¸€ã€‚å³</p><blockquote><p>[è´Ÿæ•°çš„è¡¥ç ] &#x3D; [è´Ÿæ•°çš„åç ] + 1;</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+10ï¼š[0000 1010]åŸ == [0000 1010]å == [0000 1010]è¡¥</span><br><span class="line">-10ï¼š[1000 1010]åŸ == [1111 0101]å == [1111 0110]è¡¥</span><br></pre></td></tr></table></figure><ul><li>å·¦ç§» <code>&lt;&lt;</code></li></ul><blockquote><p>é€»è¾‘å·¦ç§» N ä½ï¼Œç©ºç¼ºéƒ¨åˆ†è¡¥ 0 </p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 &lt;&lt; 3 == 8;</span><br><span class="line">å³ 0001 =&gt; 1000</span><br></pre></td></tr></table></figure><ul><li>æ— ç¬¦å·å³ç§» <code>&gt;&gt;&gt;</code></li></ul><blockquote><p>é€»è¾‘å³ç§» N ä½ï¼Œç©ºç¼ºéƒ¨åˆ†è¡¥ 0 </p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">8 &gt;&gt;&gt; 3 == 1;</span><br><span class="line">å³ 1000 =&gt; 0001</span><br></pre></td></tr></table></figure><ul><li>æœ‰ç¬¦å·å³ç§» <code>&gt;&gt;</code></li></ul><blockquote><p>å·¦è¾¹çš„ç©ºå‡ºçš„æ‰€æœ‰ä½æ•°æ ¹æ®ç§»ä½å‰åŸæ¥çš„å†…å®¹ï¼ŒåŸæ¥ä¸º0å°±è¡¥0ï¼ŒåŸæ¥ä¸º1å°±è¡¥1</p></blockquote><p><em><strong>æ³¨æ„</strong></em>ï¼š<em>è´Ÿæ•°æ˜¯ä½¿ç”¨è¡¥ç è¿›è¡Œè®¡ç®—</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-8 &gt;&gt;&gt; 3 (-8 æ— ç¬¦å·å³ç§» 3 ä½)</span><br><span class="line">-8 ==</span><br><span class="line">[1000,0000,0000,0000,0000,0000,0000,1000]åŸ</span><br><span class="line">[1111,1111,1111,1111,1111,1111,1111,0111]å</span><br><span class="line">[1111,1111,1111,1111,1111,1111,1111,1000]è¡¥</span><br><span class="line">å³ç§»ä¸‰ä½(é«˜ä½è¡¥å……0) =&gt;</span><br><span class="line">[0001,1111,1111,1111,1111,1111,1111,1111]è¡¥</span><br><span class="line">[0001,1111,1111,1111,1111,1111,1111,1111]å</span><br><span class="line">[0001,1111,1111,1111,1111,1111,1111,1111]åŸ</span><br><span class="line">== 2^29 -1</span><br><span class="line"></span><br><span class="line">-8 &gt;&gt; 3 (-8 æœ‰ç¬¦å·å³ç§» 3 ä½)</span><br><span class="line">-8 == </span><br><span class="line">[1000,0000,0000,0000,0000,0000,0000,1000]åŸ</span><br><span class="line">[1111,1111,1111,1111,1111,1111,1111,0111]å</span><br><span class="line">[1111,1111,1111,1111,1111,1111,1111,1000]è¡¥</span><br><span class="line">å³ç§»ä¸‰ä½(æ ¹æ®åŸå†…å®¹è¡¥å……) =&gt;</span><br><span class="line">[1111,1111,1111,1111,1111,1111,1111,1111]è¡¥</span><br><span class="line">[1111,1111,1111,1111,1111,1111,1111,1110]å</span><br><span class="line">[1000,0000,0000,0000,0000,0000,0000,0001]åŸ</span><br><span class="line">== -1</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>Tips</strong></p><p>å¯¹äºæ­£æ•° x æ¥è¯´ï¼Œ<br>å·¦ç§» n ä½<code>&lt;&lt;</code>ç›¸å½“äº <code>x * 2^n</code>ï¼Œ<br>å³ç§» n ä½<code>&gt;&gt;</code>ç›¸å½“äº <code>x mod 2^n</code>ï¼Œå–ä½™<br>æ— ç¬¦å·å³ç§» n ä½ <code>&gt;&gt;&gt;</code>ç›¸å½“äº <code>x mod 2^n</code>ï¼Œå–ä½™</p><p>å¯¹è´Ÿæ•° y æ¥è¯´ï¼Œ<br>å·¦ç§» n ä½<code>&lt;&lt;</code>ç›¸å½“äº <code>y * 2^n</code>ï¼Œ<br>å³ç§» n ä½<code>&gt;&gt;</code>ç›¸å½“äº </p><h3 id="HashMap-çš„åŸºæœ¬åŸç†"><a href="#HashMap-çš„åŸºæœ¬åŸç†" class="headerlink" title="HashMap çš„åŸºæœ¬åŸç†"></a>HashMap çš„åŸºæœ¬åŸç†</h3><h3 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h3><h4 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h4><ul><li>DEFAULT_INITIAL_CAPACITY</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The default initial capacity - MUST be a power of two.</span><br><span class="line"> * é»˜è®¤åˆå§‹åŒ–å®¹é‡ï¼Œå¿…é¡»æ˜¯2çš„å¹‚</span><br><span class="line"> */</span><br><span class="line"> </span><br><span class="line">static final int DEFAULT_INITIAL_CAPACITY = 4;//JDK7</span><br><span class="line">static final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; //å³16 JDK8 </span><br></pre></td></tr></table></figure><ul><li>MAXIMUM_CAPACITY</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The maximum capacity, used if a higher value is implicitly specified</span><br><span class="line"> * by either of the constructors with arguments.</span><br><span class="line"> * MUST be a power of two &lt;= 1&lt;&lt;30.</span><br><span class="line"> * æœ€å¤§çš„å®¹é‡ï¼Œå¿…é¡»æ˜¯2çš„å¹‚ï¼Œå¹¶ä¸”åœ¨ [2,2^30]ä¹‹é—´</span><br><span class="line"> * int å‹çš„æœ€å¤§å€¼ä¸º 2^31 -1 ï¼Œä½† HashMap çš„å®¹é‡å¿…é¡»æ˜¯ 2 çš„å¹‚ï¼Œæ‰€ä»¥æœ€å¤§å€¼åªèƒ½æ˜¯ 2^30</span><br><span class="line"> */</span><br><span class="line">static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;</span><br></pre></td></tr></table></figure><ul><li>DEFAULT_LOAD_FACTOR</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The load factor used when none specified in constructor.</span><br><span class="line"> * é»˜è®¤çš„è´Ÿè½½å› å­å€¼ï¼Œç”¨æ¥è®¡ç®—æ‰©å®¹çš„ä¸´ç•Œå€¼ï¼Œ0.75f</span><br><span class="line"> */</span><br><span class="line">static final float DEFAULT_LOAD_FACTOR = 0.75f;</span><br></pre></td></tr></table></figure><ul><li>EMPTY_TABLE</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * An empty table instance to share when the table is not inflated.</span><br><span class="line"> * å½“ table è¿˜æ²¡æ‰©å®¹æ—¶çš„å®ä¾‹ï¼Œå³ä¸€ä¸ªç©ºçš„table</span><br><span class="line"> */</span><br><span class="line">static final HashMapEntry&lt;?,?&gt;[] EMPTY_TABLE = &#123;&#125;;</span><br></pre></td></tr></table></figure><ul><li>table ;HashMap ä¸­çš„å­˜æ”¾é”®å€¼å¯¹çš„å•é“¾è¡¨æ•°ç»„</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The table, resized as necessary. Length MUST Always be a power of two.</span><br><span class="line"> * å¯ä»¥éšæ—¶è°ƒæ•´çš„ tableï¼Œé•¿åº¦å¿…é¡»æ˜¯2çš„å¹‚</span><br><span class="line"> */</span><br><span class="line">transient HashMapEntry&lt;K,V&gt;[] table = (HashMapEntry&lt;K,V&gt;[]) EMPTY_TABLE;</span><br></pre></td></tr></table></figure><ul><li>size</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The number of key-value mappings contained in this map.</span><br><span class="line"> * è¿™ä¸ª map ä¸­é”®å€¼å¯¹çš„æ•°é‡</span><br><span class="line"> */</span><br><span class="line">transient int size;</span><br></pre></td></tr></table></figure><ul><li>threshold</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The next size value at which to resize (capacity * load factor).</span><br><span class="line"> * ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å€¼ï¼Œå³é˜ˆå€¼ï¼Œç­‰äºæœ€å¤§å®¹é‡ * è´Ÿè½½å› å­</span><br><span class="line"> * @serial</span><br><span class="line"> */</span><br><span class="line">// If table == EMPTY_TABLE then this is the initial capacity at which the</span><br><span class="line">// table will be created when inflated.</span><br><span class="line">//å¦‚æœ table æ˜¯ç©ºçš„æ—¶å€™ï¼Œå³ table == EMPTY_TABLE ï¼Œ threshold çš„å€¼å°±æ˜¯ table æ‰©å®¹æ—¶çš„åˆå§‹å®¹é‡</span><br><span class="line">int threshold;</span><br></pre></td></tr></table></figure><ul><li>loadFactor</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The load factor for the hash table.</span><br><span class="line"> * hash table çš„è´Ÿè½½å› å­</span><br><span class="line"> * @serial</span><br><span class="line"> */</span><br><span class="line">// Android-Note: We always use a load factor of 0.75 and ignore any explicitly</span><br><span class="line">// selected values.</span><br><span class="line">//Android-Note: ä½¿ç”¨ 0.75 è¿™ä¸ªå›ºå®šçš„å€¼ï¼Œå¿½ç•¥å…¶ä»–æ˜ç¡®çš„å€¼</span><br><span class="line">final float loadFactor = DEFAULT_LOAD_FACTOR;</span><br></pre></td></tr></table></figure><ul><li>modCount</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HashMap çš„ç»“æ„è¢«ä¿®æ”¹çš„æ¬¡æ•°</span><br><span class="line">ç»“æ„ä¿®æ”¹æŒ‡çš„æ˜¯é‚£äº› HashMap ä¸­æ˜ å°„æ•°é‡æˆ–è€…æ˜¯å…¶å†…éƒ¨ç»“æ„(æ¯”å¦‚ rehash)çš„ä¿®æ”¹</span><br></pre></td></tr></table></figure><h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><p>å¥½äº†ï¼Œç°åœ¨å¼€å§‹æ¥çœ‹æ„é€ å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructs an empty &lt;tt&gt;HashMap&lt;/tt&gt; with the specified initial</span></span><br><span class="line"><span class="comment"> * capacity and load factor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  initialCapacity the initial capacity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  loadFactor      the load factor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity is negative</span></span><br><span class="line"><span class="comment"> *         or the load factor is nonpositive</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal initial capacity: &quot;</span> +</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity &lt; DEFAULT_INITIAL_CAPACITY) &#123;</span><br><span class="line">        initialCapacity = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                           loadFactor);</span><br><span class="line">    <span class="comment">// Android-Note: We always use the default load factor of 0.75f.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This might appear wrong but it&#x27;s just awkward design. We always call</span></span><br><span class="line">    <span class="comment">// inflateTable() when table == EMPTY_TABLE. That method will take &quot;threshold&quot;</span></span><br><span class="line">    <span class="comment">// to mean &quot;capacity&quot; and then replace it with the real threshold (i.e, multiplied with</span></span><br><span class="line">    <span class="comment">// the load factor).</span></span><br><span class="line">    threshold = initialCapacity;</span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯åˆå§‹å®¹é‡(initialCapacity)ï¼Œä¸€ä¸ªæ˜¯è´Ÿè½½å› å­(loadFactor)</p><p>ä»ä»£ç ä¸­å¯è§ï¼Œå‰é¢éƒ½æ˜¯åœ¨è¿›è¡Œåˆ¤æ–­è¿™ä¸¤ä¸ªå€¼çš„åˆæ³•æ€§ï¼Œæ¯”å¦‚åˆå§‹å®¹é‡å¿…é¡»å¤§äºç­‰äº0ï¼Œå¦‚æœå¤§äºå¯å®¹çº³çš„æœ€å¤§å®¹é‡ï¼Œåˆ™èµ‹å€¼ä¸ºæœ€å¤§å€¼<code>MAXIMUM_CAPACITY(2^30)</code> ï¼Œå¦‚æœå°äºé»˜è®¤çš„å®¹é‡ï¼Œåˆ™èµ‹å€¼ä¸ºæœ€å°å®¹é‡ã€‚<br>è´Ÿè½½å› å­çš„å¿…é¡»å¤§äº0ï¼Œå¹¶ä¸”æ˜¯ä¸ªæµ®ç‚¹æ•°(Float)</p><p>æœ€åä¸€æ­¥å°†åˆå§‹å®¹é‡èµ‹å€¼ç»™ threshold<br><code>init()</code> æ–¹æ³•æ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œå¿½ç•¥ä¸è®¡</p><h2 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put æ–¹æ³•"></a>put æ–¹æ³•</h2><p>å‘ HashMap ä¸­æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå¹¶è¿”å› value</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å½“ table æ˜¯ç©ºçš„æ—¶å€™ï¼Œå¯¹ table è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">            inflateTable(threshold);<span class="comment">//â‘ </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœkey æ˜¯ nullï¼Œåˆ™æ”¾å…¥ valueå¹¶è¿”å›æ—§çš„å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> putForNullKey(value);<span class="comment">//â‘¡</span></span><br><span class="line">        <span class="comment">//key ä¸ä¸º nullï¼Œè®¡ç®— key çš„ hash å€¼</span></span><br><span class="line">        <span class="keyword">int</span> hash = </span><br><span class="line">sun.misc.Hashing.singleWordWangJenkinsHash(key);</span><br><span class="line">        <span class="comment">//é€šè¿‡ key çš„ hash å€¼å’Œæ•°ç»„ table çš„é•¿åº¦è®¡ç®—å‡ºè¿™ä¸ª`é”®å€¼å¯¹`åº”åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•å€¼</span></span><br><span class="line">        <span class="keyword">int</span> i = indexFor(hash, table.length);<span class="comment">//â‘¢</span></span><br><span class="line">        <span class="comment">//è·å–åˆ°å½“å‰ç´¢å¼•å€¼å­˜æ”¾çš„é“¾è¡¨ï¼Œå¹¶è¿›è¡Œå¾ªç¯</span></span><br><span class="line">        <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            Object k;</span><br><span class="line">            <span class="comment">//å¦‚æœè¯¥é“¾è¡¨ä¸Šæœ‰ä¸€ä¸ªé”®å€¼å¯¹ e ï¼Œå¹¶ä¸”è¿™ä¸ªé”®å€¼å¯¹ e çš„ hash å€¼å’Œæ–°æ”¾å…¥çš„é”®å€¼å¯¹çš„hashç›¸åŒï¼Œå¹¶ä¸”keyå€¼ä¹Ÿç›¸åŒï¼Œåˆ™å°†æ–°çš„ value æ›¿æ¢æ—§çš„ valueï¼Œå¹¶è¿”å›æ—§çš„ value å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">                V oldValue = e.value;</span><br><span class="line">                e.value = value;</span><br><span class="line">                e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦åˆ™ï¼Œå³å½“å‰é“¾è¡¨ä¸Šæ²¡æœ‰ key å€¼ä»¥åŠ hash å€¼ç›¸åŒçš„é”®å€¼å¯¹ï¼Œåˆ™ modCount è‡ªå¢</span></span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="comment">//æ–°å¢ä¸€ä¸ªé”®å€¼å¯¹</span></span><br><span class="line">        addEntry(hash, key, value, i);<span class="comment">//â‘£</span></span><br><span class="line">        <span class="comment">//è¿”å› null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>â‘  å…ˆçœ‹ <code>inflateTable(int toSize)</code> æ–¹æ³•</p><ul><li>å…ˆè®¡ç®— table çš„å®¹é‡</li><li>å†è®¡ç®—æ–°çš„é˜ˆå€¼</li><li>åˆ›å»º table å¯¹è±¡ï¼Œå³ HashMapEntry æ•°ç»„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ‰©å®¹ table ï¼ŒtoSize æ˜¯è¦æ‰©å¤§åˆ°çš„å®¹é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inflateTable</span><span class="params">(<span class="keyword">int</span> toSize)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Find a power of 2 &gt;= toSize</span></span><br><span class="line">    <span class="comment">//è®¡ç®— table çš„å®¹é‡ï¼Œå› ä¸ºå¿…é¡»æ˜¯2çš„å¹‚ï¼Œæ‰€ä»¥é€šè¿‡ roundUpToPowerOf2() æ–¹æ³•è®¡ç®—å‡ºå¤§äºç­‰äº toSize å€¼çš„ 2çš„å¹‚</span></span><br><span class="line">    <span class="keyword">int</span> capacity = roundUpToPowerOf2(toSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Android-changed: Replace usage of Math.min() here because this method is</span></span><br><span class="line">    <span class="comment">// called from the &lt;clinit&gt; of runtime, at which point the native libraries</span></span><br><span class="line">    <span class="comment">// needed by Float.* might not be loaded.</span></span><br><span class="line">    <span class="comment">//å†è®¡ç®—æ–°çš„é˜ˆå€¼ï¼Œå³ table å®¹é‡ * è´Ÿè½½å› å­ï¼Œå¦‚æœè¶…è¿‡äº†æœ€å¤§çš„å®¹é‡ï¼Œåˆ™å°†é˜ˆå€¼è®¾ç½®ä¸º table æœ€å¤§å€¼ + 1</span></span><br><span class="line">    <span class="keyword">float</span> thresholdFloat = capacity * loadFactor;</span><br><span class="line">    <span class="keyword">if</span> (thresholdFloat &gt; MAXIMUM_CAPACITY + <span class="number">1</span>) &#123;</span><br><span class="line">        thresholdFloat = MAXIMUM_CAPACITY + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    threshold = (<span class="keyword">int</span>) thresholdFloat;</span><br><span class="line">    <span class="comment">// æ–°å»ºä¸€ä¸ª HashMapEntry å¯¹è±¡ï¼Œå³ table</span></span><br><span class="line">    table = <span class="keyword">new</span> HashMapEntry[capacity];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â‘¡ å†æ¥ç€çœ‹ <code>putForNullKey(V value)</code> æ–¹æ³•</p><blockquote><p>å¯è§ HashMap æ˜¯å¯ä»¥å­˜å…¥é”®å€¼(key) ä¸º <code>null</code> çš„é”®å€¼å¯¹çš„ï¼Œå¹¶ä¸”ä¼šå°† <code>key = null</code> çš„é”®å€¼å¯¹æ”¾åˆ°æ•°ç»„çš„ç¬¬ä¸€ä½ï¼Œå³ <code>table[0]</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Offloaded version of put for null keys</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> V <span class="title">putForNullKey</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å–å‡ºæ•°ç»„ä¸­ç´¢å¼•ä¸º 0 çš„é“¾è¡¨ï¼Œè¿›è¡Œå¾ªç¯ï¼Œ</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœé“¾è¡¨ä¸­æœ‰ key ä¸º null çš„é”®å€¼å¯¹ï¼Œå³è¯¥ HashMap ä¸­æœ‰ key ä¸º null çš„é”®å€¼å¯¹ï¼Œåˆ™å°†æ–°å€¼æ›¿æ¢æ—§å€¼ï¼Œå¹¶è¿”å›æ—§å€¼ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (e.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœåŸæ¥é“¾è¡¨ä¸­æ²¡æœ‰ key ä¸º null çš„é”®å€¼å¯¹ï¼Œå°† modCount è‡ªå¢</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">//å¹¶å‘é“¾è¡¨ä¸­æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹</span></span><br><span class="line">    addEntry(<span class="number">0</span>, <span class="keyword">null</span>, value, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//è¿”å› null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â‘¢ å†çœ‹è®¡ç®—ç´¢å¼•çš„æ–¹æ³• <code>indexFor(int hash, int length)</code><br>hash -&gt; hash å€¼<br>length -&gt; æ•°ç»„é•¿åº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns index for hash code h.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> h, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert Integer.bitCount(length) == 1 : &quot;length must be a non-zero power of 2&quot;;</span></span><br><span class="line">    <span class="comment">//å³ç›¸å½“äº h % lengthï¼Œå–ä½™æ•°</span></span><br><span class="line">    <span class="keyword">return</span> h &amp; (length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â‘£ æ¥ç€çœ‹ <code>addEntry(int hash, K key, V value, int bucketIndex)</code> æ–¹æ³•<br>è¿™ä¸ªæ–¹æ³•æœ‰å››ä¸ªå…¥å‚åˆ†åˆ«æ˜¯</p><table><thead><tr><th>å…¥å‚</th><th>æ„ä¹‰</th></tr></thead><tbody><tr><td>hash</td><td>key çš„ hash å€¼</td></tr><tr><td>key</td><td>key(é”®)</td></tr><tr><td>value</td><td>value(å€¼)</td></tr><tr><td>bucketIndex</td><td>è¯¥é”®å€¼å¯¹åº”è¯¥æ”¾åœ¨ table ä¸­çš„ç´¢å¼•</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å½“å‰çš„é”®å€¼å¯¹æ•°é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="keyword">null</span> != table[bucketIndex])) &#123;</span><br><span class="line">        <span class="comment">//å½“å‰çš„é”®å€¼å¯¹æ•°é‡å¤§äºé˜ˆå€¼ï¼Œä¸”è¯¥é”®å€¼å¯¹åº”æ”¾å…¥çš„ç´¢å¼•ä½ç½®çš„é“¾è¡¨ä¸ä¸ºç©ºï¼ˆå³å‘ç”Ÿäº† hash ç¢°æ’ï¼‰ï¼Œåˆ™è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œæ‰©å®¹2å€</span></span><br><span class="line">        resize(<span class="number">2</span> * table.length);<span class="comment">//â‘¤</span></span><br><span class="line">        <span class="comment">//é‡æ–°è®¡ç®— hash å€¼</span></span><br><span class="line">        hash = (<span class="keyword">null</span> != key) ? sun.misc.Hashing.singleWordWangJenkinsHash(key) : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//é‡æ–°è®¡ç®—åœ¨æ‰©å®¹åçš„ table ä¸­çš„ç´¢å¼•</span></span><br><span class="line">        bucketIndex = indexFor(hash, table.length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°çš„èŠ‚ç‚¹</span></span><br><span class="line">    createEntry(hash, key, value, bucketIndex);<span class="comment">//â‘¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â‘¤ ä¸‹é¢çœ‹ <code>resize(int newCapacity)</code> æ‰©å®¹çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡å­˜æ”¾åŸæ¥çš„ table çš„å¼•ç”¨</span></span><br><span class="line">    HashMapEntry[] oldTable = table;</span><br><span class="line">    <span class="comment">//ç®—å‡ºæ—§ table çš„é•¿åº¦ï¼Œå³æ—§ table çš„å®¹é‡</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">    <span class="comment">//å¦‚æœä¹‹å‰çš„å®¹é‡å·²ç»è¾¾åˆ°æœ€å¤§äº†ï¼Œä¿®æ”¹é˜ˆå€¼ä¸ºæœ€å¤§å€¼å¹¶è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å®¹é‡è¿˜æ²¡è¾¾åˆ°æœ€å¤§ï¼Œæ–°å»ºä¸€ä¸ª table (é“¾è¡¨æ•°ç»„)ï¼Œé•¿åº¦ä¸ºæ–°çš„å®¹é‡(newCapacity)</span></span><br><span class="line">    HashMapEntry[] newTable = <span class="keyword">new</span> HashMapEntry[newCapacity];</span><br><span class="line">    <span class="comment">//è½¬ç§»æ–°çš„é”®å€¼å¯¹ï¼Œå°†åŸæ¥çš„é”®å€¼å¯¹è½¬ç§»åˆ°æ–°çš„ table ä¸­</span></span><br><span class="line">    transfer(newTable);<span class="comment">//â‘¦</span></span><br><span class="line">    <span class="comment">//å°†æ–°çš„ table(newTable) çš„å¼•ç”¨èµ‹å€¼ç»™ table</span></span><br><span class="line">    table = newTable;</span><br><span class="line">    <span class="comment">//è®¡ç®—æ–°çš„é˜ˆå€¼ï¼Œå³ï¼ˆæ–°çš„å®¹é‡ * è´Ÿè½½å› å­ï¼‰æˆ–è€…æ˜¯ï¼ˆæœ€å¤§å®¹é‡ + 1ï¼‰çš„æœ€å°å€¼</span></span><br><span class="line">    threshold = (<span class="keyword">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â‘¦ <code>transfer()</code> è½¬ç§»åˆ°æ–° table çš„æ–¹æ³•</p><blockquote><p>æ³¨æ„ï¼Œè¿™ä»½æ–¹æ³•åœ¨è½¬ç§»é”®å€¼å¯¹åˆ°æ–°çš„tableä¸­æ—¶ï¼Œä¼šå°†é“¾è¡¨çš„é¡ºåºç»™å€’åºäº†ï¼Œæ’å…¥æ—¶æ’åˆ°é“¾è¡¨çš„æœ€å‰é¢<br>å³åŸæ¥é“¾è¡¨æ˜¯ [A] -&gt; [B] -&gt; [C]ï¼Œè½¬ç§»åˆ°æ–°çš„é“¾è¡¨åå˜æˆ [C] -&gt; [B] -&gt; [A] {å‡è®¾æ‰©å®¹åè¿™ä¸‰ä¸ªé”®å€¼å¯¹çš„ hash ç´¢å¼•è¿˜ç›¸åŒ}</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(HashMapEntry[] newTable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è®¡ç®—æ–°çš„ table çš„å®¹é‡</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">    <span class="comment">//å¯¹æ—§çš„ table æ•°ç»„è¿›è¡Œå¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">        <span class="comment">//ä¸‹é¢å¯¹é“¾è¡¨è¿›è¡Œå¾ªç¯</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">null</span> != e) &#123;</span><br><span class="line">            HashMapEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">            <span class="comment">//è®¡ç®—å½“å‰èŠ‚ç‚¹åœ¨æ–° table ä¸­çš„ç´¢å¼•å€¼</span></span><br><span class="line">            <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);</span><br><span class="line">            <span class="comment">//å–æ–°çš„ table ä¸­ç¬¬iä¸ªä½ç½®çš„é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªé”®å€¼å¯¹ï¼Œèµ‹å€¼ç»™ e.next</span></span><br><span class="line">            e.next = newTable[i];<span class="comment">//â‘ </span></span><br><span class="line">            <span class="comment">//å°†å½“å‰çš„ é”®å€¼å¯¹ æ”¾å…¥æ–° table çš„ç¬¬ä¸€ä¸ªä½ç½®</span></span><br><span class="line">            newTable[i] = e;<span class="comment">//â‘¡</span></span><br><span class="line">            <span class="comment">//å°†åŸæ¥çš„é“¾è¡¨ä¸Šçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹èµ‹å€¼ç»™ e</span></span><br><span class="line">            e = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›¾è§£<br><img src="https://i.loli.net/2020/05/02/GIUbRardgenqSyQ.png" alt="HashMap_transfer.png"></p><p>åœ¨ for å¾ªç¯æ—¶ï¼Œe æŒ‡å‘æ—§ table æ•°ç»„ä¸­çš„æŸæ¡é“¾è¡¨</p><ul><li><p>ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œe æŒ‡å‘è¯¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ªé”®å€¼å¯¹ï¼Œnext æŒ‡å‘ e.next å³ç¬¬äºŒä¸ªé”®å€¼å¯¹</p><blockquote><p>PS.æˆ‘ä»¬å‡è®¾è½¬ç§»å‰åæˆ‘ä»¬çš„è¿™ä¸¤ä¸ªé”®å€¼å¯¹çš„ hash å€¼è®¡ç®—å‡ºæ¥çš„ç´¢å¼•ä»ç„¶ç›¸åŒ</p></blockquote></li><li><p>å°†æ–° table æ•°ç»„ç¬¬ i ä¸ªä½ç½®çš„é“¾è¡¨æ¥åˆ° e çš„åé¢ï¼Œå†æŠŠ e æ”¾åˆ° <code>newTable[i]</code> çš„ä½ç½®</p></li><li><p>å°† next èµ‹å€¼ç»™ e ï¼Œç»§ç»­å¾ªç¯ï¼Œç›´åˆ°é“¾è¡¨å¾ªç¯ç»“æŸ</p></li></ul><p>â‘¥ <code>createEntry(int hash, K key, V value, int bucketIndex)</code> åˆ›å»ºæ–°çš„é”®å€¼å¯¹</p><blockquote><p>æ–°æ’å…¥çš„é”®å€¼å¯¹ä¼šæ’å…¥åˆ°é“¾è¡¨æœ€å‰é¢</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å°†è¯¥é”®å€¼å¯¹å¯¹åº”çš„ç´¢å¼•çš„ä½ç½®çš„é”®å€¼å¯¹table[bucketIndex] çš„å¼•ç”¨èµ‹å€¼ç»™å±€éƒ¨å˜é‡ e</span></span><br><span class="line">    HashMapEntry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    <span class="comment">//æ–°å»ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œå³æ–°æ”¾å…¥çš„ hashï¼Œkeyï¼Œvalueï¼Œè¯¥é”®å€¼å¯¹çš„ next æ˜¯åŸæ¥çš„åœ¨è¿™ä¸ªç´¢å¼•ä½ç½®çš„é”®å€¼å¯¹</span></span><br><span class="line">    <span class="comment">//å¯è§æ’å…¥é”®å€¼å¯¹æ—¶ä¼šæ’å…¥åˆ°é“¾è¡¨çš„æœ€å‰é¢</span></span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> HashMapEntry&lt;&gt;(hash, key, value, e);â‘¦</span><br><span class="line">    <span class="comment">//å¯¹ size è‡ªå¢ï¼Œå³é”®å€¼å¯¹æ•°é‡ + 1</span></span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â‘¦ <code>HashMapEntry</code> æ„é€ æ–¹æ³•ï¼Œå¯è§ä¼ å…¥çš„ç¬¬å››ä¸ªå‚æ•° n ä¼šè¢«æ”¾åˆ°è¿™ä¸ªæ–°çš„ entry çš„ next ï¼Œå³æ”¾åˆ°ç¬¬å››ä¸ªå‚æ•°åœ¨é“¾è¡¨ä½ç½®ä¸Šçš„å‰é¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HashMapEntry(<span class="keyword">int</span> h, K k, V v, HashMapEntry&lt;K,V&gt; n) &#123;</span><br><span class="line">            value = v;</span><br><span class="line">            next = n;</span><br><span class="line">            key = k;</span><br><span class="line">            hash = h;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h2 id="remove-æ–¹æ³•"><a href="#remove-æ–¹æ³•" class="headerlink" title="remove æ–¹æ³•"></a>remove æ–¹æ³•</h2><p>ä» HashMap ä¸­é€šè¿‡ <em>key</em> ç§»é™¤æŸä¸ªé”®å€¼å¯¹ï¼Œå½“è¿™ä¸ªé”®å€¼å¯¹å­˜åœ¨æ—¶ï¼Œè¿”å›è¯¥ key å¯¹åº”çš„ valueï¼Œè‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› null</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = removeEntryForKey(key);</span><br><span class="line">    <span class="keyword">return</span> (e == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾€ä¸‹çœ‹ <code>removeEntryForKey(key)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">removeEntryForKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//è‹¥è¯¥ HashMap çš„é•¿åº¦ä¸º 0 ï¼Œè¯´æ˜æ²¡æœ‰é”®å€¼å¯¹ï¼Œç›´æ¥è¿”å› null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–è¯¥ key å¯¹åº”çš„ hash å€¼</span></span><br><span class="line">    <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : sun.misc.Hashing.singleWordWangJenkinsHash(key);</span><br><span class="line">    <span class="comment">//è·å–è¯¥ hash å€¼æ‰€å¯¹åº”çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="comment">//è·å–è¯¥ç´¢å¼•å¤„çš„é“¾è¡¨</span></span><br><span class="line">    HashMapEntry&lt;K,V&gt; prev = table[i];</span><br><span class="line">    <span class="comment">//å°†è¯¥é“¾è¡¨èµ‹å€¼ç»™ e</span></span><br><span class="line">    HashMapEntry&lt;K,V&gt; e = prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯¹é“¾è¡¨è¿›è¡Œå¾ªç¯ï¼Œå½“é“¾è¡¨ä¸Šçš„èŠ‚ç‚¹ e ä¸ä¸º null æ—¶</span></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">        å°†é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹èµ‹å€¼ç»™ next</span><br><span class="line">        HashMapEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="comment">//å½“è¯¥èŠ‚ç‚¹çš„ hash å€¼å’Œæ‰€è¦åˆ é™¤çš„ key çš„ hash å€¼ç›¸åŒï¼Œå¹¶ä¸” key å€¼ç›¸åŒï¼Œæˆ–è€… key ä¸ä¸º nullï¼Œåˆ™æ‰¾åˆ°äº†æ‰€è¦åˆ é™¤çš„é”®å€¼å¯¹</span></span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">            ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">            <span class="comment">//è‡ªå¢ä¿®æ”¹æ¬¡æ•°</span></span><br><span class="line">            modCount++;</span><br><span class="line">            <span class="comment">//å°† HashMap é”®å€¼å¯¹æ•°é‡å‡ä¸€</span></span><br><span class="line">            size--;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (prev == e)</span><br><span class="line">            <span class="comment">//å¦‚æœ prev == e ï¼Œå³åˆšå¥½é“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯æ‰€è¦æŸ¥æ‰¾çš„èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥å°†é“¾è¡¨çš„ next æŒ‡å‘ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œå°±æŠŠè¯¥èŠ‚ç‚¹åˆ é™¤äº†</span></span><br><span class="line">                table[i] = next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            <span class="comment">//å¦åˆ™å°† e èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹èµ‹å€¼ç»™ï¼Œprev çš„ä¸‹ä¸ªèŠ‚ç‚¹ï¼Œå³å°† prev çš„ next æŒ‡å‘ e.next </span></span><br><span class="line">                prev.next = next;</span><br><span class="line">            e.recordRemoval(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//è¿”å›åˆ é™¤çš„èŠ‚ç‚¹ e</span></span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        prev = e;</span><br><span class="line">        e = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿”å› e ï¼Œè¿™é‡Œå·²ç»å¾ªç¯é“¾è¡¨å®Œæ¯•ï¼Œe ä¸º null</span></span><br><span class="line">    <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å½“ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯æ‰€è¦æŸ¥è¯¢çš„èŠ‚ç‚¹æ—¶å€™<br><img src="https://i.loli.net/2020/05/02/w2Vbk17NYMHDSI5.png" alt="HaspMap_æˆªå›¾_1.png"></li></ul><p>æ­¤æ—¶ <code>prev == e</code>ï¼Œåˆ™ç›´æ¥å°† <code>e.next(å³ next)</code>ç›´æ¥èµ‹å€¼ç»™ <code>table[i]</code>ï¼Œåˆ™æŠŠ node a ç›´æ¥åˆ é™¤äº†</p><ul><li>ä»é“¾è¡¨ä¸­ä¸èƒ½æŸ¥åˆ°è¯¥èŠ‚ç‚¹</li></ul><p><img src="https://i.loli.net/2020/05/02/rX6oDc27s48gOyi.png" alt="HaspMap_æˆªå›¾_2.png"></p><p>prev å’Œ e æ˜¯é“¾è¡¨å¯¹è±¡ï¼Œæ¯æ¬¡å¾ªç¯å e ä¼šå…ˆå¾€é“¾è¡¨ä¸‹èµ°ï¼Œç›´åˆ°æŸ¥æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ <code>e == null</code> æ­¤æ—¶ä¼šé€€å‡ºå¾ªç¯ï¼Œå¹¶è¿”å› e ï¼Œå³è¿”å› nullã€‚</p><ul><li>ä»é“¾è¡¨ä¸­èƒ½æŸ¥åˆ°è¯¥èŠ‚ç‚¹</li></ul><p><img src="https://i.loli.net/2020/05/02/cStraUJXR5QupYm.png" alt="HaspMap_æˆªå›¾_3.png"></p><p>è‹¥æ‰¾åˆ°äº†æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ node b(å³ e)ï¼Œåˆ™å°† prev.next &#x3D; e.next ï¼Œç­‰æ•ˆäºå°† node b ä»é“¾è¡¨ä¸­åˆ é™¤äº†</p><h2 id="Java-8-ä¸­çš„-put-æ–¹æ³•"><a href="#Java-8-ä¸­çš„-put-æ–¹æ³•" class="headerlink" title="Java 8 ä¸­çš„ put æ–¹æ³•"></a>Java 8 ä¸­çš„ put æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implements Map.put and related methods</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hash hash for key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key the key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value the value to put</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> onlyIfAbsent if true, don&#x27;t change existing value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> evict if false, the table is in creation mode.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> previous value, or null if none</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">//å¦‚æœå½“å‰ table ä¸º null æˆ–è€…æ•°ç»„é•¿åº¦ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//æ‰©å®¹ï¼Œå¹¶å°†æ‰©å®¹åçš„æ•°ç»„èµ‹å€¼ç»™ tab ï¼Œn åˆ™ä¸ºå½“å‰æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä¸‹é¢çš„ `(n - 1) &amp; hash]` å°±æ˜¯ Java 7 ä¸­è®¡ç®—ç´¢å¼•çš„æ–¹æ³•</span></span><br><span class="line">        <span class="comment">//å¦‚æœè®¡ç®—å‡ºçš„ç´¢å¼•å¤„è¦æ’å…¥çš„åœ°æ–¹ä¸º null ï¼Œåˆ™ç›´æ¥æ–°å¢ä¸€ä¸ª Node é”®å€¼å¯¹</span></span><br><span class="line">        <span class="comment">//æ­¤æ—¶å°† tab[index] èµ‹å€¼ç»™äº† p ï¼Œå³ p = tab[index]</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//å¦‚æœèµ°åˆ°è¿™é‡Œï¼Œå¯ä»¥è¯´æ˜è¯¥é”®å€¼å¯¹çš„ key åœ¨åŸå…ˆçš„ HashMap ä¸­æ˜¯ä¸å­˜åœ¨çš„</span></span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//è¦æ’å…¥çš„ç´¢å¼•å¤„å·²ç»æœ‰ Node äº†</span></span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="comment">//å‡å¦‚è¯¥ç´¢å¼•å¤„çš„ Node p çš„ hash å€¼å’Œæ–°æ”¾å…¥çš„é”®å€¼å¯¹çš„hashç›¸åŒï¼Œå¹¶ä¸”keyå€¼ä¹Ÿç›¸åŒ</span></span><br><span class="line">            <span class="comment">//å°† p èµ‹å€¼ç»™ e</span></span><br><span class="line">            e = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            <span class="comment">//key ä¸ç›¸åŒçš„è¯ï¼Œå¹¶ä¸” p æ˜¯çº¢é»‘æ ‘çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥æ’å…¥çº¢é»‘æ ‘ä¸­</span></span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//key ä¸ç›¸åŒï¼Œå¹¶ä¸”ä¸ä¸ºçº¢é»‘æ ‘ï¼Œå³é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="comment">//è¿›è¡Œå¾ªç¯</span></span><br><span class="line">                <span class="comment">//å¦‚æœ p çš„ä¸‹ä¸ªèŠ‚ç‚¹ä¸ºç©º(å³ p æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹)</span></span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//å°†è¯¥éœ€è¦æ’å…¥çš„èŠ‚ç‚¹æ’åˆ°é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        <span class="comment">//å¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡ 8 ï¼Œåˆ™è½¬ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="comment">//è·³å‡ºå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//å¦‚æœ p çš„ä¸‹ä¸ªèŠ‚ç‚¹ e ä¸ä¸ºç©ºï¼Œä¸” e çš„ hash å€¼ç­‰äºæ’å…¥çš„èŠ‚ç‚¹çš„ hash å¹¶ä¸” key ç›¸åŒï¼Œå³ e å°±ç­‰äºéœ€è¦æ’å…¥çš„èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥è·³å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//å°†é“¾è¡¨çš„ä¸‹ä¸ªèŠ‚ç‚¹ `e` åœ¨å¾ªç¯ä¸­èµ‹å€¼ç»™ `p`</span></span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            <span class="comment">//å¦‚æœ e ä¸ä¸ºç©ºï¼Œå³åŸæ¥çš„ table ä¸­å­˜åœ¨ç›¸åŒçš„ key ï¼Œe ä¸ºæ—§çš„ node</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">//æ›¿æ¢æ‰æ—§å€¼</span></span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="comment">//è¿”å› key å¯¹åº”çš„æ—§å€¼</span></span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœ HashMap ä¸­ä¸å­˜åœ¨è¯¥ keyï¼Œä¼šèµ°åˆ°è¿™é‡Œ</span></span><br><span class="line">    <span class="comment">//mod æ¬¡æ•°è‡ªå¢</span></span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">//å¦‚æœé”®å€¼å¯¹æ•°é‡å¤§äºé˜ˆå€¼ï¼Œåˆ™æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>æ€»ç»“ä¸‹æ€è·¯</p><ol><li>åœ¨æ’å…¥æ—¶ï¼Œè®¡ç®—å‡º key å€¼å¯¹åº”çš„ hash å€¼ï¼Œæ¥ç€è®¡ç®— hash å€¼å¯¹åº”çš„ç´¢å¼•</li><li>åˆ¤æ–­è¯¥ç´¢å¼•å¤„æ˜¯å¦ä¸ºç©º</li></ol><p>2.1 å¦‚æœä¸ºç©ºï¼Œåˆ™ç›´æ¥æ’å…¥è¯¥é”®å€¼å¯¹<br>2.2 å¦‚æœä¸ä¸ºç©ºï¼Œè¯´æ˜è¯¥ç´¢å¼•å¤„å·²ç»å­˜åœ¨ã€é“¾è¡¨ã€æˆ–è€…ã€çº¢é»‘æ ‘ã€äº†<br>2.2.1 å¦‚æœã€é“¾è¡¨ã€çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…ã€çº¢é»‘æ ‘ã€çš„æ ¹èŠ‚ç‚¹çš„ key å€¼ç­‰äºè¦æ’å…¥çš„ key å¹¶ä¸” hash å€¼ç›¸åŒï¼Œåˆ™è¿›è¡Œæ›¿æ¢<br>2.2.2 å¦åˆ™ï¼Œå¦‚æœæ˜¯ã€çº¢é»‘æ ‘ã€ï¼Œåˆ™è¿›è¡Œæ’å…¥<br>2.2.3 å¦åˆ™ï¼Œå¦‚æœæ˜¯ã€é“¾è¡¨ã€ï¼Œåˆ™è¿›è¡Œå¾ªç¯é“¾è¡¨æ’å…¥ï¼ˆå¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡ 8ï¼Œåˆ™è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰<br>2.2.4 ç»è¿‡ 2.2.1 - 2.2.3 ä¹‹åï¼Œå¦‚æœåŸæ¥ä¸­æœ‰ç›¸åŒçš„ key ï¼Œåˆ™ç›´æ¥ return æ—§å€¼<br>2.3 åŸ HashMap ä¸­æ²¡æœ‰æ’å…¥çš„ keyï¼Œåˆ™é”®å€¼å¯¹æ•°é‡è‡ªå¢ï¼Œåˆ¤æ–­æ‰©å®¹ï¼Œreturn null</p></blockquote><h3 id="Java-8-ä¸­çš„-resize-æ–¹æ³•"><a href="#Java-8-ä¸­çš„-resize-æ–¹æ³•" class="headerlink" title="Java 8 ä¸­çš„ resize() æ–¹æ³•"></a>Java 8 ä¸­çš„ resize() æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Initializes or doubles table size.  If null, allocates in</span></span><br><span class="line"><span class="comment"> * accord with initial capacity target held in field threshold.</span></span><br><span class="line"><span class="comment"> * Otherwise, because we are using power-of-two expansion, the</span></span><br><span class="line"><span class="comment"> * elements from each bin must either stay at same index, or move</span></span><br><span class="line"><span class="comment"> * with a power of two offset in the new table.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the table</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    <span class="comment">//è·å–æ—§çš„æ•°ç»„å¼•ç”¨</span></span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="comment">//è®¡ç®—æ—§æ•°æ®çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="comment">//è·å–æ—§é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ—§æ•°ç»„é•¿åº¦å¤§äºç­‰äºæœ€å¤§å®¹é‡ï¼Œåˆ™ç›´æ¥è¿”å›æ—§æ•°ç»„</span></span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">                 <span class="comment">//æ–°æ•°æ®å®¹é‡ = æ—§æ•°æ®å®¹é‡å·¦ç§»ä¸€ä½ï¼Œå³ * 2</span></span><br><span class="line">                 <span class="comment">//å¦‚æœæ–°æ•°ç»„å®¹é‡å°äºæœ€å¤§å€¼ï¼Œä¸”æ—§æ•°ç»„å®¹é‡å¤§äºç­‰äºé»˜è®¤é•¿åº¦ï¼ˆ16ï¼‰</span></span><br><span class="line">                 <span class="comment">//åŒæ—¶å°†é˜ˆå€¼æ‰©å¤§ä¸€å€</span></span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">         <span class="comment">// å¦‚æœåŸæ¥çš„ threshold å¤§äº0åˆ™å°†å®¹é‡è®¾ä¸ºåŸæ¥çš„ threshold</span></span><br><span class="line">        <span class="comment">// åœ¨ç¬¬ä¸€æ¬¡å¸¦å‚æ•°åˆå§‹åŒ–æ—¶å€™ä¼šæœ‰è¿™ç§æƒ…å†µ</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// åœ¨é»˜è®¤æ— å‚æ•°åˆå§‹åŒ–ä¼šæœ‰è¿™ç§æƒ…å†µ</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;<span class="comment">//16</span></span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);<span class="comment">//16 * 0.75 = 12</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ–°çš„é˜ˆå€¼ä¸º 0</span></span><br><span class="line">        <span class="comment">//è®¡ç®—æ–°çš„é˜ˆå€¼</span></span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        <span class="comment">//å¦‚æœæ–°çš„å®¹é‡å°äºæœ€å¤§å®¹é‡ä¸”æ–°çš„é˜ˆå€¼ä¹Ÿå°äºæœ€å¤§å®¹é‡</span></span><br><span class="line">        <span class="comment">//åˆ™æ–°çš„é˜ˆå€¼ç­‰äº ft ï¼Œå¦åˆ™è®¾ç½®ä¸º Integer.MAX_VALUE</span></span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ–°çš„é˜ˆå€¼èµ‹å€¼ç»™ threshold</span></span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºæ–°çš„æ•°ç»„</span></span><br><span class="line">        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">        <span class="comment">//å°†æ–°æ•°ç»„èµ‹å€¼ç»™ table </span></span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="comment">//è¿›è¡Œæ‰©å®¹å¤åˆ¶</span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//æ—§æ•°ç»„ä¸ä¸º null ï¼Œè¿›è¡Œå¾ªç¯</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="comment">// å°†å½“å‰ç´¢å¼•å¤„çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹èµ‹å€¼ç»™ e </span></span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//å°†æ—§æ•°ç»„çš„å¼•ç”¨ç½®ä¸º null</span></span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//å¦‚æœå½“å‰ç´¢å¼•å¤„åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥è®¡ç®—åœ¨æ–°æ•°ç»„ä¸­çš„ç´¢å¼•å¹¶èµ‹å€¼</span></span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    <span class="comment">//å¦‚æœ e æ˜¯çº¢é»‘æ ‘ï¼Œåˆ™è°ƒç”¨çº¢é»‘æ ‘çš„æ–¹æ³•è¿›è¡Œå¤„ç†</span></span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    <span class="comment">//å¤„ç†é“¾è¡¨é•¿åº¦ä¸º 1 ~ 8 çš„æƒ…å†µ</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;<span class="comment">//ä½ä½çš„é“¾è¡¨å¤´èŠ‚ç‚¹ï¼Œä½ä½çš„é“¾è¡¨å°¾èŠ‚ç‚¹</span></span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;<span class="comment">//é«˜ä½çš„é“¾è¡¨å¤´èŠ‚ç‚¹ï¼Œé«˜ä½çš„é“¾è¡¨å°¾èŠ‚ç‚¹</span></span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">//ï¼ï¼è¿™é‡Œ e.hash &amp; oldCap ä¸æ˜¯è®¡ç®—ç´¢å¼•ï¼Œè®¡ç®—ç´¢å¼•åº”è¯¥æ˜¯ e.hash &amp; (oldCap -1)</span></span><br><span class="line">                            <span class="comment">//å¦‚æœèŠ‚ç‚¹ e çš„ hash å€¼å’Œ oldCap è®¡ç®—å‡ºæ¥å€¼ä¸º 0 ï¼Œè¯´æ˜åœ¨æ‰©å®¹åè¯¥èŠ‚ç‚¹çš„ç´¢å¼•ç›¸åŒï¼Œä¸éœ€è¦ç§»åŠ¨ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                <span class="comment">//ç¬¬ä¸€æ¬¡æ‰ä¼šèµ°å…¥è¿™ä¸ªåœ°æ–¹</span></span><br><span class="line">                                <span class="comment">//å¦‚æœä½ä½å°¾éƒ¨èŠ‚ç‚¹ä¸º nullï¼Œå°† e èµ‹å€¼ç»™å¤´éƒ¨èŠ‚ç‚¹ï¼Œå³é“¾è¡¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                <span class="comment">//å¦åˆ™(å³ç¬¬äºŒæ¬¡ä»¥å)ï¼Œå°† e èµ‹å€¼ç»™å°¾éƒ¨èŠ‚ç‚¹çš„ nextï¼Œå³ loTail.next </span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            <span class="comment">//å†å°† e èµ‹å€¼ç»™å°¾éƒ¨èŠ‚ç‚¹ loTailï¼Œ</span></span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//å¦åˆ™ï¼Œè¯¥èŠ‚ç‚¹éœ€è¦ç§»åŠ¨ç´¢å¼•ä½ç½®åˆ°æ–°çš„ç´¢å¼•å»</span></span><br><span class="line">                            <span class="comment">//æ–¹æ³•åŒä¸Š</span></span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);<span class="comment">// å°† next èµ‹å€¼ç»™ eï¼Œç›´åˆ°æ²¡æœ‰ next ï¼Œå³é“¾è¡¨å¾ªç¯å®Œæ¯•</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœä½ä½çš„å°¾èŠ‚ç‚¹ä¸ä¸º null ï¼Œåˆ™å°†å…¶ next ç½®ä¸º null</span></span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">//å¹¶å°†ä½ä½çš„å¤´èŠ‚ç‚¹æ”¾åˆ°è¯¥ä½ä½ç´¢å¼•å¤„</span></span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœé«˜ä½çš„å°¾èŠ‚ç‚¹ä¸ä¸º null ï¼Œåˆ™å°†å…¶ next ç½®ä¸º null</span></span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">//å¹¶å°†é«˜ä½çš„å¤´èŠ‚ç‚¹æ”¾åˆ°è¯¥é«˜ä½ç´¢å¼•å¤„</span></span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡ç‚¹çœ‹ä¸€ä¸‹å¤„ç†é“¾è¡¨é•¿åº¦ä¸º 1~ 8 çš„æƒ…å†µ</p><p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äºä¸€ä¸ªé”®å€¼å¯¹èŠ‚ç‚¹ï¼Œå…¶ç´¢å¼•çš„è®¡ç®—æ–¹å¼ä¸º <code>index = hash(key) &amp; (n - 1)</code> </p><p>å‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ <code>Node A</code> å’Œ <code>Node B</code> ,å…¶ key çš„ hash å€¼åˆ†åˆ«ä¸º hash(a)ã€hash(b)ï¼Œn &#x3D; 16</p><p>è®¡ç®—å…¶ç´¢å¼•è¿‡ç¨‹å¦‚ä¸‹</p><p>n - 1     0000 0000 0000 0000 0000 0000 0000 1111<br>hash(a)   1111 1111 1111 1111 0000 1111 0000 0101<br>hash(b)   1111 1111 1111 1111 0000 1111 0001 0101</p><p>è®¡ç®—ç´¢å¼• <code>index = hash(key) &amp; (n - 1)</code></p><p>index(a)  0000 0000 0000 0000 0000 0000 0000 0101 &#x3D;&#x3D; 5<br>index(b)  0000 0000 0000 0000 0000 0000 0000 0101 &#x3D;&#x3D; 5</p><p>åˆ™ <code>Node A</code> å’Œ <code>Node B</code> è®¡ç®—å‡ºæ¥çš„ç´¢å¼•ç›¸åŒï¼Œåˆ™æ”¾åœ¨åŒä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œå½“è¿›è¡Œæ‰©å®¹æ—¶ï¼Œæ•°ç»„çš„é•¿åº¦ä¼šå˜ä¸ºåŸæ¥é•¿åº¦çš„ä¸¤å€<br>å³ n &#x3D; n * 2;<br>æ‰©å®¹åè¦é‡æ–°è®¡ç®—ç´¢å¼•</p><p>n - 1     0000 0000 0000 0000 0000 0000 0001 1111<br>hash(a)   1111 1111 1111 1111 0000 1111 0000 0101<br>hash(b)   1111 1111 1111 1111 0000 1111 0001 0101<br>è®¡ç®—ç´¢å¼• <code>index = hash(key) &amp; (n - 1)</code></p><p>index(a)  0000 0000 0000 0000 0000 0000 0000 0101 &#x3D; 5<br>index(b)  0000 0000 0000 0000 0000 0000 0001 0101 &#x3D; <code>21 = 5 + 16</code></p><p>ç”±æ­¤å¯è§ï¼Œå½“åŒä¸€ä¸ªé“¾è¡¨ä¸­çš„èŠ‚ç‚¹åœ¨è¿›è¡Œé‡æ–°ç´¢å¼•æ—¶ï¼Œå¹¶ä¸éœ€è¦é‡æ–°é€šè¿‡ <code>index = hash(key) &amp; (n - 1)</code> æ–¹æ³•è®¡ç®—ç´¢å¼•ï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸­çš„èŠ‚ç‚¹åœ¨æ‰©å®¹åè¦ä¹ˆè¿˜åœ¨å½“å‰ç´¢å¼•<code>index</code>å¤„ï¼Œè¦ä¹ˆåœ¨ <code>index + oldCap</code>å¤„ã€‚</p><p>æ‰€ä»¥å½“æ‰©å®¹æ—¶é‡æ–°è®¡ç®—ç´¢å¼•ï¼Œå¯ä»¥ä¸éœ€è¦é‡æ–°è®¡ç®— hash å€¼ï¼ŒèŠ‚çœäº†è®¡ç®— hash çš„æ—¶é—´ï¼Œå¹¶ä¸”åªéœ€è¦çœ‹åŸæ¥çš„ hash å€¼æ–°å¢çš„é‚£ä¸ªé«˜ä½çš„å€¼æ˜¯ 1 è¿˜æ˜¯ 0 å³å¯â‘¨ï¼Œå¦‚æœæ˜¯ 1 ï¼Œåˆ™æ–°çš„ç´¢å¼•ä¸º <code>index = index + olcCap</code>ï¼Œå¦åˆ™ <code>index</code> ä¸å˜</p><p>â‘¨è®¡ç®—æ–¹æ³•</p><blockquote><p>e.hash &amp; oldCap åˆ¤æ–­æ˜¯å¦ä¸º 0 </p></blockquote><p><img src="https://i.loli.net/2020/05/02/dl6RxSMi3HEA9ze.png" alt="HaspMap_æˆªå›¾_4.png"></p><p>æ›´ç®€å•æ¥è¯´ï¼Œ</p><ul><li><p>ç¬¬ä¸€æ¬¡: </p><blockquote><p>e -&gt; A,next -&gt; B,<br>loHead -&gt; e(A) ,loTail -&gt; e(A)<br>e -&gt; next(B)</p></blockquote></li><li><p>ç¬¬äºŒæ¬¡: </p><blockquote><p>e -&gt; B,next -&gt; C,loTail -&gt; A<br>loTail.next -&gt; e(B)<br>æ­¤æ—¶ loHead å’Œ loTail æŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œæ‰€ä»¥ loHead.next &#x3D; e(B)<br>loTail -&gt; e(B),e -&gt; next(C)</p></blockquote></li><li><p>ç¬¬ä¸‰æ¬¡:</p><blockquote><p>e -&gt; C,next -&gt; null,loTail -&gt; B<br>loTail.next -&gt; e(C)<br>åˆ™æ­¤æ—¶ B.next  æŒ‡å‘äº† C ,è€Œ loHead.next æŒ‡å‘çš„ä¹Ÿæ˜¯ B ,å³ loTail,æ‰€ä»¥æ­¤æ—¶ loHead.next.next -&gt; C<br>loTail -&gt; e(C),e -&gt; next(null)</p></blockquote></li><li><p>ç»“æŸå¾ªç¯<br>loHead &#x3D; A -&gt; B -&gt; C</p></li></ul><p><strong>é€šè¿‡ä¸Šé¢çš„åˆ†æä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒJava 8 åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œé“¾è¡¨çš„é¡ºåºæ˜¯ä¸å˜çš„ï¼Œé“¾è¡¨åœ¨æ‰©å®¹åè¿˜ä¿æŒåŸæ¥çš„é¡ºåºï¼Œè€Œ Java 7 æ˜¯å€’åºçš„</strong></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#åŸºç¡€çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;/a&gt;åŸºç¡€çŸ¥è¯†&lt;/h2&gt;&lt;h3 id=&quot;ä½è¿ç®—ç¬¦&quot;&gt;&lt;a href=&quot;#ä½è¿ç®—ç¬¦&quot; class=&quot;headerlink&quot; title=&quot;ä½è¿ç®—ç¬¦&quot;&gt;&lt;/a&gt;ä½è¿ç®—ç¬¦&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ä½ä¸ &lt;code&gt;&amp;amp;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;1 &amp;amp; 1 &amp;#x3D; 1 ï¼Œå…¶ä½™éƒ½æ˜¯ 0 &lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sample : &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;0011&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1010&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;0010&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;å³ `3 &amp;amp; 10 = 2`&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Java" scheme="https://ppting.me/categories/Java/"/>
    
    <category term="æºç " scheme="https://ppting.me/categories/%E6%BA%90%E7%A0%81/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="https://ppting.me/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
    
    <category term="Map" scheme="https://ppting.me/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>Android TextView ä¸¤ç«¯å¯¹é½</title>
    <link href="https://ppting.me/2018/04/14/2018_04_14_justify-in-android/"/>
    <id>https://ppting.me/2018/04/14/2018_04_14_justify-in-android/</id>
    <published>2018-04-14T03:35:02.000Z</published>
    <updated>2022-02-12T08:11:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨é¡¹ç›®ä¸­é‡åˆ°é¡¹ç›®è¦æ±‚åœ¨æè¿°ä¸­è¿›è¡Œä¸¤ç«¯å¯¹é½ï¼Œè€Œæˆ‘ä»¬çš„ <code>TextView</code> æ˜¯ä¸æ”¯æŒä¸¤ç«¯å¯¹é½çš„<br>è¦åšåˆ°ä¸¤ç«¯å¯¹é½ï¼Œå…¶å®è¿˜æ˜¯æœ‰äº›å° trick çš„<br><img src="https://i.loli.net/2020/05/02/MIVy2WYan7dSmGt.png" alt="justify_in_android_image_1.png"></p><span id="more"></span><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªå­—ç¬¦ä¹‹é—´æ’å…¥ä¸€ä¸ªç©ºæ ¼å­—ç¬¦ï¼Œç„¶ååŠ¨æ€åœ°è®¡ç®—ä¸ºäº†è¾¾åˆ°æŸä¸ªå®½åº¦(å³æœ€å¤§å®½åº¦)ï¼Œæ¯ä¸ªç©ºæ ¼å­—ç¬¦éœ€è¦å¤šå¤§çš„å®½åº¦ï¼Œç„¶åä½¿ç”¨ <code>ScaleXSpan</code> å°†ç©ºæ ¼å­—ç¬¦æ¨ªå‘æ”¾å¤§&#x2F;ç¼©å°ï¼Œè¿™æ ·å°±è§£å†³äº†æˆ‘ä»¬ä¸¤ç«¯å¯¹é½çš„æ–¹æ³•ï¼Œåªéœ€è¦ä½¿ç”¨ä¸€ä¸ª <code>TextView</code> å°±å¤Ÿäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†æ–‡å­—è½¬ä¸ºä¸¤ç«¯å¯¹é½</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxSize æœ€å¤§çš„æ–‡å­—æ•°é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text æ–‡å­—</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> textSize æ–‡å­—å¤§å°ï¼Œå•ä½ä¸º sp æˆ–è€… dp</span></span><br><span class="line"><span class="comment"> * ä¸¾ä¾‹ï¼Œå‡è®¾éœ€è¦å°†ã€ä¸‰ä¸ªå­—ã€è¿›è¡Œä¸¤ç«¯å¯¹é½ï¼Œæœ€å¤§é•¿åº¦ä¸º4ä¸ªä¸­æ–‡å­—</span></span><br><span class="line"><span class="comment"> * åˆ™åœ¨ã€ä¸‰ä¸ªå­—ã€çš„æ¯ä¸ªå­—ç¬¦ä¹‹é—´æ’å…¥ä¸€ä¸ªå…¨è§’ç©ºæ ¼ï¼Œå¹¶è®¡ç®—å…¶åº”è¯¥æ”¾å¤§/ç¼©å°çš„å€æ•°ï¼Œç„¶åç”¨ ScaleXSpan å¯¹ x è½´æ–¹å‘è¿›è¡Œæ”¾å¤§/ç¼©æ”¾</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Spannable <span class="title">formatText</span><span class="params">(<span class="keyword">int</span> maxSize,String text,<span class="keyword">int</span> textSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(text))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpannableString(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å…ˆè·å– maxSize ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">int</span> textLength = text.length();</span><br><span class="line">    <span class="keyword">if</span> (maxSize &lt; textLength || textLength == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpannableString(text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¡ç®—å•ä¸ªä¸­æ–‡å­—åœ¨è¯¥è®¾å¤‡ä¸Šçš„é•¿åº¦ï¼Œå•ä½æ˜¯ px</span></span><br><span class="line">    <span class="keyword">float</span> oneCharLength = DisplayMetricsUtil.getTextWidth(<span class="string">&quot;æ­£&quot;</span>,textSize);</span><br><span class="line">    <span class="keyword">float</span> maxTextLength = oneCharLength * maxSize;</span><br><span class="line">    <span class="comment">//è®¡ç®—è¯¥æ–‡å­—å’Œåº”æœ‰é•¿åº¦çš„å·®</span></span><br><span class="line">    <span class="keyword">float</span> diffLength = maxTextLength - DisplayMetricsUtil.getTextWidth(text,textSize);</span><br><span class="line">    <span class="comment">//è®¡ç®—æ¯ä¸ªé—´éš™çš„å®½åº¦</span></span><br><span class="line">    <span class="keyword">float</span> singleGapLength = diffLength / (textLength -<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//è®¡ç®—æ¯ä¸ªé—´éš™åº”è¯¥æ”¾å¤§/ç¼©å°çš„å€æ•°</span></span><br><span class="line">    <span class="keyword">float</span> scale = singleGapLength / oneCharLength;</span><br><span class="line">    SpannableStringBuilder spannableStringBuilder = <span class="keyword">new</span> SpannableStringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>[] chars = text.toCharArray();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; textLength; i++) &#123;</span><br><span class="line">        spannableStringBuilder.append(chars[i]);</span><br><span class="line">        <span class="keyword">if</span> (i != textLength -<span class="number">1</span>)&#123;</span><br><span class="line">            SpannableString space = <span class="keyword">new</span> SpannableString(<span class="string">&quot;ã€€&quot;</span>);<span class="comment">//å…¨è§’ç©ºæ ¼</span></span><br><span class="line">            space.setSpan(<span class="keyword">new</span> ScaleXSpan(scale), <span class="number">0</span>, <span class="number">1</span>, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">            spannableStringBuilder.append(space);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> spannableStringBuilder;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¡ç®—æ–‡å­—çš„å®½åº¦å¯ä»¥ä½¿ç”¨ <code>Paint</code> ä¸­çš„ <code>measureText()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®å­—ä½“å¤§å°è·å–å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text ä¾‹å¦‚ æ­£æ­£æ­£</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> textSize 18 (å•ä½æ˜¯ sp æˆ– dp)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">getTextWidth</span><span class="params">(String text, <span class="keyword">int</span> textSize)</span> </span>&#123;</span><br><span class="line">    TextPaint paint = <span class="keyword">new</span> TextPaint();</span><br><span class="line">    <span class="keyword">float</span> scaledDensity = App.getContext().getResources().getDisplayMetrics().scaledDensity;</span><br><span class="line">    paint.setTextSize(scaledDensity * textSize);</span><br><span class="line">    <span class="keyword">return</span>  paint.measureText(text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶åªéœ€è¦è°ƒç”¨ <code>formatText</code> æ–¹æ³•å¯¹æ–‡å­—è¿›è¡Œå¤„ç†å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">textView.setText(formatText(<span class="number">4</span>,<span class="string">&quot;ä¸‰ä¸ªå­—&quot;</span>,<span class="number">14</span>));</span><br></pre></td></tr></table></figure><p>æœ€ååšå‡ºæ¥çš„æ•ˆæœå¤§æ¦‚å¦‚ä¸‹<br><img src="https://i.loli.net/2020/05/02/Du9PdSt1x7GFIvs.png" alt="justify_in_android_image_2.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨é¡¹ç›®ä¸­é‡åˆ°é¡¹ç›®è¦æ±‚åœ¨æè¿°ä¸­è¿›è¡Œä¸¤ç«¯å¯¹é½ï¼Œè€Œæˆ‘ä»¬çš„ &lt;code&gt;TextView&lt;/code&gt; æ˜¯ä¸æ”¯æŒä¸¤ç«¯å¯¹é½çš„&lt;br&gt;è¦åšåˆ°ä¸¤ç«¯å¯¹é½ï¼Œå…¶å®è¿˜æ˜¯æœ‰äº›å° trick çš„&lt;br&gt;&lt;img src=&quot;https://i.loli.net/2020/05/02/MIVy2WYan7dSmGt.png&quot; alt=&quot;justify_in_android_image_1.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://ppting.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Android" scheme="https://ppting.me/categories/Android/"/>
    
    
    <category term="Trick" scheme="https://ppting.me/tags/Trick/"/>
    
  </entry>
  
</feed>
